<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>기록은 재산이다</title>
  
  <subtitle>To Improve Human Life</subtitle>
  <link href="/feed.xml" rel="self"/>
  
  <link href="https://supawer0728.github.io/"/>
  <updated>2020-03-04T13:27:27.496Z</updated>
  <id>https://supawer0728.github.io/</id>
  
  <author>
    <name>supawer0728</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>(Spring Boot)오류 처리에 대해</title>
    <link href="https://supawer0728.github.io/2019/04/04/spring-error-handling/"/>
    <id>https://supawer0728.github.io/2019/04/04/spring-error-handling/</id>
    <published>2019-04-04T07:07:41.000Z</published>
    <updated>2020-03-04T13:27:27.496Z</updated>
    
    <content type="html"><![CDATA[<h1 id="서론"><a href="#서론" class="headerlink" title="서론"></a>서론</h1><p>오류 처리는 어플리케이션 개발에 있어 매우 큰 부분을 차지한다.<br>오류를 예측하는 것과 예방하는 것, 그리고 <code>오류를 빨리 발견하고 고칠 수 있는 것</code>은 훌륭한 개발자의 필수조건이라고 생각한다.<br>본 문서에서는 Spring에서 어떻게 예외처리 잘 할 수 있도록 도와주는지를 알아보고 공유하려한다.</p><a id="more"></a><h1 id="ErrorController"><a href="#ErrorController" class="headerlink" title="ErrorController"></a>ErrorController</h1><p>먼저 아래 Spring Boot에서 기본적으로 오류처리를 어떻게 해주는지 살펴보자.<br>아래는 404 Not Found에 대해서 html, json 응답 예제이다.</p><p><strong>GET /123</strong></p><p><img src="/images/spring-error-handling/notfound.png" alt="image.png"></p><p><strong>GET /123 - json 응답</strong></p><ul><li>Content-Type: application/json</li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"timestamp"</span>: <span class="string">"2019-02-15T21:48:44.447+0000"</span>,</span><br><span class="line">  <span class="attr">"status"</span>: <span class="number">404</span>,</span><br><span class="line">  <span class="attr">"error"</span>: <span class="string">"Not Found"</span>,</span><br><span class="line">  <span class="attr">"message"</span>: <span class="string">"No message available"</span>,</span><br><span class="line">  <span class="attr">"path"</span>: <span class="string">"/123"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>위에서 살펴본 것과 같이 별다른 설정 없이 spring boot에서 웹 어플리케이션을 실행하면 기본적으로 오류 처리가 되고 있음을 알 수 있다.<br>그렇다면 어떠한 설정으로 spring boot에서 오류를 처리하는지 먼저 spring boot의 오류 처리에 대한 properties를 살펴보자.</p><p><strong>Spring Boot의 기본 오류 처리 properties</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># spring boot의 기본 properties</span></span><br><span class="line"><span class="attr">server.error:</span></span><br><span class="line">  <span class="attr">include-exception:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">include-stacktrace:</span> <span class="string">never</span> <span class="comment"># 오류 응답에 stacktrace 내용을 포함할 지 여부</span></span><br><span class="line">  <span class="attr">path:</span> <span class="string">'/error'</span> <span class="comment"># 오류 응답을 처리할 Handler의 경로</span></span><br><span class="line">  <span class="attr">whitelabel.enabled:</span> <span class="literal">true</span> <span class="comment"># 서버 오류 발생시 브라우저에 보여줄 기본 페이지 생성 여부</span></span><br></pre></td></tr></table></figure><ul><li><code>server.error.include-exception</code> : 응답에 exception의 내용을 포함할지 여부</li><li><code>server.error.include-stacktrace</code> : 응답에 stacktrace 내용을 포함할지 여부</li><li><code>server.error.path</code> : 오류 응답을 처리할 핸들러(ErrorController)의 path</li><li><code>server.error.whitelabel.enabled</code> : 브라우저 요청에 대해 서버 오류시 기본으로 노출할 페이지를 사용할지 여부</li></ul><p><code>server.error.whitelabel.enabled</code>의 기본값이 <code>true</code>이기 때문에 위에서와 같이 오류 페이지가 노출되고 있었다<br>아래 스크린샷은 <code>include-exception</code>과 <code>include-stacktrace</code>를 활성화하면 아래와 같이 응답을 받을 수 있다.</p><p><strong>HTML 응답</strong></p><p><img src="/images/spring-error-handling/error-html.png" alt="errorhtml"></p><p><strong>json 응답</strong></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"timestamp"</span>: <span class="string">"2019-04-04T09:31:27.931+0000"</span>,</span><br><span class="line">  <span class="attr">"status"</span>: <span class="number">500</span>,</span><br><span class="line">  <span class="attr">"error"</span>: <span class="string">"Internal Server Error"</span>,</span><br><span class="line">  <span class="attr">"exception"</span>: <span class="string">"java.lang.IllegalStateException"</span>,</span><br><span class="line">  <span class="attr">"message"</span>: <span class="string">"test"</span>,</span><br><span class="line">  <span class="attr">"trace"</span>: <span class="string">"java.lang.IllegalStateException: test ...(길어서 줄임)"</span>,</span><br><span class="line">  <span class="attr">"path"</span>: <span class="string">"/rest-test"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Spring-Boot의-기본-오류-처리-BasicErrorController"><a href="#Spring-Boot의-기본-오류-처리-BasicErrorController" class="headerlink" title="Spring Boot의 기본 오류 처리 - BasicErrorController"></a>Spring Boot의 기본 오류 처리 - BasicErrorController</h2><p>그렇다면 Spring Boot에서는 어떻게 이런 기본 처리를 하고 있는 것일까.<br>Spring Boot는 오류가 발생하면 <code>server.error.path</code>에 설정된 경로에서 요청을 처리하게 한다.<br>Spring Boot에서는 기본적으로 BasicErrorController가 등록이 되어 해당 요청을 처리하게 된다.<br>BasicErrorController는 대략적으로 아래와 같이 구현되어 있다.<br>전반적으로 소스코드를 모두 읽어보면 좋겠지만 주요한 곳에 번호를 붙여 아래에 설명을 달아두었다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"$&#123;server.error.path:$&#123;error.path:/error&#125;&#125;"</span>) <span class="comment">// 1)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BasicErrorController</span> <span class="keyword">extends</span> <span class="title">AbstractErrorController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getErrorPath</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.errorProperties.getPath();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@RequestMapping</span>(produces = MediaType.TEXT_HTML_VALUE) <span class="comment">// 2)</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> ModelAndView <span class="title">errorHtml</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> </span>&#123;</span><br><span class="line">            </span><br><span class="line">    HttpStatus status = getStatus(request);</span><br><span class="line">    Map&lt;String, Object&gt; model =</span><br><span class="line">      getErrorAttributes(request, isIncludeStackTrace(request, MediaType.TEXT_HTML)));</span><br><span class="line"></span><br><span class="line">    response.setStatus(status.value());</span><br><span class="line">    ModelAndView modelAndView = resolveErrorView(request, response, status, model);</span><br><span class="line">    <span class="keyword">return</span> (modelAndView != <span class="keyword">null</span>) ? modelAndView : <span class="keyword">new</span> ModelAndView(<span class="string">"error"</span>, model);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@RequestMapping</span> <span class="comment">// 3)</span></span><br><span class="line">  <span class="keyword">public</span> ResponseEntity&lt;Map&lt;String, Object&gt;&gt; error(HttpServletRequest request) &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4)</span></span><br><span class="line">    Map&lt;String, Object&gt; body =</span><br><span class="line">      getErrorAttributes(request, isIncludeStackTrace(request, MediaType.ALL));</span><br><span class="line">    HttpStatus status = getStatus(request);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ResponseEntity&lt;&gt;(body, status);</span><br><span class="line">  &#125;    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>Spring 환경 내에 <code>server.error.path</code> 혹은 <code>error.path</code>로 등록된 property의 값을 넣거나, 없는 경우 <code>/error</code>를 사용한다.</li><li>HTML로 응답을 주는 경우 <code>errorHtml</code>에서 응답을 처리한다.</li><li>HTML 외의 응답이 필요한 경우 <code>error</code>에서 처리한다.</li><li>실질적으로 view에 보낼 model을 생성한다</li></ol><blockquote><p><strong>BasicErrorController 정리</strong><br><code>BasicErrorController</code>에서는 HTML 요청, 그 외의 요청을 나누어서 처리할 핸들러를 등록하고 <code>getErrorAttributes</code>를 통해 응답을 위한 모델을 생성한다.</p></blockquote><h2 id="Spring-Boot의-기본-오류-처리-AbstractErrorController와-ErrorAttributes"><a href="#Spring-Boot의-기본-오류-처리-AbstractErrorController와-ErrorAttributes" class="headerlink" title="Spring Boot의 기본 오류 처리 - AbstractErrorController와 ErrorAttributes"></a>Spring Boot의 기본 오류 처리 - AbstractErrorController와 ErrorAttributes</h2><p><code>getErrorAttributes</code>를 조금 더 깊게 살펴보자.<br><code>getErrorAttributes</code>는 <code>BasicErrorController</code>의 상위 클래스인 <code>AbstractErrorController</code>에 구현되어 있다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractErrorController</span> <span class="keyword">implements</span> <span class="title">ErrorController</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> ErrorAttributes errorAttributes;</span><br><span class="line">    </span><br><span class="line">  <span class="function"><span class="keyword">protected</span> Map&lt;String, Object&gt; <span class="title">getErrorAttributes</span><span class="params">(HttpServletRequest request,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">boolean</span> includeStackTrace)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    WebRequest webRequest = <span class="keyword">new</span> ServletWebRequest(request);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.errorAttributes.getErrorAttributes(webRequest, includeStackTrace);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>구현된 내용을 보면 <code>ErrorAttributes</code> 인터페이스의 <code>getErrorAttributes</code>를 호출하는 것을 알 수 있다.(위임자 패턴)<br>별도로 <code>ErrorAttributes</code>를 등록하지 않았다면 Spring Boot는 <code>DefaultErrorAttributes</code>를 사용한다.<br>아래는 <code>DefaultErrorAttributes</code>의 일부 내용이다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ErrorAttributes</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 요청을 기반으로 모델을 생성</span></span><br><span class="line"><span class="function">Map&lt;String, Object&gt; <span class="title">getErrorAttributes</span><span class="params">(WebRequest webRequest, <span class="keyword">boolean</span> includeStackTrace)</span></span>;</span><br><span class="line">  <span class="comment">// 요청에서 Throwable을 획득</span></span><br><span class="line"><span class="function">Throwable <span class="title">getError</span><span class="params">(WebRequest webRequest)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> DefaultErrorAttributes &#123;</span><br><span class="line">  <span class="comment">// 생성자 및 메서드</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title">getErrorAttributes</span><span class="params">(WebRequest request, <span class="keyword">boolean</span> includeStackTrace)</span> </span>&#123;</span><br><span class="line">    Map&lt;String, Object&gt; errorAttributes = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</span><br><span class="line">    errorAttributes.put(<span class="string">"timestamp"</span>, <span class="keyword">new</span> Date()); <span class="comment">// timestamp 생성</span></span><br><span class="line">    addStatus(errorAttributes, request); <span class="comment">// status 생성</span></span><br><span class="line">    addErrorDetails(errorAttributes, request, includeStackTrace); <span class="comment">// 오류 상세 내용</span></span><br><span class="line">    addPath(errorAttributes, request); <span class="comment">// path 생성</span></span><br><span class="line">    <span class="keyword">return</span> errorAttributes;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>ErrorAttributes에서 가져온 모델로 응답을 생성</strong></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"timestamp"</span>: <span class="string">"2019-02-15T21:48:44.447+0000"</span>,</span><br><span class="line">  <span class="attr">"status"</span>: <span class="number">404</span>,</span><br><span class="line">  <span class="attr">"error"</span>: <span class="string">"Not Found"</span>,</span><br><span class="line">  <span class="attr">"message"</span>: <span class="string">"No message available"</span>,</span><br><span class="line">  <span class="attr">"path"</span>: <span class="string">"/123"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="확장-포인트-ErrorAttributes"><a href="#확장-포인트-ErrorAttributes" class="headerlink" title="확장 포인트 - ErrorAttributes"></a>확장 포인트 - ErrorAttributes</h2><p>위에서 살펴봤듯이 <code>ErrorAttributes</code>에서는 오류가 발생했을 때 응답을 내려줄 모델을 생성하고 있다.<br>여기서 우리는 <code>ErrorAttributes</code> 인터페이스를 마음껏 구현할 수 있다. Spring에서 제공하는 확장 포인트인 것이다.<br>개발자가 <code>ErrorAttributes</code>를 구현하여 bean으로 등록하면 <code>BasicErrorController</code>는 해당 <code>ErrorAttributes</code>를 사용한다.<br>아래는 임의로 모델에 <code>&quot;greeting&quot;: &quot;Hello&quot;</code>를 추가한 예제이다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomErrorAttributes</span> <span class="keyword">extends</span> <span class="title">DefaultErrorAttributes</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title">getErrorAttributes</span><span class="params">(WebRequest webRequest, <span class="keyword">boolean</span> includeStackTrace)</span> </span>&#123;</span><br><span class="line">        Map&lt;String, Object&gt; result = <span class="keyword">super</span>.getErrorAttributes(webRequest, includeStackTrace);</span><br><span class="line">        result.put(<span class="string">"greeting"</span>, <span class="string">"Hello"</span>);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>응답 예제</strong></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"timestamp"</span>: <span class="string">"2019-02-15T22:24:41.275+0000"</span>,</span><br><span class="line">  <span class="attr">"status"</span>: <span class="number">404</span>,</span><br><span class="line">  <span class="attr">"error"</span>: <span class="string">"Not Found"</span>,</span><br><span class="line">  <span class="attr">"message"</span>: <span class="string">"No message available"</span>,</span><br><span class="line">  <span class="attr">"path"</span>: <span class="string">"/123"</span>,</span><br><span class="line">  <span class="attr">"greeting"</span>: <span class="string">"Hello"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="HTML-View-연계-404-html-4xx-html"><a href="#HTML-View-연계-404-html-4xx-html" class="headerlink" title="HTML View 연계 - 404.html, 4xx.html"></a>HTML View 연계 - 404.html, 4xx.html</h2><p>본 문서에서는 View Template Engine으로 <a href="https://mustache.github.io/" target="_blank" rel="noopener">Mustache</a>를 사용했다.<br>이 경우 Spring은 view를 <code>src/main/resources/templates</code> 하위 경로에서 찾는다.(View Template Engine 구현에 따라 다를 수 있다)<br>이 때 기본 경로 하위에 <code>/error/{응답코드}</code>로 view의 이름을 작성하는 경우<br><code>ErrorController</code>에서 응답 코드에 맞게 해당 view로 응답을 내려줄 수 있다.</p><blockquote><p>본 문서에서는 HTML view의 접미사(suffix)를 <code>.html</code>로 사용했다</p></blockquote><p><strong>src/main/resources<code>/templates/error/404.html</code> 작성</strong></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>404오류<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">timestamp: &#123;&#123;timestamp&#125;&#125;</span><br><span class="line">error: &#123;&#123;error&#125;&#125;</span><br><span class="line">message: &#123;&#123;message&#125;&#125;</span><br><span class="line">path: &#123;&#123;path&#125;&#125;</span><br><span class="line">greeting: &#123;&#123;greeting&#125;&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>위와 같이 응답코드로 view 이름을 작성한 경우 404 응답은 위 view로 응답이 처리된다.<br>더 넓게 <code>4xx.html</code>과 같은 명명으로 400번 대의 응답코드를 모두 처리할 수도 있다.</p><h2 id="View를-가져오는-방법-TemplateAvailabilityProvider"><a href="#View를-가져오는-방법-TemplateAvailabilityProvider" class="headerlink" title="View를 가져오는 방법 - TemplateAvailabilityProvider"></a>View를 가져오는 방법 - TemplateAvailabilityProvider</h2><p>Spring은 어떻게 위와 같은 방식으로 view를 가져왔을까.<br>이는 <code>TemplateAvailablityProvider</code>로 구현되어 있다.<br><code>TemplateAvailabilityProvider</code> 인터페이스의 <code>isTemplateAvailable()</code>을 호출하여 view를 resolve할 수 있는지 여부를 파악한다.<br>현재 프로젝트에 쓰인 Mustache에 대해서는 <code>MustacheTemplateAvailabilityProvider</code> 구현체가 동작한다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MustacheTemplateAvailabilityProvider</span> <span class="keyword">implements</span> <span class="title">TemplateAvailabilityProvider</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isTemplateAvailable</span><span class="params">(String view Environment environment,</span></span></span><br><span class="line"><span class="function"><span class="params">      ClassLoader classLoader, ResourceLoader resourceLoader)</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    </span><br><span class="line">    String prefix = environment.getProperty(<span class="string">"spring.mustache.prefix"</span>, DEFAULT_PREFIX); <span class="comment">// 1)</span></span><br><span class="line">    String suffix = environment.getProperty(<span class="string">"spring.mustache.suffix"</span>, DEFAULT_SUFFIX); <span class="comment">// 2)</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> resourceLoader.getResource(prefix + view + suffix).exists(); <span class="comment">// 3)</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li><code>spring.mustache.prefix</code>의 기본값 “classpath:/templates/“</li><li><code>spring.mustache.suffix</code>는 <code>.html</code>로 설정</li><li>view는 <code>error/{응답코드}</code>가 들어간다</li></ol><blockquote><p>view를 resolve하기 위해 <code>classpath:/templates/error/404.html</code>이 호출된다</p></blockquote><h2 id="확장-포인트-BasicErrorController"><a href="#확장-포인트-BasicErrorController" class="headerlink" title="확장 포인트 - BasicErrorController"></a>확장 포인트 - BasicErrorController</h2><p><code>ErrorAttributes</code>와 마찬가지로 <code>ErrorController</code>의 구현체를 개발자가 bean으로 등록한다면<br>Spring Boot는 해당 빈을 먼저 찾아 <code>BasicErrorController</code> 대신 오류 처리를 위해 사용하게 된다.<br>위임자 패턴을 사용해서 기본적인 처리는 <code>BasicErrorController</code>에게 위임하고, 나머지 필요한 처리를 추가할 수 있다.<br>아래 소스에서는 로그를 추가해보았다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"$&#123;server.error.path:$&#123;error.path:/error&#125;&#125;"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomErrorController</span> <span class="keyword">extends</span> <span class="title">BasicErrorController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CustomErrorController</span><span class="params">(ErrorAttributes errorAttributes,</span></span></span><br><span class="line"><span class="function"><span class="params">                                 ServerProperties serverProperties,</span></span></span><br><span class="line"><span class="function"><span class="params">                                 List&lt;ErrorViewResolver&gt; errorViewResolvers)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(errorAttributes, serverProperties.getError(), errorViewResolvers);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(produces = MediaType.TEXT_HTML_VALUE)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ModelAndView <span class="title">errorHtml</span><span class="params">(HttpServletRequest request,</span></span></span><br><span class="line"><span class="function"><span class="params">                                  HttpServletResponse response)</span> </span>&#123;</span><br><span class="line">        log(request); <span class="comment">// 로그 추가</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.errorHtml(request, response);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;Map&lt;String, Object&gt;&gt; error(HttpServletRequest request) &#123;</span><br><span class="line">        log(request);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.error(request);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">log</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">        log.error(<span class="string">"error"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="spring-webflux에서는"><a href="#spring-webflux에서는" class="headerlink" title="spring-webflux에서는?"></a>spring-webflux에서는?</h2><p>여태까지는 <code>spring-mvc</code> 모듈을 통해 지원되는 내용이었다.<br>SpringFramework 5에 추가된 <code>spring-webflux</code>에서도 <code>spring-mvc</code>와의 로직에 대한 대칭성을 유지하는 클래스들이 있다.</p><table><thead><tr><th>설명</th><th>spring-mvc</th><th>spring-webflux</th></tr></thead><tbody><tr><td>인터페이스</td><td>ErrorController</td><td>ErrorWebExceptionHandler extends WebExceptionHandler</td></tr><tr><td>편의를 위해 추상화된 클래스</td><td>AbstractErrorController</td><td>AbstractErrorWebExceptionHandler</td></tr><tr><td>기본 Bean으로 제공되는 클래스</td><td>BasicErrorController</td><td>DefaultErrorWebExceptionHandler</td></tr></tbody></table><p><code>spring-mvc</code>와 마찬가지로 <code>ErrorAttributes</code>를 확장해서 사용할 수 있다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultErrorWebExceptionHandler</span> <span class="keyword">extends</span> <span class="title">AbstractErrorWebExceptionHandler</span> </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> RouterFunction&lt;ServerResponse&gt; <span class="title">getRoutingFunction</span><span class="params">(ErrorAttributes errorAttributes)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> RouterFunctions.route(<span class="keyword">this</span>.acceptsTextHtml(), <span class="keyword">this</span>::renderErrorView)</span><br><span class="line">                          .andRoute(RequestPredicates.all(), <span class="keyword">this</span>::renderErrorResponse);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ErrorController에-대한-추가-설명"><a href="#ErrorController에-대한-추가-설명" class="headerlink" title="ErrorController에 대한 추가 설명"></a>ErrorController에 대한 추가 설명</h2><p><code>ErrorController</code>가 호출되기까지의 흐름을 설명하자면 다음과 같다.</p><ol><li>서블릿 컨테이너(ex: 톰캣)에서 등록된 서블릿에서 요청을 처리하다가</li><li>오류가 발생했는데</li><li>해당 서블릿에서 처리하지 못하고</li><li>서블릿 컨테이너까지 오류가 전파되었을 때, 서블릿 컨테이너가 오류를 처리하기 위해 특정 경로(<code>server.error.path</code>)로 해당 요청처리를 위임할 때 사용된다.</li></ol><img  src=http://www.plantuml.com/plantuml/svg/YmvEBIhBIIrHSCxFAqdCp4ijYbNGrRLJY8QAnofOAHZgARoPDUNDfhKARpRDUBriZKQ2Vaf-WYONGerkQG6I7cIph1ICWBfdB7czT8R2wmrptZJFrKY0AdEjI4ujACdCpqCo2fypZE46GPm1TPI6kdvgKL5-aRec0000><h1 id="spring-mvc-Exception-기반으로-오류-처리"><a href="#spring-mvc-Exception-기반으로-오류-처리" class="headerlink" title="spring-mvc Exception 기반으로 오류 처리"></a>spring-mvc Exception 기반으로 오류 처리</h1><p>앞의 추가 설명에서 봤듯이 <code>ErrorController</code>가 동작하는 것은 요청을 처리해야할 Servlet에서 오류가 발생했으나 해당 Servlet에서 오류를 처리하지 않아서 Servlet Container까지 오류가 전파되었을 때(<code>ServletException</code>으로 래핑된다), Servlet Container가 <code>ErrorController</code>를 호출한다. 이 때, 필자가 테스트한 Servlet Container(Tomcat 9.0.17)에서는 아래와 같은 로그를 남긴다</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2019-04-04 18:31:27.915 ERROR 21947 --- [nio-8080-exec-1] o.a.c.c.C.[.[.[&#x2F;].[dispatcherServlet]    : Servlet.service() for servlet [dispatcherServlet] in context with path [] threw exception [Request processing failed; nested exception is java.lang.IllegalStateException: test] with root cause</span><br></pre></td></tr></table></figure><p>해당 로그는 Servlet Container에서 남기고 있는 것으로, 개발자가 사용자화 하기 어려운 부분이다.<br>logging framework(log4j, logback) 등으로 해당 로그를 남기지 않거나 할 수는 있지만,<br>로그 내요을 변경하거나 하기는 어렵다는 것이다.</p><p>Spring에서는 Handler(Controller의 <code>@RequestMapping</code>이 걸린 메서드)에서 처리하다 Exception이 발생한 경우, 이를 Servlet Container까지 전파하지 않고, 직접 Exception 별로 처리를 할 수 있도록 해준다. Spring에서 Exception 기반으로 오류를 처리하는 방법을 알아보자.</p><h2 id="ExceptionHandler"><a href="#ExceptionHandler" class="headerlink" title="@ExceptionHandler"></a>@ExceptionHandler</h2><p>Spring에서는 발생한 Exception을 기반으로 오류를 처리할 수 있도록 <code>@ExceptionHandler</code>를 제공한다.</p><p><strong>예외를 던지도록 소스 추가</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/boards"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BoardController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@GetMapping</span>(<span class="string">"/&#123;id&#125;"</span>)</span><br><span class="line">  <span class="function"><span class="keyword">public</span> Board <span class="title">get</span><span class="params">(@PathVariable Long id)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (id &lt; <span class="number">1L</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> BoardNotFoundException(<span class="string">"invalid id: "</span> + id);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Board(<span class="string">"title"</span>, <span class="string">"content"</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@ResponseStatus</span>(HttpStatus.NOT_FOUND)</span><br><span class="line">  <span class="meta">@ExceptionHandler</span>(BoardNotFoundException<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">  <span class="title">public</span> <span class="title">Map</span>&lt;<span class="title">String</span>, <span class="title">String</span>&gt; <span class="title">handle</span>(<span class="title">BoardNotFoundException</span> <span class="title">e</span>) </span>&#123;</span><br><span class="line">      log.error(e.getMessage(), e);</span><br><span class="line">      Map&lt;String, String&gt; errorAttributes = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">      errorAttributes.put(<span class="string">"code"</span>, <span class="string">"BOARD_NOT_FOUND"</span>);</span><br><span class="line">      errorAttributes.put(<span class="string">"message"</span>, e.getMessage());</span><br><span class="line">      <span class="keyword">return</span> errorAttribute;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>위와 같이 특정 Controller에서 예외가 발생한 경우, Spring은 <code>@ExceptionHandler</code>를 검색하여<br>해당 애너테이션에 선언된 예외 및 하위 예외에 대해서 특정 메서드가 처리할 수 있도록 한다.<br>또한 보통의 핸들러와 마찬가지로 <code>@ResponseStatus</code>를 통해 응답 코드를 정의하거나,<br><code>ModelAndView</code>, <code>String</code>을 반환하여 view를 resolve할 수 있고, <code>ResponseEntity&lt;T&gt;</code>를 반환할 수도 있다.</p><p>이제 오류가 발생하도록 요청을 보내보자.</p><p><strong>실행</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">HTTP&#x2F;1.1 404</span><br><span class="line">Content-Type: application&#x2F;json;charset&#x3D;UTF-8</span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line">Date: Sun, 17 Feb 2019 04:31:33 GMT</span><br><span class="line"></span><br><span class="line">&#123;&quot;code&quot;:&quot;BOARD_NOT_FOUND&quot;,&quot;message&quot;:&quot;invalid id: 0&quot;&#125;</span><br></pre></td></tr></table></figure><h2 id="ControllerAdvice"><a href="#ControllerAdvice" class="headerlink" title="ControllerAdvice"></a>ControllerAdvice</h2><p>Spring에서는 Bean으로 등록되는 <code>@Controller</code>들을 선택적으로, 혹은 전역으로 몇가지 공통 설정을 적용할 수 있도록 <code>@ControllerAdvice</code>를 사용할 수 있다<br>이 <code>@ControllerAdvice</code>에서 사용할 수 있는 것 중 하나가 <code>@ExceptionHandler</code>다</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@ControllerAdvice</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GlobalControllerAdvice</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@ResponseStatus</span>(HttpStatus.NOT_FOUND)</span><br><span class="line">  <span class="meta">@ExceptionHandler</span>(BoardNotFoundException<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">  <span class="title">public</span> <span class="title">Object</span> <span class="title">handle</span>(<span class="title">BoardNotFoundException</span> <span class="title">e</span>, <span class="title">HttpServletRequest</span> <span class="title">request</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (JSON_응답해야하는지(request)) &#123;</span><br><span class="line">      <span class="keyword">return</span> makeJson(e);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">"/error/404"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ControllerAdvice-나누기"><a href="#ControllerAdvice-나누기" class="headerlink" title="ControllerAdvice 나누기"></a>ControllerAdvice 나누기</h2><p>앞의 예제에서는 하나의 method에서 JSON응답과 HTML응답을 해야하는 경우를 나누고 있었다.<br>HTML view를 사용할 경우와 json view를 사용할 경우를 나누어 <code>ControllerAdivce</code>를 등록하고,<br><code>@Order</code>를 사용하여 우선 순위를 부여하면 분기처리 없이 나누어 오류 처리를 할 수 있다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@Order</span>(ORDER)</span><br><span class="line"><span class="meta">@RestControllerAdvice</span>(annotations = RestController<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">GlobalRestControllerAdvice</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> ORDER = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ResponseStatus</span>(HttpStatus.NOT_FOUND)</span><br><span class="line">    <span class="meta">@ExceptionHandler</span>(BoardNotFoundException<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">    <span class="title">public</span> <span class="title">Map</span>&lt;<span class="title">String</span>, <span class="title">String</span>&gt; <span class="title">handle</span>(<span class="title">BoardNotFoundException</span> <span class="title">e</span>) </span>&#123;</span><br><span class="line">        log.error(e.getMessage(), e);</span><br><span class="line">        Map&lt;String, String&gt; errorAttributes = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        errorAttributes.put(<span class="string">"code"</span>, <span class="string">"BOARD_NOT_FOUND"</span>);</span><br><span class="line">        errorAttributes.put(<span class="string">"message"</span>, e.getMessage());</span><br><span class="line">        <span class="keyword">return</span> errorAttributes;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@Order</span>(GlobalRestControllerAdvice.ORDER + <span class="number">1</span>)</span><br><span class="line"><span class="meta">@ControllerAdvice</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GlobalHtmlControllerAdvice</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ResponseStatus</span>(HttpStatus.NOT_FOUND)</span><br><span class="line">    <span class="meta">@ExceptionHandler</span>(BoardNotFoundException<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">    <span class="title">public</span> <span class="title">String</span> <span class="title">handle</span>(<span class="title">BoardNotFoundException</span> <span class="title">e</span>, <span class="title">Model</span> <span class="title">model</span>, <span class="title">HttpServletRequest</span> <span class="title">request</span>) </span>&#123;</span><br><span class="line">        log.error(e.getMessage(), e);</span><br><span class="line">        model.addAttribute(<span class="string">"timestamp"</span>, LocalDateTime.now());</span><br><span class="line">        model.addAttribute(<span class="string">"error"</span>, <span class="string">"BOARD_NOT_FOUND"</span>);</span><br><span class="line">        model.addAttribute(<span class="string">"path"</span>, request.getRequestURI());</span><br><span class="line">        model.addAttribute(<span class="string">"message"</span>, e.getMessage());</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"/error/404"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Spring-MVC에서-제공해주는-ResponseEntityExceptionHandler"><a href="#Spring-MVC에서-제공해주는-ResponseEntityExceptionHandler" class="headerlink" title="Spring MVC에서 제공해주는 ResponseEntityExceptionHandler"></a>Spring MVC에서 제공해주는 ResponseEntityExceptionHandler</h2><p><code>ControllerAdvice</code>를 사용하여 Exception 처리를 한 곳으로 모으는 경우, <a href="https://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/web/servlet/mvc/method/annotation/ResponseEntityExceptionHandler.html" target="_blank" rel="noopener">ResponseEntityExceptionHandler</a>를 상속받도록 하여 Spring MVC에서 기본으로 제공되는 Exception들의 처리를 간단하게 등록할 수 있다. 각 Exception 처리를 위한 메서드들은 모두 <code>protected</code>로 선언되어 있으며, 하위 클래스에서 필요에 따라 Override할 수 있다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ResponseEntityExceptionHandler</span> </span>&#123;</span><br><span class="line">  <span class="meta">@ExceptionHandler</span>(&#123;</span><br><span class="line">    HttpRequestMethodNotSupportedException<span class="class">.<span class="keyword">class</span>,</span></span><br><span class="line"><span class="class">    <span class="title">HttpMediaTypeNotSupportedException</span>.<span class="title">class</span>,</span></span><br><span class="line"><span class="class">    <span class="title">HttpMediaTypeNotAcceptableException</span>.<span class="title">class</span>,</span></span><br><span class="line"><span class="class">    <span class="title">MissingPathVariableException</span>.<span class="title">class</span>,</span></span><br><span class="line"><span class="class">    <span class="title">MissingServletRequestParameterException</span>.<span class="title">class</span>,</span></span><br><span class="line"><span class="class">    <span class="title">ServletRequestBindingException</span>.<span class="title">class</span>,</span></span><br><span class="line"><span class="class">    <span class="title">ConversionNotSupportedException</span>.<span class="title">class</span>,</span></span><br><span class="line"><span class="class">    <span class="title">TypeMismatchException</span>.<span class="title">class</span>,</span></span><br><span class="line"><span class="class">    <span class="title">HttpMessageNotReadableException</span>.<span class="title">class</span>,</span></span><br><span class="line"><span class="class">    <span class="title">HttpMessageNotWritableException</span>.<span class="title">class</span>,</span></span><br><span class="line"><span class="class">    <span class="title">MethodArgumentNotValidException</span>.<span class="title">class</span>,</span></span><br><span class="line"><span class="class">    <span class="title">MissingServletRequestPartException</span>.<span class="title">class</span>,</span></span><br><span class="line"><span class="class">    <span class="title">BindException</span>.<span class="title">class</span>,</span></span><br><span class="line"><span class="class">    <span class="title">NoHandlerFoundException</span>.<span class="title">class</span>,</span></span><br><span class="line"><span class="class">    <span class="title">AsyncRequestTimeoutException</span>.<span class="title">class</span></span></span><br><span class="line"><span class="class">  &#125;)</span></span><br><span class="line"><span class="class">  @<span class="title">Nullable</span></span></span><br><span class="line"><span class="class">  <span class="title">public</span> <span class="title">final</span> <span class="title">ResponseEntity</span>&lt;<span class="title">Object</span>&gt; <span class="title">handleException</span>(<span class="title">Exception</span> <span class="title">ex</span>, <span class="title">WebRequest</span> <span class="title">request</span>) <span class="title">throws</span> <span class="title">Exception</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 각 예외에 대한 분기처리 로직(상속 구현 가능하도록 protected로 메서드가 선언되어 있음)</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 각 예외 처리를 위한 protected 메서드들이 있음</span></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> ResponseEntity&lt;Object&gt; <span class="title">handleHttpRequestMethodNotSupported</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">      HttpRequestMethodNotSupportedException ex, HttpHeaders headers, HttpStatus status, WebRequest request)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 예외 처리</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>각 Spring MVC Exception 설명</strong></p><table><thead><tr><th>Exception</th><th>설명</th><th>응답코드</th></tr></thead><tbody><tr><td>HttpRequestMethodNotSupportedException</td><td>요청 경로는 있으나 지원하지 않는 Method인 경우 발생</td><td>405 - Method Not Allowed</td></tr><tr><td>HttpMediaTypeNotSupportedException</td><td>요청의 Content Type을 핸들러가 지원하지 않는 경우 발생</td><td>415 - Unsupported Media Type</td></tr><tr><td>HttpMediaTypeNotAcceptableException</td><td>핸들러가 Client가 요청한 Type으로 응답을 내려줄 수 없는 경우 발생</td><td>406 - Not Acceptable</td></tr><tr><td>MissingPathVariableException</td><td>핸들러가 URL에서 기대한 Path Variable을 찾지 못한 경우 발생</td><td>500 - Internal Server Error</td></tr><tr><td>MissingServletRequestParameterException</td><td>핸들러가 기대한 요청 Parameter를 찾지 못한 경우 발생</td><td>400 - Bad Request</td></tr><tr><td>ServletRequestBindingException</td><td>복구 불가능한 치명적인 간주할 binding exception<br>Filter 등의 Servlet Resource에서 던지기 쉽도록 ServletException을 상속하고 있음</td><td>400 - Bad Request</td></tr><tr><td>ConversionNotSupportedException</td><td>bean property로 요청 내용을 변경하기 위한<br><code>editor</code> 혹은 <code>converter</code>를 찾지 못한 경우 발생</td><td>500 - Internal Server Error</td></tr><tr><td>TypeMismatchException</td><td>bean property로 값을 변경할 때, 핸들러가 예상한 class로 변경할 수 없는 경우 발생</td><td>400 - Bad Request</td></tr><tr><td>HttpMessageNotReadableException</td><td><code>HttpMessageConverter</code>에서 발생하며 <code>read</code> 메서드가 실패한 경우 발생</td><td>400 - Bad Request</td></tr><tr><td>HttpMessageNotWritableException</td><td><code>HttpMessageConverter</code>에서 발생하며 <code>write</code> 메서드가 실패한 경우 발생</td><td>500 - Internal Server Error</td></tr><tr><td>MethodArgumentNotValidException</td><td><code>@Valid</code>가 붙은 파라미터에 대해 검증 실패시 발생</td><td>400 - Bad Request</td></tr><tr><td>MissingServletRequestPartException</td><td><code>multipart/form-data</code> 요청의 일부가 손실(can’t be found)되었을 때 발생</td><td>400 - Bad Request</td></tr><tr><td>NoHandlerFoundException</td><td>Dispatcher Servlet에서 핸들러를 찾지 못한 경우 기본적으로 404 응답을 내리지만<br>Dispatcher Servlet의 <code>throwExceptionIfNoHandlerFound</code> 값이 true인 경우 해당 예외를 발생</td><td>404 - Not Found</td></tr><tr><td>AsyncRequestTimeoutException</td><td>비동기 요청의 응답시간이 초과될 때 발생</td><td>503 - Service Unavailable</td></tr></tbody></table><h2 id="HandlerExceptionResolver"><a href="#HandlerExceptionResolver" class="headerlink" title="HandlerExceptionResolver"></a>HandlerExceptionResolver</h2><p>애너테이션 기반으로 동작하는 <code>@ExceptionHandler</code> 외에도 <code>HandlerExceptionResolver</code> 인터페이스를 사용할 수 있다.<br>이 인터페이스는 요청, 응답, 핸들러, 예외를 받아 <code>ModelAndView</code>를 반환값으로 하는 <code>resolveException</code> 메서드를 가지고 있다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">HandlerExceptionResolver</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="function">ModelAndView <span class="title">resolveException</span><span class="params">(HttpServletRequest req, HttpServletResponse res, Object handler, Exception ex)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="HandlerExceptionResolver-구현체"><a href="#HandlerExceptionResolver-구현체" class="headerlink" title="HandlerExceptionResolver 구현체"></a>HandlerExceptionResolver 구현체</h3><ul><li>ExceptionHandlerExceptionResolver : <code>@ExceptionHandler</code>가 붙은 메서드를 통해 예외 처리를 할 수 있도록 설정하는 클래스</li><li>SimpleMappingExceptionResolver : 예외 이름과 view 이름을 매핑해주며, browser 요청을 view로 렌더링할 때 유용하게 쓸 수 있다</li><li>ResponseStatusExceptionResolver : Exception 클래스에 <code>@ResponseStatus</code>를 달아 해당 응답 코드로 응답을 보낼 수 있도록 설정하는 클래스</li><li>DefaultHandlerExceptionResolver : Spring MVC Exception에 대해 기본적인 처리를 해주는 클래스</li></ul><h4 id="Exception에-응답코드-달기"><a href="#Exception에-응답코드-달기" class="headerlink" title="Exception에 응답코드 달기"></a>Exception에 응답코드 달기</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ResponseStatus</span>(HttpStatus.NOT_FOUND)</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">NotFoundException</span> <span class="keyword">extends</span> <span class="title">RuntimeException</span> </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BoardNotFoundException</span> <span class="keyword">extends</span> <span class="title">NotFoundException</span> </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>위와 같이 Exception에 <code>@ResponseStatus</code>가 붙어 있고, 해당 Exception이 발생하면<br>Spring에서는 해당 Response Code로 응답을 준다.</p><blockquote><p>이 경우 서비스 로직에서 사용할 Exception이 HTTP라고 하는 MVC 구현에 종속된다.<br>MVC Layer와 Service Layer의 커플링을 발생시키지 않도록 유의해야 한다.</p></blockquote><h3 id="사용자-정의-HandlerExceptionResolver-구현"><a href="#사용자-정의-HandlerExceptionResolver-구현" class="headerlink" title="사용자 정의 HandlerExceptionResolver 구현"></a>사용자 정의 HandlerExceptionResolver 구현</h3><h1 id="번외"><a href="#번외" class="headerlink" title="번외"></a>번외</h1><h2 id="Filter와-Interceptor"><a href="#Filter와-Interceptor" class="headerlink" title="Filter와 Interceptor"></a>Filter와 Interceptor</h2><p>Filter와 Interceptor는 실행되는 위치가 다르다.<br>때문에 Exception이 발생했을 때 처리하는 방법도 달라진다.</p><p>Interceptor는 DispatcherServlet 내부에서 발생하기 때문에 <code>ControllerAdvice</code>를 적용할 수 있다.<br>하지만 Filter는 DispatcherServlet 외부에서 발생해서 <code>ErrorController</code>에서 처리해야 한다.</p><p><img src="/images/spring-filter-interceptor/spring-request-lifecycle.jpg" alt="image"><br>이미지 출처: <a href="https://justforchangesake.files.wordpress.com/2014/05/spring-request-lifecycle.jpg" target="_blank" rel="noopener">https://justforchangesake.files.wordpress.com/2014/05/spring-request-lifecycle.jpg</a></p><h1 id="정리"><a href="#정리" class="headerlink" title="정리"></a>정리</h1><p>Spring에서 예외처리를 하는 방법에 대해 훑어보았다.<br>Spring MVC 내에서는 <code>@HandlerException</code>을 통해 각 <code>@Controller</code>별로 예외 처리를 할 수 있었으며,<br><code>@HandlerException</code>을 <code>@ControllerAdvice</code>에 등록하여 전역적으로 예외를 처리할 수도 있었다.<br>또한 브라우저 요청과 REST API의 요청을 나누어서 <code>@ControllerAdvice</code>에서 처리할 수 있다.<br>이러한 기본 동작들은 <code>HandlerExceptionResolver</code>에 의해 이루어진다.</p><p>Spring MVC 내에서 처리하지 못한 예외들은 <code>ServletException</code>으로 포장되어 서블릿 컨테이너까지 전파되며, 서블릿 컨테이너는 예외를 처리하기 위해나 경로로 예외 처리를 위임하게 된다. 이때 Spring boot를 기본설정으로 사용하는 경우, <code>BasicErrorController</code>가 이를 담당하게 된다.</p><h1 id="마무리"><a href="#마무리" class="headerlink" title="마무리"></a>마무리</h1><p>예외 처리에 대해 잘 이해하고, 이를 잘 해내는 것은 견고한 어플리케이션을 작성하기 위한 밑거름이 된다고 생각한다.<br>경험있는 개발자들은 예외를 미리 예측하고 방지할 수 있다. 하지만 이러한 경험을 잘 쌓기 위해서는 그동안 발생하는 예외에 대해서 파악하기 쉬워야 한다.<br>예외 처리를 잘 해낸다면 같은 오류가 발생해도 더 빠르게 인지하고, 문제점을 정확하게 짚어낼 수 있을 것이다.<br>어플리케이션 개발이 운영 국면에 들어서면 기능만 잘 뽑아내는 것보다 예외 탐지, 트러블슈팅, 장애 방지를 잘하는 것이 얼마나 가치있는 것인지 깨닫게 되는 것 같다.</p><h1 id="참고"><a href="#참고" class="headerlink" title="참고"></a>참고</h1><p>Spring framework reference </p><ul><li>mvc exceptions : <a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/web.html#mvc-ann-exceptionhandler" target="_blank" rel="noopener">https://docs.spring.io/spring/docs/current/spring-framework-reference/web.html#mvc-ann-exceptionhandler</a></li><li>controller exceptions : <a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/web.html#mvc-ann-exceptionhandler" target="_blank" rel="noopener">https://docs.spring.io/spring/docs/current/spring-framework-reference/web.html#mvc-ann-exceptionhandler</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;서론&quot;&gt;&lt;a href=&quot;#서론&quot; class=&quot;headerlink&quot; title=&quot;서론&quot;&gt;&lt;/a&gt;서론&lt;/h1&gt;&lt;p&gt;오류 처리는 어플리케이션 개발에 있어 매우 큰 부분을 차지한다.&lt;br&gt;오류를 예측하는 것과 예방하는 것, 그리고 &lt;code&gt;오류를 빨리 발견하고 고칠 수 있는 것&lt;/code&gt;은 훌륭한 개발자의 필수조건이라고 생각한다.&lt;br&gt;본 문서에서는 Spring에서 어떻게 예외처리 잘 할 수 있도록 도와주는지를 알아보고 공유하려한다.&lt;/p&gt;
    
    </summary>
    
      <category term="spring" scheme="https://supawer0728.github.io/categories/spring/"/>
    
      <category term="boot" scheme="https://supawer0728.github.io/categories/spring/boot/"/>
    
    
      <category term="spring" scheme="https://supawer0728.github.io/tags/spring/"/>
    
      <category term="spring-boot" scheme="https://supawer0728.github.io/tags/spring-boot/"/>
    
      <category term="error" scheme="https://supawer0728.github.io/tags/error/"/>
    
      <category term="error-handling" scheme="https://supawer0728.github.io/tags/error-handling/"/>
    
  </entry>
  
  <entry>
    <title>(Spring Boot)Spring Boot Actuator 소개</title>
    <link href="https://supawer0728.github.io/2018/05/12/spring-actuator/"/>
    <id>https://supawer0728.github.io/2018/05/12/spring-actuator/</id>
    <published>2018-05-12T08:33:26.000Z</published>
    <updated>2020-03-04T08:18:02.747Z</updated>
    
    <content type="html"><![CDATA[<h1 id="서론"><a href="#서론" class="headerlink" title="서론"></a>서론</h1><p>웹 개발자로서 웹 애플리케이션을 만들 때 신경써야할 것은 서비스 로직 뿐만이 아니다. 웹 애플리케이션의 사용자는 누구인지(일반인? 외부시스템?), 어떤 경로로 애플리케이션에 요청을 할 지(Load Balancing, Fire Wall), 요청 수나 TPS 등 많은 것들을 고려해야한다. 이번에 소개할 <code>spring-boot-actuator</code>라는 모듈은 <strong>애플리케이션의 상태</strong>를 종합적으로 정리하여 우리에게 제공해준다. 본문에서는 <a href="https://github.com/spring-projects/spring-boot/tree/master/spring-boot-samples" target="_blank" rel="noopener">Spring Boot Samples</a>에 있는 프로젝트 중에서 <code>spring-boot-sample-actuator-ui</code>를 가져와 살짝 소스를 수정하여 actuator가 무엇이고 어떤 일 해주는지 알아보려한다.</p><a id="more"></a><h1 id="샘플-프로젝트로-Actuator-체험해보기"><a href="#샘플-프로젝트로-Actuator-체험해보기" class="headerlink" title="샘플 프로젝트로 Actuator 체험해보기"></a>샘플 프로젝트로 Actuator 체험해보기</h1><h2 id="소스-수정"><a href="#소스-수정" class="headerlink" title="소스 수정"></a>소스 수정</h2><p><a href="https://github.com/spring-projects/spring-boot/tree/master/spring-boot-samples/spring-boot-sample-actuator-ui" target="_blank" rel="noopener">spring-boot-sample-actuator-ui</a>에서 소스를 다운받아 <code>pom.xml</code> 파일의 <code>parent</code>를 수정하여 바로 실행해볼 수 있다. 여기서는 <code>sprint-boot-starter-security</code>도 제외시키겠다.</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- parent를 spring-boot-starter-parent로 수정 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- Your own application should inherit from spring-boot-starter-parent --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.2.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- spring-security 주석처리 --&gt;</span></span><br><span class="line"><span class="comment">&lt;!--&lt;dependency&gt;--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--&lt;artifactId&gt;spring-boot-starter-security&lt;/artifactId&gt;--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--&lt;/dependency&gt;--&gt;</span></span><br></pre></td></tr></table></figure><h2 id="applcation-properties"><a href="#applcation-properties" class="headerlink" title="applcation.properties"></a>applcation.properties</h2><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">spring.security.user.name</span>=<span class="string">user</span></span><br><span class="line"><span class="meta">spring.security.user.password</span>=<span class="string">password</span></span><br><span class="line"><span class="meta">management.health.diskspace.enabled</span>=<span class="string">false</span></span><br><span class="line"><span class="meta">management.endpoints.web.exposure.include</span>=<span class="string">*</span></span><br></pre></td></tr></table></figure><p>앞서 security 의존성을 없앴기 때문에 <code>spring-security</code>가 동작하지는 않는다.</p><h2 id="실행"><a href="#실행" class="headerlink" title="실행"></a>실행</h2><p>maven의 <code>spring-boot:run</code>이나 직접 <code>SampleActuatorUiApplication</code>의 <code>main()</code>을 호출하여 서버를 띄운 후 <code>GET /actuator</code>를 실행해보자. 아래와 같은 json 정보를 얻을 수 있다.(몇몇 부분은 생략했다) </p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   <span class="attr">"_links"</span>:&#123;</span><br><span class="line">      <span class="attr">"self"</span>:&#123;<span class="attr">"href"</span>:<span class="string">"http://localhost:8080/actuator"</span>&#125;,</span><br><span class="line">      <span class="attr">"auditevents"</span>:&#123;<span class="attr">"href"</span>:<span class="string">"http://localhost:8080/actuator/auditevents"</span>&#125;,</span><br><span class="line">      <span class="attr">"beans"</span>:&#123;<span class="attr">"href"</span>:<span class="string">"http://localhost:8080/actuator/beans"</span>&#125;,</span><br><span class="line">      <span class="attr">"health"</span>:&#123;<span class="attr">"href"</span>:<span class="string">"http://localhost:8080/actuator/health"</span>&#125;,</span><br><span class="line">      <span class="attr">"conditions"</span>:&#123;<span class="attr">"href"</span>:<span class="string">"http://localhost:8080/actuator/conditions"</span>&#125;,</span><br><span class="line">      <span class="attr">"configprops"</span>:&#123;<span class="attr">"href"</span>:<span class="string">"http://localhost:8080/actuator/configprops"</span>&#125;,</span><br><span class="line">      <span class="attr">"env"</span>:&#123;<span class="attr">"href"</span>:<span class="string">"http://localhost:8080/actuator/env"</span>&#125;,</span><br><span class="line">      <span class="attr">"env-toMatch"</span>:&#123;<span class="attr">"href"</span>:<span class="string">"http://localhost:8080/actuator/env/&#123;toMatch&#125;"</span>&#125;,</span><br><span class="line">      <span class="attr">"info"</span>:&#123;<span class="attr">"href"</span>:<span class="string">"http://localhost:8080/actuator/info"</span>&#125;,</span><br><span class="line">      <span class="attr">"loggers"</span>:&#123;<span class="attr">"href"</span>:<span class="string">"http://localhost:8080/actuator/loggers"</span>&#125;,</span><br><span class="line">      <span class="attr">"loggers-name"</span>:&#123;<span class="attr">"href"</span>:<span class="string">"http://localhost:8080/actuator/loggers/&#123;name&#125;"</span>&#125;,</span><br><span class="line">      <span class="attr">"heapdump"</span>:&#123;<span class="attr">"href"</span>:<span class="string">"http://localhost:8080/actuator/heapdump"</span>&#125;,</span><br><span class="line">      <span class="attr">"threaddump"</span>:&#123;<span class="attr">"href"</span>:<span class="string">"http://localhost:8080/actuator/threaddump"</span>&#125;,</span><br><span class="line">      <span class="attr">"metrics-requiredMetricName"</span>:&#123;<span class="attr">"href"</span>:<span class="string">"http://localhost:8080/actuator/metrics/&#123;requiredMetricName&#125;"</span>&#125;,</span><br><span class="line">      <span class="attr">"metrics"</span>:&#123;<span class="attr">"href"</span>:<span class="string">"http://localhost:8080/actuator/metrics"</span>&#125;,</span><br><span class="line">      <span class="attr">"scheduledtasks"</span>:&#123;<span class="attr">"href"</span>:<span class="string">"http://localhost:8080/actuator/scheduledtasks"</span>&#125;,</span><br><span class="line">      <span class="attr">"httptrace"</span>:&#123;<span class="attr">"href"</span>:<span class="string">"http://localhost:8080/actuator/httptrace"</span>&#125;,</span><br><span class="line">      <span class="attr">"mappings"</span>:&#123;<span class="attr">"href"</span>:<span class="string">"http://localhost:8080/actuator/mappings"</span>&#125;,</span><br><span class="line">      <span class="attr">"jolokia"</span>:&#123;<span class="attr">"href"</span>:<span class="string">"http://localhost:8080/actuator/jolokia"</span>&#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>위와 같은 내용의 애플리케이션의 상태를 확인할 수 있다. 예를 들어 <code>GET /actuator/health</code>를 실행해보자. 아래와 같이 현재 애플리케이션의 health 상태를 알 수 있다.</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">"status"</span>: <span class="string">"UP"</span>&#125;</span><br></pre></td></tr></table></figure><p>혹은 <code>GET /actuator/metrics/jvm.threads.live</code>를 요청해보자. 현재 JVM의 활성화된 Thread의 정보를 가져올 수 있다.</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;  </span><br><span class="line">   <span class="attr">"name"</span>:<span class="string">"jvm.threads.live"</span>,</span><br><span class="line">   <span class="attr">"measurements"</span>:[  </span><br><span class="line">      &#123;  </span><br><span class="line">         <span class="attr">"statistic"</span>:<span class="string">"VALUE"</span>,</span><br><span class="line">         <span class="attr">"value"</span>:<span class="number">23</span></span><br><span class="line">      &#125;</span><br><span class="line">   ],</span><br><span class="line">   <span class="attr">"availableTags"</span>: []</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>GET /actuator/heapdump</code>나 <code>GET /actuator/threaddump</code>를 요청하면 dump 파일을 받을 수도 있다.</p><p>이러한 애플리케이션의 상태 정보를 아무에게나 노출하면 안될 것 같다. 확인된 사용자에게만 actuator 정보를 노출하고자 할 때에는 간단하게 두 가지 방법을 고려할 수 있다.</p><ol><li><code>management.server.port</code>, <code>management.server.address</code> 값을 수정해서 해당 ip, address에 한해 ACL를 걺</li><li><code>spring-security</code>를 이용하여 <code>management.endpoints.web.base-path(기본값 /actuator)</code>에 대해 권한을 확인</li></ol><p>물론 두 방법을 동시에 사용할 수도 있다.</p><h1 id="그래서-Spring-Boot-Actuator란"><a href="#그래서-Spring-Boot-Actuator란" class="headerlink" title="그래서 Spring Boot Actuator란"></a>그래서 Spring Boot Actuator란</h1><p>간단히 말하자면 Spring Boot Application의 상태를 관리해준다.</p><ul><li>Spring Boot Application의 상태 정보(health, properties, beans, 구동된 AutoConfiguration 목록 등)를 다룰 수 있도록 자동 설정.</li><li>각종 추상화 클래스(HealthIndicator 등)을 제공하여, 상태 정보를 변경할 수 있도록 Service를 제공.</li></ul><h1 id="써먹을-만한-설정과-사용자화-가능한-것들"><a href="#써먹을-만한-설정과-사용자화-가능한-것들" class="headerlink" title="써먹을 만한 설정과 사용자화 가능한 것들"></a>써먹을 만한 설정과 사용자화 가능한 것들</h1><h2 id="노출할-항목-설정"><a href="#노출할-항목-설정" class="headerlink" title="노출할 항목 설정"></a>노출할 항목 설정</h2><p>앞서 본 샘플에서는 많은 정보들이 노출되고 있었다. <code>auditevents</code>, <code>beans</code>, <code>health</code>, <code>env</code> 등등, 필요해 보이는 것부터 T.M.I.까지 있다. <code>application.properties</code>에서 <code>management.endpoints.web.exposure.include</code>에 필요한 endpoint의 id를 설정할 수 있다. endpoint의 목록은 <a href="https://docs.spring.io/spring-boot/docs/2.0.2.RELEASE/reference/htmlsingle/#production-ready-endpoints" target="_blank" rel="noopener">레퍼런스 문서</a>를 참고하자.</p><p><strong>예제: health와 metrics 정보만 노출</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">management.endpoints.web.exposure.include&#x3D;health,metrics</span><br></pre></td></tr></table></figure><h2 id="Endpoint-경로-설정"><a href="#Endpoint-경로-설정" class="headerlink" title="Endpoint 경로 설정"></a>Endpoint 경로 설정</h2><p>앞에서 소개한 것과 같이 <code>management.endpoint.web.base-path(기본값 /actuator)</code>를 수정하여 base-path를 수정할 수 있다. 그 외에도 <code>management.endpoints.web.path-mapping.&lt;id&gt;</code>값을 수정하여, 특정 id의 endpoint의 경로를 수정할 수 있다.</p><p><strong>예제: health의 경로를 /monitor/healthcheck로 변경</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">management.endpoints.web.base-path&#x3D;&#x2F;monitor</span><br><span class="line">management.endpoints.web.path-mapping.health&#x3D;healthcheck</span><br></pre></td></tr></table></figure><h2 id="CORS"><a href="#CORS" class="headerlink" title="CORS"></a>CORS</h2><p><code>spring-boot-actuator</code>는 기본적으로 <strong>클라우드 환경에서 관리자가 각종 애플리케이션의 상태를 파악하기 쉽도록 설계되어 있다.</strong> 때문에 필요한 경우 외부 UI를 구성한 다른 도메인명을 가진 Web Application에서 각각의 서비스 애플리케이션의 상태를 파악하기 위해서 actuator 정보를 요청할 수도 있다. 이럴때 CORS를 설정하여 사용할 수 있다.</p><p><strong>예제: <a href="http://other-domain.com" target="_blank" rel="noopener">http://other-domain.com</a> 의 GET, POST요청을 허용</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">management.endpoints.web.cors.allowed-origins&#x3D;http:&#x2F;&#x2F;other-domain.com</span><br><span class="line">management.endpoints.web.cors.allowed-methods&#x3D;GET,POST</span><br></pre></td></tr></table></figure><h2 id="Health-Endpoint"><a href="#Health-Endpoint" class="headerlink" title="Health Endpoint"></a>Health Endpoint</h2><h3 id="Details"><a href="#Details" class="headerlink" title="Details"></a>Details</h3><p>Health Endpoint는 위 샘플에서 소개된 것 외에도 사실상 많은 정보들을 내보일 수 있다. 이전의 샘플 소스로 돌아가서 <code>pom.xml</code>과 <code>application.properties</code>를 아래와 같이 수정해보자.</p><p><strong>pom.xml: jpa와 h2 database 의존성 추가</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">  &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">  &lt;artifactId&gt;spring-boot-starter-data-jpa&lt;&#x2F;artifactId&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">  &lt;groupId&gt;com.h2database&lt;&#x2F;groupId&gt;</span><br><span class="line">  &lt;artifactId&gt;h2&lt;&#x2F;artifactId&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br></pre></td></tr></table></figure><p><strong>application.properties: 상세 정보를 노출하도록 변경</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">management.endpoint.health.show-details&#x3D;always</span><br></pre></td></tr></table></figure><p>다시 애플리케이션을 실행시킨 후 <code>GET /actuator/health</code> 요청을 보내보면 아래와 같이 응답이 온다.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;  </span><br><span class="line">   &quot;status&quot;:&quot;UP&quot;,</span><br><span class="line">   &quot;details&quot;:&#123;  </span><br><span class="line">      &quot;db&quot;:&#123;  </span><br><span class="line">         &quot;status&quot;:&quot;UP&quot;,</span><br><span class="line">         &quot;details&quot;:&#123;  </span><br><span class="line">            &quot;database&quot;:&quot;H2&quot;,</span><br><span class="line">            &quot;hello&quot;:1</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>애플리케이션에서 의존하고 있는 시스템의 Health check도 함께 파악할 수 있다. <code>DataSource</code> 외에도 <code>Disk</code>, <code>Cassandra</code>, <code>ElasticSearch</code>, <code>Redis</code> 등의 health check를 확인할 수 있다.</p><h3 id="사용자-정의-Health-Indicator"><a href="#사용자-정의-Health-Indicator" class="headerlink" title="사용자 정의 Health Indicator"></a>사용자 정의 Health Indicator</h3><p>Health Endpoint의 내용은 <code>HealthIndicator</code>를 구현하여 정의할 수 있다.</p><p><strong>HealthIndicator</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">HealthIndicator</span> </span>&#123;</span><br><span class="line">    <span class="function">Health <span class="title">health</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>아래는 간단하게 health indicator를 구현한 예제이다.</p><ul><li><code>PUT /actuator/health/up</code> : UP 상태로 변경</li><li><code>PUT /actuator/health/down</code> : DOWN 상태로 변경</li><li><code>PUT /actuator/health/maintenance</code> : 점검 상태로 변경</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"$&#123;management.endpoints.web.base-path:/actuator&#125;"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomHealthIndicator</span> <span class="keyword">implements</span> <span class="title">HealthIndicator</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AtomicReference&lt;Health&gt; health = <span class="keyword">new</span> AtomicReference&lt;&gt;(Health.up().build());</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Health <span class="title">health</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> health.get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PutMapping</span>(<span class="string">"$&#123;management.endpoints.web.path-mapping.health:health&#125;/up"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Health <span class="title">up</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Health up = Health.up().build();</span><br><span class="line">        <span class="keyword">this</span>.health.set(up);</span><br><span class="line">        <span class="keyword">return</span> up;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PutMapping</span>(<span class="string">"$&#123;management.endpoints.web.path-mapping.health:health&#125;/down"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Health <span class="title">down</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Health down = Health.down().build();</span><br><span class="line">        <span class="keyword">this</span>.health.set(down);</span><br><span class="line">        <span class="keyword">return</span> down;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PutMapping</span>(<span class="string">"$&#123;management.endpoints.web.path-mapping.health:health&#125;/maintenance"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Health <span class="title">maintenance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Health maintenance = Health.status(<span class="keyword">new</span> Status(<span class="string">"MAINTENANCE"</span>, <span class="string">"점검중"</span>)).build();</span><br><span class="line">        <span class="keyword">this</span>.health.set(maintenance);</span><br><span class="line">        <span class="keyword">return</span> maintenance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>각 URL에 맞춰서 <code>health</code>의 값을 변경한다. 기본적으로 <code>up</code>, <code>down</code>, <code>out-of-service</code>, <code>unkwon</code>의 상태값이 존재하지만 <code>maintenance</code>의 상태값은 없다. 사실 의미상 <code>out-of-service</code>와 동일하지만, 사용자화를 할 수 있다는 걸 보이기 위해서 새로 만들었다. 새로운 상태값을 만들어 actuator에서 인식하도록 만들려면 <code>application.properties</code>를 수정해야한다.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 심각도에 따른 순서</span><br><span class="line">management.health.status.order&#x3D;DOWN, MAINTENANCE, UNKOWN, UP</span><br><span class="line"></span><br><span class="line"># 각 상태별 Http 응답 코드</span><br><span class="line">management.health.status.http-mapping.DOWN&#x3D;503</span><br><span class="line">management.health.status.http-mapping.MAINTENANCE&#x3D;503</span><br><span class="line">management.health.status.http-mapping.UNKNOWN&#x3D;200</span><br><span class="line">management.health.status.http-mapping.UP&#x3D;200</span><br></pre></td></tr></table></figure><p>이제 애플리케이션을 실행하여 <code>PUT /actuator/health/maintenance</code>를 요청한 후 <code>GET /actuator/health</code>로 확인해보자 아래와 같이 나온다.</p><p><img src="/images/spring-actuator/maintenance.png" alt="점검중"></p><h4 id="HealthIndicator를-구현하며-management-endpoint-health-show-details-always가-설정된-경우"><a href="#HealthIndicator를-구현하며-management-endpoint-health-show-details-always가-설정된-경우" class="headerlink" title="HealthIndicator를 구현하며, management.endpoint.health.show-details=always가 설정된 경우"></a>HealthIndicator를 구현하며, <code>management.endpoint.health.show-details=always</code>가 설정된 경우</h4><p>사용자화한 항목을 하나의 상세로 표시해준다.</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;  </span><br><span class="line">   <span class="attr">"status"</span>:<span class="string">"UP"</span>,</span><br><span class="line">   <span class="attr">"details"</span>:&#123;  </span><br><span class="line">      <span class="attr">"custom"</span>:&#123;  </span><br><span class="line">         <span class="attr">"status"</span>:<span class="string">"UP"</span></span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Metrics"><a href="#Metrics" class="headerlink" title="Metrics"></a>Metrics</h2><p>간단히 말하자면 시계열 지표로 활용할 수 있는 정보를 관리한다. 아래는 그 일부이다.</p><ul><li>JVM 정보<ul><li>thread 수</li><li>GC 정보</li><li>heap 정보</li></ul></li><li>DBCP 정보</li><li>PROCESS 관련 정보</li><li>CPU<ul><li>USAGE</li><li>LOAD</li></ul></li><li>FILE<ul><li>최대 사용가능한 File Descriptor 수</li><li>현재 사용중인 File Descriptor 수</li></ul></li></ul><h3 id="사용자-정의-Metircs"><a href="#사용자-정의-Metircs" class="headerlink" title="사용자 정의 Metircs"></a>사용자 정의 Metircs</h3><p>Metrics의 정보도 사용자 정의할 수 있다. 예를 들어 현재 처리중인 동시 요청 수나 분당 요청 처리량 등을 표시할 수 있다. 방법은 간단하다. <code>MeterRegistry</code>를 주입받아 사용하면 된다.  아래는 처리중인 동시 요청 수에 대한 예제이다.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">public class ConcurrentTransactionCountInterceptor extends HandlerInterceptorAdapter &#123;</span><br><span class="line"></span><br><span class="line">    private final Counter counter;</span><br><span class="line"></span><br><span class="line">    public ConcurrentTransactionCountInterceptor(MeterRegistry meterRegistry) &#123;</span><br><span class="line">        this.counter &#x3D; meterRegistry.counter(&quot;transaction.current.count&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception &#123;</span><br><span class="line">        counter.increment();</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) throws Exception &#123;</span><br><span class="line">        counter.increment(-1d);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>GET /actuator/metrics/transaction.current.count</code>를 호출하면 아래와 같이 나온다.</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"name"</span>: <span class="string">"transaction.current.count"</span>,</span><br><span class="line">  <span class="attr">"measurements"</span>:[</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"statistic"</span>: <span class="string">"COUNT"</span>,</span><br><span class="line">      <span class="attr">"value"</span>: <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="마무리"><a href="#마무리" class="headerlink" title="마무리"></a>마무리</h1><p>Spring Boot Actuator에 대해서 간략하게 살펴보았다. actuator에서는 이외에도 많은 기능을 제공해주지만, 자주 사용할 것 같은 기능 위주로 살펴봤다.</p><p>actuator는 기본적으로 애플리케이션의 상태를 조회하고, 변경할 수 있도록 기능을 추상화하여 정의하고 있다. 추상화된 기능들에 대한 간단한 구현체들을 제공해주며, 개발자로 하여금 사용자 정의를 통해 더욱 상세한 설정을 할 수 있도록 가능성을 열어두었다. actuator로 인해 프로젝트 내에서 애플리케이션 관리를 통합해서 사용할 수 있으며, 이는 클라우드 환경에서 애플리케이션을 관리하는 데 매우 유용하게 사용할 수 있다. Load Balancing은 물론이거니와 필요시 Instance를 자동으로 배포, 제거하는 데에 유용한 정보들을 제공해줄 수 있다.</p><p>애플리케이션 개발팀과 인프라스트럭처 관리팀이 나누어진 경우, 인프라스트럭처 관리팀에서 정해둔 정책이 있다면 <code>spring-boot-starter</code>를 사용자 정의하여 <code>actuator</code>를 회사, 혹은 팀 단위에 맞춰서 미리 정의해서 사용해보자. 그렇게 되면 개발팀은 서비스 로직에만 신경쓸 수 있게 될 것이다.</p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;서론&quot;&gt;&lt;a href=&quot;#서론&quot; class=&quot;headerlink&quot; title=&quot;서론&quot;&gt;&lt;/a&gt;서론&lt;/h1&gt;&lt;p&gt;웹 개발자로서 웹 애플리케이션을 만들 때 신경써야할 것은 서비스 로직 뿐만이 아니다. 웹 애플리케이션의 사용자는 누구인지(일반인? 외부시스템?), 어떤 경로로 애플리케이션에 요청을 할 지(Load Balancing, Fire Wall), 요청 수나 TPS 등 많은 것들을 고려해야한다. 이번에 소개할 &lt;code&gt;spring-boot-actuator&lt;/code&gt;라는 모듈은 &lt;strong&gt;애플리케이션의 상태&lt;/strong&gt;를 종합적으로 정리하여 우리에게 제공해준다. 본문에서는 &lt;a href=&quot;https://github.com/spring-projects/spring-boot/tree/master/spring-boot-samples&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Spring Boot Samples&lt;/a&gt;에 있는 프로젝트 중에서 &lt;code&gt;spring-boot-sample-actuator-ui&lt;/code&gt;를 가져와 살짝 소스를 수정하여 actuator가 무엇이고 어떤 일 해주는지 알아보려한다.&lt;/p&gt;
    
    </summary>
    
      <category term="spring" scheme="https://supawer0728.github.io/categories/spring/"/>
    
      <category term="boot" scheme="https://supawer0728.github.io/categories/spring/boot/"/>
    
      <category term="actuator" scheme="https://supawer0728.github.io/categories/spring/boot/actuator/"/>
    
    
      <category term="spring" scheme="https://supawer0728.github.io/tags/spring/"/>
    
      <category term="spring-boot" scheme="https://supawer0728.github.io/tags/spring-boot/"/>
    
      <category term="spring-boot-actuator" scheme="https://supawer0728.github.io/tags/spring-boot-actuator/"/>
    
  </entry>
  
  <entry>
    <title>(Spring Boot) 다중 DataSource 사용하기 with Sharding</title>
    <link href="https://supawer0728.github.io/2018/05/06/spring-boot-multiple-datasource/"/>
    <id>https://supawer0728.github.io/2018/05/06/spring-boot-multiple-datasource/</id>
    <published>2018-05-06T14:34:38.000Z</published>
    <updated>2020-03-04T08:18:02.748Z</updated>
    
    <content type="html"><![CDATA[<h1 id="서론"><a href="#서론" class="headerlink" title="서론"></a>서론</h1><p>Spring Boot를 사용해서 Database Sharding을 처리할 수 있을까?<br>요즘 NoSQL에서는 Sharding과 관련해서 많은 편의를 제공한다. 알아서 Sharding을 제공해주고, 클러스터에 노드가 추가되면 Shard key를 기반으로 자동으로 새로운 노드로 값들을 분배해주거나, 노드를 제거하면 대상 노드에 있던 값들을 Shard Key에 맞추어 남은 노드로 분배해준다. 자세히 알아보지는 않았지만 RDBMS 측의 각종 벤더들도 이러한 아키텍처를 구현기위한 방법을 제공할 것이라 생각된다.(예를 들어 MySQL의 Fabric - 현재 MySQL Utilities에 통합)</p><p>이번 포스트에서는 RDBMS Sharding을 각 벤더에 의존해서 구현하지 않고, Spring Boot로 편리하게 설정을 추상화하여 사용할 방법에 대해 공유하려 한다. 앞서 Sharding에 대해서 거창하게 이야기를 했지만, 본문에서 다루고자 하는 영역은 아래의 두 가지 기능이다.</p><ul><li>이름 기반으로 다중 DataSource 정보를 등록 : AbstractRoutingDataSource</li><li>특정 값을 기반으로 대상 DataSource를 사용 : Spring AOP</li></ul><a id="more"></a><h1 id="이름-기반으로-다중-DataSource-정보-등록하기"><a href="#이름-기반으로-다중-DataSource-정보-등록하기" class="headerlink" title="이름 기반으로 다중 DataSource 정보 등록하기"></a>이름 기반으로 다중 DataSource 정보 등록하기</h1><h2 id="AbstractRoutingDataSource"><a href="#AbstractRoutingDataSource" class="headerlink" title="AbstractRoutingDataSource"></a>AbstractRoutingDataSource</h2><p>우선 <code>spring-jdbc</code> 모듈에 있는 <a href="https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/jdbc/datasource/lookup/AbstractRoutingDataSource.html" target="_blank" rel="noopener">AbstractRoutingDataSource</a>에 대해서 먼저 소개를 해야할 것 같다. 여러 DataSource를 등록하고, 특정 상황에 맞게 원하는 DataSource를 사용할 수 있도록 추상화한 클래스다. 이 클래스의 <code>public void setTargetDataSources(Map&lt;Object, Object&gt; targetDataSource)</code>를 호출하여 <code>String:DataSource</code>을 <code>키:값</code>으로하는 <code>Map</code>을 저장할 수 있다. 또한 <code>Object determineCurrentLooupKey()</code>를 오버라이드해서 상황에 맞게 Key를 반환하도록 구현할 수 있다.</p><p>예시로 MyBatis의 <a href="https://github.com/hatunet/spring-data-mybatis/blob/master/src/main/java/org/springframework/data/mybatis/replication/datasource/ReplicationRoutingDataSource.java" target="_blank" rel="noopener">ReplicationRoutingDataSource</a>를 살펴보자.</p><p>아래 소스는 <code>ReplicationRoutingDataSource</code>의 내용을 간략화한 것이다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReplicationRoutingDataSource</span> <span class="keyword">extends</span> <span class="title">AbstractRoutingDataSource</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 1</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">ReplicationRoutingDataSource</span><span class="params">(DataSource master, List&lt;DataSource&gt; slaves)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">super</span>.setDefaultTargetDataSource(master);</span><br><span class="line">    Map&lt;Object, Object&gt; targetDataSources =</span><br><span class="line">      IntStream.range(<span class="number">0</span>, slaves.size)</span><br><span class="line">               .boxed()</span><br><span class="line">               .collect(toMap(n -&gt; <span class="string">"slave_"</span> + n, n -&gt; slaves.get(n));</span><br><span class="line">    targetDataSources.put(<span class="string">"master"</span>, master);</span><br><span class="line">    <span class="keyword">super</span>.setTargetDataSources(targetDataSources);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 2</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> Object <span class="title">determineCurrentLookupKey</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> transactionActive = TransactionSynchronizationManager.isActualTransactionActive();</span><br><span class="line">    <span class="keyword">if</span> (transactionActive) &#123;</span><br><span class="line">      <span class="keyword">boolean</span> readOnly = TransactionSynchronizationManager.isCurrentTransactionReadOnly();</span><br><span class="line">      <span class="keyword">if</span> (readOnly) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"slave_"</span> + dataSourceSelectPolicy.select(slaves);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"master"</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>1: 생성자를 통해서 <code>master</code>로 사용할 <code>DataSource</code>와 <code>slave</code>로 사용할 <code>DataSource</code> 목록을 받고 있다.<br>2: 현재 트랜잭션이 활성화되어 있고, 읽기 전용이면 <code>slave</code> 중에 하나를 선택해서 반환하도록 되어 있다.</p><p>이를 응용해서 이름 기반으로 동작하는 <code>AbstractRoutingDataSource</code>를 구현할 수 있다.</p><h2 id="application-yml을-이용해서-구현해보기"><a href="#application-yml을-이용해서-구현해보기" class="headerlink" title="application.yml을 이용해서 구현해보기"></a>application.yml을 이용해서 구현해보기</h2><p>아래와 같은 구조로 RDBMS가 구성되어 있다고 가정해보자.</p><img  src=http://www.plantuml.com/plantuml/svg/IqaiIKnAB4vLo4qiBaajqiZ9JqxCoSWlBh4oDZOmqrIevb9GY4xEBqgD1J6ACnABKWmHJADOhbekhXIO6SKvYMMfg4QO8ncX0PRNH389GyG8Bb8B0000><p>이러한 구조를 아래와 같은 property를 등록하여 설정되도록 하려고 한다.</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">named-routing-data-source:</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">slave-suffix:</span> <span class="string">-slave</span></span><br><span class="line">  <span class="attr">default-data-source:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">data-sources:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">core</span></span><br><span class="line">      <span class="attr">hikari:</span></span><br><span class="line">        <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">        <span class="attr">password:</span> <span class="string">root</span></span><br><span class="line">        <span class="attr">jdbc-url:</span> <span class="string">jdbc:mysql://localhost:3306/core?useSSL=false</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">slave-of:</span> <span class="string">core</span> <span class="comment"># slave의 경우에는 `slave-of`로 등록한다</span></span><br><span class="line">      <span class="attr">hikari:</span></span><br><span class="line">        <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">        <span class="attr">password:</span> <span class="string">root</span></span><br><span class="line">        <span class="attr">jdbc-url:</span> <span class="string">jdbc:mysql://localhost:3307/core?useSSL=false</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">shard1</span></span><br><span class="line">      <span class="attr">hikari:</span></span><br><span class="line">        <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">        <span class="attr">password:</span> <span class="string">root</span></span><br><span class="line">        <span class="attr">jdbc-url:</span> <span class="string">jdbc:mysql://localhost:3306/shard1?useSSL=false</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">slave-of:</span> <span class="string">shard1</span></span><br><span class="line">      <span class="attr">hikari:</span></span><br><span class="line">        <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">        <span class="attr">password:</span> <span class="string">root</span></span><br><span class="line">        <span class="attr">jdbc-url:</span> <span class="string">jdbc:mysql://localhost:3307/shard1?useSSL=false</span> </span><br><span class="line">    <span class="bullet">-</span> <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">shard2</span></span><br><span class="line">      <span class="attr">hikari:</span></span><br><span class="line">        <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">        <span class="attr">password:</span> <span class="string">root</span></span><br><span class="line">        <span class="attr">jdbc-url:</span> <span class="string">jdbc:mysql://localhost:3306/shard2?useSSL=false</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">slave-of:</span> <span class="string">shard2</span></span><br><span class="line">      <span class="attr">hikari:</span></span><br><span class="line">        <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">        <span class="attr">password:</span> <span class="string">root</span></span><br><span class="line">        <span class="attr">jdbc-url:</span> <span class="string">jdbc:mysql://localhost:3307/shard2?useSSL=false</span></span><br></pre></td></tr></table></figure><p>위 properties는 java로 아래와 같이 나타낼 수 있다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 전역 설정</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ConfigurationProperties</span>(prefix = <span class="string">"named-routing-data-source"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NamedRoutingDataSourceGlobalProperties</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> Boolean enabled;</span><br><span class="line">  <span class="keyword">private</span> String slaveSuffix = <span class="string">"-slave"</span>;</span><br><span class="line">  <span class="keyword">private</span> String defaultDataSource = <span class="string">"default"</span>;</span><br><span class="line">  <span class="keyword">private</span> List&lt;NamedRoutingDataSourceTargetProperties&gt; dataSources;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// DataSource 항목 설정</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NamedRoutingDataSourceTargetProperties</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> String name;</span><br><span class="line">  <span class="keyword">private</span> String slaveOf;</span><br><span class="line">  <span class="keyword">private</span> HikariConfig hikari;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isSlave</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> !StringUtils.isEmpty(slaveOf);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">check</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> hasName = !StringUtils.isEmpty(name);</span><br><span class="line">    <span class="keyword">if</span> (hasName == isSlave) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"name 혹은 slaveOf 둘 중 하나만 있어야 합니다"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><code>NamedRoutingDataSourceTargetProperties</code>에서 <code>name</code>이나 <code>slaveOf</code> 둘 중 하나만 값이 있어야 한다.<ul><li><code>slaveOf</code>가 <code>a</code>인 경우 <code>name</code>은 <code>&quot;a&quot; + slaveSuffix</code>가 된다.</li></ul></li></ul><h2 id="NamedRoutingDataSource와-NamedDataSource"><a href="#NamedRoutingDataSource와-NamedDataSource" class="headerlink" title="NamedRoutingDataSource와 NamedDataSource"></a>NamedRoutingDataSource와 NamedDataSource</h2><p><code>NamedRoutingDataSource</code>는 <code>AbstractRoutingDataSource</code>를 구현하였다.  <code>NamedDataSource</code>는 <code>NamedRoutingDataSource</code>에서 들고 있을 대상이다. 먼저 <code>NamedDataSource</code>부터 살펴보자.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Value</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span>(access = AccessLevel.PRIVATE)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NamedDataSource</span> <span class="keyword">implements</span> <span class="title">DataSource</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> String name;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> String slaveOf;</span><br><span class="line">  <span class="meta">@Delegate</span>(types = DataSource<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">  <span class="title">private</span> <span class="title">final</span> <span class="title">DataSource</span> <span class="title">delegate</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> NamedDataSource <span class="title">slaveOf</span><span class="params">(String slaveOf, String slaveSuffix, DataSource delegate)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> NamedDataSource(slaveOf + slaveSuffix, slaveOf, delegate);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> NamedDataSource <span class="title">asMaster</span><span class="params">(String name, DataSource delegate)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> NamedDataSource(name, <span class="keyword">null</span>, delegate);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isSlave</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> !StringUtils.isEmpty(slaveOf);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>NamedDataSource</code>는 slave(<code>slaveOf()</code>)로, 혹은 master(<code>asMaster()</code>)로 생성된다. 그리고 <code>DataSource</code>를 구현하고 있는데, 구현에 필요한 메서드는 모두 <code>delegate</code>에 위임하였다.</p><p>다음은 이 <code>NamedDataSource</code>를 가지고 routing 처리를 할 <code>NamedRoutingDataSource</code>를 살펴보자.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NamedRoutingDataSource</span> <span class="keyword">extends</span> <span class="title">AbstractRoutingDataSource</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> String defaultDataSource;</span><br><span class="line">  <span class="comment">// 이름을 key로 하여 실제 대상을 메모리로 들고 있는다</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, NamedDataSource&gt; dataSourceMap;</span><br><span class="line">  <span class="comment">// master key에 대한 slave key를 들고 있는다.</span></span><br><span class="line">  <span class="comment">// 여러 slave를 등록할 수 있도록 구현하고 싶다면 Map&lt;String, List&lt;String&gt;&gt;으로 구현할 수 있다.</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, String&gt; masterSlaveMap;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">NamedRoutingDataSource</span><span class="params">(String defaultDataSource, List&lt;NamedDataSource&gt; dataSources)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.defaultDataSource = defaultDataSource;</span><br><span class="line">    <span class="keyword">this</span>.dataSourceMap = createDataSourceMap(dataSources);</span><br><span class="line">    <span class="keyword">this</span>.masterSlaveMap = dataSourceMap.values()</span><br><span class="line">                                       .stream()</span><br><span class="line">                                       .filter(NamedDataSource::isSlave)</span><br><span class="line">                                       .collect(toMap(NamedDataSource::getSlaveOf, NamedDataSource::getName));</span><br><span class="line">   </span><br><span class="line">    <span class="comment">// AbstractRoutingDataSource에 등록</span></span><br><span class="line">    <span class="keyword">super</span>.setTargetDataSources(dataSourceMap.entrySet().stream().collect(toMap(Entry::getKey, Entry::getValue)));</span><br><span class="line">    <span class="keyword">super</span>.setDefaultTargetDataSource(dataSourceMap.get(defaultDataSource));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> Map&lt;String, NamedDataSource&gt; <span class="title">createDataSourceMap</span><span class="params">(List&lt;NamedDataSource&gt; dataSources)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> dataSources.stream().collect(toMap(NamedDataSource::getName, Function.identity()));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// routing 로직</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> Object <span class="title">determineCurrentLookupKey</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    String dataSourceName = NamedRoutingDataSourceManager.getCurrentDataSourceName();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (dataSourceName == <span class="keyword">null</span>) &#123;</span><br><span class="line">      dataSourceName = defaultDataSource;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> transactionActive = TransactionSynchronizationManager.isActualTransactionActive();</span><br><span class="line">    <span class="keyword">if</span> (transactionActive) &#123;</span><br><span class="line">      <span class="keyword">boolean</span> readOnly = TransactionSynchronizationManager.isCurrentTransactionReadOnly();</span><br><span class="line">      <span class="keyword">if</span> (readOnly) &#123;</span><br><span class="line">        dataSourceName = masterSlaveMap.getOrDefault(dataSourceName, dataSourceName);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    log.debug(<span class="string">"dataSourceName: &#123;&#125;"</span>, dataSourceName);</span><br><span class="line">    <span class="keyword">return</span> dataSourceName;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> List&lt;NamedDataSource&gt; <span class="title">masters</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> dataSourceMap.values().stream().filter(dataSource -&gt; !dataSource.isSlave()).collect(Collectors.toList());</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>NamedRoutingDataSourceManager</code>에서 현재 사용할 DataSource의 이름을 가지고 올 수 있다(<code>getDataSourceName()</code>). <code>NamedRoutingDataSourceManager</code>의 구현은 아래와 같다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NamedRoutingDataSourceManager</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;String&gt; currentDataSourceName = <span class="keyword">new</span> NamedThreadLocal&lt;&gt;(<span class="string">"name of DataSource selected in this thread"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="title">NamedRoutingDataSourceManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">"this class can't be instance"</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getCurrentDataSourceName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> currentDataSourceName.get();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setCurrentDataSourceName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">    currentDataSourceName.set(name);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">removeCurrentDataSourceName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    currentDataSourceName.remove();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>ThreadLocal</code>로 현재 사용할 DataSource의 이름을 설정할 수 있다. 어디선가는 이 이름을 설정해줘야 <code>Sharding</code>이 제대로 동작할 것이다. 만약 이름이 없다면 <code>NamedRoutingDataSource</code>는 항상 <code>defaultDataSource</code>만 반환할 것이다.</p><h2 id="Spring-AOP를-활용해서-DataSource-이름-설정하기"><a href="#Spring-AOP를-활용해서-DataSource-이름-설정하기" class="headerlink" title="Spring AOP를 활용해서 DataSource 이름 설정하기"></a>Spring AOP를 활용해서 DataSource 이름 설정하기</h2><p>긴 설명보다는 아래 소스를 보고 어떻게 동작할 지 설명하는게 빠를 것 같다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BoardRepository</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 1</span></span><br><span class="line">  <span class="meta">@SetDataSourceName</span>(getterType = HashModularDataSourceNameGetter<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">  <span class="title">public</span> <span class="title">List</span>&lt;<span class="title">Board</span>&gt; <span class="title">findByWriterId</span>(<span class="title">String</span> <span class="title">id</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 2</span></span><br><span class="line">  <span class="meta">@SetDataSourceName</span>(spel = <span class="string">"#this[0].id"</span>, getterType = HashModularDataSourceNameGetter<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">  <span class="title">public</span> <span class="title">List</span>&lt;<span class="title">Board</span>&gt; <span class="title">findByWriter</span>(<span class="title">Writer</span> <span class="title">writer</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Target</span>(ElementType.METHOD)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> SetDataSourceName &#123;</span><br><span class="line"></span><br><span class="line">  <span class="function">String <span class="title">spel</span><span class="params">()</span> <span class="keyword">default</span> "#<span class="keyword">this</span>[0]"</span>;</span><br><span class="line">  Class&lt;? extends DataSourceNameGetter&gt; getterType();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">DataSourceNameGetter</span> </span>&#123;</span><br><span class="line">  <span class="function">String <span class="title">getDataSourceName</span><span class="params">(Object object)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HashModularDataSourceNameGetter</span> <span class="keyword">implements</span> <span class="title">DataSourceNameGetter</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> modValue;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">HashModularDataSourceNameGetter</span><span class="params">(NamedRoutingDataSource dataSource)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.modValue = dataSource.masters().size();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getDataSourceName</span><span class="params">(Object object)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"shard"</span> + (object.hashCode % modValue + <span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>1: <code>findByWriterId</code>의 <code>id</code>값의 <code>hashCode()</code> 결과에 modular 연산을 수행하여 대상 DataSource의 이름을 설정할 수 있다.<br>2: <a href="https://docs.spring.io/spring/docs/5.0.5.RELEASE/spring-framework-reference/core.html#expressions" target="_blank" rel="noopener">SpEL</a>를 적용하여 메서드의 특정 argument를 대상으로 DataSource의 이름을 설정할 수 있다.</p><p>이를 가능하게 하는 <code>SetDataSourceNameAspect</code> 클래스는 다음과 같이 정의할 수 있다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SetDataSourceNameAspect</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> ExpressionParser parser = <span class="keyword">new</span> SpelExpressionParser();</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> BeanFactory factory;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Pointcut</span>(<span class="string">"@annotation(setDataSourceName)"</span>)</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">hasAnnotation</span><span class="params">(SetDataSourceName setDataSourceName)</span> </span>&#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Around</span>(<span class="string">"hasAnnotation(setDataSourceName)"</span>)</span><br><span class="line">  <span class="function"><span class="keyword">public</span> Object <span class="title">around</span><span class="params">(ProceedingJoinPoint joinPoint, SetDataSourceName setDataSourceName)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line"></span><br><span class="line">    Object getterKey = parser.parseExpression(setDataSourceName.spel()).getValue(joinPoint.getArgs());</span><br><span class="line">    <span class="comment">// Spring Context에 등록되어 있는 Bean 중에서 Type을 기반으로 검색</span></span><br><span class="line">    DataSourceNameGetter getter = factory.getBean(setDataSourceName.getterType());</span><br><span class="line">    String dataSourceName = getter.getDataSourceName(getterKey);</span><br><span class="line">    <span class="comment">// NamedRoutingDataSourceManager에 사용할 DataSource의 이름 등록</span></span><br><span class="line">    NamedRoutingDataSourceManager.setCurrentDataSourceName(dataSourceName);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> joinPoint.proceed();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="comment">// ThreadLocal을 사용하므로 반드시 `remove()`를 실행할 것</span></span><br><span class="line">      NamedRoutingDataSourceManager.removeCurrentDataSourceName();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="결론"><a href="#결론" class="headerlink" title="결론"></a>결론</h1><p>여러 DataSource를 이름 기반으로 등록하고, Spring AOP를 통해서 사용할 DataSource의 이름을 정하도록 소스를 작성해보았다. <code>AbstractRoutingDataSource</code>와 Spring AOP의 원리를 이용해 간단하게 추상화해보고 구현까지 해보았다. 해당 소스에서는 복잡성을 증가시키지 않기 위해 <code>slave</code>는 하나라고 단정하고 진행하였는데, 필요하다면 <code>slave</code> 용도의 DataSource를 따로 <code>SlaveNamedRoutingDataSource</code>같은 클래스로 묶어서 단순한 round-robin 정도라면 간단히 load balancing까지 쉽게 할 수 있을 것이다.<br>한 가지 애매한 것이 DataSource의 이름은 무슨 기준으로 정하느냐 하는 것이다. String으로 되어 있어, 등록하는 부분(<code>NamedDataSource</code>)과 실제로 값을 가져오는 부분(<code>DataSourceNameGetter</code>)에서 문자열을 잘못 입력하여 런타임 오류가 발생하는 가능성도 있는데, 이 부분에 있어서 좋은 해결책이 딱히 떠오르지는 않았다. 만약 강한 제약을 넣고 싶다면 <code>NamedDataSource</code>가 아니라 <code>EnumedDataSource</code>를 사용하는 것도 하나의 옵션으로 고려할 수 있지 않을까 생각된다.</p><p>위에서 소개한 내용 중에 <code>application.yml</code>에 설정된 property를 기반으로 <code>NamedRoutingDataSource</code>를 생성하는 소스는 빠져있다. property와 java 소스가 대칭을 이루기에 굳이 구현 소스를 넣지는 않았다. 상세한 구현이 궁금하다면 github 소스를 참고하자.</p><p>Github 소스 : <a href="https://github.com/supawer0728/parfait-spring-boot-starter-sharding" target="_blank" rel="noopener">https://github.com/supawer0728/parfait-spring-boot-starter-sharding</a></p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;서론&quot;&gt;&lt;a href=&quot;#서론&quot; class=&quot;headerlink&quot; title=&quot;서론&quot;&gt;&lt;/a&gt;서론&lt;/h1&gt;&lt;p&gt;Spring Boot를 사용해서 Database Sharding을 처리할 수 있을까?&lt;br&gt;요즘 NoSQL에서는 Sharding과 관련해서 많은 편의를 제공한다. 알아서 Sharding을 제공해주고, 클러스터에 노드가 추가되면 Shard key를 기반으로 자동으로 새로운 노드로 값들을 분배해주거나, 노드를 제거하면 대상 노드에 있던 값들을 Shard Key에 맞추어 남은 노드로 분배해준다. 자세히 알아보지는 않았지만 RDBMS 측의 각종 벤더들도 이러한 아키텍처를 구현기위한 방법을 제공할 것이라 생각된다.(예를 들어 MySQL의 Fabric - 현재 MySQL Utilities에 통합)&lt;/p&gt;
&lt;p&gt;이번 포스트에서는 RDBMS Sharding을 각 벤더에 의존해서 구현하지 않고, Spring Boot로 편리하게 설정을 추상화하여 사용할 방법에 대해 공유하려 한다. 앞서 Sharding에 대해서 거창하게 이야기를 했지만, 본문에서 다루고자 하는 영역은 아래의 두 가지 기능이다.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;이름 기반으로 다중 DataSource 정보를 등록 : AbstractRoutingDataSource&lt;/li&gt;
&lt;li&gt;특정 값을 기반으로 대상 DataSource를 사용 : Spring AOP&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
      <category term="spring" scheme="https://supawer0728.github.io/categories/spring/"/>
    
      <category term="practice" scheme="https://supawer0728.github.io/categories/practice/"/>
    
      <category term="practice" scheme="https://supawer0728.github.io/categories/spring/practice/"/>
    
      <category term="spring-boot" scheme="https://supawer0728.github.io/categories/spring/spring-boot/"/>
    
    
      <category term="spring" scheme="https://supawer0728.github.io/tags/spring/"/>
    
      <category term="spring-boot" scheme="https://supawer0728.github.io/tags/spring-boot/"/>
    
      <category term="sharding" scheme="https://supawer0728.github.io/tags/sharding/"/>
    
  </entry>
  
  <entry>
    <title>Spring Cache 장애 대응 방안</title>
    <link href="https://supawer0728.github.io/2018/04/18/spring-cache-fallback/"/>
    <id>https://supawer0728.github.io/2018/04/18/spring-cache-fallback/</id>
    <published>2018-04-17T16:20:53.000Z</published>
    <updated>2020-03-04T08:18:02.749Z</updated>
    
    <content type="html"><![CDATA[<h1 id="서론"><a href="#서론" class="headerlink" title="서론"></a>서론</h1><p>Spring은 <a href="https://docs.spring.io/spring/docs/5.0.5.RELEASE/spring-framework-reference/integration.html#cache" target="_blank" rel="noopener">캐시 추상화</a>를 통해서 쉽게 캐시를 사용할 수 있게 해준다. <code>CacheManager</code>를 잘 구현한다면 <code>@Cacheable</code>, <code>@CachePut</code>, <code>@CacheEvict</code> 등을 통해서 얼마든지 커스터마이징된 캐시를 사용할 수 있다. 하지만 의외로 장애에 대응하는 방안에 대해서는 Reference 상에서도 구체적인 설명을 해주지 않고 있다. 덕분에 다시 글 쓸 거리가 생긴 것 같다.</p><p>사용하는 캐시 시스템에 문제가 생겼을 때 어떻게 대처해야하는지는 어떤 정보를 캐시하느냐에 따라 다르다. 경우의 수 자체가 너무 많다. 또한 캐시 자체가 여러 용도로 쓰일 수 있다. HTTP 응답을 캐시하든지, Repository의 결과를 캐시하든지 혹은 Service의 결과를 캐시할 수도 있다. 본문에서는 아래 두 경우로 간단하게 나누고 이에 대한 해결법을 궁리해보고자 한다.</p><ul><li>부하가 많이 걸린다면? 2차 캐시 구성을 고려하자.(Local Cache, Global Cache 구성)</li><li>Global Cache에서 장애가 발생할 경우를 대비, Hystrix를 고려하자</li></ul><a id="more"></a><h1 id="서비스-입장에서-본-구조"><a href="#서비스-입장에서-본-구조" class="headerlink" title="서비스 입장에서 본 구조"></a>서비스 입장에서 본 구조</h1><p>MVC의 Controller에서 로직을 실행하기 위해 Service를 호출할 때 캐시를 사용하려 한다.</p><img  src=http://www.plantuml.com/plantuml/svg/YovEBIhBJ4xLIqyjqT2CLT3LjLE8TavCpaYDLR1II0OnNY_Te_1wnPut2neKtixOyMRR72wO0jsYpFIC4f2EeDIKpE9We56fHR5SA3m5tPpKj1A4gGZD47q5-SMP9Vb5bN3htaoVeF1cmTJNcxUysj2Wy6PwsvivUrwlt0Ar6m00><h1 id="기본-예제"><a href="#기본-예제" class="headerlink" title="기본 예제"></a>기본 예제</h1><p>우선 Spring에서 캐시를 사용하는 기본 예제를 간단히 작성하자. 여기서는 Redis를 캐시로 사용한다.</p><h2 id="의존성-설정"><a href="#의존성-설정" class="headerlink" title="의존성 설정"></a>의존성 설정</h2><p><code>Spring Boot</code>는 <code>2.0.1.RELEASE</code>를 사용했다.</p><p>2.0.x부터 redis를 사용시 <code>lettuce</code> 라이브러리가 기본으로 설정된다. 하지만 예전부터 Spring을 사용하는 경우라면 jedis에 익숙한 개발자가 많을 것으로 예상된다. 어차피 본문에서는 라이브러리에 따라 크게 달라지는 설정이 없으므로 익숙한 jedis를 사용하려고 한다. </p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">dependencies</span> &#123;</span><br><span class="line">    <span class="keyword">compile</span>(<span class="string">'org.springframework.boot:spring-boot-starter-cache'</span>)</span><br><span class="line">    <span class="keyword">compile</span>(<span class="string">'org.springframework.boot:spring-boot-starter-data-redis'</span>) &#123;</span><br><span class="line">        <span class="keyword">exclude</span> <span class="keyword">group</span>: <span class="string">'io.lettuce'</span>, module: <span class="string">'lettuce-core'</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">compile</span>(<span class="string">'redis.clients:jedis'</span>)</span><br><span class="line">    <span class="keyword">compile</span>(<span class="string">'org.springframework.boot:spring-boot-starter-web'</span>)</span><br><span class="line">    compileOnly(<span class="string">'org.projectlombok:lombok'</span>)</span><br><span class="line">    testCompile(<span class="string">'org.springframework.boot:spring-boot-starter-test'</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="도메인"><a href="#도메인" class="headerlink" title="도메인"></a>도메인</h2><p><strong>Person</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> age;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 테스트 정보를 넣기 위한 생성자</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Person</span><span class="params">(@NonNull String name, <span class="keyword">int</span> age)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 캐시에 저장된 json string을 인스턴스로 만들기 위한 생성자</span></span><br><span class="line">    <span class="meta">@JsonCreator</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Person</span><span class="params">(@JsonProperty(<span class="string">"id"</span>)</span> Long id,</span></span><br><span class="line"><span class="function">                  @<span class="title">JsonProperty</span><span class="params">(<span class="string">"name"</span>)</span> String name,</span></span><br><span class="line"><span class="function">                  @<span class="title">JsonProperty</span><span class="params">(<span class="string">"age"</span>)</span> <span class="keyword">int</span> age) </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>PersonRepository</strong></p><p>본문에서는 Repository의 내용이 중요하진 않으므로 Method Signature만 적고 넘어가려고 한다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PersonRepository</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Person <span class="title">save</span><span class="params">(Person person)</span> </span>&#123; ... &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Person <span class="title">findOne</span><span class="params">(Long id)</span> </span>&#123; ... &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="응용-계층"><a href="#응용-계층" class="headerlink" title="응용 계층"></a>응용 계층</h2><p><strong>PersonService</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PersonService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PersonRepository personRepository;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PersonService</span><span class="params">(@NonNull PersonRepository personRepository)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.personRepository = personRepository;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 메서드 항상 실행, 결과값에 id가 null이 아닌 경우 캐싱</span></span><br><span class="line">    <span class="meta">@CachePut</span>(cacheNames = <span class="string">"person"</span>, key = <span class="string">"#person.id"</span>, unless = <span class="string">"#result.id != null"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Person <span class="title">save</span><span class="params">(Person person)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">"save() called"</span>);</span><br><span class="line">        <span class="keyword">return</span> personRepository.save(person);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 캐시에 값이 없는 경우에는 로그를 남기고 repository 실행</span></span><br><span class="line">    <span class="meta">@Cacheable</span>(cacheNames = <span class="string">"person"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Person <span class="title">get</span><span class="params">(@NonNull Long id)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">"get(Long) called"</span>);</span><br><span class="line">        <span class="keyword">return</span> personRepository.findOne(id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Controller"><a href="#Controller" class="headerlink" title="Controller"></a>Controller</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/people"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PersonController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PersonService personService;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PersonController</span><span class="params">(@NonNull PersonService personService)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.personService = personService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/&#123;id&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Person <span class="title">get</span><span class="params">(@PathVariable Long id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> personService.get(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Person <span class="title">save</span><span class="params">(@RequestBody Person person)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> personService.save(person);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="캐시-설정"><a href="#캐시-설정" class="headerlink" title="캐시 설정"></a>캐시 설정</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableCaching</span>(proxyTargetClass = <span class="keyword">true</span>)</span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CacheConfig</span> <span class="keyword">extends</span> <span class="title">CachingConfigurerSupport</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;redis.host:localhost&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String redisHost;</span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;redis.port:6379&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> Integer redisPort;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JedisConnectionFactory <span class="title">jedisConnectionFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 현 버전에서 factory.setHostName() 등의 api는 Deprecated되었다.</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> JedisConnectionFactory(<span class="keyword">new</span> RedisStandaloneConfiguration(redisHost, redisPort));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CacheManager <span class="title">cacheManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        RedisCacheManager.RedisCacheManagerBuilder builder = RedisCacheManager.RedisCacheManagerBuilder.fromConnectionFactory(jedisConnectionFactory());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 값은 json 문자열로 넣는다. @class 필드로 클래스 정보가 들어간다.</span></span><br><span class="line">        RedisCacheConfiguration defaultConfig =</span><br><span class="line">                RedisCacheConfiguration.defaultCacheConfig()</span><br><span class="line">                                       .serializeValuesWith(RedisSerializationContext.SerializationPair.fromSerializer(<span class="keyword">new</span> GenericJackson2JsonRedisSerializer()))</span><br><span class="line">                                       .entryTtl(Duration.ofSeconds(<span class="number">20L</span>));</span><br><span class="line"></span><br><span class="line">        builder.cacheDefaults(defaultConfig);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> builder.build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="기본-데이터-인입"><a href="#기본-데이터-인입" class="headerlink" title="기본 데이터 인입"></a>기본 데이터 인입</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleCacheApplication</span> <span class="keyword">implements</span> <span class="title">CommandLineRunner</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> PersonRepository personRepository;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(String... args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        personRepository.save(<span class="keyword">new</span> Person(<span class="string">"John"</span>, <span class="number">12</span>));</span><br><span class="line">        personRepository.save(<span class="keyword">new</span> Person(<span class="string">"Michel"</span>, <span class="number">16</span>));</span><br><span class="line">        personRepository.save(<span class="keyword">new</span> Person(<span class="string">"Chris"</span>, <span class="number">52</span>));</span><br><span class="line">        personRepository.save(<span class="keyword">new</span> Person(<span class="string">"Michael"</span>, <span class="number">25</span>));</span><br><span class="line">        personRepository.save(<span class="keyword">new</span> Person(<span class="string">"Susan"</span>, <span class="number">34</span>));</span><br><span class="line">        personRepository.save(<span class="keyword">new</span> Person(<span class="string">"Kim"</span>, <span class="number">44</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="테스트"><a href="#테스트" class="headerlink" title="테스트"></a>테스트</h2><p><strong>/people/1</strong>를 호출하면 <code>get(Long) called</code>가 로그에 한 번 남고, 이후에는 20초 동안 남지 않는다. 그리고 <code>redis-cli</code>로 키를 직접 조회해보면 아래와 같이 정보가 잘 인입되었음을 확인할 수 있다.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; get person::1</span><br><span class="line">&quot;&#123;\&quot;@class\&quot;:\&quot;com.parfait.study.simplecache.person.domain.Person\&quot;,\&quot;id\&quot;:1,\&quot;name\&quot;:\&quot;John\&quot;,\&quot;age\&quot;:12&#125;&quot;</span><br></pre></td></tr></table></figure><blockquote><p>소스코드 : <a href="https://github.com/supawer0728/simple-cache/tree/simple-cache" target="_blank" rel="noopener">https://github.com/supawer0728/simple-cache/tree/simple-cache</a></p></blockquote><h1 id="2차-캐시-구성"><a href="#2차-캐시-구성" class="headerlink" title="2차 캐시 구성"></a>2차 캐시 구성</h1><p>캐시에 많은 부하가 몰릴 수 있는 시스템의 경우 캐시를 수직적으로 나누어 1차, 2차 캐시를 사용하는 것이 좋을 때가 있다. 서비스 입장에서 구성을 나타내면 아래와 같다.</p><img  src=http://www.plantuml.com/plantuml/svg/YovEBIhBJ4xLIqyjqT2CLT3LjLE8zibFJinnJapEI8rLi5B8I4qiU3EtHU5DqvetirQ-dJhZTTSKXHoG4eLaa1g5jpDslDasXmj56yYOr0mmHyC3Q81cB1SQNm7D9ZJz85dtdFma98SWsVbc-WI5LniclPcxHU7Dz3QGwrvFxL4eIitDBqb5SnMA8Rf5cUaP9I2pWr9JCek3WPvFBG9QZSnJqCr9JIj1jn_T88WP1Vd5cINvHPKWvo7RZijzCFLGrm40><p>이러한 구성을 할 때 주의할 점이 있다. local cache와 global cache의 정보가 맞지 않는 기간이 발생할 수 있다는 것이다. 당연한 이야기지만 local cache의 만료 시간이 길면 길수록 그 기간은 길어진다. 때문에 일관된 데이터가 필요한 만큼 local cache의 만료 시간을 짧게 가져가야한다.</p><p>아쉽게도 이러한 n차 캐시 구성은 Spring에서 지원해주지 않는다. <code>CompositeCacheManager</code>라는 클래스가 있는데, 이 클래스는 등록된 여러 CacheManager 중에서 캐시명으로 Cache를 조회해서 하나만 내어준다.</p><p><strong>CompositeCacheManager</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Cache <span class="title">getCache</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (CacheManager cacheManager : <span class="keyword">this</span>.cacheManagers) &#123;</span><br><span class="line">    Cache cache = cacheManager.getCache(name);</span><br><span class="line">    <span class="keyword">if</span> (cache != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> cache;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>우리가 필요한 것은 CacheManager의 목록을 연결(Chained) 구성하는 것이다. 다행히 핵심 로직은 이미 라이브러리들이 구현해두었다. 우리는 CacheManager와 Cache만 연결 구현하면 된다. </p><h2 id="예제"><a href="#예제" class="headerlink" title="예제"></a>예제</h2><h3 id="ChainedCacheManager"><a href="#ChainedCacheManager" class="headerlink" title="ChainedCacheManager"></a>ChainedCacheManager</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ChainedCacheManager</span> <span class="keyword">implements</span> <span class="title">CacheManager</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;CacheManager&gt; cacheManagers;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Cache&gt; cacheMap = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 반드시 하나 이상의 CacheManager를 등록</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ChainedCacheManager</span><span class="params">(@NonNull CacheManager... cacheManagers)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (cacheManagers.length &lt; <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.cacheManagers = Collections.unmodifiableList(Arrays.asList(cacheManagers));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 특정 캐시명으로 조회시 map에 없으면 ChainedCache를 생성</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Cache <span class="title">getCache</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> cacheMap.computeIfAbsent(name, key -&gt; <span class="keyword">new</span> ChainedCache(getCaches(key)));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> List&lt;Cache&gt; <span class="title">getCaches</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> cacheManagers.stream().map(manager -&gt; manager.getCache(name)).collect(Collectors.toList());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Collection&lt;String&gt; <span class="title">getCacheNames</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> cacheManagers.stream()</span><br><span class="line">                            .flatMap(manager -&gt; manager.getCacheNames().stream())</span><br><span class="line">                            .collect(Collectors.toSet());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>실제 로직을 담고 있는 <code>cacheManagers</code>를 두고 위임자 패턴으로 구현하였다. <code>getCache(String)</code> 호출이 있으면, <code>cacheManagers</code>의 순서로 해당 <code>CacheManager</code>의 <code>Cache</code>를 불러와 <code>ChainedCache</code>를 새로 생성한다.</p><h3 id="ChainedCache"><a href="#ChainedCache" class="headerlink" title="ChainedCache"></a>ChainedCache</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ChainedCache</span> <span class="keyword">implements</span> <span class="title">Cache</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 실제 로직을 위임할 캐시들(local, global)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;Cache&gt; caches;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> first = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> size;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ChainedCache</span><span class="params">(List&lt;Cache&gt; caches)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.caches = Collections.unmodifiableList(caches);</span><br><span class="line">        <span class="keyword">this</span>.size = caches.size();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ValueWrapper <span class="title">get</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 순서대로 캐시에서 값을 불러온다</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = first; i &lt; size; i++) &#123;</span><br><span class="line">            ValueWrapper valueWrapper = caches.get(i).get(key);</span><br><span class="line">            <span class="keyword">if</span> (valueWrapper != <span class="keyword">null</span> &amp;&amp; valueWrapper.get() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// 첫번째 캐시에 값이 있으면 그대로 반환</span></span><br><span class="line">                <span class="keyword">if</span> (i == first) &#123;</span><br><span class="line">                    <span class="keyword">return</span> valueWrapper;</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 첫번째 이후의 캐시에 값이 있으면 이전 index의 캐시에 각각 저장</span></span><br><span class="line">                putIntoPreviousIndexedCaches(i, key, valueWrapper.get());</span><br><span class="line">                <span class="keyword">return</span> valueWrapper;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">putIntoPreviousIndexedCaches</span><span class="params">(<span class="keyword">int</span> index, Object key, Object value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = index - <span class="number">1</span>; i &gt;= first; i--) &#123;</span><br><span class="line">            singleCachePut(caches.get(i), key, value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>CacheManager</code>에서 실제 구현을 담고 있는 <code>Cache</code>를 저장한다. 우리가 구현할 내용은 순서를 지정해주고 순서에 따라 값을 넣는 것이다. 실제 동작은 <code>caches</code>에 위임하자.</p><h3 id="CacheConfig"><a href="#CacheConfig" class="headerlink" title="CacheConfig"></a>CacheConfig</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableCaching</span>(proxyTargetClass = <span class="keyword">true</span>)</span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CacheConfig</span> <span class="keyword">extends</span> <span class="title">CachingConfigurerSupport</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;redis.host:localhost&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String redisHost;</span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;redis.port:6379&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> Integer redisPort;</span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;spring.cache.jcache.provider&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String jCacheProvider;</span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;spring.cache.jcache.config&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> Resource jCacheConfig;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JedisConnectionFactory <span class="title">jedisConnectionFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> JedisConnectionFactory(<span class="keyword">new</span> RedisStandaloneConfiguration(redisHost, redisPort));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CacheManager <span class="title">redisCacheManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        RedisCacheManager.RedisCacheManagerBuilder builder = RedisCacheManager.RedisCacheManagerBuilder.fromConnectionFactory(jedisConnectionFactory());</span><br><span class="line"></span><br><span class="line">        RedisCacheConfiguration defaultConfig =</span><br><span class="line">                RedisCacheConfiguration.defaultCacheConfig()</span><br><span class="line">                                       .serializeValuesWith(RedisSerializationContext.SerializationPair.fromSerializer(<span class="keyword">new</span> GenericJackson2JsonRedisSerializer()))</span><br><span class="line">                                       .entryTtl(Duration.ofSeconds(<span class="number">20L</span>));</span><br><span class="line"></span><br><span class="line">        builder.cacheDefaults(defaultConfig);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> LoggingCacheManager(builder.build(), <span class="string">"Global-Cache"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CacheManager <span class="title">jCacheCacheManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        CachingProvider provider = Caching.getCachingProvider(jCacheProvider);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> LoggingCacheManager(<span class="keyword">new</span> JCacheCacheManager(provider.getCacheManager(jCacheConfig.getURI(), provider.getDefaultClassLoader())), <span class="string">"Local-Cache"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"can't create URI with spring.cache.jcache.config"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@Primary</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CacheManager <span class="title">cacheManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ChainedCacheManager(jCacheCacheManager(), redisCacheManager());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>RedisCacheManager</code>와 <code>JCacheCacheManager(ehCache)</code>를 각각 원격, 로컬 캐시로 잡았다. <code>LoggingCacheManager</code>는 필자가 로그를 남기기 위해 작성한 것이다.</p><h2 id="테스트-1"><a href="#테스트-1" class="headerlink" title="테스트"></a>테스트</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"># 최초 호출시 service의 get(Long)까지 부른다</span><br><span class="line">03:24:17  INFO LoggingCache     : Local-Cache.getName() called</span><br><span class="line">03:24:17  INFO LoggingCache     : Local-Cache.get(Object) called</span><br><span class="line">03:24:17  INFO LoggingCache     : Global-Cache.get(Object) called</span><br><span class="line">03:24:17  INFO PersonService    : get(Long) called</span><br><span class="line">03:24:17  INFO LoggingCache     : Local-Cache.put(Object, Object) called</span><br><span class="line">03:24:17  INFO LoggingCache     : Global-Cache.put(Object, Object) called</span><br><span class="line"></span><br><span class="line"># 이후 10초 동안 local-cache의 값 호출</span><br><span class="line">03:24:19  INFO LoggingCache     : Local-Cache.getName() called</span><br><span class="line">03:24:19  INFO LoggingCache     : Local-Cache.get(Object) called</span><br><span class="line">03:24:23  INFO LoggingCache     : Local-Cache.getName() called</span><br><span class="line">03:24:23  INFO LoggingCache     : Local-Cache.get(Object) called</span><br><span class="line">03:24:26  INFO LoggingCache     : Local-Cache.getName() called</span><br><span class="line">03:24:26  INFO LoggingCache     : Local-Cache.get(Object) called</span><br><span class="line"></span><br><span class="line"># 10초가 지나면 local-cache가 만료됨. global-cache까지 호출</span><br><span class="line">03:24:29  INFO LoggingCache     : Local-Cache.getName() called</span><br><span class="line">03:24:29  INFO LoggingCache     : Local-Cache.get(Object) called</span><br><span class="line">03:24:29  INFO LoggingCache     : Global-Cache.get(Object) called</span><br><span class="line">03:24:29  INFO LoggingCache     : Local-Cache.put(Object, Object) called</span><br><span class="line"></span><br><span class="line"># 이후 10초간 local-cache만 호출</span><br><span class="line">03:24:34  INFO LoggingCache     : Local-Cache.getName() called</span><br><span class="line">03:24:34  INFO LoggingCache     : Local-Cache.get(Object) called</span><br><span class="line">03:24:38  INFO LoggingCache     : Local-Cache.getName() called</span><br><span class="line">03:24:38  INFO LoggingCache     : Local-Cache.get(Object) called</span><br><span class="line"></span><br><span class="line"># 10초 뒤 모든 캐시 만료되고 다시 service 호출</span><br><span class="line">03:24:43  INFO LoggingCache     : Local-Cache.getName() called</span><br><span class="line">03:24:43  INFO LoggingCache     : Local-Cache.get(Object) called</span><br><span class="line">03:24:43  INFO LoggingCache     : Global-Cache.get(Object) called</span><br><span class="line">03:24:43  INFO PersonService    : get(Long) called</span><br><span class="line">03:24:43  INFO LoggingCache     : Local-Cache.put(Object, Object) called</span><br><span class="line">03:24:43  INFO LoggingCache     : Global-Cache.put(Object, Object) called</span><br></pre></td></tr></table></figure><p>원하는 대로 정상적으로 동작하고 있다.</p><blockquote><p>소스코드 : <a href="https://github.com/supawer0728/simple-cache/tree/double-cache" target="_blank" rel="noopener">https://github.com/supawer0728/simple-cache/tree/double-cache</a></p></blockquote><h1 id="Hystrix-구성"><a href="#Hystrix-구성" class="headerlink" title="Hystrix 구성"></a>Hystrix 구성</h1><p>전역 캐시가 부하를 받아 Timeout이 발생하거나 특정 이유로 접근이 되지 않는 등의 장애가 발생한 경우, 일전에 공유했던 Hystrix를 고려해볼 수 있다. <strong>전역 캐시에 장애를 감지한 시점부터는 요청을 보내면 안된다.</strong> 물론 이 방법 또한 만병 통치약인 것은 아니다. 아래의 경우를 생각해보자.</p><ul><li>단순 네트워크 단절 : 다행이다. 1차 캐시와 repository로 2차 캐시를 복구할 때까지 운용할 수 있다.</li><li>트래픽 부하로 인한 장애 : 전역 캐시에 장애를 일으켰던 트래픽을 고스란히 1차 캐시와 repository로 견뎌내어야 한다. 2차 캐시를 복구하기 위한 잠깐의 시간 벌기는 가능할 것이다.</li></ul><p>위와 같은 한계가 있음을 숙지하고, 이제 Hystirx를 어떻게 구성할 수 있을지 예제로 작성하려한다.</p><img  src=http://www.plantuml.com/plantuml/svg/YovEBIhBJ4xLIqyjqT2CLT3LjLE8zibFJinnJapEI8rLi5B8I4qiU3EtHU5DqvetirQ-dJhZTTSKXHoG4eLaa1g5jpDslDasXmj56yYOr0mmHyC3Q81cB1SQNm7D9ZJz85dtdFma98SWsVbc-WI5LniclPcxHU7Dz3QGwrvFxL4eIitDBqb5SnMA8Ref-ULvM8mEIat9B0u61aLgaSARUKlVJ5tmUk4SXJTpTxoTEaSXERCekJIpH26_83LF4Tr0a651gGNvnPab-KML8BEGNO7BdJ3rK5S20000><h2 id="HystirxCacheManager"><a href="#HystirxCacheManager" class="headerlink" title="HystirxCacheManager"></a>HystirxCacheManager</h2><p>사실상 Spring에서 캐시 추상화(<code>CacheManager</code>, <code>Cache</code>)를 제공하니 우리는 앞에서 한 작업의 반복을 할 뿐이다. 실제 구현체를 <code>delegate</code>로 잡아두고 위임자 패턴을 사용하여 구현하자.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HystrixCacheManager</span> <span class="keyword">implements</span> <span class="title">CacheManager</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> CacheManager delegate;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Cache&gt; cacheMap = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">HystrixCacheManager</span><span class="params">(@NonNull CacheManager delegate)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.delegate = delegate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Cache <span class="title">getCache</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> cacheMap.computeIfAbsent(name, key -&gt; <span class="keyword">new</span> HystrixCache(delegate.getCache(key)));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Collection&lt;String&gt; <span class="title">getCacheNames</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> delegate.getCacheNames();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="HystrixCache"><a href="#HystrixCache" class="headerlink" title="HystrixCache"></a>HystrixCache</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HystrixCache</span> <span class="keyword">implements</span> <span class="title">Cache</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Cache delegate;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">HystrixCache</span><span class="params">(Cache delegate)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.delegate = delegate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ValueWrapper <span class="title">get</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> HystrixCacheGetCommand(delegate, key).execute();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(Object key, Object value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> HystrixCachePutCommand(delegate, key, value).execute();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">evict</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> HystrixCacheEvictCommand(delegate, key).execute();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>아쉽게도 <code>spring-netflix-starter-hystrix</code>에서 지원해주는 애노테이션들을 이용한 설정은 어렵다. 애노테이션을 사용해서 Hystirx설정을 하기 위해서는 설정할 인스턴스가 <code>ApplicationContext</code>에 Bean으로 등록되어야 한다. 때문에 여기서는 Spring의 도움 없이 직접 Hystrix API를 사용하였다. <code>execute()</code>는 HystrixCommand를 동기로 실행한다.</p><h2 id="HystrixCacheGetCommand"><a href="#HystrixCacheGetCommand" class="headerlink" title="HystrixCacheGetCommand"></a>HystrixCacheGetCommand</h2><p>앞에서 get, push, evict에 대해서 모두 <code>HystirxCacheXXXCommand</code>로 작성하였으나 본문에서는 <code>HystrixCacheGetCommand</code>만 살펴보려고 한다. 나머지든 대동소이하다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HystrixCacheGetCommand</span> <span class="keyword">extends</span> <span class="title">HystrixCommand</span>&lt;<span class="title">ValueWrapper</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Cache delegate;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object key;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">HystrixCacheGetCommand</span><span class="params">(Cache delegate, Object key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(Setter.withGroupKey(HystrixCommandGroupKey.Factory.asKey(<span class="string">"testGroupKey"</span>))</span><br><span class="line">                    .andCommandKey(HystrixCommandKey.Factory.asKey(<span class="string">"cache-get"</span>))</span><br><span class="line">                    .andCommandPropertiesDefaults(</span><br><span class="line">                            HystrixCommandProperties.defaultSetter()</span><br><span class="line">                                                    .withExecutionTimeoutInMilliseconds(<span class="number">500</span>)</span><br><span class="line">                                                    .withCircuitBreakerErrorThresholdPercentage(<span class="number">50</span>)</span><br><span class="line">                                                    .withCircuitBreakerRequestVolumeThreshold(<span class="number">5</span>)</span><br><span class="line">                                                    .withMetricsRollingStatisticalWindowInMilliseconds(<span class="number">20000</span>)));</span><br><span class="line">        <span class="keyword">this</span>.delegate = delegate;</span><br><span class="line">        <span class="keyword">this</span>.key = key;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> ValueWrapper <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> delegate.get(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> ValueWrapper <span class="title">getFallback</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.warn(<span class="string">"get fallback called, circuit is &#123;&#125;"</span>, <span class="keyword">super</span>.circuitBreaker.isOpen() ? <span class="string">"opened"</span> : <span class="string">"closed"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>20초간 API의 성공/실패 여부를 측정하며, 5번 이상 실행되고 50% 이상 실패했을 경우 회로가 열린다. Timeout은 500ms로 설정했다. <code>execute()</code>를 실행하면 <code>run()</code>이 실행되며, 실패한 경우 <code>getFallback()</code>이 실행된다.</p><h2 id="CacheConfig-1"><a href="#CacheConfig-1" class="headerlink" title="CacheConfig"></a>CacheConfig</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableCaching</span>(proxyTargetClass = <span class="keyword">true</span>)</span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CacheConfig</span> <span class="keyword">extends</span> <span class="title">CachingConfigurerSupport</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CacheManager <span class="title">redisCacheManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        RedisCacheManager.RedisCacheManagerBuilder builder = RedisCacheManager.RedisCacheManagerBuilder.fromConnectionFactory(jedisConnectionFactory());</span><br><span class="line"></span><br><span class="line">        RedisCacheConfiguration defaultConfig =</span><br><span class="line">                RedisCacheConfiguration.defaultCacheConfig()</span><br><span class="line">                                       .serializeValuesWith(RedisSerializationContext.SerializationPair.fromSerializer(<span class="keyword">new</span> GenericJackson2JsonRedisSerializer()))</span><br><span class="line">                                       .entryTtl(Duration.ofSeconds(<span class="number">20L</span>));</span><br><span class="line"></span><br><span class="line">        builder.cacheDefaults(defaultConfig);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> HystrixCacheManager(<span class="keyword">new</span> LoggingCacheManager(builder.build(), <span class="string">"Global-Cache"</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>앞서 만들었던 부분을 그대로 생성자로 주입하자.</p><h2 id="테스트-2"><a href="#테스트-2" class="headerlink" title="테스트"></a>테스트</h2><p>서버를 실행 후 Redis 서버를 Down 시킨 후 <code>/people/1</code>을 호출해보았다.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">2018-04-18 22:55:09.653  INFO LoggingCache           : Local-Cache.get(Object) called</span><br><span class="line">2018-04-18 22:55:09.653  INFO LoggingCache           : Global-Cache.get(Object) called</span><br><span class="line">2018-04-18 22:55:09.661  WARN HystrixCacheGetCommand : get fallback called, circuit is closed</span><br><span class="line">2018-04-18 22:55:09.662  INFO PersonService          : get(Long) called</span><br><span class="line">2018-04-18 22:55:09.662  INFO LoggingCache           : Local-Cache.put(Object, Object) called</span><br><span class="line">2018-04-18 22:55:09.663  INFO LoggingCache           : Global-Cache.put(Object, Object) called</span><br><span class="line">2018-04-18 22:55:10.164  WARN HystrixCachePutCommand : put fallback called, circuit is closed</span><br><span class="line">2018-04-18 22:55:14.085  INFO LoggingCache           : Local-Cache.get(Object) called</span><br><span class="line">2018-04-18 22:55:14.086  INFO LoggingCache           : Global-Cache.get(Object) called</span><br><span class="line">2018-04-18 22:55:14.588  WARN HystrixCacheGetCommand : get fallback called, circuit is closed</span><br><span class="line">2018-04-18 22:55:14.588  INFO PersonService          : get(Long) called</span><br><span class="line">2018-04-18 22:55:14.588  INFO LoggingCache           : Local-Cache.put(Object, Object) called</span><br><span class="line">2018-04-18 22:55:14.588  INFO LoggingCache           : Global-Cache.put(Object, Object) called</span><br><span class="line">2018-04-18 22:55:15.090  WARN HystrixCachePutCommand : put fallback called, circuit is closed</span><br><span class="line">2018-04-18 22:55:16.104  INFO LoggingCache           : Local-Cache.get(Object) called</span><br><span class="line">2018-04-18 22:55:16.105  INFO LoggingCache           : Global-Cache.get(Object) called</span><br><span class="line">2018-04-18 22:55:16.606  WARN HystrixCacheGetCommand : get fallback called, circuit is closed</span><br><span class="line">2018-04-18 22:55:16.606  INFO PersonService          : get(Long) called</span><br><span class="line">2018-04-18 22:55:16.606  INFO LoggingCache           : Local-Cache.put(Object, Object) called</span><br><span class="line">2018-04-18 22:55:16.607  INFO LoggingCache           : Global-Cache.put(Object, Object) called</span><br><span class="line">2018-04-18 22:55:17.108  WARN HystrixCachePutCommand : put fallback called, circuit is closed</span><br><span class="line">2018-04-18 22:55:17.973  INFO LoggingCache           : Local-Cache.get(Object) called</span><br><span class="line">2018-04-18 22:55:17.974  INFO LoggingCache           : Global-Cache.get(Object) called</span><br><span class="line">2018-04-18 22:55:18.474  WARN HystrixCacheGetCommand : get fallback called, circuit is closed</span><br><span class="line">2018-04-18 22:55:18.474  INFO PersonService          : get(Long) called</span><br><span class="line">2018-04-18 22:55:18.474  INFO LoggingCache           : Local-Cache.put(Object, Object) called</span><br><span class="line">2018-04-18 22:55:18.475  INFO LoggingCache           : Global-Cache.put(Object, Object) called</span><br><span class="line">2018-04-18 22:55:18.977  WARN HystrixCachePutCommand : put fallback called, circuit is closed</span><br><span class="line">2018-04-18 22:55:19.112  INFO LoggingCache           : Local-Cache.get(Object) called</span><br><span class="line">2018-04-18 22:55:19.112  INFO LoggingCache           : Global-Cache.get(Object) called</span><br><span class="line">2018-04-18 22:55:19.613  WARN HystrixCacheGetCommand : get fallback called, circuit is closed</span><br><span class="line">2018-04-18 22:55:19.613  INFO PersonService          : get(Long) called</span><br><span class="line">2018-04-18 22:55:19.613  INFO LoggingCache           : Local-Cache.put(Object, Object) called</span><br><span class="line">2018-04-18 22:55:19.614  INFO LoggingCache           : Global-Cache.put(Object, Object) called</span><br><span class="line">2018-04-18 22:55:20.114  WARN HystrixCachePutCommand : put fallback called, circuit is closed</span><br><span class="line">2018-04-18 22:55:20.241  INFO LoggingCache           : Local-Cache.get(Object) called</span><br><span class="line">2018-04-18 22:55:20.241  INFO LoggingCache           : Global-Cache.get(Object) called</span><br><span class="line">2018-04-18 22:55:20.742  WARN HystrixCacheGetCommand : get fallback called, circuit is closed</span><br><span class="line">2018-04-18 22:55:20.742  INFO PersonService          : get(Long) called</span><br><span class="line">2018-04-18 22:55:20.743  INFO LoggingCache           : Local-Cache.put(Object, Object) called</span><br><span class="line"></span><br><span class="line"># 일정 횟수 fallback이 호출된 후 회로 열림!</span><br><span class="line">2018-04-18 22:55:20.743  WARN HystrixCachePutCommand : put fallback called, circuit is opened</span><br><span class="line">2018-04-18 22:55:21.312  INFO LoggingCache           : Local-Cache.get(Object) called</span><br><span class="line">2018-04-18 22:55:21.312  WARN HystrixCacheGetCommand : get fallback called, circuit is opened</span><br><span class="line">2018-04-18 22:55:21.312  INFO PersonService          : get(Long) called</span><br><span class="line">2018-04-18 22:55:21.312  INFO LoggingCache           : Local-Cache.put(Object, Object) called</span><br><span class="line">2018-04-18 22:55:21.312  WARN HystrixCachePutCommand : put fallback called, circuit is opened</span><br><span class="line">2018-04-18 22:55:22.250  INFO LoggingCache           : Local-Cache.get(Object) called</span><br><span class="line">2018-04-18 22:55:22.250  WARN HystrixCacheGetCommand : get fallback called, circuit is opened</span><br></pre></td></tr></table></figure><blockquote><p>소스코드 : <a href="https://github.com/supawer0728/simple-cache/tree/hystrix-cache" target="_blank" rel="noopener">https://github.com/supawer0728/simple-cache/tree/hystrix-cache</a></p></blockquote><h1 id="마무리"><a href="#마무리" class="headerlink" title="마무리"></a>마무리</h1><p>Spring의 캐시 추상화를 사용하며, 부하 분산을 통해 장애에 대응할 수 있는 방안에 대해 다뤄보았다.</p><p>우선 n차 캐시 구성을 통해서 Heap을 사용하여 외부 시스템의 호출을 줄여서 전역 리소스(전역 캐시, repository)의 부하를 줄였다. n차 캐시 구성을 사용하는 경우, 리소스 간의 일관성이 무너질 수 있다. 일관성이 중요할수록 로컬 캐시의 수명을 짧게해서 사용해야 한다. </p><p>원격 캐시의 경우 파티션(장애)이 발생할 수 있다. 이에 대응하기 위해 Hystrix를 활용할 수 있다. 회로를 열어 원격에 요청을 보내지 않고, 빠른 실패처리를 할 수 있다. 하지만 여기서도 유의해야할 점이 있는데. 트래픽이 몰리는 상황에서 부하를 견디지 못해 장애가 발생한 경우, 이를 1차 캐시와 repository가 받아내게 된다. 본문에서는 fallback에서 null을 던져 repository를 실행시켰다. 원격 캐시에서 장애가 발생했을 때, 사용자 정의 Exception을 던져 캐시 오류인 경우의 응답을 따로 내려줘서 repository를 지켜내는 것도 방법이 될 수 있을 것 같다.</p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;서론&quot;&gt;&lt;a href=&quot;#서론&quot; class=&quot;headerlink&quot; title=&quot;서론&quot;&gt;&lt;/a&gt;서론&lt;/h1&gt;&lt;p&gt;Spring은 &lt;a href=&quot;https://docs.spring.io/spring/docs/5.0.5.RELEASE/spring-framework-reference/integration.html#cache&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;캐시 추상화&lt;/a&gt;를 통해서 쉽게 캐시를 사용할 수 있게 해준다. &lt;code&gt;CacheManager&lt;/code&gt;를 잘 구현한다면 &lt;code&gt;@Cacheable&lt;/code&gt;, &lt;code&gt;@CachePut&lt;/code&gt;, &lt;code&gt;@CacheEvict&lt;/code&gt; 등을 통해서 얼마든지 커스터마이징된 캐시를 사용할 수 있다. 하지만 의외로 장애에 대응하는 방안에 대해서는 Reference 상에서도 구체적인 설명을 해주지 않고 있다. 덕분에 다시 글 쓸 거리가 생긴 것 같다.&lt;/p&gt;
&lt;p&gt;사용하는 캐시 시스템에 문제가 생겼을 때 어떻게 대처해야하는지는 어떤 정보를 캐시하느냐에 따라 다르다. 경우의 수 자체가 너무 많다. 또한 캐시 자체가 여러 용도로 쓰일 수 있다. HTTP 응답을 캐시하든지, Repository의 결과를 캐시하든지 혹은 Service의 결과를 캐시할 수도 있다. 본문에서는 아래 두 경우로 간단하게 나누고 이에 대한 해결법을 궁리해보고자 한다.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;부하가 많이 걸린다면? 2차 캐시 구성을 고려하자.(Local Cache, Global Cache 구성)&lt;/li&gt;
&lt;li&gt;Global Cache에서 장애가 발생할 경우를 대비, Hystrix를 고려하자&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
      <category term="spring" scheme="https://supawer0728.github.io/categories/spring/"/>
    
      <category term="practice" scheme="https://supawer0728.github.io/categories/spring/practice/"/>
    
    
      <category term="spring" scheme="https://supawer0728.github.io/tags/spring/"/>
    
      <category term="cache" scheme="https://supawer0728.github.io/tags/cache/"/>
    
      <category term="fault-tolerance" scheme="https://supawer0728.github.io/tags/fault-tolerance/"/>
    
  </entry>
  
  <entry>
    <title>(Spring Boot)Logging과 Profile 전략</title>
    <link href="https://supawer0728.github.io/2018/04/07/spring-boot-logging/"/>
    <id>https://supawer0728.github.io/2018/04/07/spring-boot-logging/</id>
    <published>2018-04-06T16:45:18.000Z</published>
    <updated>2020-03-04T08:18:02.748Z</updated>
    
    <content type="html"><![CDATA[<h1 id="서론"><a href="#서론" class="headerlink" title="서론"></a>서론</h1><p><code>spring-boot</code>에서는 Logback을 확장해서 편리한 logging 설정을 할 수 있다. <code>application.yml</code>의 설정을 읽어 오거나 특정 profile의 동작을 수행할 수 있다. 이 글에서는 Spring Boot에서 어떻게 logging 설정을 하는지를 알아볼 것이다. 그리고 그것을 기반으로 <code>spring-boot</code>를 사용할 때 profile을 활용할 수 있는 방법을 공유하려고 한다.</p><blockquote><p>본문에서는 logback의 기초적인 정보를 가이드하지 않는다.<br><code>spring-boot</code>는 logback 외에도 log4j 등을 지원하지만 logback만을 고려하고 작성한다.</p></blockquote><a id="more"></a><h1 id="Logback-확장-Extentions"><a href="#Logback-확장-Extentions" class="headerlink" title="Logback 확장(Extentions)"></a>Logback 확장(Extentions)</h1><p><code>spring-boot</code>에서는 <a href="https://logback.qos.ch" target="_blank" rel="noopener">Logback</a>을 사용한다. 기존의 logback을 사용해본 사람은 알 것이다. Web Application을 가동하면 classpath 내에서 환경 설정 파일(<code>logback.xml(logback-text.xml)</code>)을 검색해서 logback을 초기화시킨다. 이때는 아직 Spring이 구동되기 전의 시점이다. <code>spring-boot</code>에서는 <code>logback-spring.xml</code>을 사용해서 Spring이 logback을 구동할 수 있도록 지원해준다. 덕분에 profile이나 <code>application.xml</code>에 설정된 properties를 읽어올 수 있다.</p><p>우선은 logger를 등록하는 방법을 알아보자.</p><h2 id="Logger-등록과-level-설정"><a href="#Logger-등록과-level-설정" class="headerlink" title="Logger 등록과 level 설정"></a>Logger 등록과 level 설정</h2><p>기존에 logback에서 logger를 등록하던 방식을 알아보자.<br>우선 아래와 같이 소스 상에서 로그를 남긴다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SomeService</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">log</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">"hello"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>logback.xml</code>에서 해당 로그가 남을 수 있도록 설정을 한다.</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">"STDOUT"</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.core.ConsoleAppender"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">encoder</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>%d&#123;HH:mm:ss.SSS&#125; [%thread] %-5level %logger&#123;36&#125; - %msg%n<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">logger</span> <span class="attr">name</span>=<span class="string">"com.parfait.study.simplelogging.service.SomeService"</span> <span class="attr">level</span>=<span class="string">"INFO"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">root</span> <span class="attr">level</span>=<span class="string">"warn"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"STDOUT"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure><p>위 설정에서는 전역으로 log level이 warn 이상인 로그만 남기고 있지만, <code>SomeService</code>의 로그는 info 이상이면 남기도록 했다.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">02:15:04.557 [restartedMain] INFO  c.p.s.s.service.SomeService - hello</span><br></pre></td></tr></table></figure><p><code>spring-boot</code>를 사용한다면 이제 <code>logback.xml</code>은 필요 없다.</p><p><strong>application.yml</strong></p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">level:</span></span><br><span class="line">    <span class="attr">root:</span> <span class="string">warn</span></span><br><span class="line">    <span class="attr">com.parfait.study.simplelogging.service.SomeService:</span> <span class="string">info</span></span><br></pre></td></tr></table></figure><p>보다시피 <code>application.yml</code>의 설정만으로 logger와 level을 설정할 수 있다.</p><h2 id="Logging-관련-Spring-Boot-Properties"><a href="#Logging-관련-Spring-Boot-Properties" class="headerlink" title="Logging 관련 Spring Boot Properties"></a>Logging 관련 Spring Boot Properties</h2><p><code>spring-boot</code>에서는 <code>application.yml</code>에 정의한 properties로도 logging이 동작하도록 지원해준다. 그중에서 활용도가 있어 보이는 몇 개를 골라보았다.</p><table><thead><tr><th>key</th><th>default</th><th>description<td colspan=3></th></tr></thead><tbody><tr><td>logging.file</td><td>- <td colspan=4> 절대 경로로 표현되거나 현재 경로의 상대 경로로 로그 파일명을 지정한다.</td><td></td></tr><tr><td>logging.file.path</td><td>- <td colspan=4> <code>logging.file</code>의 값이 없을 때 동작한다. 지정된 경로에 <code>spring.log</code>로 로그를 남긴다.</td><td></td></tr><tr><td>logging.file.max-size</td><td>10MB <td colspan=4> 로그 파일의 사이즈가 지정된 임계치를 초과하면 파일명에 index를 추가한 후 새로운 파일을 작성한다.<br>예 : spring1.log, spring2.log</td><td></td></tr><tr><td>logging.file.max-history</td><td>0 <td colspan=4> 아래에서 따로 설명한다.</td><td></td></tr><tr><td>logging.level.*</td><td>- <td colspan=4> path 기반으로 logger의 level을 지정한다.</td><td></td></tr></tbody></table><p><strong>logging.file.max-history 부가 설명</strong></p><p>File Appender는 <code>RollingFileAppender</code>를 사용한다. 하지만 <code>spring-boot 1.5.x</code>까지만 해도 file을 rolling하는 정책이 <code>SizeBasedTriggeringPolicy</code>으로 파일 크기가 특정 값에 도달하면 새로운 log file을 남기는 기능만 지원했었다. 때문에 시간이 많이 경과한 log를 지우기 위해서는 서버에서 따로 crond를 돌리거나 별도의 <code>logback-spring.xml</code> 설정을 했어야 했다. 하지만 <code>spring-boot 2.0.0</code>부터는 rolling 정책이 <code>SizeAndTimeBasedRollingPolicy</code>로 변경되었다. 즉 기본 설정으로 로그가 일별로 남는다.(예 : spring.2018-01-01.log) 그리고 <code>logging.file.max-history</code>에 지정한 일수가 지난 로그를 자동으로 삭제해준다.</p><h2 id="기본-설정-파헤치기"><a href="#기본-설정-파헤치기" class="headerlink" title="기본 설정 파헤치기"></a>기본 설정 파헤치기</h2><p>그렇다면 <code>spring-boot</code>는 어떻게 저런 일들을 지원하는 것일까? spring에 있는 기본 설정을 한 번 살펴보자.</p><p><strong>base.xml</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">included</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">include</span> <span class="attr">resource</span>=<span class="string">"org/springframework/boot/logging/logback/defaults.xml"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"LOG_FILE"</span> <span class="attr">value</span>=<span class="string">"$&#123;LOG_FILE:-$&#123;LOG_PATH:-$&#123;LOG_TEMP:-$&#123;java.io.tmpdir:-/tmp&#125;&#125;&#125;/spring.log&#125;"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">include</span> <span class="attr">resource</span>=<span class="string">"org/springframework/boot/logging/logback/console-appender.xml"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">include</span> <span class="attr">resource</span>=<span class="string">"org/springframework/boot/logging/logback/file-appender.xml"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">root</span> <span class="attr">level</span>=<span class="string">"INFO"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"CONSOLE"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"FILE"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">included</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li><code>&lt;include resource=&quot;.../defaults.xml&quot;&gt;</code> : <code>defaults.xml</code>에서 추가로 설정을 읽어온다. Console Log Pattern과 File Log Pattern의 기본값이 정의되어 있고, 그 외의 <code>tomcat</code>이나 <code>hibernate</code> 등의 모듈의 log level 설정이 되어 있다. 궁금하면 따로 찾아보자.</li><li><code>&lt;property name=&quot;LOG_FILE&quot; ...&gt;</code> : <code>${LOG_FILE}</code>이 없으면 <code>${LOG_PATH}</code>를 부른다. <code>${LOG_PATH}</code>가 없으면 <code>${LOG_TEMP}</code>를 부른다. 이러한 형식으로 <code>application.yml</code>의 property를 불러오고 있다는 것을 파악할 수 있다.</li><li><code>&lt;include resource=&quot;.../console-appender.xml&quot;&gt;</code> : Console Appender 설정을 읽어온다. 아래에서 살펴보자.</li><li><code>&lt;include resource=&quot;.../file-appender.xml&quot;&gt;</code> : File Appender 설정을 읽어온다. 아래에서 살펴보자.</li></ul><p><strong>console-appender.xml</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">included</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">"CONSOLE"</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.core.ConsoleAppender"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">encoder</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">pattern</span>&gt;</span>$&#123;CONSOLE_LOG_PATTERN&#125;<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">included</span>&gt;</span></span><br></pre></td></tr></table></figure><p><strong>file-appender.xml</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">included</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">"FILE"</span></span></span><br><span class="line"><span class="tag"><span class="attr">class</span>=<span class="string">"ch.qos.logback.core.rolling.RollingFileAppender"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">encoder</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">pattern</span>&gt;</span>$&#123;FILE_LOG_PATTERN&#125;<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">file</span>&gt;</span>$&#123;LOG_FILE&#125;<span class="tag">&lt;/<span class="name">file</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">rollingPolicy</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">fileNamePattern</span>&gt;</span>$&#123;LOG_FILE&#125;.%d&#123;yyyy-MM-dd&#125;.%i.gz<span class="tag">&lt;/<span class="name">fileNamePattern</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">maxFileSize</span>&gt;</span>$&#123;LOG_FILE_MAX_SIZE:-10MB&#125;<span class="tag">&lt;/<span class="name">maxFileSize</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">maxHistory</span>&gt;</span>$&#123;LOG_FILE_MAX_HISTORY:-0&#125;<span class="tag">&lt;/<span class="name">maxHistory</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">rollingPolicy</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">included</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li><code>rollingPolicy</code> : 앞에서도 설명했지만 <code>SizeAndTimeBasedRollingPolicy</code>로 정책이 변경되면서 날짜별로 로그를 남기고, <code>maxHistory</code>에서 지정한 일수가 지나면 자동으로 삭제한다. 만약 <code>2.0.x</code>보다 옛 버전을 사용하고 있다면 차라리 위 설정을 복사해서 쓰자.</li></ul><h2 id="application-yml의-property-가져오기"><a href="#application-yml의-property-가져오기" class="headerlink" title="application.yml의 property 가져오기"></a>application.yml의 property 가져오기</h2><p>애플리케이션에서 원격의 로그 서버로 로그를 보내고, 로그 서버의 주소를 <code>application.yml</code>에서 <code>logserver.host: http://logserver.com</code>으로 정의했다고 하자. 이때 아래와 같이 <code>application.yml</code>을 참조할 수 있다.</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">  <span class="tag">&lt;<span class="name">springProperty</span> <span class="attr">name</span>=<span class="string">"host"</span> <span class="attr">source</span>=<span class="string">"logserver.host"</span> <span class="attr">defaultValue</span>=<span class="string">"http://dev-logserver.com"</span>/&gt;</span></span><br><span class="line">  </span><br><span class="line">  <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">"REMOTE_LOG_SERVER"</span> <span class="attr">class</span>=<span class="string">"xxx.yyy.RemoteLogAppender"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">remoteHost</span>&gt;</span>$&#123;host&#125;<span class="tag">&lt;/<span class="name">remoteHost</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">logger</span> <span class="attr">name</span>=<span class="string">"com.parfait.study.simplelogging.service.SomeService"</span> <span class="attr">level</span>=<span class="string">"INFO"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">root</span> <span class="attr">level</span>=<span class="string">"warn"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"REMOTE_LOG_SERVER"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="Profile별-환경-설정"><a href="#Profile별-환경-설정" class="headerlink" title="Profile별 환경 설정"></a>Profile별 환경 설정</h2><p><code>spring.profiles.active</code>에서 지정한 profile에 따라 조건들을 추가할 수 있다.</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">springProfile</span> <span class="attr">name</span>=<span class="string">"dev"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">"CONSOLE"</span> <span class="attr">class</span>=<span class="string">"..."</span>&gt;</span><span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">root</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"CONSOLE"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">springProfile</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">springProfile</span> <span class="attr">name</span>=<span class="string">"alpha"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">"FILE"</span> <span class="attr">class</span>=<span class="string">"..."</span>&gt;</span><span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">root</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"FILE"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">springProfile</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">springProfile</span> <span class="attr">name</span>=<span class="string">"staging"</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- staging profile인 경우 --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">springProfile</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">springProfile</span> <span class="attr">name</span>=<span class="string">"!production"</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- production profile이 아닌 경우 --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">springProfile</span>&gt;</span></span><br></pre></td></tr></table></figure><p>위 예제는 <a href="https://docs.spring.io/spring-boot/docs/2.0.1.RELEASE/reference/htmlsingle/#_profile_specific_configuration" target="_blank" rel="noopener">Spring Reference에 있는 예제</a>를 약간 수정한 것이다. 이 예제를 보고 아쉬움이 생긴다. <code>OOP</code>스럽지 않다는 것이다. <code>OOP</code>스러운 것은 무엇일까? 작은 문제들로 나누고 이를 조합해서 큰 문제를 해결하는 방식이다! 어떻게 profile로 그러한 사용을 할지 알아보자.</p><h1 id="Profile-전략"><a href="#Profile-전략" class="headerlink" title="Profile 전략"></a>Profile 전략</h1><p>앞서 보았던 profile은 애플리케이션 배포의 주기를 그대로 따르고 있다.</p><ul><li>dev : 개발 단계. 여기서는 CONSOLE로 로그를 남긴다.</li><li>alpha : 알파 테스트 단계. 여기서부터 서버에 배포하므로 FILE로 로그를 남긴다.</li></ul><p>언뜻 보기에는 별다른 문제가 없을 것 같다. 여기에 아까 만들었던 원격 로그 서버로 로그를 내보내는 Appender를 추가해보자. beta profile에서는 FILE과 REMOTE_LOG_SERVER Appender를 사용한다.</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">springProfile</span> <span class="attr">name</span>=<span class="string">"beta"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">"FILE"</span> <span class="attr">class</span>=<span class="string">"..."</span>&gt;</span><span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">"REMOTE_LOG_SERVER"</span> <span class="attr">class</span>=<span class="string">"..."</span>&gt;</span><span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">root</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"FILE"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"REMOTE_LOG_SERVER"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">springProfile</span>&gt;</span></span><br></pre></td></tr></table></figure><p>문제가 발생했다. 중복이 생긴 것이다. alpha에서도 FILE Appender를 선언하고 beta에서도 FILE Appender를 선언했다. 어떻게 해야 할까?</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">springProfile</span> <span class="attr">name</span>=<span class="string">"alpha,beta"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">"FILE"</span> <span class="attr">class</span>=<span class="string">"..."</span>&gt;</span><span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">root</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"FILE"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">springProfile</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">springProfile</span> <span class="attr">name</span>=<span class="string">"beta"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">"REMOTE_LOG_SERVER"</span> <span class="attr">class</span>=<span class="string">"..."</span>&gt;</span><span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">root</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"REMOTE_LOG_SERVER"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">springProfile</span>&gt;</span></span><br></pre></td></tr></table></figure><p>위와 예제가 실행되는지는 모르겠지만, 여하튼 저렇게 해서는 안될 것 같다.</p><p>필자가 제시하고 싶은 해결책은 profile을 <code>조합</code>해서 사용하자는 것이다.</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">springProfile</span> <span class="attr">name</span>=<span class="string">"console-logging"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">"CONSOLE"</span> <span class="attr">class</span>=<span class="string">"..."</span>&gt;</span><span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">springProfile</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">springProfile</span> <span class="attr">name</span>=<span class="string">"file-logging"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">"FILE"</span> <span class="attr">class</span>=<span class="string">"..."</span>&gt;</span><span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">springProfile</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">springProfile</span> <span class="attr">name</span>=<span class="string">"remote-logging"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">"REMOTE_LOG_SERVER"</span> <span class="attr">class</span>=<span class="string">"..."</span>&gt;</span><span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">springProfile</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">root</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">springProfile</span> <span class="attr">name</span>=<span class="string">"console-logging"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"CONSOLE"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">springProfile</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">  <span class="tag">&lt;<span class="name">springProfile</span> <span class="attr">name</span>=<span class="string">"file-logging"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"FILE"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">springProfile</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">  <span class="tag">&lt;<span class="name">springProfile</span> <span class="attr">name</span>=<span class="string">"remote-logging"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"REMOTE_LOG_SERVER"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">springProfile</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br></pre></td></tr></table></figure><p>조합을 사용하면 훨씬 유리하게 환경을 구성할 수 있다. 배포 환경과 맞춰서 설정을 해보자.</p><p><strong>배포 환경에 따른 <code>spring.profiles.active</code></strong></p><ul><li>dev : console-logging</li><li>alpha : file-logging</li><li>beta : file-logging,remote-logging</li></ul><p>조합을 해서 원하는 환경을 쉽게 구성할 수 있다는 건 알겠는데 또 다른 문제가 있다. beta에서 모든 것을 다 조합해서 쓰기에는 profile을 입력하는 게 꽤 눈이 아프다.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ java -Dspring.profiles.active&#x3D;file-logging,remote-logging -jar simple-logging-0.0.1-SNAPSHOT.jar</span><br></pre></td></tr></table></figure><p>이런 문제를 해결하기 위해 <code>spring.profiles.include</code> 설정을 걸어둘 수 있다.</p><p><strong>application-dev.yml</strong></p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring.profiles.include:</span> <span class="string">console-logging</span></span><br></pre></td></tr></table></figure><p><strong>application-alpha.yml</strong></p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring.profiles.include:</span> <span class="string">file-logging</span></span><br></pre></td></tr></table></figure><p><strong>application-beta.yml</strong></p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring.profiles.include:</span> <span class="string">file-logging,remote-logging</span></span><br></pre></td></tr></table></figure><p>배포 단계에 맞춰 필요한 조합을 미리 구성해두고 쓰자.</p><p>이러한 조합은 비단 로깅에서만 쓸 것이 아니다. 업무를 진행하다 보면 배포 환경에 유연성이 필요함을 느낄 때가 있다. 한 마일스톤 내에 두 개의 큰 기능을 배포해야 할 경우가 있다. 예를 들어 메일링 기능 추가와 SMS 기능 추가라고 하자. QA를 진행하다가 한 쪽이 통과하지 못하면 해당 기능을 빼고 배포를 하기 위한 준비가 되어 있고, 각각 별도의 서버(alpha1, alpha2)에서 QA를 진행한다. alpha1에서는 메일링 테스트를 하는데 메일 서버는 운영 환경을 바라보도록 하고, alpha2에서 진행되는 SMS 또한 SMS 서비스만 실제 운영 환경을 바라보도록 해야 한다. 이러한 요구 사항들은 얼마든지 있을 수 있으며, 이에 대한 준비 또한 필요하다.</p><h1 id="마무리"><a href="#마무리" class="headerlink" title="마무리"></a>마무리</h1><p>사실 Profile 전략을 공유하기 위해서 <code>spring-boot</code>에서 지원하는 로깅을 소개했다. 로깅 지원은 Spring Reference만 읽어봐도 어떤 일을 해주는지 알 수 있다. Spring Boot는 여러 자동 설정으로 우리를 간편하게 해준다. 이번에는 그 설정의 간편화로 인해 얻을 수 있는 큰 이점에 대해서 이야기해봤다. Profile을 배포 단계와 동일시하는 경향이 있다. 실제로 Spring Reference조차 profile을 그런식으로 설명하는 부분이 많으니 어쩔 수 없다. 하지만 <code>spring-boot</code>에서 <code>spring.profiles.include</code>가 생기면서 Profile을 바라보는 시각을 조금 바꿀 수 있게 된 것 같다. 우리는 이제 애플리케이션 설정을 마치 플러그인 다루듯이 할 수 있게 된 것이다.</p><p>이제 <code>spring-boot</code>를 사용할 때 자바 설정상으로는 배포 단계를 나타내지 말자. <code>application-{배포단계}.yml</code>을 작성하고 필요한 설정을 조합하여 사용하자.</p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;서론&quot;&gt;&lt;a href=&quot;#서론&quot; class=&quot;headerlink&quot; title=&quot;서론&quot;&gt;&lt;/a&gt;서론&lt;/h1&gt;&lt;p&gt;&lt;code&gt;spring-boot&lt;/code&gt;에서는 Logback을 확장해서 편리한 logging 설정을 할 수 있다. &lt;code&gt;application.yml&lt;/code&gt;의 설정을 읽어 오거나 특정 profile의 동작을 수행할 수 있다. 이 글에서는 Spring Boot에서 어떻게 logging 설정을 하는지를 알아볼 것이다. 그리고 그것을 기반으로 &lt;code&gt;spring-boot&lt;/code&gt;를 사용할 때 profile을 활용할 수 있는 방법을 공유하려고 한다.&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;본문에서는 logback의 기초적인 정보를 가이드하지 않는다.&lt;br&gt;&lt;code&gt;spring-boot&lt;/code&gt;는 logback 외에도 log4j 등을 지원하지만 logback만을 고려하고 작성한다.&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
      <category term="spring" scheme="https://supawer0728.github.io/categories/spring/"/>
    
      <category term="boot" scheme="https://supawer0728.github.io/categories/spring/boot/"/>
    
    
      <category term="spring" scheme="https://supawer0728.github.io/tags/spring/"/>
    
      <category term="spring-boot" scheme="https://supawer0728.github.io/tags/spring-boot/"/>
    
      <category term="log" scheme="https://supawer0728.github.io/tags/log/"/>
    
      <category term="logging" scheme="https://supawer0728.github.io/tags/logging/"/>
    
      <category term="logback" scheme="https://supawer0728.github.io/tags/logback/"/>
    
      <category term="profile" scheme="https://supawer0728.github.io/tags/profile/"/>
    
  </entry>
  
  <entry>
    <title>(Spring)Filter와 Interceptor의 차이</title>
    <link href="https://supawer0728.github.io/2018/04/04/spring-filter-interceptor/"/>
    <id>https://supawer0728.github.io/2018/04/04/spring-filter-interceptor/</id>
    <published>2018-04-04T12:38:46.000Z</published>
    <updated>2020-03-04T08:18:02.751Z</updated>
    
    <content type="html"><![CDATA[<h1 id="서론"><a href="#서론" class="headerlink" title="서론"></a>서론</h1><p>Spring을 익힌지 얼마 되지 않았을 때, 회원 인증 로직을 구현할 일이 생겼었다. 그 인증을 구현하기 위해 Filter와 Interceptor를 조사했었다. 하지만 Filter와 Interceptor를 어떤 경우에 써야 좋은지 명확하게 알지는 못했다. 이제 와서 옛 기억들이 떠올라 다시 <code>spring filter interceptor 차이</code>로 검색을 해보고 올라온 글들을 읽어봤는데, 아무래도 몇 가지 아쉬운 부분들이 있었다. 이번 글에서는 Spring Web Application에서 사용하는 Filter와 Interceptor에 대해, 많은 글에서 공통적으로 이야기하는 부분과 의외로 언급하지 않는 부분 두가지를 쓰려고 한다.</p><a id="more"></a><h1 id="실행-시점"><a href="#실행-시점" class="headerlink" title="실행 시점"></a>실행 시점</h1><table><thead><tr><th><img src="/images/spring-filter-interceptor/spring-request-lifecycle.jpg" alt="request-lifecycle"></th></tr></thead><tbody><tr><td>출처 : <a href="https://justforchangesake.wordpress.com/2014/05/07/spring-mvc-request-life-cycle/" target="_blank" rel="noopener">https://justforchangesake.wordpress.com/2014/05/07/spring-mvc-request-life-cycle/</a></td></tr></tbody></table><h2 id="공통적으로-이야기하는-점"><a href="#공통적으로-이야기하는-점" class="headerlink" title="공통적으로 이야기하는 점"></a>공통적으로 이야기하는 점</h2><ul><li>Filter와 Interceptor는 실행되는 시점이 다르다.</li><li>Filter는 Web Application에 등록을 하고, Interceptor는 Spring의 Context에 등록을 한다.</li></ul><h2 id="추가로-이야기하고-싶은-점"><a href="#추가로-이야기하고-싶은-점" class="headerlink" title="추가로 이야기하고 싶은 점"></a>추가로 이야기하고 싶은 점</h2><p>tomcat의 경우 <code>deployment descriptor(/WEB-INF/web.xml)</code>에 사용할 Filter를 등록한다. 때문에 애플리케이션 전역에 영향을 주는 작업은 Filter로 한다는 의견이 있다. 실제로 필자도 예전에는 그런 줄 알았다. 하지만 사실은 그렇지 않다. Filter도 Interceptor도 모두 요청에 대한 <code>전후 처리</code>라고 하는 역할을 수행한다. 또한 uri기반으로 언제 실행할 것인지를 조정 가능하며, 직접 request의 내용을 파악해서 원하는 조건에 부합할 때 로직을 수행할 수 있다는 점에서 차이가 없다.</p><p>실행 시점이 다르기 때문에 가장 큰 영향을 받는 것. 내가 생각하기에는 예외 처리(Exception Handling)다.</p><p>Filter에서 예외가 발생하면 Web Application에서 처리해야 한다. tomcat을 사용한다면 <code>&lt;error-page&gt;</code>를 잘 선언하든가 아니면 Filter 내에서 예외를 잡아 <code>request.getRequestDispatcher(String)</code>으로 마치 핑퐁 하듯이 예외 처리를 미뤄야 한다. 하지만 Interceptor에서 예외가 발생하면? Interceptor의 실행 시점을 보자, Spring의 ServletDispatcher 내에 있다. 즉 <code>@ControllerAdvice</code>에서 <code>@ExceptionHandler</code>를 사용해서 예외를 처리를 할 수 있다. Spring Web Application의 예외 처리 방법에 대해서는 서술하지 않겠다. 대신 <a href="https://spring.io/blog/2013/11/01/exception-handling-in-spring-mvc" target="_blank" rel="noopener">좋은 글</a>이 있으니 읽어두면 좋을 것 같다. 예외 처리가 견고한 Application은 유지 보수하기 좋다. 만약 작성해야할 전후처리 로직에서 예외를 전역적으로 처리하고 싶다면 Interceptor를 사용하자.</p><h1 id="Interface"><a href="#Interface" class="headerlink" title="Interface"></a>Interface</h1><p>당연하지만 interface가 다르다. 두 interface의 실행 메서드를 비교해보자.</p><p><strong>Filter</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Filter</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain chain)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>HandlerInterceptor</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">HandlerInterceptor</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">boolean</span> <span class="title">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">postHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView mav)</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">afterCompletion</span><span class="params">(HttpServletRequest request, HttpServeletResponse response, Object handler, Exception ex)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="공통적으로-이야기하는-점-1"><a href="#공통적으로-이야기하는-점-1" class="headerlink" title="공통적으로 이야기하는 점"></a>공통적으로 이야기하는 점</h2><ul><li>Filter는 Servlet에서 처리하기 전후를 다룰 수 있다.</li><li>Interceptor는 Handler를 실행하기전(preHandle), Handler를 실행한 후(postHandle), view를 렌더링한 후(afterCompletion) 등, Servlet내에서도 메서드에 따라 실행 시점을 다르게 가져간다.</li></ul><h2 id="추가로-이야기하고-싶은-점-1"><a href="#추가로-이야기하고-싶은-점-1" class="headerlink" title="추가로 이야기하고 싶은 점"></a>추가로 이야기하고 싶은 점</h2><h3 id="Interceptor에서만-할-수-있는-것"><a href="#Interceptor에서만-할-수-있는-것" class="headerlink" title="Interceptor에서만 할 수 있는 것"></a>Interceptor에서만 할 수 있는 것</h3><ul><li>AOP 흉내를 낼 수 있다. <code>@RequestMapping</code> 선언으로 요청에 대한 <code>HandlerMethod(@Controller의 메서드)</code>가 정해졌다면, handler라는 이름으로 <code>HandlerMethod</code>가 들어온다. <code>HandlerMethod</code>로 메서드 시그니처 등 추가적인 정보를 파악해서 로직 실행 여부를 판단할 수 있다.</li><li>View를 렌더링하기 전에 추가 작업을 할 수 있다. 예를 들어 웹 페이지가 권한에 따라 GNB(Global Navigation Bar)이 항목이 다르게 노출되어야 할 때 등의 처리를 하기 좋다.</li></ul><h3 id="Filter에서만-할-수-있는-것"><a href="#Filter에서만-할-수-있는-것" class="headerlink" title="Filter에서만 할 수 있는 것"></a>Filter에서만 할 수 있는 것</h3><p><code>ServletRequest</code> 혹은 <code>ServletResponse</code>를 교체할 수 있다. 아래와 같은 일이 가능하다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SomeFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>&#123;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> </span>&#123;</span><br><span class="line">    chain.doFilter(<span class="keyword">new</span> CustomServletRequest(), <span class="keyword">new</span> CustomResponse());</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>설마 저런 일을 할까? 꽤 자주 있는 요구 사항이다. HttpServletRequest의 body(ServletInputStream의 내용)를 로깅하는 것을 예로 들 수 있을 것 같다. <code>HttpServletRequest</code>는 body의 내용을 한 번만 읽을 수 있다. Rest API Application을 작성할 때, 흔히 json 형식으로 요청을 받는다. <code>@Controller(Handler)</code>에 요청이 들어오면서 body를 한 번 읽게 된다. 때문에 Filter나 Interceptor에서는 body를 읽을 수 없다. <code>IOException</code>이 발생한다. body를 로깅하기 위해서는 <code>HttpServletRequest</code>를 감싸서 여러 번 inputStream을 열 수 있도록 커스터마이징 된 <code>ServletRequest</code>를 쓸 수밖에 없다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SomeFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>&#123;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> </span>&#123;</span><br><span class="line">    chain.doFilter(<span class="keyword">new</span> BodyCachedServletRequestWrapper(request), response);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="마무리"><a href="#마무리" class="headerlink" title="마무리"></a>마무리</h1><p>Spring으로 Web Application을 작성할 때, 한 번쯤은 Filter와 Interceptor를 선택해야 할 상황에 놓일 것이다. 전후 처리라는 점에서 그 역할은 비슷하나, 실제로 실행되는 시점이나 할 수 있는 것들이 다르다. 처리해야 할 요구 사항에 따라서 무엇을 써도 무방할 수도 있다. 하지만 차이점을 정확히 파악하고 있다면 조금이나마 더 효과적으로 개발을 할 수 있을 것이라고 믿는다.</p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;서론&quot;&gt;&lt;a href=&quot;#서론&quot; class=&quot;headerlink&quot; title=&quot;서론&quot;&gt;&lt;/a&gt;서론&lt;/h1&gt;&lt;p&gt;Spring을 익힌지 얼마 되지 않았을 때, 회원 인증 로직을 구현할 일이 생겼었다. 그 인증을 구현하기 위해 Filter와 Interceptor를 조사했었다. 하지만 Filter와 Interceptor를 어떤 경우에 써야 좋은지 명확하게 알지는 못했다. 이제 와서 옛 기억들이 떠올라 다시 &lt;code&gt;spring filter interceptor 차이&lt;/code&gt;로 검색을 해보고 올라온 글들을 읽어봤는데, 아무래도 몇 가지 아쉬운 부분들이 있었다. 이번 글에서는 Spring Web Application에서 사용하는 Filter와 Interceptor에 대해, 많은 글에서 공통적으로 이야기하는 부분과 의외로 언급하지 않는 부분 두가지를 쓰려고 한다.&lt;/p&gt;
    
    </summary>
    
      <category term="spring" scheme="https://supawer0728.github.io/categories/spring/"/>
    
      <category term="mvc" scheme="https://supawer0728.github.io/categories/spring/mvc/"/>
    
    
      <category term="spring" scheme="https://supawer0728.github.io/tags/spring/"/>
    
      <category term="interceptor" scheme="https://supawer0728.github.io/tags/interceptor/"/>
    
      <category term="filter" scheme="https://supawer0728.github.io/tags/filter/"/>
    
      <category term="spring-webmvc" scheme="https://supawer0728.github.io/tags/spring-webmvc/"/>
    
  </entry>
  
  <entry>
    <title>Spring WebSocket 소개</title>
    <link href="https://supawer0728.github.io/2018/03/30/spring-websocket/"/>
    <id>https://supawer0728.github.io/2018/03/30/spring-websocket/</id>
    <published>2018-03-29T15:29:13.000Z</published>
    <updated>2020-03-06T04:31:43.910Z</updated>
    
    <content type="html"><![CDATA[<h1 id="서론"><a href="#서론" class="headerlink" title="서론"></a>서론</h1><p>Web Browser에서 Request를 보내면 Server는 Response를 준다. HTTP 통신의 기본적인 동작 방식이다. 하지만 Server에서 Client로 특정 동작을 알려야 하는 상황도 있다. 예를 들어 Browser로 Facebook에 접속해 있다가 누군가 친구가 글을 등록하는 경우, 혹은 Web Browser로 메신저를 구현하는 경우다. WebSocket이 있기 전에는 이를 Polling이나 Long polling 등의 방식으로 해결했었다. 하지만 WebSocket의 등장으로 Server-Client 간의 실시간 통신이 가능하게 되면서, 앞으로 Long polling은 역사의 뒤안길로 사라질 것 같다.</p><a id="more"></a><p>WebSocket이란 HTTP 환경에서 전이중 통신(full duplex, 2-way communication)을 지원하기 위한 프로토콜로, <a href="https://tools.ietf.org/html/rfc6455" target="_blank" rel="noopener">RFC 6455</a>에 정의되어 있다. HTTP 프로토콜에서 Handshaking을 완료한 후, HTTP로 동작을 하지만, HTTP와는 다른 방식으로 통신을 한다.</p><p>본 문서는 WebSocket을 소개하며, 간단하게 Web Chatting을 지원하는 Application을 작성하여 Spring에서 어떻게 WebSocket을 사용할 수 있도록 지원하는지 소개한다.</p><h1 id="Handshake"><a href="#Handshake" class="headerlink" title="Handshake"></a>Handshake</h1><p>WebSocket은 HTTP 기반으로 Handshaking을 한다. 어떠한 방식인지 잠깐 훑어보자.</p><h2 id="Handshake-요청"><a href="#Handshake-요청" class="headerlink" title="Handshake 요청"></a>Handshake 요청</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;chat HTTP&#x2F;1.1</span><br><span class="line">Host: server.example.com</span><br><span class="line">Upgrade: websocket</span><br><span class="line">Connection: Upgrade</span><br><span class="line">Sec-WebSocket-Key: dGhlIHNhbXBsZSBub25jZQ&#x3D;&#x3D;</span><br><span class="line">Origin: http:&#x2F;&#x2F;example.com</span><br><span class="line">Sec-WebSocket-Protocol: v10.stomp, v11.stomp, my-team-custom</span><br><span class="line">Sec-WebSocket-Version: 13</span><br></pre></td></tr></table></figure><ul><li><code>Connection: Upgrade</code> : HTTP 사용 방식을 변경하자.</li><li><code>Upgrade : websocket</code> : WebSocket을 사용하자.</li><li><code>Sec-WebSocket-Protocol: xxx, yyy, zzz</code> : WebSocket을 쓰면서 이 중에서 protocol을 골라서 쓰자.</li><li><code>Sec-WebSocket-Key</code> : 보안을 위한 요청 키.</li></ul><h2 id="Handshake-응답"><a href="#Handshake-응답" class="headerlink" title="Handshake 응답"></a>Handshake 응답</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">HTTP&#x2F;1.1 101 Switching Protocols</span><br><span class="line">Upgrade: websocket</span><br><span class="line">Connection: Upgrade</span><br><span class="line">Sec-WebSocket-Accept: s3pPLMBiTxaQ9kYGzzhZRbK+xOo&#x3D;</span><br></pre></td></tr></table></figure><ul><li><code>101 Switching Protocols</code> : Handshake 요청 내용을 기반으로 다음부터 WebSocket으로 통신할 수 있다.</li><li><code>Sec-WebSocket-Accept</code> : 보안을 위한 응답 키 - <code>base64.encode(Sec-WebSocket-Key.concat(GUID))</code></li></ul><h1 id="WebSocket-Sevrer를-운용할-때의-유의사항"><a href="#WebSocket-Sevrer를-운용할-때의-유의사항" class="headerlink" title="WebSocket Sevrer를 운용할 때의 유의사항"></a>WebSocket Sevrer를 운용할 때의 유의사항</h1><ul><li>HTTP에서 동작하나, 그 방식이 HTTP와는 많이 상이하다.<ul><li>REST한 방식의 HTTP 통신에서는 많은 URI를 통해 application이 설계된다.</li><li>WebSocket은 하나의 URL을 통해 Connection이 맺어지고, 후에는 해당 Connection으로만 통신한다.</li></ul></li><li>Handshake가 완료되고 Connection을 유지한다.<ul><li>전통적인 HTTP 통신은 요청-응답이 완료되면 Connection을 close한다. 때문에 이론상 하나의 Server가 Port 수의 한계(<code>n&lt;65535</code>)를 넘는 client의 요청을 처리할 수 있다.</li><li>WebSocket은 Connection을 유지하고 있으므로, 가용 Port 수만큼의 Client와 통신할 수 있다.</li></ul></li></ul><p>Spring의 지원을 받아 Web Application Server에서 HTTP를 지원하면서 WebSocket도 지원할 수 있다. 하지만 HTTP와 WebSocket의 개념이 많이 상이하다 보니, WebSocket을 사용해야 한다면 전용 Server를 구축하는 편이 운영하기 쉬울 것으로 판단된다.</p><h1 id="언제-쓰면-좋을까"><a href="#언제-쓰면-좋을까" class="headerlink" title="언제 쓰면 좋을까?"></a>언제 쓰면 좋을까?</h1><p><a href="https://docs.spring.io/spring/docs/5.0.4.RELEASE/spring-framework-reference/web.html#websocket-intro-when-to-use" target="_blank" rel="noopener">Spring Reference</a>을 참조하면, <code>자주 + 많은 양의 + 지연이 짧아야 하는 통신</code>을 할 수록 WebSocket이 적합하다고 설명하고 있다. 주로 채팅이나 게임이 이러한 요구 사항을 가질 것이다. 단순한 알림 성격의 뉴스 피드 같은 정보에는 polling이나 streaming 방식이 더욱 단순하고 효율적인 솔루션이 될 수 있다.</p><h1 id="지원하는-Browser"><a href="#지원하는-Browser" class="headerlink" title="지원하는 Browser"></a>지원하는 Browser</h1><table><thead><tr><th><img src="/images/spring-websocket/support-browsers.png" alt="지원브라우저"></th></tr></thead><tbody><tr><td><a href="https://caniuse.com/#feat=websockets" target="_blank" rel="noopener">https://caniuse.com/#feat=websockets</a></td></tr></tbody></table><blockquote><p>IE는 10부터 지원한다</p></blockquote><h1 id="SockJS"><a href="#SockJS" class="headerlink" title="SockJS"></a>SockJS</h1><p>IE 8, 9는 여전히 많은 인터넷 사용자가 사용하고 있는 브라우저이나, 해당 버전에서는 WebSocket을 지원하지 않는다. Spring에서는 <a href="https://github.com/sockjs/sockjs-client/" target="_blank" rel="noopener">sockjs-client</a>와 합을 맞추어서, 기존 설정에 큰 변경 없이, 마치 WebSocket Polyfill을 사용하는 것과 같은 효과를 낸다.</p><h2 id="Spring-WebSocket-설정"><a href="#Spring-WebSocket-설정" class="headerlink" title="Spring WebSocket 설정"></a>Spring WebSocket 설정</h2><p><strong>WebSocket 기본 설정</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebSocket</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebSocketConfig</span> <span class="keyword">implements</span> <span class="title">WebSocketConfigurer</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerWebSocketHandlers</span><span class="params">(WebSocketHandlerRegistry registry)</span> </span>&#123;</span><br><span class="line">        registry.addHandler(<span class="keyword">new</span> MyHandler(), <span class="string">"/myHandler"</span>).setAllowedOrigins(<span class="string">"*"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>WebSocket SockJS 설정</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebSocket</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebSocketConfig</span> <span class="keyword">implements</span> <span class="title">WebSocketConfigurer</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerWebSocketHandlers</span><span class="params">(WebSocketHandlerRegistry registry)</span> </span>&#123;</span><br><span class="line">        registry.addHandler(<span class="keyword">new</span> MyHandler(), <span class="string">"/myHandler"</span>).setAllowedOrigins(<span class="string">"*"</span>).withSockJS();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>.withSockJS()</code>만 추가되었다. Client에서는 <code>GET /myHandler/info</code>를 호출해서 Server의 정보를 취득하며, Client의 지원 여부에 따라 Long polling이나 Polling으로 통신한다. Server 측에서는 위 설정 외에는 소스 코드의 변함없이 운영할 수 있다.</p><h1 id="SockJS-기반-채팅서버-예제"><a href="#SockJS-기반-채팅서버-예제" class="headerlink" title="SockJS 기반 채팅서버 예제"></a>SockJS 기반 채팅서버 예제</h1><p>서버에서 미리 정의한 채팅방(<code>ChatRoom</code>)에 들어가 있는 사용자(<code>Session</code>) 간에 채팅을 지원한다.</p><h2 id="Gradle-설정"><a href="#Gradle-설정" class="headerlink" title="Gradle 설정"></a>Gradle 설정</h2><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">dependencies</span> &#123;</span><br><span class="line">  <span class="keyword">compile</span>(<span class="string">'org.springframework.boot:spring-boot-starter-mustache'</span>)</span><br><span class="line">  <span class="keyword">compile</span>(<span class="string">'org.springframework.boot:spring-boot-starter-web'</span>)</span><br><span class="line">  <span class="keyword">compile</span>(<span class="string">'org.springframework.boot:spring-boot-starter-websocket'</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">compile</span>(<span class="string">'org.webjars.bower:jquery:3.3.1'</span>)</span><br><span class="line">  <span class="keyword">compile</span>(<span class="string">'org.webjars:sockjs-client:1.1.2'</span>)</span><br><span class="line">  <span class="keyword">compile</span>(<span class="string">'org.webjars:webjars-locator:0.30'</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">runtime</span>(<span class="string">'org.springframework.boot:spring-boot-devtools'</span>)</span><br><span class="line">  compileOnly(<span class="string">'org.projectlombok:lombok'</span>)</span><br><span class="line">  testCompile(<span class="string">'org.springframework.boot:spring-boot-starter-test'</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Spring-Application-설정"><a href="#Spring-Application-설정" class="headerlink" title="Spring Application 설정"></a>Spring Application 설정</h2><p><strong>application.yml</strong></p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring.mustache.suffix:</span> <span class="string">.html</span></span><br></pre></td></tr></table></figure><p><strong>WebSocketConfig</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Profile</span>(<span class="string">"!stomp"</span>)</span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebSocket</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebSocketConfig</span> <span class="keyword">implements</span> <span class="title">WebSocketConfigurer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ChatHandler chatHandler;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerWebSocketHandlers</span><span class="params">(WebSocketHandlerRegistry registry)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 해당 endpoint로 handshake가 이루어진다.</span></span><br><span class="line">        registry.addHandler(chatHandler, <span class="string">"/ws/chat"</span>).setAllowedOrigins(<span class="string">"*"</span>).withSockJS();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>WebSocketHandlerRegistry</code>에 <code>WebSocketHandler</code>의 구현체를 등록한다. 등록된 Handler는 특정 endpoint(<code>&quot;/wa/chat&quot;</code>)로 handshake를 완료한 후 맺어진 connection의 관리한다. <code>WebSocketHandler</code>의 구현체(<code>ChatHandler</code>)의 내용은 아래에서 살펴보겠다.</p><h2 id="채팅방-입장-구현"><a href="#채팅방-입장-구현" class="headerlink" title="채팅방 입장 구현"></a>채팅방 입장 구현</h2><h3 id="ChatRoom"><a href="#ChatRoom" class="headerlink" title="ChatRoom"></a>ChatRoom</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ChatRoom</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Set&lt;WebSocketSession&gt; sessions = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 채팅방 생성</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ChatRoom <span class="title">create</span><span class="params">(@NonNull String name)</span> </span>&#123;</span><br><span class="line">        ChatRoom created = <span class="keyword">new</span> ChatRoom();</span><br><span class="line">        created.id = UUID.randomUUID().toString();</span><br><span class="line">        created.name = name;</span><br><span class="line">        <span class="keyword">return</span> created;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>채팅방은 <code>id</code>, <code>name</code>, <code>sessions</code>로 구성된다. <code>WebSocketSession</code>은 spring에서 WebSocket connection이 맺어진 세션을 가리킨다. 편하게 고수준 <code>socket</code>이라고 생각하자. 해당 session을 통해서 메시지를 보낼(<code>sendMessage()</code>) 수 있다.</p><h3 id="ChatRoomRepository"><a href="#ChatRoomRepository" class="headerlink" title="ChatRoomRepository"></a>ChatRoomRepository</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ChatRoomRepository</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, ChatRoom&gt; chatRoomMap;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ChatRoomRepository</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        chatRoomMap = Collections.unmodifiableMap(</span><br><span class="line">                Stream.of(ChatRoom.create(<span class="string">"1번방"</span>), ChatRoom.create(<span class="string">"2번방"</span>), ChatRoom.create(<span class="string">"3번방"</span>))</span><br><span class="line">                      .collect(Collectors.toMap(ChatRoom::getId, Function.identity())));</span><br><span class="line"></span><br><span class="line">        chatRooms = Collections.unmodifiableCollection(chatRoomMap.values());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ChatRoom <span class="title">getChatRoom</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> chatRoomMap.get(id);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> Collection&lt;ChatRoom&gt; <span class="title">getChatRooms</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> chatRoomMap.values();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>테스트를 위한 용도로 UUID로 채팅방 id를 지정하여, 3개의 채팅방을 생성해두었다.</p><h3 id="ChatController"><a href="#ChatController" class="headerlink" title="ChatController"></a>ChatController</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/chat"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ChatRoomController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ChatRoomRepository repository;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AtomicInteger seq = <span class="keyword">new</span> AtomicInteger(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ChatRoomController</span><span class="params">(ChatRoomRepository repository)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.repository = repository;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/rooms"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">rooms</span><span class="params">(Model model)</span> </span>&#123;</span><br><span class="line">        model.addAttribute(<span class="string">"rooms"</span>, repository.getChatRooms());</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"/chat/room-list"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/rooms/&#123;id&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">room</span><span class="params">(@PathVariable String id, Model model)</span> </span>&#123;</span><br><span class="line">        ChatRoom room = repository.getChatRoom(id);</span><br><span class="line">        model.addAttribute(<span class="string">"room"</span>, room);</span><br><span class="line">        model.addAttribute(<span class="string">"member"</span>, <span class="string">"member"</span> + seq.incrementAndGet()); <span class="comment">// 회원 이름 부여</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"/chat/room"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>채팅방에 진입을 하기 위한 Controller다. <code>/chat/rooms</code>를 통해서 채팅방의 목록을 확인할 수 있고, <code>/chat/rooms/{id}</code>를 통해서 특정 id의 채팅방에 입장할 수 있다.</p><h3 id="room-list-html"><a href="#room-list-html" class="headerlink" title="room-list.html"></a>room-list.html</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>채팅방 목록<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">    &#123;&#123;#rooms&#125;&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"/chat/rooms/&#123;&#123;id&#125;&#125;"</span>&gt;</span>&#123;&#123;name&#125;&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    &#123;&#123;/rooms&#125;&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="room-html"><a href="#room-html" class="headerlink" title="room.html"></a>room.html</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>&#123;&#123;room.name&#125;&#125;<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"/webjars/jquery/dist/jquery.min.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"/webjars/sockjs-client/sockjs.min.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>&#123;&#123;room.name&#125;&#125;(&#123;&#123;room.id&#125;&#125;)<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"content"</span> <span class="attr">data-room-id</span>=<span class="string">"&#123;&#123;room.id&#125;&#125;"</span> <span class="attr">data-member</span>=<span class="string">"&#123;&#123;member&#125;&#125;"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">"chat_box"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">"message"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">"send"</span>&gt;</span>보내기<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">    $(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> chatBox = $(<span class="string">'.chat_box'</span>);</span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> messageInput = $(<span class="string">'input[name="message"]'</span>);</span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> sendBtn = $(<span class="string">'.send'</span>);</span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> roomId = $(<span class="string">'.content'</span>).data(<span class="string">'room-id'</span>);</span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> member = $(<span class="string">'.content'</span>).data(<span class="string">'member'</span>);</span></span><br><span class="line"></span><br><span class="line"><span class="actionscript">        <span class="comment">// handshake</span></span></span><br><span class="line"><span class="actionscript">        <span class="keyword">var</span> sock = <span class="keyword">new</span> SockJS(<span class="string">"/ws/chat"</span>);</span></span><br><span class="line"></span><br><span class="line"><span class="actionscript">        <span class="comment">// onopen : connection이 맺어졌을 때의 callback</span></span></span><br><span class="line"><span class="actionscript">        sock.onopen = <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">            <span class="comment">// send : connection으로 message를 전달</span></span></span><br><span class="line"><span class="actionscript">            <span class="comment">// connection이 맺어진 후 가입(JOIN) 메시지를 전달</span></span></span><br><span class="line"><span class="javascript">            sock.send(<span class="built_in">JSON</span>.stringify(&#123;<span class="attr">chatRoomId</span>: roomId, <span class="attr">type</span>: <span class="string">'JOIN'</span>, <span class="attr">writer</span>: member&#125;));</span></span><br><span class="line">            </span><br><span class="line"><span class="actionscript">            <span class="comment">// onmessage : message를 받았을 때의 callback</span></span></span><br><span class="line"><span class="actionscript">            sock.onmessage = <span class="function"><span class="keyword">function</span> <span class="params">(e)</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">                <span class="keyword">var</span> content = <span class="built_in">JSON</span>.parse(e.data);</span></span><br><span class="line"><span class="actionscript">                chatBox.append(<span class="string">'&lt;li&gt;'</span> + content.message + <span class="string">'('</span> + content.writer + <span class="string">')&lt;/li&gt;'</span>)</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="actionscript">        sendBtn.click(<span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">            <span class="keyword">var</span> message = messageInput.val();</span></span><br><span class="line"><span class="javascript">            sock.send(<span class="built_in">JSON</span>.stringify(&#123;<span class="attr">chatRoomId</span>: roomId, <span class="attr">type</span>: <span class="string">'CHAT'</span>, <span class="attr">message</span>: message, <span class="attr">writer</span>: member&#125;));</span></span><br><span class="line"><span class="actionscript">            messageInput.val(<span class="string">''</span>);</span></span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li><code>new SockJS(&quot;/ws/chat&quot;)</code> : handshake를 한다.</li><li><code>sock.onoepn = function() { ... }</code> : handshake가 완료되고 connection이 맺어지면 실행된다.</li><li><code>sock.send(string)</code> : socket을 대상으로 문자열을 전송한다.</li><li><code>sock.onmessage = function(evt) { ... }</code> : socket에서 정보를 수신했을 때 실행된다. <code>evt.data</code>로 정보가 들어온다.</li></ul><h3 id="ChatMessage"><a href="#ChatMessage" class="headerlink" title="ChatMessage"></a>ChatMessage</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ChatMessage</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String chatRoomId;</span><br><span class="line">    <span class="keyword">private</span> String writer;</span><br><span class="line">    <span class="keyword">private</span> String message;</span><br><span class="line">    <span class="keyword">private</span> MessageType type;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>client와 주고받을 모델이다.</p><h3 id="ChatHandler"><a href="#ChatHandler" class="headerlink" title="ChatHandler"></a>ChatHandler</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@Profile</span>(<span class="string">"!stomp"</span>)</span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ChatHandler</span> <span class="keyword">extends</span> <span class="title">TextWebSocketHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ObjectMapper objectMapper;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ChatRoomRepository repository;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ChatHandler</span><span class="params">(ObjectMapper objectMapper, ChatRoomRepository chatRoomRepository)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.objectMapper = objectMapper;</span><br><span class="line">        <span class="keyword">this</span>.repository = chatRoomRepository;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">handleTextMessage</span><span class="params">(WebSocketSession session, TextMessage message)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        String payload = message.getPayload();</span><br><span class="line">        log.info(<span class="string">"payload : &#123;&#125;"</span>, payload);</span><br><span class="line"></span><br><span class="line">        ChatMessage chatMessage = objectMapper.readValue(payload, ChatMessage<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        ChatRoom chatRoom = repository.getChatRoom(chatMessage.getChatRoomId());</span><br><span class="line">        chatRoom.handleMessage(session, chatMessage, objectMapper);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterConnectionClosed</span><span class="params">(WebSocketSession session, CloseStatus status)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        repository.remove(session);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>ChatHandler</code>는 <code>WebSocketHandler</code>의 구현체이다. <code>WebSocketHandler</code>는 다음 메서드를 가지고 있다.</p><ul><li><code>afterConnectionEstablished(WebSocketSession)</code> : connection이 맺어진 후 실행된다.</li><li><code>handleMessage(WebSocketSession, WebSocketMessage&lt;?&gt;)</code> : session에서 메시지를 수신했을 때 실행된다. message 타입에 따라 <code>handleTextMessage()</code>, <code>handleBinaryMessage()</code>를 실행한다.<ul><li>본문에서 상속한 <code>TextWebSocketHandler</code>는 <code>handleTextMessage(WebSocketSession, TextMessage)</code>를 실행한다.</li></ul></li><li><code>afterConnectionClosed(WebSocketSession, CloseStatus)</code> : close 이후 실행된다.</li></ul><p>위 소스에서는 message가 들어오는 경우, <code>message.getChatRoomId()</code>로 채팅방을 찾아 메시지를 전파한다.</p><h3 id="ChatRoom-1"><a href="#ChatRoom-1" class="headerlink" title="ChatRoom"></a>ChatRoom</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ChatRoom</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Set&lt;WebSocketSession&gt; sessions = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(WebSocketSession session, ChatMessage chatMessage, ObjectMapper objectMapper)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (chatMessage.getType() == MessageType.JOIN) &#123;</span><br><span class="line">            join(session);</span><br><span class="line">            chatMessage.setMessage(chatMessage.getWriter() + <span class="string">"님이 입장했습니다."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        send(chatMessage, objectMapper);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">join</span><span class="params">(WebSocketSession session)</span> </span>&#123;</span><br><span class="line">        sessions.add(session);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">send</span><span class="params">(T messageObject, ObjectMapper objectMapper)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        TextMessage message = <span class="keyword">new</span> TextMessage(objectMapper.writeValueAsString(messageObject));</span><br><span class="line">        sessions.parallelStream().forEach(session -&gt; session.sendMessage(message));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="실행"><a href="#실행" class="headerlink" title="실행"></a>실행</h2><p><img src="/images/spring-websocket/websocket-example1.png" alt="스크린샷1"></p><h2 id="현재-채팅-서버의-단점"><a href="#현재-채팅-서버의-단점" class="headerlink" title="현재 채팅 서버의 단점"></a>현재 채팅 서버의 단점</h2><p><code>ChatRoom</code>이 하는 일이 저수준이다. 마치 socket을 직접 처리하는 것 같다. socket을 보유하고 있고, 특정 이벤트가 발생하면 socket에 메시지를 보내고, session이 종료되면 socket을 삭제한다. 지금까지의 소스에서 WebSocket의 기본적인 동작에 대해서 배웠다고 생각하자. Spring에서 지원해주는 STOMP를 사용하게 되면, 지금까지와는 전혀 다른 모습으로 개발을 하게 될 것이다.</p><h1 id="STOMP"><a href="#STOMP" class="headerlink" title="STOMP"></a>STOMP</h1><br>> 여태까지의 WebSocket Application은 잊자. STOMP를 사용하게 되면, 사실상 Application에서 직접 session을 처리하는 것이 아니라, 오히려 proxy에 가까운 역할을 하게 된다.<p>앞서 <code>WebSocketHandler</code>에 대해서 설명하기를 message 타입이 binary 혹은 text로 나뉜다고 했었다. message가 binary거나 text이기만 하면 실제 내용물이 무엇이든지 통신이 이루어지는 것이다. 이를 sub-protocol을 사용해서 제어할 수 있다. handshake 과정에서 특정 sub-protocol을 사용하기로 합의할 수 있다. sub-protocol의 하나인 STOMP를 사용하게 되면 단순한 binary, text가 아닌 규격을 갖춘(format) message를 보낼 수 있다.</p><p>STOMP의 형식은 마치 HTTP와 닮아 있다.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">COMMAND</span><br><span class="line">header1:value1</span><br><span class="line">header2:value2</span><br><span class="line"></span><br><span class="line">Body^@</span><br></pre></td></tr></table></figure><ul><li>COMMAND : SEND, SUBSCRIBE를 지시할 수 있다.</li><li>header : 기존의 WebSocket으로는 표현이 불가능한 header를 작성할 수 있다.<ul><li>destination : 이 헤더로 메시지를 보내거나(SEND), 구독(SUBSCRIBE)할 수 있다. 이를 통해 간단하게 PUB-SUB를 구현할 수 있다.</li></ul></li></ul><p>예를 들어 ClientA는 아래와 같이 5번 채팅방에 대해 구독을 걸어둘 수 있다.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SUBSCRIBE</span><br><span class="line">destination: &#x2F;subscribe&#x2F;chat&#x2F;room&#x2F;5</span><br></pre></td></tr></table></figure><p>후에 ClientB에서 아래와 같이 채팅 메시지를 보낼 수 있다.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SEND</span><br><span class="line">content-type: application&#x2F;json</span><br><span class="line">destination: &#x2F;publish&#x2F;chat</span><br><span class="line"></span><br><span class="line">&#123;&quot;chatRoomId&quot;: 5, &quot;type&quot;: &quot;MESSAGE&quot;, &quot;writer&quot;: &quot;clientB&quot;&#125;</span><br></pre></td></tr></table></figure><p>이때 Server에서는 내용을 기반(<code>chatRoomId</code>)으로 메시지를 전송할 broker에 전달한다.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">MESSAGE</span><br><span class="line">destination: &#x2F;subscribe&#x2F;chat&#x2F;room&#x2F;5</span><br><span class="line"></span><br><span class="line">&#123;&quot;chatRoomId&quot;: 5, &quot;type&quot;: &quot;MESSAGE&quot;, &quot;writer&quot;: &quot;clientB&quot;&#125;</span><br></pre></td></tr></table></figure><p>이렇게 <code>/subscribe/chat/room/5</code>를 구독하는 Client에게 메시지가 송신된다.</p><img  src=http://www.plantuml.com/plantuml/svg/Iyx9JCqhSLJGjLC8JYqgIorIi58mr5C83dKATWxoT79Lq2ykJIfEBifCIjLFpaWiqI_Apy_LD-M2AhRHLKW6c-04r6S4rEVgvwAWNr2Qb9DPd07M05E9R86ndeAlQt2mepiXuu6Qag4Ej58mqLDuCtVYw-wj0000><h1 id="STOMP-기반-채팅서버-예제"><a href="#STOMP-기반-채팅서버-예제" class="headerlink" title="STOMP 기반 채팅서버 예제"></a>STOMP 기반 채팅서버 예제</h1><p><a href="https://docs.spring.io/spring/docs/5.0.4.RELEASE/spring-framework-reference/web.html#websocket-stomp-message-flow" target="_blank" rel="noopener">Spring Reference</a>에서는 동작 방식을 먼저 상세히 설명한 후에 이런저런 소스를 설명하는데, 오히려 소스를 한 번 보고 동작 방식을 설명하는 것이 이해하기 쉬울 것 같아서 예제를 먼저 소개하려고 한다.</p><h2 id="Spring-Application-설정-1"><a href="#Spring-Application-설정-1" class="headerlink" title="Spring Application 설정"></a>Spring Application 설정</h2><h3 id="StompWebSocketConfig"><a href="#StompWebSocketConfig" class="headerlink" title="StompWebSocketConfig"></a>StompWebSocketConfig</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Profile</span>(<span class="string">"stomp"</span>)</span><br><span class="line"><span class="meta">@EnableWebSocketMessageBroker</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StompWebSocketConfig</span> <span class="keyword">implements</span> <span class="title">WebSocketMessageBrokerConfigurer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerStompEndpoints</span><span class="params">(StompEndpointRegistry registry)</span> </span>&#123;</span><br><span class="line">        registry.addEndpoint(<span class="string">"/stomp-chat"</span>).setAllowedOrigins(<span class="string">"*"</span>).withSockJS();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configureMessageBroker</span><span class="params">(MessageBrokerRegistry registry)</span> </span>&#123;</span><br><span class="line">        registry.setApplicationDestinationPrefixes(<span class="string">"/publish"</span>);</span><br><span class="line">        registry.enableSimpleBroker(<span class="string">"/subscribe"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>구현할 interface의 대상이 <code>WebSocketMessageBrokerConfigurer</code>로 바뀌었다. <code>registerStompEndpoints</code>에서 기존의 WebSocket 설정과 마찬가지로 handshake와 통신을 담당할 endpoint를 지정한다. <code>configureMessageBroker</code>에서 Application 내부에서 사용할 path를 지정할 수 있다.</p><ul><li><code>setApplicationDestinationPrefixes</code> : client에서 <code>SEND</code> 요청을 처리한다.<ul><li>Spring Reference에서는 <code>/topic</code>, <code>/queue</code>가 주로 등장하는데 여기서는 이해를 돕기 위해 <code>/publish</code>로 지정하였다.<ul><li><code>/topic</code> : 암시적으로 1:N 전파를 의미한다.</li><li><code>/queue</code> : 암시적으로 1:1 전파를 의미한다.</li></ul></li></ul></li><li><code>enableSimpleBroker</code> : 해당 경로로 <code>SimpleBroker</code>를 등록한다. <code>SimpleBroker</code>는 해당하는 경로를 <code>SUBSCRIBE</code>하는 client에게 메시지를 전달하는 간단한 작업을 수행한다.</li><li><code>enableStompBrokerRelay</code> : <code>SimpleBroker</code>의 기능과 외부 message broker(<code>RabbitMQ</code>, <code>ActiveMQ</code> 등)에 메시지를 전달하는 기능을 가지고 있다.</li></ul><h2 id="Client"><a href="#Client" class="headerlink" title="Client"></a>Client</h2><h3 id="room-html-1"><a href="#room-html-1" class="headerlink" title="room.html"></a>room.html</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>&#123;&#123;room.name&#125;&#125;<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"/webjars/jquery/dist/jquery.min.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"/webjars/sockjs-client/sockjs.min.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"/webjars/stomp-websocket/stomp.min.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>&#123;&#123;room.name&#125;&#125;(&#123;&#123;room.id&#125;&#125;)<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"content"</span> <span class="attr">data-room-id</span>=<span class="string">"&#123;&#123;room.id&#125;&#125;"</span> <span class="attr">data-member</span>=<span class="string">"&#123;&#123;member&#125;&#125;"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">"chat_box"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">"message"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">"send"</span>&gt;</span>보내기<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">    $(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> chatBox = $(<span class="string">'.chat_box'</span>);</span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> messageInput = $(<span class="string">'input[name="message"]'</span>);</span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> sendBtn = $(<span class="string">'.send'</span>);</span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> roomId = $(<span class="string">'.content'</span>).data(<span class="string">'room-id'</span>);</span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> member = $(<span class="string">'.content'</span>).data(<span class="string">'member'</span>);</span></span><br><span class="line"></span><br><span class="line"><span class="actionscript">        <span class="keyword">var</span> sock = <span class="keyword">new</span> SockJS(<span class="string">"/stomp-chat"</span>);</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">var</span> client = Stomp.over(sock); <span class="comment">// 1. SockJS를 내부에 들고 있는 client를 내어준다.</span></span></span><br><span class="line"></span><br><span class="line"><span class="actionscript">        <span class="comment">// 2. connection이 맺어지면 실행된다.</span></span></span><br><span class="line"><span class="actionscript">        client.connect(&#123;&#125;, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">            <span class="comment">// 3. send(path, header, message)로 메시지를 보낼 수 있다.</span></span></span><br><span class="line"><span class="javascript">            client.send(<span class="string">'/publish/chat/join'</span>, &#123;&#125;, <span class="built_in">JSON</span>.stringify(&#123;<span class="attr">chatRoomId</span>: roomId, <span class="attr">writer</span>: member&#125;)); </span></span><br><span class="line"><span class="actionscript">            <span class="comment">// 4. subscribe(path, callback)로 메시지를 받을 수 있다. callback 첫번째 파라미터의 body로 메시지의 내용이 들어온다.</span></span></span><br><span class="line"><span class="actionscript">            client.subscribe(<span class="string">'/subscribe/chat/room/'</span> + roomId, <span class="function"><span class="keyword">function</span> <span class="params">(chat)</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">                <span class="keyword">var</span> content = <span class="built_in">JSON</span>.parse(chat.body);</span></span><br><span class="line"><span class="actionscript">                chatBox.append(<span class="string">'&lt;li&gt;'</span> + content.message + <span class="string">'('</span> + content.writer + <span class="string">')&lt;/li&gt;'</span>)</span></span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line"><span class="actionscript">        sendBtn.click(<span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">            <span class="keyword">var</span> message = messageInput.val();</span></span><br><span class="line"><span class="javascript">            client.send(<span class="string">'/publish/chat/message'</span>, &#123;&#125;, <span class="built_in">JSON</span>.stringify(&#123;<span class="attr">chatRoomId</span>: roomId, <span class="attr">message</span>: message, <span class="attr">writer</span>: member&#125;));</span></span><br><span class="line"><span class="actionscript">            messageInput.val(<span class="string">''</span>);</span></span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="Controller"><a href="#Controller" class="headerlink" title="Controller"></a>Controller</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Profile</span>(<span class="string">"stomp"</span>)</span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ChatMessageController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SimpMessagingTemplate template;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ChatMessageController</span><span class="params">(SimpMessagingTemplate template)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.template = template;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@MessageMapping</span>(<span class="string">"/chat/join"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">join</span><span class="params">(ChatMessage message)</span> </span>&#123;</span><br><span class="line">        message.setMessage(message.getWriter() + <span class="string">"님이 입장하셨습니다."</span>);</span><br><span class="line">        template.convertAndSend(<span class="string">"/subscribe/chat/room/"</span> + message.getChatRoomId(), message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@MessageMapping</span>(<span class="string">"/chat/message"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">message</span><span class="params">(ChatMessage message)</span> </span>&#123;</span><br><span class="line">        template.convertAndSend(<span class="string">"/subscribe/chat/room/"</span> + message.getChatRoomId(), message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><code>SimpleMessagingTemplate</code> : <code>@EnableWebSocketMessageBroker</code>를 통해서 등록되는 bean이다. 특정 Broker로 메시지를 전달한다.</li><li><code>@MessageMapping</code> : Client가 <code>SEND</code>를 할 수 있는 경로다. <code>StompWebSocketConfig</code>에서 등록한 <code>applicationDestinationPrfixes</code>와 <code>@MessageMapping</code>의 경로가 합쳐진다.(<code>/publish/chat/join</code>)</li></ul><h2 id="설명"><a href="#설명" class="headerlink" title="설명"></a>설명</h2><p>소스는 위에서 설명한 것이 전부다. session도 Spring이 알아서 관리한다. 개발자가 할 일은 권한과 서비스 로직에 맞게 메시지를 처리하거나, broker로 메시지를 라우팅하는 것이다.</p><h3 id="메시지-흐름"><a href="#메시지-흐름" class="headerlink" title="메시지 흐름"></a>메시지 흐름</h3><p>아래 그림은 <a href="https://docs.spring.io/spring/docs/5.0.4.RELEASE/spring-framework-reference/web.html#websocket-stomp-message-flow" target="_blank" rel="noopener">Spring Reference</a>에서 가져왔다. 이해하기 어렵다면 <code>/app</code>을 <code>/publish</code>로, <code>/topic</code>을 <code>/subscribe</code>로 치환해서 보자.</p><table><thead><tr><th><img src="/images/spring-websocket/message-flow-simple-broker.png" alt="메시지 흐름"></th></tr></thead><tbody><tr><td>출처 : <a href="https://docs.spring.io/spring/docs/5.0.4.RELEASE/spring-framework-reference/web.html#websocket-stomp-message-flow" target="_blank" rel="noopener">https://docs.spring.io/spring/docs/5.0.4.RELEASE/spring-framework-reference/web.html#websocket-stomp-message-flow</a></td></tr></tbody></table><ul><li>SimpAnnotationMethod : <code>@MessageMapping</code> 등 client의 <code>SEND</code>를 받아서 처리한다.</li><li>SimpleBroker : client의 정보를 메모리 상에 들고 있으며, client로 메시지를 내보낸다.</li><li>channel : 3종류의 channel이 등장한다<ul><li>clientInboundChannel : WebSocket Client로부터 들어오는 요청을 전달하며, <code>WebSocketMessageBrokerConfigurer</code>를 통해 interceptor, taskExecutor를 설정할 수 있다.</li><li>clientOutboundChannel : WebSocket Client로 Server의 메시지를 내보내며, <code>WebSocketMessageBrokerConfigurer</code>를 통해 interceptor, taskExecutor를 설정할 수 있다.</li><li>brokerChannel : Server 내부에서 사용하는 channel이며, 이를 통해 <code>SimpAnnotationMetho</code>는 <code>SimpleBroker</code>의 존재를 직접 알지 못해도 메시지를 전달할 수 있다(결합도를 낮춤)</li></ul></li></ul><h1 id="2대-이상의-서버를-사용한다면"><a href="#2대-이상의-서버를-사용한다면" class="headerlink" title="2대 이상의 서버를 사용한다면?"></a>2대 이상의 서버를 사용한다면?</h1><p>WebSocket을 사용해서 채팅 서버를 구현하고, 여러 서버를 사용한다면 당연히 아래와 같은 구조가 나올 것이다.</p><img  src=http://www.plantuml.com/plantuml/svg/AqXCpavCJrLGAaujAaijCbHIgEPIK8ZsJIqk1Wfx9EQbv015Oq5YJaNvsM1sBLS1gYuZhBgCa7GPWNIXQpF6giqOIPinM5jqSavcQbw9Owo2hguTfjiKh1GCzHI2NVrSk33bG1fW3WSgDD9JWF3UJ9-Wy7hbb3VTSzuiRr1uiw3bTVSQBeHAP8i2IrDBKq6QZVKKa8KmZ7ZJjX3PYD82a25mjuFruxCIMRqJJlMeZj95-Cy8fCL4Jm7Yjhap55utRNapQoL8uzkU7Yw4Abs4DSuWFQQudOMgsWMdQfoECYRAKSOerhWIS1IgQZSSgW40><h1 id="마무리"><a href="#마무리" class="headerlink" title="마무리"></a>마무리</h1><p>WebSocket에 대해서 알아보고, Spring에서 WebSocket을 어떻게 지원하는지 알아보았다. WebSocket 기술은 Web에서 Socket 통신을 하는 것처럼 동작하며, Spring에서는 이를 STOMP를 사용하여 고수준의 프로그래밍을 가능하게 했다. 간단한 소개가 목적이었기 때문에 Security, Load Balancing, Firewall 등의 주제는 다루지 않았다. 이러한 기술이 있음을 기억하고, 필요할 때 더 깊이 있게 파고들면 좋을 것 같다.</p><p>WebSocket을 사용하고자 하는 서비스가 Web과 iOS, Android 환경을 모두 지원해야 하는 경우가 있을 수 있다. 이럴 때에는 Web 환경에서는 SockJS를 사용하여 <code>/ws-sockjs</code>로 endpoint를 열어두고, mobile 환경에는 <code>/ws</code>로 endpoint를 열어서 endpoint를 분리해서 운용할 수 있을 것이다. Android나 iOS 둘 다 STOMP를 지원하는 Library가 있는 것은 확인했다. 다만 필자가 해당 분야의 개발자가 아니기에 얼마나 사용성이 있는지는 확인하지 않았다. 가능하다면 STOMP로 동일한 sub-protocol을 운용할 수 있다면 운영하는 데에 큰 도움이 될 것 같다.</p><p>WebSocket의 사용 여부를 결정하는 것은 사실상 하나로 귀결되는 것 같다. Connection을 유지할 필요가 있는지를 따져보는 것이다.</p><ul><li>장점 : Handshake(TCP 상의 통신 준비)를 할 필요가 없으며, 덕분에 지연이 낮다.<ul><li>적은 지연, 높은 빈도, 대량의 정보 통신에 유리</li></ul></li><li>단점 : Connection이 유지되는 동안 항상 통신을 하는 것은 아니다(Connection 낭비)</li></ul><p>Server에서 Client로 메시지를 보낼 수 있다는 것은 하나의 기능에 불과하다. 가장 중요하게 염두에 둬야 할 사항은 Connection 유지의 필요성이라 생각한다.</p><p>2011년에 작성된 <a href="http://d2.naver.com/helloworld/1336" target="_blank" rel="noopener">네이버 Hello Wold의 글</a>에서는 WebSocket이 한창 발전하고 있다고 시사하였다. 이제는 미래 기술로서 발전 가능성이 아니라, 요구 사항이 충족된다면 실 서비스에서 도입할만한 기술이라고 생각한다.</p><p>소스 코드 : <a href="https://github.com/supawer0728/simple-websocket" target="_blank" rel="noopener">https://github.com/supawer0728/simple-websocket</a></p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;서론&quot;&gt;&lt;a href=&quot;#서론&quot; class=&quot;headerlink&quot; title=&quot;서론&quot;&gt;&lt;/a&gt;서론&lt;/h1&gt;&lt;p&gt;Web Browser에서 Request를 보내면 Server는 Response를 준다. HTTP 통신의 기본적인 동작 방식이다. 하지만 Server에서 Client로 특정 동작을 알려야 하는 상황도 있다. 예를 들어 Browser로 Facebook에 접속해 있다가 누군가 친구가 글을 등록하는 경우, 혹은 Web Browser로 메신저를 구현하는 경우다. WebSocket이 있기 전에는 이를 Polling이나 Long polling 등의 방식으로 해결했었다. 하지만 WebSocket의 등장으로 Server-Client 간의 실시간 통신이 가능하게 되면서, 앞으로 Long polling은 역사의 뒤안길로 사라질 것 같다.&lt;/p&gt;
    
    </summary>
    
      <category term="spring" scheme="https://supawer0728.github.io/categories/spring/"/>
    
    
      <category term="spring" scheme="https://supawer0728.github.io/tags/spring/"/>
    
      <category term="websocket" scheme="https://supawer0728.github.io/tags/websocket/"/>
    
  </entry>
  
  <entry>
    <title>Spring Event + Async + AOP 적용해보기</title>
    <link href="https://supawer0728.github.io/2018/03/24/spring-event/"/>
    <id>https://supawer0728.github.io/2018/03/24/spring-event/</id>
    <published>2018-03-23T15:43:45.000Z</published>
    <updated>2020-03-04T08:18:02.750Z</updated>
    
    <content type="html"><![CDATA[<h1 id="서론"><a href="#서론" class="headerlink" title="서론"></a>서론</h1><p>원래 글을 쓰기 위해 준비하던 내용은 Event를 강조하는 것이었는데, 준비를 하다 보니 Async와 AOP를 다 쓰게 되어버렸다.</p><p>이번 글에서는 하나의 transaction 안에서 많은 일을 처리하는 소스 코드를 두고, 아래와 같이 점진적으로 리팩토링해나가는 과정에 대해 이야기하려고 한다. </p><ol><li>하나의 transaction으로 처리하기</li><li>transaction 내에 처리하지 않아도 될 부분은, transaction이 끝난 후에 처리하기</li><li>Event 사용하기</li><li>Event도 비동기로 처리하기</li><li>AOP를 사용해서 Advisor에서 Event 발급하기</li><li>순서가 필요 있나? Best Effort!</li></ol><a id="more"></a><p>본문에서는 <code>mybatis</code>를 사용하며, <code>@Service</code>에서 대부분의 로직을 처리하는 방식에 대해 다루고 있다. 도메인 주도 설계(Domain-Driven Design)으로 개발을 하는 경우에는 <code>Domain Event</code> 개념을 사용할 수 있다. 기회가 된다면 <code>DDD Start!(최범균 저)</code>라는 책을 읽어볼 것을 강력히 추천한다. 필자가 알고 있는 DDD의 지식이 대부분 저 책을 기반으로 하다 보니, 현재 알고 있는 내용으로 공개 블로그를 작성하기가 어렵다.<br><code>Spring Framework 5.0.4.RELEASE</code>가 나온 현재까지, 간편하게 <code>Domain Event</code>를 사용할 수 있는 방법은 없어 보인다. <code>ThreadLocal</code>이나 <code>Configurable</code>의 힘을 빌려 자체적으로 구현해야한다. <code>DDD Start!</code>를 보고 Spring에서 <code>Domain Event</code>를 사용할 것이라면, 작가님이 운영하는 <a href="http://javacan.tistory.com/entry/Handle-DomainEvent-with-Spring-ApplicationEventPublisher-EventListener-TransactionalEventListener" target="_blank" rel="noopener">블로그</a>도 참조하자.</p><p>여기서 <code>Domain Event</code>에 대해서 다루지는 않겠지만 힌트 정도는 얻어 갈 수 있다고 생각한다.</p><h1 id="요구-사항"><a href="#요구-사항" class="headerlink" title="요구 사항"></a>요구 사항</h1><ul><li>회원이 가입하면 이메일과 SMS로 가입 축하 메시지를 보낸다.</li><li>이메일과 SMS는 반드시 성공하지 않아도 괜찮다.</li></ul><h1 id="구현-1-하나의-transaction으로-처리하기"><a href="#구현-1-하나의-transaction으로-처리하기" class="headerlink" title="구현 1. 하나의 transaction으로 처리하기"></a>구현 1. 하나의 transaction으로 처리하기</h1><h2 id="의존성"><a href="#의존성" class="headerlink" title="의존성"></a>의존성</h2><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">dependencies</span> &#123;</span><br><span class="line">    <span class="keyword">compile</span>(<span class="string">'org.mybatis.spring.boot:mybatis-spring-boot-starter:1.3.2'</span>)</span><br><span class="line">    <span class="keyword">compile</span>(<span class="string">'org.springframework.boot:spring-boot-starter-aop'</span>)</span><br><span class="line">    <span class="keyword">compile</span>(<span class="string">'org.projectlombok:lombok'</span>)</span><br><span class="line">    <span class="keyword">runtime</span>(<span class="string">'com.h2database:h2'</span>)</span><br><span class="line">    testCompile(<span class="string">'org.springframework.boot:spring-boot-starter-test'</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="회원-관련"><a href="#회원-관련" class="headerlink" title="회원 관련"></a>회원 관련</h2><h3 id="모델"><a href="#모델" class="headerlink" title="모델"></a>모델</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Member</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> String email;</span><br><span class="line">    <span class="keyword">private</span> String phoneNo;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Member <span class="title">create</span><span class="params">(@NonNull String name, @NonNull String email, @NonNull String phoneNo)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        Member member = <span class="keyword">new</span> Member();</span><br><span class="line">        member.setName(name);</span><br><span class="line">        member.setEmail(email);</span><br><span class="line">        member.setPhoneNo(phoneNo);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> member;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MemberJoinService</span> </span>&#123;</span><br><span class="line">    <span class="function">Member <span class="title">join</span><span class="params">(Member member)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>설명</strong></p><p><code>MemberJoinService</code>의 구현체를 여럿 생성하여, Spring의 Profile 별로 구현체를 바꿔서 사용할 것이다.</p><h2 id="MainClass"><a href="#MainClass" class="headerlink" title="MainClass"></a>MainClass</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleEventApplication</span> <span class="keyword">implements</span> <span class="title">CommandLineRunner</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MemberJoinService memberJoinService;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MemberMapper memberMapper;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(SimpleEventApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(String... args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        log.info(<span class="string">"&#123;&#125; is injected"</span>, memberJoinService.getClass().getCanonicalName());</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Member member = Member.create(<span class="string">"test"</span>, <span class="string">"test@test.com"</span>, <span class="string">"012-3456-7890"</span>);</span><br><span class="line">            memberJoinService.join(member);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">"&#123;&#125; was thrown"</span>, e.getClass().getCanonicalName());</span><br><span class="line">        &#125;</span><br><span class="line">        log.info(<span class="string">"member count : &#123;&#125;"</span>, memberMapper.count());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="핵심-로직"><a href="#핵심-로직" class="headerlink" title="핵심 로직"></a>핵심 로직</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Profile</span>(<span class="string">"simple"</span>)</span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleMemberJoinService</span> <span class="keyword">implements</span> <span class="title">MemberJoinService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MemberMapper memberMapper;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> EmailService emailService;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SmsService smsService;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Member <span class="title">join</span><span class="params">(Member member)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        memberMapper.insert(member);</span><br><span class="line">        emailService.sendEmail(member.getEmail(), EmailTemplateType.JOIN); <span class="comment">// log만 남김</span></span><br><span class="line">        smsService.sendSms(member.getPhoneNo(), SmsTemplateType.JOIN); <span class="comment">// log만 남김, `fail` profile에서는 RuntimeException을 던짐</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> member;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="성공-실패"><a href="#성공-실패" class="headerlink" title="성공, 실패"></a>성공, 실패</h3><p><strong>성공</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">INFO  [main] c.p.s.s.service.email.EmailService       : send JOIN email to test@test.com</span><br><span class="line">INFO  [main] c.p.s.s.service.sms.SuccessSmsService    : send JOIN sms to 012-3456-7890</span><br><span class="line">INFO  [main] c.p.s.s.SimpleEventApplication           : member count : 1</span><br></pre></td></tr></table></figure><p><strong>실패</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">INFO  [main] c.p.s.s.service.email.EmailService       : send JOIN email to test@test.com</span><br><span class="line">INFO  [main] c.p.s.s.service.sms.FailSmsService       : send JOIN sms to 012-3456-7890</span><br><span class="line">ERROR [main] c.p.s.s.SimpleEventApplication           : java.lang.RuntimeException was thrown</span><br><span class="line">INFO  [main] c.p.s.s.SimpleEventApplication           : member count : 0</span><br></pre></td></tr></table></figure><h3 id="설명"><a href="#설명" class="headerlink" title="설명"></a>설명</h3><p>Application을 실행시킬 때 <code>spring.profiles.active=simple</code>로 해야 정상 동작한다. 요구 사항을 단순하게 하나의 transaction에서 구현했다. 무척이나 간단하지만 <code>emailService</code>가 실패하거나, <code>smsService</code>가 실패하면 <code>memberMapper.insert()</code>도 <code>rollback</code>된다. 축하 메일을 못 받았으니 회원 가입이 취소된다? 있을 수 없는 일이다.</p><h1 id="구현-2-transaction-내에-처리하지-않아도-될-부분은-transaction이-끝난-후에-처리하기"><a href="#구현-2-transaction-내에-처리하지-않아도-될-부분은-transaction이-끝난-후에-처리하기" class="headerlink" title="구현 2. transaction 내에 처리하지 않아도 될 부분은, transaction이 끝난 후에 처리하기"></a>구현 2. transaction 내에 처리하지 않아도 될 부분은, transaction이 끝난 후에 처리하기</h1><p>두 가지 방법이 있을 것 같다. 하나는 <code>@Transactional</code>를 이용하는 것, 하나는 <code>TransactionSynchronizationAdapter</code>를 사용하는 것이다. </p><h2 id="Propagation-사용하기"><a href="#Propagation-사용하기" class="headerlink" title="Propagation 사용하기"></a>Propagation 사용하기</h2><p><code>Member</code>를 <code>insert</code>할 <code>Service</code>를 하나 더 두는 방식이다. 이 경우 <code>MemberJoinService</code>에서 <code>@Transactional</code> 선언을 지우거나, <code>MemberService.insert()</code>에서는 <code>REQUIRES_NEW</code>를 해서 <code>insert()</code>가 <code>rollback</code>되는 것을 막을 수 있다.</p><img  src=http://www.plantuml.com/plantuml/svg/Y_PDpKrABVBApymBJYqgoqnEZLNGrRLJY8Q8GyNqClEAKujAD3HZ5QmK3BcYSMbopKtCp87fAKxDIu7eCCAj8pYt65EzCG00><h2 id="TransactionSynchronizationAdapter-사용하기"><a href="#TransactionSynchronizationAdapter-사용하기" class="headerlink" title="TransactionSynchronizationAdapter 사용하기"></a>TransactionSynchronizationAdapter 사용하기</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Profile</span>(<span class="string">"advanced"</span>)</span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AdvancedMemberJoinService</span> <span class="keyword">implements</span> <span class="title">MemberJoinService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MemberMapper memberMapper;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> EmailService emailService;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SmsService smsService;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Member <span class="title">join</span><span class="params">(Member member)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        memberMapper.insert(member);</span><br><span class="line">        TransactionSynchronizationManager.registerSynchronization(<span class="keyword">new</span> TransactionSynchronizationAdapter() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterCommit</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                emailService.sendEmail(member.getEmail(), EmailTemplateType.JOIN);</span><br><span class="line">                smsService.sendSms(member.getPhoneNo(), SmsTemplateType.JOIN);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> member;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="성공-실패-1"><a href="#성공-실패-1" class="headerlink" title="성공, 실패"></a>성공, 실패</h3><p><strong>성공</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">INFO  [main] c.p.s.s.service.email.EmailService       : send JOIN email to test@test.com</span><br><span class="line">INFO  [main] c.p.s.s.service.sms.SuccessSmsService    : send JOIN sms to 012-3456-7890</span><br><span class="line">INFO  [main] c.p.s.s.SimpleEventApplication           : member count : 1</span><br></pre></td></tr></table></figure><p><strong>실패</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">INFO  [main] c.p.s.s.service.email.EmailService       : send JOIN email to test@test.com</span><br><span class="line">INFO  [main] c.p.s.s.service.sms.FailSmsService       : send JOIN sms to 012-3456-7890</span><br><span class="line">ERROR [main] c.p.s.s.SimpleEventApplication           : java.lang.RuntimeException was thrown</span><br><span class="line">INFO  [main] c.p.s.s.SimpleEventApplication           : member count : 1</span><br></pre></td></tr></table></figure><p><code>TransactionSynchronizationAdaptor</code>를 사용하면 위와 같이, <code>beforeCommit()</code>, <code>afterCommit()</code> 등을 구현해서 특정 로직의 실행 시점을 조절할 수 있다. <code>TransactionSynchronizationAdaptor</code>는 이름 그대로 <code>TransactionSynchronization</code>를 어댑터 패턴으로 구현해 둔 추상 클래스이다. <code>TransactionSynchronization</code>에는 각 로직이 실행될 시점이 추상화되어 있으며, 자세한 설명은 <a href="https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/transaction/support/TransactionSynchronization.html" target="_blank" rel="noopener">JavaDoc</a>을 확인하자.</p><p><code>Spring Framework 4.2.x</code>부터는 더 좋은 게 있으므로 길게 설명하지 않겠다.</p><h1 id="구현-3-Event-사용하기"><a href="#구현-3-Event-사용하기" class="headerlink" title="구현 3. Event 사용하기"></a>구현 3. Event 사용하기</h1><p>이 구현부터 본격적으로 본문의 주제에 가까워진다. 우선 소스 코드로 어떻게 Spring Event를 이용할 수 있는지 확인해보자.</p><h2 id="Spring-Application-Event-사용하기"><a href="#Spring-Application-Event-사용하기" class="headerlink" title="Spring Application Event 사용하기"></a>Spring Application Event 사용하기</h2><h3 id="Publisher"><a href="#Publisher" class="headerlink" title="Publisher"></a>Publisher</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Profile</span>(<span class="string">"event"</span>)</span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EventMemberJoinService</span> <span class="keyword">implements</span> <span class="title">ApplicationEventPublisherAware</span>, <span class="title">MemberJoinService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MemberMapper memberMapper;</span><br><span class="line">    <span class="keyword">private</span> ApplicationEventPublisher eventPublisher;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Member <span class="title">join</span><span class="params">(Member member)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        memberMapper.insert(member);</span><br><span class="line">        eventPublisher.publishEvent(<span class="keyword">new</span> MemberJoinedEvent(member)); <span class="comment">// gray zone</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> member;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setApplicationEventPublisher</span><span class="params">(ApplicationEventPublisher applicationEventPublisher)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.eventPublisher = applicationEventPublisher;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MemberJoinedEvent</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Getter</span></span><br><span class="line">        <span class="keyword">private</span> Member member;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="title">MemberJoinedEvent</span><span class="params">(@NonNull Member member)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.member = member;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="설명-1"><a href="#설명-1" class="headerlink" title="설명"></a>설명</h4><p><code>ApplicationEventPublisherAware</code> 인터페이스를 구현하면, Spring이 자동으로 <code>ApplicationEventPublisher</code>를 주입해준다. Event를 발급하는 방법은 너무나 간단하다. <code>ApplicationEventPublisher.publishEvent(Object event)</code>를 호출하면 끝이다.</p><p><code>MemberService</code>는 이제 회원이 가입되었으면, 가입되었다는 Event를 발급한다.(<code>MemberJoinedEvent</code>) 어디선가 이 Event를 받아서 처리만 해주면 될 것이다. 이 Event를 어떻게 받아서 처리하는지 확인해보자.</p><blockquote><p><code>// gray zone</code>이라고 붙인 곳은, 저 코드가 저 위치에 있는 것을 허용할 것이냐, 말 것이냐를 개발자들의 판단에 맡기고 싶어서 두었다. 본문에서는 refactoring의 대상이라 판단하고, 나중에 AOP로 제거할 것이다.</p></blockquote><h3 id="Listener"><a href="#Listener" class="headerlink" title="Listener"></a>Listener</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MemberJoinedEventListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SmsService smsService;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> EmailService emailService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@TransactionalEventListener</span>(phase = TransactionPhase.AFTER_COMMIT, classes = EventMemberJoinService.MemberJoinedEvent<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">    <span class="title">public</span> <span class="title">void</span> <span class="title">handle</span>(<span class="title">EventMemberJoinService</span>.<span class="title">MemberJoinedEvent</span> <span class="title">event</span>) </span>&#123;</span><br><span class="line">        Member member = event.getMember();</span><br><span class="line">        emailService.sendEmail(member.getEmail(), EmailTemplateType.JOIN);</span><br><span class="line">        smsService.sendSms(member.getPhoneNo(), SmsTemplateType.JOIN);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="설명-2"><a href="#설명-2" class="headerlink" title="설명"></a>설명</h4><p><code>@TransactionalEventListener</code>는 <code>4.2</code> 버전부터 사용할 수 있다. 간단하게 위에서 사용한 것과 같이, <code>phase</code>에는 실행 시점을, <code>classes</code>에는 Event의 타입을 넣어 발급된 Event를 처리할 수 있다.</p><p><strong>TransactionalEventListener</strong></p><p>| parameter <th colspan="3">description |<br>| - | - | - | - |<br>| phase <td colspan="3"> transaction과 연관지어, 어느 시점에서 로직을 실행할지 정할 수 있다.<br>- BEFORE_COMMIT<br>- AFTER_COMMIT(default)<br>- AFTER_ROLLBACK<br>- AFTER_COMPLETION |<br>| fallbackExecution <td colspan="3"> 진행 중인 transaction이 없을 때에도 실행할지 여부. 기본값은 <code>false</code> |<br>| value, classes <td colspan="3"> Listener가 처리할 Event의 타입을 배열로 받는다.<br>한 종류의 타입만 지정되었을 때에는 메서드의 파라미터로 받을 수 있지만,<br>여러 타입이 선언된 경우에는 메서드의 파라미터는 비워둬야 한다. |<br>| condition <td colspan="3"> SpEL을 선언하여 true인 경우에 실행된다. |</p><h4 id="결과"><a href="#결과" class="headerlink" title="결과"></a>결과</h4><p><strong>성공</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">INFO  [main] c.p.s.s.service.email.EmailService       : send JOIN email to test@test.com</span><br><span class="line">INFO  [main] c.p.s.s.service.sms.SuccessSmsService    : send JOIN sms to 012-3456-7890</span><br><span class="line">INFO  [main] c.p.s.s.SimpleEventApplication           : member count : 1</span><br></pre></td></tr></table></figure><p><strong>실패</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">INFO  [main] c.p.s.s.service.email.EmailService       : send JOIN email to test@test.com</span><br><span class="line">INFO  [main] c.p.s.s.service.sms.FailSmsService       : send JOIN sms to 012-3456-7890</span><br><span class="line">ERROR [main] o.s.t.s.TransactionSynchronizationUtils  : TransactionSynchronization.afterCompletion threw exception</span><br><span class="line">...</span><br><span class="line">INFO  [main] c.p.s.s.SimpleEventApplication           : member count : 1</span><br></pre></td></tr></table></figure><h2 id="ApplicationEvnetPublisher에-대해서"><a href="#ApplicationEvnetPublisher에-대해서" class="headerlink" title="ApplicationEvnetPublisher에 대해서"></a>ApplicationEvnetPublisher에 대해서</h2><p>Spring에서 지원하는 <code>ApplicationEvnetPublisher</code>를 이용한 Event 처리 방식은 <code>ApplicationContext</code>를 통해서 이루어진다. <code>ApplicationContext</code>가 <code>ApplicationEventPublisher</code>를 상속하고 있다. 즉 <code>Publisher</code>와 <code>Listener</code>는 Spring에 Bean으로 등록되어야 한다. Spring이 초기화될 때 <code>@EventListener</code>, <code>@TransactionalEventListener</code>를 <code>ApplicationContext</code>에 등록을 해두고 <code>publishEvent()</code>가 실행되면 등록된 Listener에 Event를 뿌려준다.</p><h2 id="Event에-대해서"><a href="#Event에-대해서" class="headerlink" title="Event에 대해서"></a>Event에 대해서</h2><p>앞서 작성했던 <code>EventMemberJoinService</code>를 다시 한 번 살펴보자.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Profile</span>(<span class="string">"event"</span>)</span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EventMemberJoinService</span> <span class="keyword">implements</span> <span class="title">ApplicationEventPublisherAware</span>, <span class="title">MemberJoinService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> Member <span class="title">join</span><span class="params">(Member member)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        memberMapper.insert(member);</span><br><span class="line">        eventPublisher.publishEvent(<span class="keyword">new</span> MemberJoinedEvent(member)); <span class="comment">// gray zone</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> member;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>이전까지의 소스와의 차이가 있다. 바로 <code>EmailService</code>와 <code>SmsService</code>가 없어진 것이다! 느슨한 결합으로 인한 OOP의 장점을 그대로 누릴 수 있다.</p><h3 id="결합도"><a href="#결합도" class="headerlink" title="결합도"></a>결합도</h3><p>현재는 하나의 Application에서만 Event를 사용하고 있어서 크게 와닿지 않을 수도 있을 것 같다. 좀 더 설명하기 쉽고, 거창해 보일 수 있도록 크기를 키워보자. 만약에 MSA와 같은 구조의 시스템에서 Event를 사용한다면 어떻게 될까?</p><h4 id="시스템-간-강결합-HTTP-Rest-API-호출"><a href="#시스템-간-강결합-HTTP-Rest-API-호출" class="headerlink" title="시스템 간 강결합 : HTTP Rest API 호출"></a>시스템 간 강결합 : HTTP Rest API 호출</h4><img  src=http://www.plantuml.com/plantuml/svg/Y_PDpKrABGfEBIfBBOfLqDMrKuZsJSpCWGbOARoUlF7rmhaA2G7-mI4A-YML1QdwNlwUVleb-VebgSKb3Y12Bpa_Du4h6ejPmRd5H1bbO6YaQsnYQgPhRc5fa000><p>강결합 상태의 시스템의 문제를 여기서 확인할 수 있다.<br><code>MemberServer</code>는 각 Server를 알고 있다. 호출해야 할 URI를 스스로 가지고 있다. 만약 <code>MailServer</code>에서 메일을 보내기 위한 URI가 변경이 된다면, <code>MemberServer</code>도 수정을 해야 한다. 메일 서버가 변경이 되었는데, 회원 가입 로직이 변경되어야 한다.</p><h4 id="느슨한-결합으로-Event-방식"><a href="#느슨한-결합으로-Event-방식" class="headerlink" title="느슨한 결합으로 : Event 방식"></a>느슨한 결합으로 : Event 방식</h4><img  src=http://www.plantuml.com/plantuml/svg/Y_PDpKrABGfEBIfBBOfLqDMrKuXsBKlDAmaiJIrDZLMmKe0eyChFp4jD0SjmeIW0w_1DpCo16M6by7f3mvjfMzuitlDguuRNJJDGrTlewcAgd_rcQikh3GtOr8FD3yuj9iLuDEKefWC0><p>앞선 구조와 비교해보자. <code>MemberServer</code>는 회원이 가입했을 때 <code>MemberJoinedEvent</code>를 생성해서 <code>EventQueue</code>에 넣기만 하면 끝이다. 뒤에 무슨 일이 일어나든 <code>관심사</code> 밖의 일이다. <code>MailServer</code>가 <code>EventQueue</code>에서 Event를 받아 가서 처리하든, <code>EventQueue</code>가 <code>MailServer</code>에 Event를 밀어주는 방식으로 처리하든 관심 없는 거다.</p><ul><li>MailServer, SmsServer의 로직 변화가 MemberServer에 영향을 주지 않는다.</li><li>MemberServer는 자신의 업무(도메인) 영역만 잘 처리하면 된다.</li></ul><h1 id="구현-4-Event도-비동기로-처리하기"><a href="#구현-4-Event도-비동기로-처리하기" class="headerlink" title="구현 4. Event도 비동기로 처리하기"></a>구현 4. Event도 비동기로 처리하기</h1><h2 id="Spring-Application-설정"><a href="#Spring-Application-설정" class="headerlink" title="Spring Application 설정"></a>Spring Application 설정</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//..</span></span><br><span class="line"><span class="meta">@EnableAsync</span>(proxyTargetClass = <span class="keyword">true</span>)</span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleEventApplication</span> <span class="keyword">implements</span> <span class="title">CommandLineRunner</span> </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="MemberJoinEvnetListener"><a href="#MemberJoinEvnetListener" class="headerlink" title="MemberJoinEvnetListener"></a>MemberJoinEvnetListener</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MemberJoinedEventListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SmsService smsService;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> EmailService emailService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Async</span></span><br><span class="line">    <span class="meta">@TransactionalEventListener</span>(phase = TransactionPhase.AFTER_COMMIT, classes = EventMemberJoinService.MemberJoinedEvent<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">    <span class="title">public</span> <span class="title">void</span> <span class="title">handle</span>(<span class="title">EventMemberJoinService</span>.<span class="title">MemberJoinedEvent</span> <span class="title">event</span>) </span>&#123;</span><br><span class="line">        Member member = event.getMember();</span><br><span class="line">        emailService.sendEmail(member.getEmail(), EmailTemplateType.JOIN);</span><br><span class="line">        smsService.sendSms(member.getPhoneNo(), SmsTemplateType.JOIN);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>@Async</code>를 사용하여 비동기로 구현할 수 있다.</p><h2 id="결과-1"><a href="#결과-1" class="headerlink" title="결과"></a>결과</h2><p><strong>성공</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">INFO  [cTaskExecutor-1] c.p.s.s.service.email.EmailService       : send JOIN email to test@test.com</span><br><span class="line">INFO  [cTaskExecutor-1] c.p.s.s.service.sms.SuccessSmsService    : send JOIN sms to 012-3456-7890</span><br><span class="line">INFO  [           main] c.p.s.s.SimpleEventApplication           : member count : 1</span><br></pre></td></tr></table></figure><p><strong>실패</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">INFO  [cTaskExecutor-1] c.p.s.s.service.email.EmailService       : send JOIN email to test@test.com</span><br><span class="line">INFO  [cTaskExecutor-1] c.p.s.s.service.sms.FailSmsService       : send JOIN sms to 012-3456-7890</span><br><span class="line">INFO  [           main] c.p.s.s.SimpleEventApplication           : member count : 1</span><br><span class="line">ERROR [cTaskExecutor-1] .a.i.SimpleAsyncUncaughtExceptionHandler : Unexpected error occurred invoking async method &#39;public void com.parfait.study.simpleevent.service.event.AsyncMemberJoinedEventListener.handle(com.parfait.study.simpleevent.service.member.AsyncEventMemberJoinService$AsyncMemberJoinedEvent)&#39;.</span><br></pre></td></tr></table></figure><h2 id="설명-3"><a href="#설명-3" class="headerlink" title="설명"></a>설명</h2><p>간단하게 spring에서 지원해주는 비동기를 사용할 수 있다. spring에서 어떻게 비동기를 지원해주는지는 본 문서에서는 설명하지 않겠다. 때문에 <code>TaskExecutor</code>도 따로 지정하지 않고 사용했다. spring에서 비동기를 사용하는 방법이 궁금하면 <a href="https://docs.spring.io/spring/docs/5.0.4.RELEASE/spring-framework-reference/integration.html#scheduling" target="_blank" rel="noopener">레퍼런스</a>를 읽어보자.</p><h1 id="구현-5-AOP를-사용해서-Advisor에서-Event-발급하기"><a href="#구현-5-AOP를-사용해서-Advisor에서-Event-발급하기" class="headerlink" title="구현 5. AOP를 사용해서 Advisor에서 Event 발급하기"></a>구현 5. AOP를 사용해서 Advisor에서 Event 발급하기</h1><p>앞서 Event를 발급하였을 때 <code>// gray zone</code>의 주석을 달았다. 왜 <code>gray zone</code>이라고 했을까? <code>MemberJoinedEvent</code>를 <code>MemberJoinedService</code>에서 발급하는 것이 맞을까? 개발자 취향에 따라 나뉠 수 있을 것 같다. 만약 <code>DDD</code>를 기반으로 작성한 코드였다면 100% <code>NO!</code>라고 할 수 있다. 하지만 지금의 예제는 <code>Service</code>에서 대부분의 로직을 처리한다. 때문에 누군가는 <code>Service</code>에서 Event를 발급해도 된다고 할 것이고, 누군가는 Service는 핵심 로직에만 집중했으면 좋겠다고 할 것이다.<br>여기서는 후자를 지지해서 AOP로 <code>gray zone</code>의 코드를 제거해보려고 한다. Event를 발급하는 행위를 하나의 공통된 방식에 따라 처리할 수 있는 관심사로 취급하겠다.</p><blockquote><p>서비스에서 Event를 발급하겠다는 전자의 선택도 존중한다. AOP는 공통 관심사를 분리해서 더 나은 POJO를 만들 수 있게 해준다. 하지만 익숙하지 않은 개발자에게는, 전체 애플리케이션 동작을 파악하는 데에 애를 먹을 수 있다. 혼자 개발하는 개발자가 아니라면, 내가 속한 팀에서 어떠한 방법의 프로그래밍이 가장 큰 효율을 낼 수 있는지 파악해봐야 할 것이다.</p></blockquote><h2 id="의존성-설정"><a href="#의존성-설정" class="headerlink" title="의존성 설정"></a>의존성 설정</h2><p>spring의 AOP를 사용할 것이니 관련된 의존성을 추가하자</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">dependencies</span> &#123;</span><br><span class="line">  <span class="keyword">compile</span>(<span class="string">'org.springframework.boot:spring-boot-starter-aop'</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Spring-Application-설정-1"><a href="#Spring-Application-설정-1" class="headerlink" title="Spring Application 설정"></a>Spring Application 설정</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//..</span></span><br><span class="line"><span class="meta">@EnableAspectJAutoProxy</span>(proxyTargetClass = <span class="keyword">true</span>)</span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleEventApplication</span> <span class="keyword">implements</span> <span class="title">CommandLineRunner</span> </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="MemberJoinService"><a href="#MemberJoinService" class="headerlink" title="MemberJoinService"></a>MemberJoinService</h2><p>최종적으로 아래 코드가 동작하도록 만들 것이다. 기존에 <code>eventPublisher.publishEvent(new MemberJoinedEvent(member));</code>가 없어졌다. 즉 <code>MemberJoinService</code>는 더 이상 <code>ApplicationEventPublisher</code>에 의존하지 않으며, 그 존재를 모르게 되었다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Profile</span>(<span class="string">"aop-async-event"</span>)</span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AopAsyncEventMemberJoinService</span> <span class="keyword">implements</span> <span class="title">MemberJoinService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MemberMapper memberMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PublishEvent</span>(eventType = AopAsyncMemberJoinedEvent<span class="class">.<span class="keyword">class</span>, <span class="title">params</span> </span>= <span class="string">"#&#123;T(com.parfait.study.simpleevent.model.SendableParameter).create(email, phoneNo)&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Member <span class="title">join</span><span class="params">(Member member)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        memberMapper.insert(member);</span><br><span class="line">        <span class="keyword">return</span> member;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>AOP는 <code>@PublishEvent</code>를 대상으로 실행된다. <code>eventType</code>을 보고 어떤 타입의 Event를 발급할 것이며, <code>params</code>를 해석해서 알맞은 생성자 파라미터를 던져준다.</p><h2 id="발행할-Event-정의"><a href="#발행할-Event-정의" class="headerlink" title="발행할 Event 정의"></a>발행할 Event 정의</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 해당 소스의 구현체는 목적에 따라 기본 생성자 혹은 하나의 값을 받는 생성자를 가질 것.</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">EventHoldingValue</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function">T <span class="title">getValue</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">AopAsyncMemberJoinedEvent</span> <span class="keyword">implements</span> <span class="title">EventHoldingValue</span>&lt;<span class="title">SendableParameter</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Getter</span></span><br><span class="line">    <span class="keyword">private</span> SendableParameter value;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AopAsyncMemberJoinedEvent</span><span class="params">(@NonNull SendableParameter sendableParameter)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.value = sendableParameter;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SendableParameter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String email;</span><br><span class="line">    <span class="keyword">private</span> String phoneNo;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SendableParameter <span class="title">create</span><span class="params">(String email, String phoneNo)</span> </span>&#123;</span><br><span class="line">        SendableParameter parameter = <span class="keyword">new</span> SendableParameter();</span><br><span class="line">        parameter.setEmail(email);</span><br><span class="line">        parameter.setPhoneNo(phoneNo);</span><br><span class="line">        <span class="keyword">return</span> parameter;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>value</code>를 가지는 Event를 뜻하는 <code>EventHoldingValue&lt;T&gt;</code>를 정의하고 이를 구현한 <code>AopAsyncMemberJoinedEvent</code>를 위와 같이 정의했다. <code>SendableParameter</code>는 앞서 봤던 <code>@PublishEvent(params)</code>에서 정의된 SpEL이 실행되어 생성된다.</p><h2 id="AOP관련-코드"><a href="#AOP관련-코드" class="headerlink" title="AOP관련 코드"></a>AOP관련 코드</h2><h3 id="PublishEvent"><a href="#PublishEvent" class="headerlink" title="@PublishEvent"></a>@PublishEvent</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Target</span>(ElementType.METHOD)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> PublishEvent &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * return이 비어있는 경우 new eventType()</span></span><br><span class="line"><span class="comment">    * params가 비어있는 경우 new eventType(returnValue)</span></span><br><span class="line"><span class="comment">    * params가 문자열인 경우 new event</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    Class&lt;? extends EventHoldingValue&gt; eventType();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 빈값, 문자열, SpEL('#&#123;표현식&#125;')을 사용할 수 있음</span></span><br><span class="line">    <span class="function">String <span class="title">params</span><span class="params">()</span> <span class="keyword">default</span> ""</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Pointcut을 제공할 애노테이션을 정의한다.</p><h3 id="Advisor"><a href="#Advisor" class="headerlink" title="Advisor"></a>Advisor</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PublishEventAspect</span> <span class="keyword">implements</span> <span class="title">ApplicationEventPublisherAware</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Pointcut</span>(<span class="string">"@annotation(publishEvent)"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">pointcut</span><span class="params">(PublishEvent publishEvent)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * return값 없으면 new eventType()</span></span><br><span class="line"><span class="comment">    * params값 없으면 new eventType(retVal)</span></span><br><span class="line"><span class="comment">    * params값이 문자열이면 new eventType(params)</span></span><br><span class="line"><span class="comment">    * params값이 SpEL이면 parse 후에 evnetType(params)</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="meta">@AfterReturning</span>(pointcut = <span class="string">"pointcut(publishEvent)"</span>, returning = <span class="string">"retVal"</span>, argNames = <span class="string">"publishEvent,retVal"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterReturning</span><span class="params">(PublishEvent publishEvent, Object retVal)</span> <span class="keyword">throws</span> NoSuchMethodException, IllegalAccessException, InvocationTargetException, InstantiationException </span>&#123;</span><br><span class="line"></span><br><span class="line">        Object event;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (retVal == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// method 반환 값이 void일 때에는 new eventType(this);</span></span><br><span class="line">            event = publishEvent.eventType()</span><br><span class="line">                                .getDeclaredConstructor()</span><br><span class="line">                                .newInstance();</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (StringUtils.isEmpty(publishEvent.params())) &#123;</span><br><span class="line">            <span class="comment">// params가 비어 있는 경우 new eventType(retVal);</span></span><br><span class="line">            event = publishEvent.eventType()</span><br><span class="line">                                .getConstructor(retVal.getClass())</span><br><span class="line">                                .newInstance(retVal);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isSpel(publishEvent.params())) &#123;</span><br><span class="line">            <span class="comment">// params가 spel인 경우 new eventType(parsed(publishEvent.params()))</span></span><br><span class="line">            String spel = publishEvent.params().replaceAll(spelRegex, <span class="string">"$1"</span>);</span><br><span class="line">            Object constructArg = expressionParser.parseExpression(spel).getValue(retVal);</span><br><span class="line">            event = publishEvent.eventType()</span><br><span class="line">                                .getDeclaredConstructor(constructArg.getClass())</span><br><span class="line">                                .newInstance(constructArg);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// params가 그냥 string인 경우 new eventType(publishEvent.params());</span></span><br><span class="line">            event = publishEvent.eventType().getConstructor(String<span class="class">.<span class="keyword">class</span>).<span class="title">newInstance</span>(<span class="title">publishEvent</span>.<span class="title">params</span>())</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        eventPublisher.publishEvent(event);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isSpel</span><span class="params">(String params)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> spelPattern.matcher(params).matches();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setApplicationEventPublisher</span><span class="params">(ApplicationEventPublisher applicationEventPublisher)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.eventPublisher = applicationEventPublisher;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="실행-결과"><a href="#실행-결과" class="headerlink" title="실행 결과"></a>실행 결과</h2><p><strong>성공</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">INFO  [cTaskExecutor-1] c.p.s.s.service.email.EmailService       : send JOIN email to test@test.com</span><br><span class="line">INFO  [cTaskExecutor-1] c.p.s.s.service.sms.SuccessSmsService    : send JOIN sms to 012-3456-7890</span><br><span class="line">INFO  [           main] c.p.s.s.SimpleEventApplication           : member count : 1</span><br></pre></td></tr></table></figure><p><strong>실패</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">INFO  [cTaskExecutor-1] c.p.s.s.service.email.EmailService       : send JOIN email to test@test.com</span><br><span class="line">INFO  [cTaskExecutor-1] c.p.s.s.service.sms.FailSmsService       : send JOIN sms to 012-3456-7890</span><br><span class="line">INFO  [           main] c.p.s.s.SimpleEventApplication           : member count : 1</span><br><span class="line">ERROR [cTaskExecutor-1] .a.i.SimpleAsyncUncaughtExceptionHandler : Unexpected error occurred invoking async method &#39;public void com.parfait.study.simpleevent.service.event.AopAsyncMemberJoinedEventListener.handle(com.parfait.study.simpleevent.service.member.AopAsyncEventMemberJoinService$AopAsyncMemberJoinedEvent)&#39;.</span><br></pre></td></tr></table></figure><h2 id="설명-4"><a href="#설명-4" class="headerlink" title="설명"></a>설명</h2><p>Event를 발급하는 공통된 행위를 애노테이션과 AOP를 사용해서 구현해보았다. 이로써 <code>Service</code> 계층의 로직에서는 특별한 일이 아니면 Event를 발급할 소스가 등장하지 않을 것이고, <code>ApplicationEventPublisher</code>와의 의존 관계도 끊을 수 있다. </p><p>여기서 한 번 더 리팩토링하려고 한다. 아직도 문제점이 있다. 바로 이벤트 처리에 <code>순서</code>가 존재한다는 점이다.</p><h1 id="구현-6-순서가-필요있나-Best-Effort"><a href="#구현-6-순서가-필요있나-Best-Effort" class="headerlink" title="구현 6. 순서가 필요있나? Best Effort!"></a>구현 6. 순서가 필요있나? Best Effort!</h1><p>비동기를 처리하는 데 굳이 순서가 필요할까? 여태까지의 코드를 보면 <code>Email</code>이 성공해야 <code>Sms</code>가 성공한다. 실제로 우리의 로직은 이러한 순서를 필요로 하지 않는다. <code>MemberJoinedEvent</code>를 발급했을 때, 이를 처리할 핸들러를 여럿 등록하고 각각의 thread를 격리해보자.</p><h3 id="설명-5"><a href="#설명-5" class="headerlink" title="설명"></a>설명</h3><p><code>MemberJoinService</code>의 구현체에서 달라진 부분은 없다</p><h2 id="EventListeners"><a href="#EventListeners" class="headerlink" title="EventListeners"></a>EventListeners</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EmailEventListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> EmailService emailService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Async</span></span><br><span class="line">    <span class="meta">@TransactionalEventListener</span>(phase = TransactionPhase.AFTER_COMMIT, classes = DistributedAopAsyncMemberJoinedEvent<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">    <span class="title">public</span> <span class="title">void</span> <span class="title">handleMemberJoinedEvent</span>(<span class="title">DistributedAopAsyncMemberJoinedEvent</span> <span class="title">event</span>) </span>&#123;</span><br><span class="line">        SendableParameter parameter = event.getValue();</span><br><span class="line">        emailService.sendEmail(parameter.getEmail(), parameter.getEmailTemplateType());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SmsEventListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SmsService smsEventService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Async</span></span><br><span class="line">    <span class="meta">@TransactionalEventListener</span>(phase = TransactionPhase.AFTER_COMMIT, classes = DistributedAopAsyncMemberJoinedEvent<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">    <span class="title">public</span> <span class="title">void</span> <span class="title">sendEmail</span>(<span class="title">DistributedAopAsyncMemberJoinedEvent</span> <span class="title">event</span>) </span>&#123;</span><br><span class="line">        SendableParameter request = event.getValue();</span><br><span class="line">        smsEventService.sendSms(request.getPhoneNo(), request.getSmsTemplateType());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="결과-2"><a href="#결과-2" class="headerlink" title="결과"></a>결과</h2><p><strong>성공</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">INFO  [cTaskExecutor-2] c.p.s.s.service.sms.SuccessSmsService    : send JOIN sms to 012-3456-7890</span><br><span class="line">INFO  [cTaskExecutor-1] c.p.s.s.service.email.EmailService       : send JOIN email to test@test.com</span><br><span class="line">INFO  [           main] c.p.s.s.SimpleEventApplication           : member count : 1</span><br></pre></td></tr></table></figure><p><strong>실패</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">INFO  [cTaskExecutor-1] c.p.s.s.service.email.EmailService       : send JOIN email to test@test.com</span><br><span class="line">INFO  [cTaskExecutor-2] c.p.s.s.service.sms.FailSmsService       : send JOIN sms to 012-3456-7890</span><br><span class="line">INFO  [           main] c.p.s.s.SimpleEventApplication           : member count : 1</span><br><span class="line">ERROR [cTaskExecutor-2] .a.i.SimpleAsyncUncaughtExceptionHandler : Unexpected error occurred invoking async method &#39;public void com.parfait.study.simpleevent.service.sms.SmsEventService.sendEmail(com.parfait.study.simpleevent.service.member.DistributedAopAsyncEventMemberJoinService$DistributedAopAsyncMemberJoinedEvent)&#39;.</span><br></pre></td></tr></table></figure><h2 id="설명-6"><a href="#설명-6" class="headerlink" title="설명"></a>설명</h2><p>Email과 Sms를 다른 thread에서 보내고 있는 것을 확인할 수 있다.<br>말만 어렵게 했지 내용은 간단하다. Event에 대한 <code>Listener(subscriber, 혹은 handler)</code>는 필요하면 언제든지 추가하면 된다. 또한 <code>@Async</code> 지원도 가능하다.</p><h1 id="마무리"><a href="#마무리" class="headerlink" title="마무리"></a>마무리</h1><p>Spring에서 지원하는 Event 처리 방법과 실제로 어떻게 사용할 수 있을지 살펴보았다. 가장 중요한 것은 Event를 사용하는 이유를 깨닫는 것이다. 가장 큰 이유는 Event 방식은 <code>시스템 간의 결합도를 낮춰주는 것</code>이다. 결합도를 낮춰서 서비스 로직에 집중하고, 장애 전파에 강한 애플리케이션을 작성할 수 있다. 비동기로 실행하는 것도 Spring의 지원을 받아 간단하게 처리할 수 있다. </p><p>물론 이러한 Event 방식도 문제는 있다. Global Transaction을 어떻게 쥐고 갈 것인지 하는 것이다. 본문에서는 하나의 Application 내에서 Event를 발생시키고 처리했는데, Event-Driven Architecture의 MSA 환경을 구성하는 경우, 어떻게 Transaction과 Latency 사이에서 타협점을 찾을 것인가는, 현재 이 업계의 큰 이슈 중 하나가 아닐까? 아직까지는 Event를 사용하면서 완벽한 Transaction을 지원하는 것은 어려워 보인다. 서비스 간의 결합도를 떨어뜨리기 위해, Event를 위한 별도의 모듈(RabbitMQ, Kafka)을 사용하는 중에 데이터 손실 등 넘어야 할 난관도 많이 있다. 하지만 Event를 사용하는 구조 자체는 매우 매력적이며, 개발자에게 더 많은 선택지를 가져다준다.</p><p>Spring은 개발자로 하여금 POJO를 작성하여 OOP를 할 수 있도록 유도한다. Spring Event 또한 개발자가 OOP를 더 잘할 수 있도록 도와주는 장치다. 더 유연한 구조로 나아가는 방법 중의 하나로 충분히 써먹을 수 있을 것이라 믿어 의심치 않는다.</p><p>소스 코드 : <a href="https://github.com/supawer0728/simple-event" target="_blank" rel="noopener">https://github.com/supawer0728/simple-event</a></p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;서론&quot;&gt;&lt;a href=&quot;#서론&quot; class=&quot;headerlink&quot; title=&quot;서론&quot;&gt;&lt;/a&gt;서론&lt;/h1&gt;&lt;p&gt;원래 글을 쓰기 위해 준비하던 내용은 Event를 강조하는 것이었는데, 준비를 하다 보니 Async와 AOP를 다 쓰게 되어버렸다.&lt;/p&gt;
&lt;p&gt;이번 글에서는 하나의 transaction 안에서 많은 일을 처리하는 소스 코드를 두고, 아래와 같이 점진적으로 리팩토링해나가는 과정에 대해 이야기하려고 한다. &lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;하나의 transaction으로 처리하기&lt;/li&gt;
&lt;li&gt;transaction 내에 처리하지 않아도 될 부분은, transaction이 끝난 후에 처리하기&lt;/li&gt;
&lt;li&gt;Event 사용하기&lt;/li&gt;
&lt;li&gt;Event도 비동기로 처리하기&lt;/li&gt;
&lt;li&gt;AOP를 사용해서 Advisor에서 Event 발급하기&lt;/li&gt;
&lt;li&gt;순서가 필요 있나? Best Effort!&lt;/li&gt;
&lt;/ol&gt;
    
    </summary>
    
      <category term="spring" scheme="https://supawer0728.github.io/categories/spring/"/>
    
      <category term="practice" scheme="https://supawer0728.github.io/categories/spring/practice/"/>
    
    
      <category term="spring" scheme="https://supawer0728.github.io/tags/spring/"/>
    
      <category term="event" scheme="https://supawer0728.github.io/tags/event/"/>
    
      <category term="practice" scheme="https://supawer0728.github.io/tags/practice/"/>
    
  </entry>
  
  <entry>
    <title>(Spring)다중 DataSource 처리</title>
    <link href="https://supawer0728.github.io/2018/03/22/spring-multi-transaction/"/>
    <id>https://supawer0728.github.io/2018/03/22/spring-multi-transaction/</id>
    <published>2018-03-22T04:54:08.000Z</published>
    <updated>2020-03-04T08:18:02.751Z</updated>
    
    <content type="html"><![CDATA[<h1 id="서론"><a href="#서론" class="headerlink" title="서론"></a>서론</h1><p>Spring Application을 만들면서 여러 <code>DataSource</code>와 <code>transaction</code>이 존재하고 하나의 transaction 내에 commit과 rollback이 잘 동작하도록 하려면 어떻게 설정해야 할까? 실제로 구현을 해본 적은 없지만 세 가지 방법이 머릿속에 떠올랐다.</p><ul><li><code>@Transactional</code>의 propagation을 이용</li><li><code>spring-data-commons</code>의 <code>ChainedTransactionManager</code> 이용</li><li><code>JtaTransactionManager</code> 이용</li></ul><p>이 방법들이 실제로 써먹을 수 있을지 확인해보려고 한다.</p><a id="more"></a><h1 id="구현-1-Transactional의-propagation-이용"><a href="#구현-1-Transactional의-propagation-이용" class="headerlink" title="구현 1 - @Transactional의 propagation 이용"></a>구현 1 - @Transactional의 propagation 이용</h1><h2 id="Transactional-propagation에-대한-간단한-설명"><a href="#Transactional-propagation에-대한-간단한-설명" class="headerlink" title="Transactional.propagation에 대한 간단한 설명"></a>Transactional.propagation에 대한 간단한 설명</h2><p>Spring의 <code>@Transactional</code>의 <code>propagation</code> 속성으로 다음과 같은 설정을 할 수 있다. 자세한 설명을 해둔 <a href="http://springsource.tistory.com/136" target="_blank" rel="noopener">블로그(Rednics Blog)</a>가 있어 링크를 남긴다. <a href="https://docs.spring.io/spring/docs/4.2.x/spring-framework-reference/html/transaction.html#tx-propagation" target="_blank" rel="noopener">spring reference</a>도 참조하자</p><ul><li>REQUIRED : 기본 설정, 진행중인 transaction이 있으면 참여, 없으면 새로 생성</li><li>SUPPORTS : 진행중인 transaction이 있으면 참여, 없으면 transaction 없이 실행</li><li>MANDATORY : 진행중인 transaction이 있으면 참여, 없으면 예외.</li><li>REQUIRES_NEW : 새로운 transaction 시작. 진행중인 transaction은 보류.</li><li>NOT_SUPPORTED : 진행중인 transaction이 있으면 보류, transaction 없이 실행.</li><li>NEVER : transaction없이 실행. 진행중인 transaction이 있으면 예외.</li><li>NESTED : 중첩 transaction 실행. 자식 tx은 부모 tx에게 영향을 주지 않지만, 부모는 자식에게 영향을 줌.</li></ul><h2 id="요구-사항"><a href="#요구-사항" class="headerlink" title="요구 사항"></a>요구 사항</h2><img  src=http://www.plantuml.com/plantuml/svg/Yov9BIvnpiyhAShFoKajYbNGrRLJYBR9JSrDIYqAgR2BoSl9JyzC3aujAijCJerLi5B8JIt9o4zHUDEzvEsqJYuyIZ5CWZ2HZ3BKKyZCAqujAl45on0sB2a_iIW5B0jc8Hbb13FA2IIXyMP6nvkPErvlcFEcUQwY9W00><p>하고자 하는 일을 다이어그램으로 나타내면 위와 같다.<br>주로 사용하는 DataSource와 transaction이 존재하고, 거기에 부가 transaction이 참여하는 모양새다. 2번에서 예외가 발생했을 때, 2번도 rollback이 되고 1번도 같이 rollback이 되었으면 좋겠다. </p><p>memberTx와 boardTx가 <code>REQUIRED</code>, <code>REQUIRES_NEW</code>, <code>NESTED</code>의 propagation을 가질 수 있을 때, 총 9가지 경우의 수가 나온다. 어떤 조합에서 <code>commit</code>과 <code>rollback</code>이 어떻게 실행될지 직접 구현해보겠다.</p><p>다음 단락부터 이를 구현한 예제가 나올텐데, 좀 지루한 내용이라 결과만 알고 싶다면 바로 결론으로 가자.</p><h2 id="의존성"><a href="#의존성" class="headerlink" title="의존성"></a>의존성</h2><p>본문에서는 <code>spring-boot</code>, <code>mysql(docker 사용)</code>, <code>mybatis</code>를 사용한다.<br><code>spring-boot</code>의 버전은 <code>2.0.0.RELEASE</code>다.</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">dependencies</span> &#123;</span><br><span class="line">    <span class="keyword">compile</span>(<span class="string">'org.springframework.boot:spring-boot-starter-web'</span>)</span><br><span class="line">    <span class="keyword">compile</span>(<span class="string">'org.mybatis.spring.boot:mybatis-spring-boot-starter:1.3.2'</span>)</span><br><span class="line">    compileOnly(<span class="string">'org.projectlombok:lombok'</span>)</span><br><span class="line">    <span class="keyword">runtime</span>(<span class="string">'mysql:mysql-connector-java'</span>)</span><br><span class="line">    testCompile(<span class="string">'org.springframework.boot:spring-boot-starter-test'</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="SpringApplication-설정"><a href="#SpringApplication-설정" class="headerlink" title="SpringApplication 설정"></a>SpringApplication 설정</h2><h3 id="application-yml"><a href="#application-yml" class="headerlink" title="application.yml"></a>application.yml</h3><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">hikari1:</span></span><br><span class="line">      <span class="attr">username:</span> <span class="string">multitxtest</span></span><br><span class="line">      <span class="attr">password:</span> <span class="string">multitxtest</span></span><br><span class="line">      <span class="attr">driver-class-name:</span> <span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line">      <span class="attr">url:</span> <span class="string">jdbc:mysql://127.0.0.1:11306/multi_tx_test</span></span><br><span class="line">    <span class="attr">hikari2:</span></span><br><span class="line">      <span class="attr">url:</span></span><br><span class="line">      <span class="attr">username:</span> <span class="string">multitxtest</span></span><br><span class="line">      <span class="attr">password:</span> <span class="string">multitxtest</span></span><br><span class="line">      <span class="attr">driver-class-name:</span> <span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line">      <span class="attr">url:</span> <span class="string">jdbc:mysql://127.0.0.1:11307/multi_tx_test</span></span><br></pre></td></tr></table></figure><h3 id="두-개의-SqlSession-생성"><a href="#두-개의-SqlSession-생성" class="headerlink" title="두 개의 SqlSession 생성"></a>두 개의 SqlSession 생성</h3><h4 id="Board용-SqlSession"><a href="#Board용-SqlSession" class="headerlink" title="Board용 SqlSession"></a>Board용 SqlSession</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// board</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties</span>(Hikari2Properties<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">BoardSqlSessionConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">boardDataSource</span><span class="params">(Hikari2Properties properties)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> DataSourceCreator.createHikariDataSource(properties);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> PlatformTransactionManager <span class="title">boardTxManager</span><span class="params">(DataSource boardDataSource)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DataSourceTransactionManager(boardDataSource);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SqlSessionFactory <span class="title">boardSqlSessionFactory</span><span class="params">(DataSource boardDataSource)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        SqlSessionFactoryBean factoryBean = <span class="keyword">new</span> SqlSessionFactoryBean();</span><br><span class="line">        factoryBean.setDataSource(boardDataSource);</span><br><span class="line">        <span class="keyword">return</span> factoryBean.getObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span>(destroyMethod = <span class="string">"clearCache"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> SqlSession <span class="title">boardSqlSession</span><span class="params">(SqlSessionFactory boardSqlSessionFactory)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SqlSessionTemplate(boardSqlSessionFactory);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> MapperFactoryBean&lt;BoardMapper&gt; <span class="title">boardMapper</span><span class="params">(SqlSessionFactory boardSqlSessionFactory)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        MapperFactoryBean&lt;BoardMapper&gt; factoryBean = <span class="keyword">new</span> MapperFactoryBean&lt;&gt;(BoardMapper<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        factoryBean.setSqlSessionFactory(boardSqlSessionFactory);</span><br><span class="line">        <span class="keyword">return</span> factoryBean;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="Member용-SqlSession"><a href="#Member용-SqlSession" class="headerlink" title="Member용 SqlSession"></a>Member용 SqlSession</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// member</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties</span>(Hikari1Properties<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">MemberSqlSessionConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">memberDataSource</span><span class="params">(Hikari1Properties properties)</span> </span>&#123; ... &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@Primary</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> PlatformTransactionManager <span class="title">memberTxManager</span><span class="params">(DataSource memberDataSource)</span> </span>&#123; ... &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SqlSessionFactory <span class="title">memberSqlSessionFactory</span><span class="params">(DataSource memberDataSource)</span> <span class="keyword">throws</span> Exception </span>&#123; ... &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span>(destroyMethod = <span class="string">"clearCache"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> SqlSession <span class="title">memberSqlSession</span><span class="params">(SqlSessionFactory memberSqlSessionFactory)</span> </span>&#123; ... &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> MapperFactoryBean&lt;MemberMapper&gt; <span class="title">memberMapper</span><span class="params">(SqlSessionFactory memberSqlSessionFactory)</span> </span>&#123; ... &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="DataSourceCreator"><a href="#DataSourceCreator" class="headerlink" title="DataSourceCreator"></a>DataSourceCreator</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@UtilityClass</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DataSourceCreator</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">createHikariDataSource</span><span class="params">(DataSourceProperties properties)</span> </span>&#123;</span><br><span class="line">        HikariDataSource dataSource = <span class="keyword">new</span> HikariDataSource();</span><br><span class="line">        dataSource.setJdbcUrl(properties.getUrl());</span><br><span class="line">        dataSource.setUsername(properties.getUsername());</span><br><span class="line">        dataSource.setPassword(properties.getPassword());</span><br><span class="line">        dataSource.setDriverClassName(properties.getDriverClassName());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> dataSource;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="DAO"><a href="#DAO" class="headerlink" title="DAO"></a>DAO</h2><h3 id="BoardMapper"><a href="#BoardMapper" class="headerlink" title="BoardMapper"></a>BoardMapper</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BoardMapper</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Insert</span>(<span class="string">"INSERT INTO board(title, content) VALUES(#&#123;title&#125;, #&#123;content&#125;)"</span>)</span><br><span class="line">    <span class="meta">@SelectKey</span>(statement = <span class="string">"SELECT LAST_INSERT_ID()"</span>, keyColumn = <span class="string">"id"</span>, keyProperty = <span class="string">"id"</span>, before = <span class="keyword">false</span>, resultType = Long<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">    <span class="title">int</span> <span class="title">insert</span>(<span class="title">Board</span> <span class="title">board</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Delete</span>(<span class="string">"TRUNCATE TABLE board"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">truncate</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="MemberMapper"><a href="#MemberMapper" class="headerlink" title="MemberMapper"></a>MemberMapper</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MemberMapper</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Insert</span>(<span class="string">"INSERT INTO member(name, age) VALUES(#&#123;name&#125;, #&#123;age&#125;)"</span>)</span><br><span class="line">    <span class="meta">@SelectKey</span>(statement = <span class="string">"SELECT LAST_INSERT_ID()"</span>, keyColumn = <span class="string">"id"</span>, keyProperty = <span class="string">"id"</span>, before = <span class="keyword">false</span>, resultType = Long<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">    <span class="title">int</span> <span class="title">insert</span>(<span class="title">Member</span> <span class="title">member</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Delete</span>(<span class="string">"TRUNCATE TABLE member"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">truncate</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h2><h3 id="MemberService"><a href="#MemberService" class="headerlink" title="MemberService"></a>MemberService</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Transactional</span>(transactionManager = <span class="string">"memberTxManager"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MemberService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MemberMapper memberMapper;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveWithRequired</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        memberMapper.insert(Member.createForTest(<span class="number">1</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Transactional</span>(transactionManager = <span class="string">"memberTxManager"</span>, propagation = Propagation.REQUIRES_NEW)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveWithRequiresNew</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        memberMapper.insert(Member.createForTest(<span class="number">1</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Transactional</span>(transactionManager = <span class="string">"memberTxManager"</span>, propagation = Propagation.NESTED)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveWithNested</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        memberMapper.insert(Member.createForTest(<span class="number">1</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="BoardService"><a href="#BoardService" class="headerlink" title="BoardService"></a>BoardService</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Transactional</span>(<span class="string">"boardTxManager"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BoardService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> BoardMapper boardMapper;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">saveWithRequired</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        boardMapper.insert(Board.createForTest(<span class="number">1</span>));</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"this method throw exception"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Transactional</span>(transactionManager = <span class="string">"boardTxManager"</span>, propagation = Propagation.REQUIRES_NEW)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">saveWithRequiresNew</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        boardMapper.insert(Board.createForTest(<span class="number">1</span>));</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"this method throw exception"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Transactional</span>(transactionManager = <span class="string">"boardTxManager"</span>, propagation = Propagation.NESTED)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">saveWithNested</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        boardMapper.insert(Board.createForTest(<span class="number">1</span>));</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"this method throw exception"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="LogicService"><a href="#LogicService" class="headerlink" title="LogicService"></a>LogicService</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LogicService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MemberService memberService;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> BoardService boardService;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">required_required</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        memberService.saveWithRequired();</span><br><span class="line">        boardService.saveWithRequired();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">required_requiresNew</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        memberService.saveWithRequired();</span><br><span class="line">        boardService.saveWithRequiresNew();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">required_nested</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        memberService.saveWithRequired();</span><br><span class="line">        boardService.saveWithNested();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">requiresNew_required</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        memberService.saveWithRequiresNew();</span><br><span class="line">        boardService.saveWithRequired();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">requiresNew_requiresNew</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        memberService.saveWithRequiresNew();</span><br><span class="line">        boardService.saveWithRequiresNew();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">requiresNew_nested</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        memberService.saveWithRequiresNew();</span><br><span class="line">        boardService.saveWithNested();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">nested_required</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        memberService.saveWithNested();</span><br><span class="line">        boardService.saveWithRequired();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">nested_requiresNew</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        memberService.saveWithNested();</span><br><span class="line">        boardService.saveWithRequiresNew();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">nested_nested</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        memberService.saveWithNested();</span><br><span class="line">        boardService.saveWithNested();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="결과"><a href="#결과" class="headerlink" title="결과"></a>결과</h2><h3 id="LogicService에-Transactional이-없는-경우"><a href="#LogicService에-Transactional이-없는-경우" class="headerlink" title="LogicService에 @Transactional이 없는 경우"></a>LogicService에 @Transactional이 없는 경우</h3><table><thead><tr><th>member propagation</th><th>board propagation</th><th>member insert</th><th>board insert</th></tr></thead><tbody><tr><td>required</td><td>required</td><td>commit</td><td>rollback</td></tr><tr><td>required</td><td>requires-new</td><td>commit</td><td>rollback</td></tr><tr><td>required</td><td>nested</td><td>commit</td><td>rollback</td></tr><tr><td>requires-new</td><td>required</td><td>commit</td><td>rollback</td></tr><tr><td>requires-new</td><td>requires-new</td><td>commit</td><td>rollback</td></tr><tr><td>requires-new</td><td>nested</td><td>commit</td><td>rollback</td></tr><tr><td>nested</td><td>required</td><td>commit</td><td>rollback</td></tr><tr><td>nested</td><td>requires-new</td><td>commit</td><td>rollback</td></tr><tr><td>nested</td><td>nested</td><td>commit</td><td>rollback</td></tr></tbody></table><h4 id="설명"><a href="#설명" class="headerlink" title="설명"></a>설명</h4><p>logicalService에서는 transaction이 시작되지 않는다. 따라서 memberService와 boardService는 각각 별개의 transaction에서 독립적으로 실행된다. 예외가 발생한 boardService의 내용만 rollback된다.</p><h3 id="LogicService에-Transactional이-있는-경우-memberTxManager"><a href="#LogicService에-Transactional이-있는-경우-memberTxManager" class="headerlink" title="LogicService에 @Transactional이 있는 경우(memberTxManager)"></a>LogicService에 @Transactional이 있는 경우(memberTxManager)</h3><table><thead><tr><th>member propagation</th><th>board propagation</th><th>member insert</th><th>board insert</th></tr></thead><tbody><tr><td>required</td><td>required</td><td>rollback</td><td>rollback</td></tr><tr><td>required</td><td>requires-new</td><td>rollback</td><td>rollback</td></tr><tr><td>required</td><td>nested</td><td>rollback</td><td>rollback</td></tr><tr><td>requires-new</td><td>required</td><td>commit</td><td>rollback</td></tr><tr><td>requires-new</td><td>requires-new</td><td>commit</td><td>rollback</td></tr><tr><td>requires-new</td><td>nested</td><td>commit</td><td>rollback</td></tr><tr><td>nested</td><td>required</td><td>rollback</td><td>rollback</td></tr><tr><td>nested</td><td>requires-new</td><td>rollback</td><td>rollback</td></tr><tr><td>nested</td><td>nested</td><td>rollback</td><td>rollback</td></tr></tbody></table><h4 id="설명-1"><a href="#설명-1" class="headerlink" title="설명"></a>설명</h4><ul><li><code>memberService</code>가 <code>REQUIRED</code>인 경우에는, <code>logicService</code>의 transaction의 영향을 받아서 rollback된다. </li><li><code>REQUIRES_NEW</code>인 경우에는 새로운 transaction을 생성하기 때문에 자신의 method execution이 종료됨과 함께 commit을 해버린다.</li><li><code>NESTED</code>의 경우, 부모 transaction의 영향을 받기 때문에 memberService의 내용은 rollback된다.</li></ul><p><strong>주의</strong></p><p>여기까지 테스트를 해보면, 정상적으로 동작하는 것처럼 보인다. 속지말자.</p><h3 id="LogicService에-Transactional이-있는-경우-boardTxManager"><a href="#LogicService에-Transactional이-있는-경우-boardTxManager" class="headerlink" title="LogicService에 @Transactional이 있는 경우(boardTxManager)"></a>LogicService에 @Transactional이 있는 경우(boardTxManager)</h3><table><thead><tr><th>member propagation</th><th>board propagation</th><th>member insert</th><th>board insert</th></tr></thead><tbody><tr><td>required</td><td>required</td><td>commit</td><td>rollback</td></tr><tr><td>required</td><td>requires-new</td><td>commit</td><td>rollback</td></tr><tr><td>required</td><td>nested</td><td>commit</td><td>rollback</td></tr><tr><td>requires-new</td><td>required</td><td>commit</td><td>rollback</td></tr><tr><td>requires-new</td><td>requires-new</td><td>commit</td><td>rollback</td></tr><tr><td>requires-new</td><td>nested</td><td>commit</td><td>rollback</td></tr><tr><td>nested</td><td>required</td><td>commit</td><td>rollback</td></tr><tr><td>nested</td><td>requires-new</td><td>commit</td><td>rollback</td></tr><tr><td>nested</td><td>nested</td><td>commit</td><td>rollback</td></tr></tbody></table><h4 id="설명-2"><a href="#설명-2" class="headerlink" title="설명"></a>설명</h4><p>확인하고 싶었던 부분 1이다. 서로 다른 transactionManager에서 관리하는 transaction context에 참여할 수 있을까? 결과를 확인해보니 불가능했다.</p><h3 id="전체-Transactional에서-boardTxManager를-쓰는-경우"><a href="#전체-Transactional에서-boardTxManager를-쓰는-경우" class="headerlink" title="전체 @Transactional에서 boardTxManager를 쓰는 경우"></a>전체 @Transactional에서 boardTxManager를 쓰는 경우</h3><table><thead><tr><th>member propagation</th><th>board propagation</th><th>member insert</th><th>board insert</th></tr></thead><tbody><tr><td>required</td><td>required</td><td>commit</td><td>rollback</td></tr><tr><td>required</td><td>requires-new</td><td>commit</td><td>rollback</td></tr><tr><td>required</td><td>nested</td><td>commit</td><td>rollback</td></tr><tr><td>requires-new</td><td>required</td><td>commit</td><td>rollback</td></tr><tr><td>requires-new</td><td>requires-new</td><td>commit</td><td>rollback</td></tr><tr><td>requires-new</td><td>nested</td><td>commit</td><td>rollback</td></tr><tr><td>nested</td><td>required</td><td>commit</td><td>rollback</td></tr><tr><td>nested</td><td>requires-new</td><td>commit</td><td>rollback</td></tr><tr><td>nested</td><td>nested</td><td>commit</td><td>rollback</td></tr></tbody></table><h4 id="설명-3"><a href="#설명-3" class="headerlink" title="설명"></a>설명</h4><p>확인하고 싶었던 부분 2다. <code>boardTxManager</code>가 <code>memberDataSource</code>에 대한 작업을 rollback할 수 있을까? 불가능하다.</p><h2 id="결론"><a href="#결론" class="headerlink" title="결론"></a>결론</h2><p>별다른 장치 없이 <code>DataSource</code> 두 개, <code>TransactionManager</code> 두 개를 사용하면 100% 위험하다. 원하는 동작을 장담할 수 없다. 이 방법은 얼른 벗어나야 한다. 이러한 설정을 사용하면서 어디에서 버그가 나고 있는지 찾지 않길 바란다.</p><h1 id="구현-2-ChainedTransactionManager-사용"><a href="#구현-2-ChainedTransactionManager-사용" class="headerlink" title="구현 2 - ChainedTransactionManager 사용"></a>구현 2 - ChainedTransactionManager 사용</h1><p>구현 2에서는 <code>spring-data-commons</code>에서 제공해주는 <code>ChainedTransactionManager</code>를 사용하려고 한다. javadoc을 읽어보면 다음과 같이 설명하고 있다.</p><blockquote><p>PlatformTransactionManager 구현체로 transaction 생성, commit, rollback을 위임자 패턴으로 구성한다. 이 구현체를 사용하는 것의 전제되는 가정은, transaction의 rollback을 야기하는 오류는 대부분 transaction이 완료되기 전, 혹은 가장 안쪽의 PlatformTransactionManager에서 발생한다는 것이다.</p><p>이 구현체의 인스턴스는 지정된 순서대로 transaction을 시작하고, 역순으로 commit/rollback한다. 즉, transaction을 중단시킬 가능성이 가장 큰 PlatformTransactionManager가 마지막에 설정되어야 한다. commit 중에 예외를 던지는 PlatformTransactionManager는 자동으로 다른 transaction manager의 rollback을 일으킨다.</p><footer><strong>ChainedTransactionManager</strong><cite><a href="https://docs.spring.io/spring-data/commons/docs/current/api/org/springframework/data/transaction/ChainedTransactionManager.html" target="_blank" rel="noopener">javadoc</a></cite></footer></blockquote><br>javadoc의 설명대로라면 원하는 구현을 할 수 있다. 하지만 한가지 유의할 점이 있다. 소스를 까보면 `for`문을 돌면서 `.getTransaction()`을 호출하는 데, 이는 성능 문제를 야기할 수 있다. 알 사람은 다 아는 `LazyConnectionDataSourceProxy`를 사용할 차례다. spring은 기본적으로 `transaction`을 미리 가져오는데, 저 `DataSource`의 구현체는 필요한 때에 `transaction`을 가져오도록 connection 호출 시점을 뒤로 미룰 수 있다. 따로 `LazyConnectionDataSourceProxy`를 상세히 설명하기 보다는, 이 구현체를 알게된 [블로그](http://kwon37xi.egloos.com/m/5364167)를 소개하겠다. <h2 id="의존성-추가"><a href="#의존성-추가" class="headerlink" title="의존성 추가"></a>의존성 추가</h2><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">dependencies</span> &#123;</span><br><span class="line">    <span class="keyword">compile</span>(<span class="string">'org.springframework.data:spring-data-commons'</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Spring-Application-설정"><a href="#Spring-Application-설정" class="headerlink" title="Spring Application 설정"></a>Spring Application 설정</h2><h3 id="DataSouceCreator"><a href="#DataSouceCreator" class="headerlink" title="DataSouceCreator"></a>DataSouceCreator</h3><p><code>LazyConnectionDataSourceProxy</code>를 반환하도록 변경한다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@UtilityClass</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DataSourceCreator</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">createHikariDataSource</span><span class="params">(DataSourceProperties properties)</span> </span>&#123;</span><br><span class="line">        HikariDataSource dataSource = <span class="keyword">new</span> HikariDataSource();</span><br><span class="line">        dataSource.setJdbcUrl(properties.getUrl());</span><br><span class="line">        dataSource.setUsername(properties.getUsername());</span><br><span class="line">        dataSource.setPassword(properties.getPassword());</span><br><span class="line">        dataSource.setDriverClassName(properties.getDriverClassName());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> LazyConnectionDataSourceProxy(dataSource);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ChainedTxConfig"><a href="#ChainedTxConfig" class="headerlink" title="ChainedTxConfig"></a>ChainedTxConfig</h3><p><code>ChainedTransactionManager</code>를 primary로 등록하자.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ChainedTxConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@Primary</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> PlatformTransactionManager <span class="title">transactionManager</span><span class="params">(PlatformTransactionManager memberTxManager, PlatformTransactionManager boardTxManager)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ChainedTransactionManager(memberTxManager, boardTxManager);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="LogicService-MemberService-BoardService-수정"><a href="#LogicService-MemberService-BoardService-수정" class="headerlink" title="LogicService, MemberService, BoardService 수정"></a>LogicService, MemberService, BoardService 수정</h2><p><code>ChainedTransactionManager</code> bean을 primary로 등록했으니, <code>@Transactional</code>에서 지정했던 transactionManager 설정을 지우자.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LogicService</span> </span>&#123; ... &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MemberService</span> </span>&#123; ... &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BoardService</span> </span>&#123; ... &#125;</span><br></pre></td></tr></table></figure><h2 id="결과-1"><a href="#결과-1" class="headerlink" title="결과"></a>결과</h2><table><thead><tr><th>member propagation</th><th>board propagation</th><th>member insert</th><th>board insert</th></tr></thead><tbody><tr><td>required</td><td>required</td><td>rollback</td><td>rollback</td></tr><tr><td>required</td><td>requires-new</td><td>rollback</td><td>rollback</td></tr><tr><td>required</td><td>nested</td><td>rollback</td><td>rollback</td></tr><tr><td>requires-new</td><td>required</td><td>commit</td><td>rollback</td></tr><tr><td>requires-new</td><td>requires-new</td><td>commit</td><td>rollback</td></tr><tr><td>requires-new</td><td>nested</td><td>commit</td><td>rollback</td></tr><tr><td>nested</td><td>required</td><td>rollback</td><td>rollback</td></tr><tr><td>nested</td><td>requires-new</td><td>rollback</td><td>rollback</td></tr><tr><td>nested</td><td>nested</td><td>rollback</td><td>rollback</td></tr><tr><td>not-supported</td><td>required</td><td>commit</td><td>rollback</td></tr><tr><td>not-supported</td><td>requires-new</td><td>commit</td><td>rollback</td></tr><tr><td>not-supported</td><td>nested</td><td>commit</td><td>rollback</td></tr><tr><td>not-supported</td><td>not-supported</td><td>commit</td><td>commit</td></tr></tbody></table><h4 id="설명-4"><a href="#설명-4" class="headerlink" title="설명"></a>설명</h4><p>일부러 <code>NOT_SUPPORTED</code>를 추가해봤다. 부모의 영향을 받는 부분(<code>REQUIRED</code>, <code>NESTED</code>)는 모두 rollback이 동작하고, 나머지는 모두 commit되었다. <code>ChainedTransactionManager</code>가 아주 잘 동작하고 있다.</p><h1 id="구현-3-JtaTransactionManager"><a href="#구현-3-JtaTransactionManager" class="headerlink" title="구현 3 - JtaTransactionManager"></a>구현 3 - JtaTransactionManager</h1><p>JTA(Java Transaction Api)는 자바 표준으로써, 분산 transaction을 가능하게 해준다. 매우 간단하게 설명하자면, JTA를 지원하는 자원을 가리키는 XA Resource 인터페이스의 구현체들을 등록하면, 해당 구현체들에 대해서 전역 transaction을 지원해준다. 때문에 어떤 자원이든 transaction을 지원할 수 있도록 정의한 셈인데, DataSource, JMS 외에는 쓰고 있는 곳이 없는 것 같다.<br>Java EE Application Server에서는 전역 tranction을 지원하기 위해서, JTA를 사용하기도 한다. Spring에서는 JNDI에서 Java EE Container가 사용 중인 DataSource를 가져와, JtaTransactionManager에 설정할 수도 있다.</p><p>JTA에 대해서 설명하는 것은 여기까지 하고, 직접 사용하면서 여러 DataSource를 대상으로 하는 transaction이 잘 동작하는지 확인해보자.</p><h2 id="의존성-추가-1"><a href="#의존성-추가-1" class="headerlink" title="의존성 추가"></a>의존성 추가</h2><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">dependencies</span> &#123;</span><br><span class="line">    <span class="keyword">compile</span>(<span class="string">'org.springframework.boot:spring-boot-starter-jta-atomikos'</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Spring-Application-설정-1"><a href="#Spring-Application-설정-1" class="headerlink" title="Spring Application 설정"></a>Spring Application 설정</h2><h3 id="application-yml-1"><a href="#application-yml-1" class="headerlink" title="application.yml"></a>application.yml</h3><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">jta:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">atomikos:</span></span><br><span class="line">      <span class="attr">datasource:</span></span><br><span class="line">        <span class="attr">member:</span></span><br><span class="line">          <span class="attr">unique-resource-name:</span> <span class="string">memberDataSource</span></span><br><span class="line">          <span class="attr">xa-data-source-class-name:</span> <span class="string">com.mysql.jdbc.jdbc2.optional.MysqlXADataSource</span></span><br><span class="line">          <span class="attr">xa-properties:</span></span><br><span class="line">            <span class="attr">user:</span> <span class="string">root</span></span><br><span class="line">            <span class="attr">password:</span> <span class="string">multitxtest</span></span><br><span class="line">            <span class="attr">url:</span> <span class="string">jdbc:mysql://127.0.0.1:11306/multi_tx_test?useSSL=false</span></span><br><span class="line">        <span class="attr">board:</span></span><br><span class="line">          <span class="attr">unique-resource-name:</span> <span class="string">boardDataSource</span></span><br><span class="line">          <span class="attr">xa-data-source-class-name:</span> <span class="string">com.mysql.jdbc.jdbc2.optional.MysqlXADataSource</span></span><br><span class="line">          <span class="attr">xa-properties:</span></span><br><span class="line">            <span class="attr">user:</span> <span class="string">root</span></span><br><span class="line">            <span class="attr">password:</span> <span class="string">multitxtest</span></span><br><span class="line">            <span class="attr">url:</span> <span class="string">jdbc:mysql://127.0.0.1:11307/multi_tx_test?useSSL=false</span></span><br></pre></td></tr></table></figure><h3 id="BoardSqlSessionConfig"><a href="#BoardSqlSessionConfig" class="headerlink" title="BoardSqlSessionConfig"></a>BoardSqlSessionConfig</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BoardSqlSessionConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConfigurationProperties</span>(prefix = <span class="string">"spring.jta.atomikos.datasource.board"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">boardDataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> AtomikosDataSourceBean();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="MemberSqlSessionConfig"><a href="#MemberSqlSessionConfig" class="headerlink" title="MemberSqlSessionConfig"></a>MemberSqlSessionConfig</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MemberSqlSessionConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConfigurationProperties</span>(prefix = <span class="string">"spring.jta.atomikos.datasource.member"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">memberDataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> AtomikosDataSourceBean();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="결과-2"><a href="#결과-2" class="headerlink" title="결과"></a>결과</h2><table><thead><tr><th>member propagation</th><th>board propagation</th><th>member insert</th><th>board insert</th></tr></thead><tbody><tr><td>required</td><td>required</td><td>rollback</td><td>rollback</td></tr><tr><td>required</td><td>requires-new</td><td>rollback</td><td>rollback</td></tr><tr><td>required</td><td>nested</td><td>rollback</td><td>rollback</td></tr><tr><td>requires-new</td><td>required</td><td>commit</td><td>rollback</td></tr><tr><td>requires-new</td><td>requires-new</td><td>commit</td><td>rollback</td></tr><tr><td>requires-new</td><td>nested</td><td>commit</td><td>rollback</td></tr><tr><td>nested</td><td>required</td><td>rollback</td><td>rollback</td></tr><tr><td>nested</td><td>requires-new</td><td>rollback</td><td>rollback</td></tr><tr><td>nested</td><td>nested</td><td>rollback</td><td>rollback</td></tr><tr><td>not-supported</td><td>required</td><td>commit</td><td>rollback</td></tr><tr><td>not-supported</td><td>requires-new</td><td>commit</td><td>rollback</td></tr><tr><td>not-supported</td><td>nested</td><td>commit</td><td>rollback</td></tr><tr><td>not-supported</td><td>not-supported</td><td>commit</td><td>commit</td></tr></tbody></table><h3 id="설명-5"><a href="#설명-5" class="headerlink" title="설명"></a>설명</h3><p>잘 동작한다. 부모의 영향을 받는 전파 수준과 받지 않는 전파 수준에서 기대하는 동작이 잘 수행되고 있다.</p><h1 id="마무리"><a href="#마무리" class="headerlink" title="마무리"></a>마무리</h1><p>여러 <code>DataSource</code>가 존재하는 상황에서 transaction 설정을 어떻게 가져가야 하는지에 대해 3가지 방법을 사용해서 살펴보았다. <code>ChainedTransactionManager</code>나 <code>JtaTransactionManager</code>를 사용해서, 전역 transaction을 지원하도록 설정하지 않는 한, 개발자가 원하는 동작을 하지 않음을 알 수 있었다.<br><code>ChainedTransactionManager</code>는 기본 개념이 쉽다. 내부 동작이 어떻게 돌고 있는지 간단하게 파악된다. 별다른 학습 비용 없이 쉽게 사용할 수 있다. 하지만 <code>JtaTransactionManager</code>의 경우에는 그에 비해 공부할 내용들이 꽤 있다. 결국은 둘 다 <code>PlatformTransactionManager</code>를 구현하고 있다. 개발자가 spring을 사용하는 한, 둘 다 유연하게 적용할 수 있다.<br>명심하자, DataSource를 두 개 이상 사용할 때에는 반드시 <code>ChainedTransactionManager</code>나 <code>JtaTransactionManager</code>로 전역 transaction 설정을 해야한다.</p><p>소스 코드 : <a href="https://github.com/supawer0728/simple-multi-tx" target="_blank" rel="noopener">https://github.com/supawer0728/simple-multi-tx</a></p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;서론&quot;&gt;&lt;a href=&quot;#서론&quot; class=&quot;headerlink&quot; title=&quot;서론&quot;&gt;&lt;/a&gt;서론&lt;/h1&gt;&lt;p&gt;Spring Application을 만들면서 여러 &lt;code&gt;DataSource&lt;/code&gt;와 &lt;code&gt;transaction&lt;/code&gt;이 존재하고 하나의 transaction 내에 commit과 rollback이 잘 동작하도록 하려면 어떻게 설정해야 할까? 실제로 구현을 해본 적은 없지만 세 가지 방법이 머릿속에 떠올랐다.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;@Transactional&lt;/code&gt;의 propagation을 이용&lt;/li&gt;
&lt;li&gt;&lt;code&gt;spring-data-commons&lt;/code&gt;의 &lt;code&gt;ChainedTransactionManager&lt;/code&gt; 이용&lt;/li&gt;
&lt;li&gt;&lt;code&gt;JtaTransactionManager&lt;/code&gt; 이용&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;이 방법들이 실제로 써먹을 수 있을지 확인해보려고 한다.&lt;/p&gt;
    
    </summary>
    
      <category term="spring" scheme="https://supawer0728.github.io/categories/spring/"/>
    
    
      <category term="spring" scheme="https://supawer0728.github.io/tags/spring/"/>
    
  </entry>
  
  <entry>
    <title>spring-data-rest 소개</title>
    <link href="https://supawer0728.github.io/2018/03/20/spring-data-rest/"/>
    <id>https://supawer0728.github.io/2018/03/20/spring-data-rest/</id>
    <published>2018-03-20T01:26:46.000Z</published>
    <updated>2020-03-04T08:18:02.749Z</updated>
    
    <content type="html"><![CDATA[<h1 id="서론"><a href="#서론" class="headerlink" title="서론"></a>서론</h1><p>Spring Data REST는 도메인 모델과 repository를 분석해서, <code>RESTful API</code>를 제공해준다.<br>본 문서에서는 Spring Data REST에 대한 간단한 예제와 함께 사용법에 관한 소개를 하고자 한다.</p><a id="more"></a><h1 id="RESTful-API"><a href="#RESTful-API" class="headerlink" title="RESTful API"></a>RESTful API</h1><p>뜬금없지만 <code>RESTful</code>에 관해 좀 더 이야기를 해두고자 한다.<br>아래 그림은 마틴 파울러 아저씨의 <a href="https://martinfowler.com/articles/richardsonMaturityModel.html" target="_blank" rel="noopener">Richardson Maturity Model</a>에 나오는 <code>REST의 영광</code>을 누리기 위한 단계를 표현하고 있다.</p><table><thead><tr><th align="center"><img src="/images/spring-data-rest/hateoas.png" alt="image1"></th></tr></thead><tbody><tr><td align="center"><em>출처: <a href="https://martinfowler.com/articles/images/richardsonMaturityModel/overview.png" target="_blank" rel="noopener">https://martinfowler.com/articles/images/richardsonMaturityModel/overview.png</a></em></td></tr></tbody></table><blockquote><p>한국어 풀이로 해둔 블로그가 있다(<a href="http://jinson.tistory.com/190" target="_blank" rel="noopener">http://jinson.tistory.com/190</a>)</p></blockquote><p>결국 <code>api가 RESTful하다</code>는 말을 듣기 위해서는 <code>level 3</code>를 충족시켜야 한다.<br><code>level 3</code>를 충족시키기 위해서 <code>HATEOAS(Hypertext As The Engine Of Application State)</code>개념을 도입해야 한다.<br><code>HATEOAS</code>가 어떤 것인지 상세히 설명하는 것은 본 문서에서 초점을 맞추는 부분이 아니기에, 여기서는 하지 않겠다.<br>정말 간단히 요약하자면 아래와 같다.</p><ul><li>Resource로 <code>무엇</code>을 할 수 있는지 알 수 있다.</li><li><code>무엇</code>을 <code>어떻게</code> 해야 하는 지 알려준다.</li></ul><p><code>HATEOAS</code>에 대해서 궁금하다면 상기한 블로그를 읽어보자</p><h1 id="간단한-예제"><a href="#간단한-예제" class="headerlink" title="간단한 예제"></a>간단한 예제</h1><p>백문이 불여일견이다.<br>우선 예제를 보며 어떻게 동작하는 것인지 알아보자.<br>여기서는 <code>spring-data-jpa</code>와 연동하여 사용한다.</p><h2 id="의존성"><a href="#의존성" class="headerlink" title="의존성"></a>의존성</h2><p><code>spring-boot</code> 버전은 <code>2.0.0.RELEASE</code>다.</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">dependencies</span> &#123;</span><br><span class="line">  <span class="keyword">compile</span>(<span class="string">'org.springframework.boot:spring-boot-starter-data-jpa'</span>)</span><br><span class="line">  <span class="keyword">compile</span>(<span class="string">'org.springframework.boot:spring-boot-starter-data-rest'</span>)</span><br><span class="line">  compileOnly(<span class="string">'org.projectlombok:lombok'</span>)</span><br><span class="line">  runtimeOnly(<span class="string">'com.h2database:h2'</span>)</span><br><span class="line">  testCompile(<span class="string">'org.springframework.boot:spring-boot-starter-test'</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Domain"><a href="#Domain" class="headerlink" title="Domain"></a>Domain</h2><p><strong>Member</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Table</span>(name = <span class="string">"member"</span>)</span><br><span class="line"><span class="meta">@NoArgsConstructor</span>(access = AccessLevel.PRIVATE)</span><br><span class="line"><span class="meta">@Getter</span>(AccessLevel.PUBLIC)</span><br><span class="line"><span class="meta">@Setter</span>(AccessLevel.PRIVATE)</span><br><span class="line"><span class="meta">@EqualsAndHashCode</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Member</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@GeneratedValue</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Enumerated</span>(EnumType.STRING)</span><br><span class="line">    <span class="keyword">private</span> Grade grade;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Member</span><span class="params">(String name, Integer age, Grade grade)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">        <span class="keyword">this</span>.grade = grade;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Member <span class="title">join</span><span class="params">(@NonNull String name, @NonNull Integer age)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Member(name, age, Grade.BRONZE);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>Repository</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RepositoryRestResource</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MemberRepository</span> <span class="keyword">extends</span> <span class="title">JpaRepository</span>&lt;<span class="title">Member</span>, <span class="title">Long</span>&gt; </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="application-설정"><a href="#application-설정" class="headerlink" title="application 설정"></a>application 설정</h2><p><strong>application.yml</strong></p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring.data.rest.base-path:</span> <span class="string">/api</span></span><br></pre></td></tr></table></figure><p><strong>SimpleDataRestApplication.java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleDataRestApplication</span> <span class="keyword">implements</span> <span class="title">CommandLineRunner</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MemberRepository memberRepository;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(SimpleDataRestApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(String... args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        memberRepository.save(Member.join(<span class="string">"member1"</span>, <span class="number">20</span>));</span><br><span class="line">        memberRepository.save(Member.join(<span class="string">"member2"</span>, <span class="number">21</span>));</span><br><span class="line">        memberRepository.save(Member.join(<span class="string">"member3"</span>, <span class="number">22</span>));</span><br><span class="line">        memberRepository.save(Member.join(<span class="string">"member4"</span>, <span class="number">23</span>));</span><br><span class="line">        memberRepository.save(Member.join(<span class="string">"member5"</span>, <span class="number">24</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="실행"><a href="#실행" class="headerlink" title="실행"></a>실행</h2><p>미리 데이터를 넣거나 했지만,<br>사실 <strong>Domain</strong>영역에서 <code>entity</code>과 <code>repository</code>만 정의했다.<br>바로 실행해서 테스트해 볼 수 있다.</p><p><strong><code>GET /api</code></strong></p><p><code>application.yml</code>에서 <code>spring-rest-data</code>의 root를 <code>/api</code>로 잡았다.<br>root uri의 자원을 호출하면 어떻 것이 나오는 지 확인하자.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;  </span><br><span class="line">   &quot;_links&quot;:&#123;  </span><br><span class="line">      &quot;members&quot;:&#123;  </span><br><span class="line">         &quot;href&quot;:&quot;http:&#x2F;&#x2F;localhost:8080&#x2F;api&#x2F;members&#123;?page,size,sort&#125;&quot;,</span><br><span class="line">         &quot;templated&quot;:true</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;profile&quot;:&#123;  </span><br><span class="line">         &quot;href&quot;:&quot;http:&#x2F;&#x2F;localhost:8080&#x2F;api&#x2F;profile&quot;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>root 경로의 하위로 어떠한 자원들을 가지고 있는지 알려준다.<ul><li>members를 가지고 있다</li><li>members에 접근하려면 <code>/api/members</code>를 호출해야 한다고 알려준다(<code>HATEOAS</code>)</li></ul></li></ul><p><strong><code>GET /api/members</code></strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;_embedded&quot; : &#123;</span><br><span class="line">    &quot;members&quot; : [ &#123;</span><br><span class="line">      &quot;name&quot; : &quot;member1&quot;,</span><br><span class="line">      &quot;age&quot; : 20,</span><br><span class="line">      &quot;grade&quot; : &quot;BRONZE&quot;,</span><br><span class="line">      &quot;_links&quot; : &#123;</span><br><span class="line">        &quot;self&quot; : &#123;</span><br><span class="line">          &quot;href&quot; : &quot;http:&#x2F;&#x2F;localhost:8080&#x2F;api&#x2F;members&#x2F;1&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;member&quot; : &#123;</span><br><span class="line">          &quot;href&quot; : &quot;http:&#x2F;&#x2F;localhost:8080&#x2F;api&#x2F;members&#x2F;1&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;, &#123;</span><br><span class="line">      ...</span><br><span class="line">    &#125;]</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;_links&quot; : &#123;</span><br><span class="line">    &quot;self&quot; : &#123;</span><br><span class="line">      &quot;href&quot; : &quot;http:&#x2F;&#x2F;localhost:8080&#x2F;api&#x2F;members&#123;?page,size,sort&#125;&quot;,</span><br><span class="line">      &quot;templated&quot; : true</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;profile&quot; : &#123;</span><br><span class="line">      &quot;href&quot; : &quot;http:&#x2F;&#x2F;localhost:8080&#x2F;api&#x2F;profile&#x2F;members&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;page&quot; : &#123;</span><br><span class="line">    &quot;size&quot; : 20,</span><br><span class="line">    &quot;totalElements&quot; : 5,</span><br><span class="line">    &quot;totalPages&quot; : 1,</span><br><span class="line">    &quot;number&quot; : 0</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>목록 호출을 해보면</p><ul><li>페이징 처리를 해주고 있다.<ul><li><code>MemberRepository</code>가 <code>PagingAndSortingRepository</code>를 구현하고 있기 때문이다.</li><li>현재 총 5개의 요소가 있는데, 만약 <code>page=1&amp;size=2</code>라는 query를 추가했다면 <code>_links</code>에 다음 주소가 추가된다<ul><li>first : <a href="http://localhost:8080/api/members?page=0&amp;size=2" target="_blank" rel="noopener">http://localhost:8080/api/members?page=0&amp;size=2</a></li><li>previous : <a href="http://localhost:8080/api/members?page=0&amp;size=2" target="_blank" rel="noopener">http://localhost:8080/api/members?page=0&amp;size=2</a></li><li>next : <a href="http://localhost:8080/api/members?page=2&amp;size=2" target="_blank" rel="noopener">http://localhost:8080/api/members?page=2&amp;size=2</a></li><li>last : <a href="http://localhost:8080/api/members?page=2&amp;size=2" target="_blank" rel="noopener">http://localhost:8080/api/members?page=2&amp;size=2</a></li></ul></li></ul></li><li>목록들을 보면 ID가 없다<ul><li><code>HATEOAS</code>를 써서 <code>자기 서술적(self-descriptive)</code>으로 동작한다.</li><li>때문에 상세를 조회하기 위해 client는 <code>location.href = &#39;/api/members/&#39; + members[0].id</code>가 아니라,<br><code>location.href = members[0]._link.self.href</code>를 넣어주면 된다.</li></ul></li></ul><p><strong><code>GET /api/members/1</code></strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;name&quot; : &quot;member1&quot;,</span><br><span class="line">  &quot;age&quot; : 20,</span><br><span class="line">  &quot;grade&quot; : &quot;BRONZE&quot;,</span><br><span class="line">  &quot;_links&quot; : &#123;</span><br><span class="line">    &quot;self&quot; : &#123;</span><br><span class="line">      &quot;href&quot; : &quot;http:&#x2F;&#x2F;localhost:8080&#x2F;api&#x2F;members&#x2F;1&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;member&quot; : &#123;</span><br><span class="line">      &quot;href&quot; : &quot;http:&#x2F;&#x2F;localhost:8080&#x2F;api&#x2F;members&#x2F;1&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong><code>POST /api/members</code></strong></p><p>생성 요청을 해보자</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;name&quot; : &quot;Test Created&quot;,</span><br><span class="line">  &quot;age&quot; : 22,</span><br><span class="line">  &quot;grade&quot; : &quot;BRONZE&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>아래와 같이 <code>201 CREATED</code> 응답이 온다</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;name&quot; : &quot;Test Created&quot;,</span><br><span class="line">  &quot;age&quot; : 22,</span><br><span class="line">  &quot;grade&quot; : &quot;BRONZE&quot;,</span><br><span class="line">  &quot;_links&quot; : &#123;</span><br><span class="line">    &quot;self&quot; : &#123;</span><br><span class="line">      &quot;href&quot; : &quot;http:&#x2F;&#x2F;localhost:8080&#x2F;api&#x2F;members&#x2F;6&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;member&quot; : &#123;</span><br><span class="line">      &quot;href&quot; : &quot;http:&#x2F;&#x2F;localhost:8080&#x2F;api&#x2F;members&#x2F;6&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong><code>PATCH /api/members/6</code></strong></p><p>수정 요청을 해보자</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;age&quot; : 30</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>아래와 같이 응답이 온다(200 OK)</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;name&quot; : &quot;Test Created&quot;,</span><br><span class="line">  &quot;age&quot; : 30,</span><br><span class="line">  &quot;grade&quot; : &quot;BRONZE&quot;,</span><br><span class="line">  &quot;_links&quot; : &#123;</span><br><span class="line">    &quot;self&quot; : &#123;</span><br><span class="line">      &quot;href&quot; : &quot;http:&#x2F;&#x2F;localhost:8080&#x2F;api&#x2F;members&#x2F;6&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;member&quot; : &#123;</span><br><span class="line">      &quot;href&quot; : &quot;http:&#x2F;&#x2F;localhost:8080&#x2F;api&#x2F;members&#x2F;6&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>PUT</code>이나 <code>DELETE</code>도 당연히 동작을 하기 때문에 굳이 설명하지 않겠다.</p><h1 id="기본-설정"><a href="#기본-설정" class="headerlink" title="기본 설정"></a>기본 설정</h1><p>앞서 예제를 통해 기본적인 동작을 살펴보았다.<br>이번에는 <code>spring-data-rest</code>가 어떠한 기본 설정으로 동작하는 지를 설명하겠다.<br><a href="https://docs.spring.io/spring-data/rest/docs/3.0.5.RELEASE/reference/html/#getting-started.basic-settings" target="_blank" rel="noopener">Spring Data REST Reference</a>에서 Java 설정의 예제가 있다.<br>여기서는 <code>spring-boot</code>에서 지원해주는 properties를 사용하여 설정하는 것을 예로 들겠다.</p><p><strong>Prefix는 <code>spring.data.rest.</code></strong></p><table><thead><tr><th>property</th><th>default</th><th>description</th></tr></thead><tbody><tr><td>base-path</td><td></td><td>repository resource를 노출할 기본 경로</td></tr><tr><td>default-media-type</td><td><code>application/hal+json;charset=UTF-8</code></td><td>개별 설정이 없을 때 사용할 <code>Content-Type</code></td></tr><tr><td>default-page-size</td><td></td><td>기본 페이지 사이즈</td></tr><tr><td>detection-strategy</td><td>default</td><td>api로 만들 repository를 찾는 전략<br>- <code>default</code> : 모든 public repository. <code>@RestResource</code>의 <code>exported</code>가 <code>false</code>인 경우 제외<br>- <code>all</code> : 가시성, annotation과 상관 없이 모든 repository 노출<br>- <code>annoation</code> : <code>exported</code>가 <code>true</code>이며 <code>@RepositoryRestResource</code>, <code>@RestResource</code>가 달린 자원들을 노출<br>- <code>visibility</code> : public interface만 노출</td></tr><tr><td>limit-param-name</td><td>size</td><td>한 번에 반환되는 결과 갯수를 받을 query string 이름<br><code>/api/members?size=10</code></td></tr><tr><td>max-page-size</td><td>20</td><td>페이지당 항목 수</td></tr><tr><td>page-param-name</td><td>page</td><td>페이지 번호를 받을 query string 이름<br><code>/api/members?page=2</code></td></tr><tr><td>return-body-on-create</td><td>true</td><td>요청에 의해 생성된 엔티티를 응답으로 내려줄 지 여부</td></tr><tr><td>return-body-on-update</td><td>true</td><td>요청에 의해 수정된 엔티티를 응답으로 내려줄 지 여부</td></tr><tr><td>sort-param-name</td><td>sort</td><td>정렬 요청을 받을 query string 이름<br><code>/api/members?sort=name,desc</code></td></tr></tbody></table><h1 id="지원하는-저장소"><a href="#지원하는-저장소" class="headerlink" title="지원하는 저장소"></a>지원하는 저장소</h1><ul><li>Spring Data JPA</li><li>Spring Data MongoDB</li><li>Spring Data Neo4j</li><li>Spring Data GemFire</li><li>Spring Data Cassandra</li></ul><h1 id="Search-API"><a href="#Search-API" class="headerlink" title="Search API"></a>Search API</h1><p>repository에 <a href="https://docs.spring.io/spring-data/jpa/docs/current/reference/html/#repositories.query-methods" target="_blank" rel="noopener">query method</a>를 추가해보자.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RepositoryRestResource</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MemberRepository</span> <span class="keyword">extends</span> <span class="title">JpaRepository</span>&lt;<span class="title">Member</span>, <span class="title">Long</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function">Member <span class="title">findByName</span><span class="params">(@Param(<span class="string">"name"</span>)</span> String name)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong><code>GET /api/members</code>*</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;_embedded&quot; : &#123; ... &#125;,</span><br><span class="line">  &quot;_links&quot; : &#123;</span><br><span class="line">    &quot;self&quot; : &#123; ... &#125;,</span><br><span class="line">    &quot;profile&quot; : &#123; ... &#125;,</span><br><span class="line">    &quot;search&quot; : &#123;</span><br><span class="line">      &quot;href&quot; : &quot;http:&#x2F;&#x2F;localhost:8080&#x2F;api&#x2F;members&#x2F;search&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;page&quot; : &#123; ... &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>links에 search가 추가되었다.<br>search를 확인해보자.</p><p><strong><code>GET /api/members/search</code></strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;_links&quot; : &#123;</span><br><span class="line">    &quot;findByName&quot; : &#123;</span><br><span class="line">      &quot;href&quot; : &quot;http:&#x2F;&#x2F;localhost:8080&#x2F;api&#x2F;members&#x2F;search&#x2F;findByName&#123;?name&#125;&quot;,</span><br><span class="line">      &quot;templated&quot; : true</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;self&quot; : &#123;</span><br><span class="line">      &quot;href&quot; : &quot;http:&#x2F;&#x2F;localhost:8080&#x2F;api&#x2F;members&#x2F;search&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>사용법에 대한 설명이 나온다</p><p>**<code>GET /api/members/search/findByName?name=member1</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;name&quot; : &quot;member1&quot;,</span><br><span class="line">  &quot;age&quot; : 20,</span><br><span class="line">  &quot;grade&quot; : &quot;BRONZE&quot;,</span><br><span class="line">  &quot;_links&quot; : &#123;</span><br><span class="line">    &quot;self&quot; : &#123;</span><br><span class="line">      &quot;href&quot; : &quot;http:&#x2F;&#x2F;localhost:8080&#x2F;api&#x2F;members&#x2F;1&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;member&quot; : &#123;</span><br><span class="line">      &quot;href&quot; : &quot;http:&#x2F;&#x2F;localhost:8080&#x2F;api&#x2F;members&#x2F;1&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Paging-처리"><a href="#Paging-처리" class="headerlink" title="Paging 처리"></a>Paging 처리</h2><p><code>query method</code>에 <code>Pageable</code>를 파라미터로 줘서, Paging처리를 시킬 수 있다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RepositoryRestResource</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MemberRepository</span> <span class="keyword">extends</span> <span class="title">JpaRepository</span>&lt;<span class="title">Member</span>, <span class="title">Long</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function">Page&lt;Member&gt; <span class="title">findByName</span><span class="params">(@Param(<span class="string">"name"</span>)</span> String name, Pageable pageable)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="Projection"><a href="#Projection" class="headerlink" title="Projection"></a>Projection</h1><p>interface와 annotation의 조합으로 projection 할 수 있다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RepositoryRestResource</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MemberRepository</span> <span class="keyword">extends</span> <span class="title">JpaRepository</span>&lt;<span class="title">Member</span>, <span class="title">Long</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function">Member <span class="title">findByName</span><span class="params">(@Param(<span class="string">"name"</span>)</span> String name)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Projection</span>(name = <span class="string">"only-name"</span>, types = &#123;Member<span class="class">.<span class="keyword">class</span>&#125;)</span></span><br><span class="line"><span class="class"><span class="title">interface</span> <span class="title">OnlyName</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function">String <span class="title">getName</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong><code>GET /api/members/1?projection=only-name</code></strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;name&quot; : &quot;member1&quot;,</span><br><span class="line">  &quot;_links&quot; : &#123;</span><br><span class="line">    &quot;self&quot; : &#123;</span><br><span class="line">      &quot;href&quot; : &quot;http:&#x2F;&#x2F;localhost:8080&#x2F;api&#x2F;members&#x2F;1&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;member&quot; : &#123;</span><br><span class="line">      &quot;href&quot; : &quot;http:&#x2F;&#x2F;localhost:8080&#x2F;api&#x2F;members&#x2F;1&#123;?projection&#125;&quot;,</span><br><span class="line">      &quot;templated&quot; : true</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>projection의 목록은 <code>/api/profile/members</code>에서 조회할 수 있다.</p><p><img src="/images/spring-data-rest/profile1.png" alt="profile1"></p><h2 id="JsonIgnore-값-보내기"><a href="#JsonIgnore-값-보내기" class="headerlink" title="JsonIgnore 값 보내기"></a>JsonIgnore 값 보내기</h2><p>회원의 연령 정보에 <code>@JsonIgnore</code>가 걸린 상황이라도,</p><p><strong>Member.java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> String name;</span><br><span class="line"><span class="meta">@JsonIgnore</span></span><br><span class="line"><span class="keyword">private</span> Integer age;</span><br></pre></td></tr></table></figure><p><code>@Projection</code>을 사용하면 노출시킬 수 있다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Projection</span>(name = <span class="string">"how-old"</span>, types = &#123; Member<span class="class">.<span class="keyword">class</span> &#125;)</span></span><br><span class="line"><span class="class"><span class="title">interface</span> <span class="title">HowOldProjection</span> </span>&#123;</span><br><span class="line">  <span class="function">Integer <span class="title">getAge</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="SpEL"><a href="#SpEL" class="headerlink" title="SpEL"></a>SpEL</h2><p><code>@Projection</code> 내의 메서드에 <a href="https://docs.spring.io/spring/docs/5.0.4.RELEASE/spring-framework-reference/core.html#expressions" target="_blank" rel="noopener">SpEL</a>을 적용할 수 있다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Projection</span>(name = <span class="string">"brief"</span>, types = &#123; Member<span class="class">.<span class="keyword">class</span> &#125;)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">interface</span> <span class="title">BriefProjection</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Value</span>(<span class="string">"#&#123;target.name&#125; : #&#123;target.age&#125;"</span>) </span><br><span class="line">  <span class="function">String <span class="title">getBrief</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="엔티티-조합에서-Projection"><a href="#엔티티-조합에서-Projection" class="headerlink" title="엔티티 조합에서 Projection"></a>엔티티 조합에서 Projection</h2><p><code>Board</code> 엔티티가 <code>Member</code> 엔티티를 <code>writer</code>로서 가지고 있다고 가정하자.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Table</span>(name = <span class="string">"board"</span>)</span><br><span class="line"><span class="meta">@NoArgsConstructor</span>(access = AccessLevel.PROTECTED)</span><br><span class="line"><span class="meta">@Getter</span>(AccessLevel.PUBLIC)</span><br><span class="line"><span class="meta">@Setter</span>(AccessLevel.PRIVATE)</span><br><span class="line"><span class="meta">@EqualsAndHashCode</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Board</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@GeneratedValue</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String title;</span><br><span class="line">    <span class="keyword">private</span> String content;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ManyToOne</span></span><br><span class="line">    <span class="meta">@JoinColumn</span>(name = <span class="string">"writer_id"</span>)</span><br><span class="line">    <span class="keyword">private</span> Member writer;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>이 경우 writer는 어떻게 참조될까?</p><p><strong><code>GET /api/boards/1</code></strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;title&quot; : &quot;title1&quot;,</span><br><span class="line">  &quot;content&quot; : &quot;content1&quot;,</span><br><span class="line">  &quot;_links&quot; : &#123;</span><br><span class="line">    ... ,</span><br><span class="line">    &quot;writer&quot; : &#123;</span><br><span class="line">      &quot;href&quot; : &quot;http:&#x2F;&#x2F;localhost:8080&#x2F;api&#x2F;boards&#x2F;6&#x2F;writer&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>보다시피 <code>writer</code> 정보를 얻기 위해서 <code>/api/boards/6/writer</code>를 호출해야 한다.<br><code>writer</code>정보를 한 번에 얻을 수 있도록 <code>@Projection</code> 설정을 할 수 있다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Projection</span>(name = <span class="string">"with-writer"</span>, types = &#123;Board<span class="class">.<span class="keyword">class</span>&#125;)</span></span><br><span class="line"><span class="class"><span class="title">interface</span> <span class="title">WithWriterProjection</span> </span>&#123;</span><br><span class="line">    <span class="function">String <span class="title">getTitle</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function">String <span class="title">getContent</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function">Member <span class="title">getWriter</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong><code>GET /api/boards/6?projection=with-writer</code></strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;content&quot; : &quot;content1&quot;,</span><br><span class="line">  &quot;title&quot; : &quot;title1&quot;,</span><br><span class="line">  &quot;writer&quot; : &#123;</span><br><span class="line">    &quot;name&quot; : &quot;member1&quot;,</span><br><span class="line">    &quot;age&quot; : 20,</span><br><span class="line">    &quot;grade&quot; : &quot;BRONZE&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;_links&quot; : &#123; ... &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="엔티티-조합-Projection-상시-설정"><a href="#엔티티-조합-Projection-상시-설정" class="headerlink" title="엔티티 조합 Projection 상시 설정"></a>엔티티 조합 Projection 상시 설정</h3><p><code>@RepositoryRestResource</code>의 <code>excerptProjection</code>으로 상시 설정할 <code>Projection</code>을 걸어 둘 수 있다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RepositoryRestResource</span>(excerptProjection = WithWriterProjection<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">interface</span> <span class="title">BoardRepository</span> <span class="keyword">extends</span> <span class="title">JpaRepository</span>&lt;<span class="title">Board</span>, <span class="title">Long</span>&gt; </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="Header와의-연계"><a href="#Header와의-연계" class="headerlink" title="Header와의 연계"></a>Header와의 연계</h1><h2 id="ETag-If-Match-If-None-Match"><a href="#ETag-If-Match-If-None-Match" class="headerlink" title="ETag, If-Match, If-None-Match"></a>ETag, If-Match, If-None-Match</h2><p><code>spring-data-commons</code>에는 <code>@Version</code>이라는 애노테이션이 있다.</p><blockquote><p>JPA에서는 이 Version으로 낙관적 락을 구현하기도 한다.</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Member</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Version</span> Long version</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Spring Data REST에서는 위와 같이 <code>@Version</code> 주석이 달린 객체를 응답할 때, <code>ETag</code> 헤더를 추가한다.</p><p><strong><code>GET /api/members/1</code></strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ETag: &quot;0&quot;</span><br><span class="line">Content-Type: application&#x2F;hal+json;charset&#x3D;UTF-8</span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line">Date: Tue, 20 Mar 2018 05:50:15 GMT</span><br></pre></td></tr></table></figure><p><code>ETag</code> 헤더를 획득하였으니 이제 <code>If-Match</code>, <code>If-Non-Match</code> 등의 헤더를 추가해서 사용할 수 있다.</p><p><strong>If-Match</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -v -X PATCH -H &#39;If-Match: &lt;value of previous ETag&gt;&#39; ...</span><br></pre></td></tr></table></figure><p><strong>If-None-Match</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -v -H &#39;If-None-Match: &lt;value of previous etag&gt;&#39; ...</span><br></pre></td></tr></table></figure><h2 id="If-Modified-Since"><a href="#If-Modified-Since" class="headerlink" title="If-Modified-Since"></a>If-Modified-Since</h2><p><code>@LastModifiedDate</code> 애노테이션을 사용하여 <code>Last-Modified</code> 응답 헤더를 줄 수 있다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Member</span> </span>&#123;</span><br><span class="line">  <span class="meta">@LastModified</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>이를 이용해 <code>If-Modified-Since</code> 헤더를 추가해서 요청할 수 있다.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -H &quot;If-Modified-Since: Wed, 24 Jun 2015 20:28:15 GMT&quot; ...</span><br></pre></td></tr></table></figure><p><strong><code>GET /api/members/1</code></strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Last-Modified: Tue, 20 Mar 2018 05:57:01 GMT-4s</span><br><span class="line">Date: Tue, 20 Mar 2018 05:57:05 GMT</span><br><span class="line">ETag: &quot;0&quot;</span><br><span class="line">Content-Type: application&#x2F;hal+json;charset&#x3D;UTF-8</span><br></pre></td></tr></table></figure><h1 id="Events"><a href="#Events" class="headerlink" title="Events"></a>Events</h1><p>엔티티를 처리하는 중에 아래의 이벤트들이 발생하며, 이를 처리할 수 있다.</p><ul><li>BeforeCreateEvent</li><li>AfterCreateEvent</li><li>BeforeSaveEvent</li><li>AfterSaveEvent</li><li>BeforeLinkSaveEvent</li><li>AfterLinkSaveEvent</li><li>BeforeDeleteEvent</li><li>AfterDeleteEvent</li></ul><h2 id="AbstractRepositoryEventListener를-상속"><a href="#AbstractRepositoryEventListener를-상속" class="headerlink" title="AbstractRepositoryEventListener를 상속"></a>AbstractRepositoryEventListener를 상속</h2><p><code>AbstractRepositoryEventListener</code>에는 각 이벤트별로 처리하기 위한 메서드들이 <code>protected</code>로 정의되어 있다.<br>필요한 메서드를 재정의하여 사용한다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MemberEventListener</span> <span class="keyword">extends</span> <span class="title">AbstractRepositoryEventListener</span>&lt;<span class="title">Member</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onBeforeSave</span><span class="params">(Member member)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAfterDelete</span><span class="params">(Member member)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Annotated-Handler"><a href="#Annotated-Handler" class="headerlink" title="Annotated Handler"></a>Annotated Handler</h2><p><code>@RepositoryEventHandler</code> 등의 애노테이션으로 이벤트 핸들러를 등록할 수 있다.<br>이 때 핸들러는 spring에 bean으로 등록되어야 한다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RepositoryEventHandler</span> </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MemberEventHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@HandleBeforeSave</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMemberSave</span><span class="params">(Member p)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@HandleBeforeSave</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleAddressSave</span><span class="params">(Address p)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="Security"><a href="#Security" class="headerlink" title="Security"></a>Security</h1><p><code>spring-security</code>와 연동하여 권한에 따른 연산을 수행할도록 설정할 수 있다.</p><h2 id="PreAuthorize"><a href="#PreAuthorize" class="headerlink" title="@PreAuthorize"></a>@PreAuthorize</h2><p><code>MemberRepository</code>의 <code>findByName</code>은 <code>ADMIN</code> 권한의 사용자만 사용할 수 있고,<br>나머지는 <code>USER</code> 권한의 사용자도 사용할 수 있다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PreAuthorize</span>(<span class="string">"hasRole('USER')"</span>)</span><br><span class="line"><span class="meta">@RepositoryRestResource</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MemberRepository</span> <span class="keyword">extends</span> <span class="title">JpaRepository</span>&lt;<span class="title">Member</span>, <span class="title">Long</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PreAuthorize</span>(<span class="string">"hasRole('ADMIN')"</span>)</span><br><span class="line">    <span class="function">Member <span class="title">findByName</span><span class="params">(@Param(<span class="string">"name"</span>)</span> String name)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="마무리"><a href="#마무리" class="headerlink" title="마무리"></a>마무리</h1><p>Spring Data REST에 대해서 알아보았다.<br>Repository와 Entity의 내용을 기반으로 간편히 RESTful API를 제공해주기는 하지만,<br>DDD에 적용할 정도의 정교함을 보여주지는 않는 것 같다.<br><code>board</code> 엔티티에 <code>public void like()</code> 메서드를 <code>/api/boards/1/like</code>를 통해 실행할 수 있다면 좋을 것 같다.<br>생각해보면 <code>spring-data</code>의 하위 라이브러리들은 <code>repository</code>에 필요한 기능들을 추상화하는 것들이니, 일부러 굳이 서비스 로직까지 건들지는 않는 것 같다.<br>위에서 말한 것도, 결국 커스텀 설정으로 가능하게 만들 수 있다.</p><p>client에서 <code>HATEOAS</code>를 적용하여 개발을 한다면 충분히 사용할 만한 기술이라고 생각한다.</p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;서론&quot;&gt;&lt;a href=&quot;#서론&quot; class=&quot;headerlink&quot; title=&quot;서론&quot;&gt;&lt;/a&gt;서론&lt;/h1&gt;&lt;p&gt;Spring Data REST는 도메인 모델과 repository를 분석해서, &lt;code&gt;RESTful API&lt;/code&gt;를 제공해준다.&lt;br&gt;본 문서에서는 Spring Data REST에 대한 간단한 예제와 함께 사용법에 관한 소개를 하고자 한다.&lt;/p&gt;
    
    </summary>
    
      <category term="spring" scheme="https://supawer0728.github.io/categories/spring/"/>
    
      <category term="reference" scheme="https://supawer0728.github.io/categories/spring/reference/"/>
    
      <category term="data" scheme="https://supawer0728.github.io/categories/spring/data/"/>
    
    
      <category term="spring" scheme="https://supawer0728.github.io/tags/spring/"/>
    
  </entry>
  
  <entry>
    <title>spring-boot에 관해서</title>
    <link href="https://supawer0728.github.io/2018/03/15/brief-of-spring-boot/"/>
    <id>https://supawer0728.github.io/2018/03/15/brief-of-spring-boot/</id>
    <published>2018-03-15T14:57:00.000Z</published>
    <updated>2020-03-04T08:18:02.747Z</updated>
    
    <content type="html"><![CDATA[<h1 id="spring-boot에-관해서"><a href="#spring-boot에-관해서" class="headerlink" title="spring-boot에 관해서"></a>spring-boot에 관해서</h1><p>필자의 친구가 N게임사에 면접을 보러가서 <code>spring-boot</code>는 설정을 편리하게 해주는 것 외에는 없나요라는 질문을 받았다고 한다.</p><p><code>spring-boot</code>는 설정을 편리하게 해주기 위한게 다라고 생각한다.<br>그 목적으로 나왔고, 그 목적을 달성함으로 파생되는 이익이 많다.</p><p>그 이익를 꼽자면</p><a id="more"></a><ul><li>관례를 통한 설정<ul><li>프로젝트를 새로 생성할 때 항상 하는 설정들…<ul><li>component-scan, InternalViewResolver, TransactionManager, DataSource, DBCP…</li></ul></li><li>일일이 타이핑할 필요없다. 무슨 설정이 있는지 알고만 있으면 된다. 변경할 부분만 고치자. 손가락 아플 일이 없다.</li></ul></li><li>앞서 소개한 <code>spring-boot-starter</code>를 이용한 팀 단위의 관례 정의 : 필요하다면 얼마든지 커스터마이징할 수 있다.</li><li>개발환경, 웹, 보안, 배치, JDBC, NoSql, Messaging, Application Monitoring, 빌드툴 통합, 배포, 클라우드 추상화까지 개발자가 뭘 좋아할지 몰라서 다 준비해놓았다.</li><li>빠른 프로토타입 프로젝트 생성 : 필요한 기술만 빠르게 테스트</li><li>의존성 버전 관리 : 사용할 기술들에 대한 버전을 <code>spring-boot-dependencies-${version}.pom</code>에 다 정리했다.</li><li>레퍼런스 한 번 훑어보자: 써봄직한 기술은 거의 다 있다(지원한다)</li></ul><h2 id="그럼에도-불구하고"><a href="#그럼에도-불구하고" class="headerlink" title="그럼에도 불구하고"></a>그럼에도 불구하고</h2><p>사실 <code>spring-boot</code>를 쓰면서 편하다고 느끼는 것은, <code>spring-boot</code>를 쓰지 않으면서 많은 커스텀 설정들을 직접 해봤었기 때문이 아니었을까 하는 생각도 든다.<br>SQL을 잘 다룰 줄 알아야, JPA를 더욱 효율적으로 사용할 수 있는 것처럼, spring으로 어떠한 일들을 할 수 있는지 한 번쯤 경험해봐야, boot도 잘 다룰 수 있지 않을까?<br>application 환경 설정이라는 부분은 개인간의 기술 격차가 생기기 쉬운 부분 중 하나라고 생각한다.<br>한 번, 여러 케이스들에 대해서 잘 템플릿화 해두면 큰 변경없이 오래도록 잘 써먹을 수 있기 때문인 것 같다.<br>실제로 필자도, 처음 개발 1년차 동안은 maven의 <code>parent pom</code>의 개념같은 것도 몰랐었으니 말 다했다.</p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;spring-boot에-관해서&quot;&gt;&lt;a href=&quot;#spring-boot에-관해서&quot; class=&quot;headerlink&quot; title=&quot;spring-boot에 관해서&quot;&gt;&lt;/a&gt;spring-boot에 관해서&lt;/h1&gt;&lt;p&gt;필자의 친구가 N게임사에 면접을 보러가서 &lt;code&gt;spring-boot&lt;/code&gt;는 설정을 편리하게 해주는 것 외에는 없나요라는 질문을 받았다고 한다.&lt;/p&gt;
&lt;p&gt;&lt;code&gt;spring-boot&lt;/code&gt;는 설정을 편리하게 해주기 위한게 다라고 생각한다.&lt;br&gt;그 목적으로 나왔고, 그 목적을 달성함으로 파생되는 이익이 많다.&lt;/p&gt;
&lt;p&gt;그 이익를 꼽자면&lt;/p&gt;
    
    </summary>
    
      <category term="chat" scheme="https://supawer0728.github.io/categories/chat/"/>
    
    
      <category term="chat" scheme="https://supawer0728.github.io/tags/chat/"/>
    
  </entry>
  
  <entry>
    <title>spring-boot-starter 작성하기</title>
    <link href="https://supawer0728.github.io/2018/03/15/create-spring-boot-starter/"/>
    <id>https://supawer0728.github.io/2018/03/15/create-spring-boot-starter/</id>
    <published>2018-03-15T08:36:38.000Z</published>
    <updated>2020-03-04T08:18:02.747Z</updated>
    
    <content type="html"><![CDATA[<h1 id="개요"><a href="#개요" class="headerlink" title="개요"></a>개요</h1><p><code>spring-boot</code>에서 <code>starter</code>란 의존성과 설정을 자동화해주는 모듈을 뜻한다.</p><p>예를 들어, <code>spring-boot-starter-jpa</code>를 의존성 추가했을 때 아래의 일을 해준다.</p><ul><li><code>spring-aop</code>, <code>spring-jdbc</code> 등의 의존성을 걸어준다.</li><li><code>classpath</code>를 뒤져서 어떤 Database를 사용하는지 파악하고, 자동으로 entityManager를 구성해준다.</li><li>해당 모듈들 설정에 필요한 properties 설정을 제공한다(<code>Configuration Processor</code>를 사용하면 효과 UP)</li></ul><p>프로젝트를 진행하면서, 공통적으로 사용되는 spring 설정을 모듈로 묶어놓고 사용할 수 있다.<br>또한 필요한 경우, 상위 프로젝트에서 얼마든지 설정을 덮어쓸 수 있다.</p><p>이번에는 직접 <code>spring-boot-starter</code>를 작성하고 동작하는 방법을 공유해보려 한다.<br><code>spring-boot</code> 버전은 <code>2.0.0.RELEASE</code>를 사용한다.</p><a id="more"></a><h1 id="구현할-내용"><a href="#구현할-내용" class="headerlink" title="구현할 내용"></a>구현할 내용</h1><p>아래 요구 사항을 충족하는 경우, reaquest parameter를 logging하는 <code>spring-boot-starter</code>를 작성한다.</p><ul><li><code>application.yml</code>에서 <code>spring.mvc.custom-uri-logging-filter.enabled: true</code>일 것</li><li><code>application.yml</code>에서 <code>spring.mvc.custom-uri-logging-filter.level: info</code> 등으로 지정한 레벨로 찍을 것</li></ul><h1 id="구현"><a href="#구현" class="headerlink" title="구현"></a>구현</h1><h2 id="설명"><a href="#설명" class="headerlink" title="설명"></a>설명</h2><p><code>sample-boot-starter</code> 내부에 3개의 모듈을 생성한다.</p><ul><li><code>sample-spring-boot-autoconfigure</code> : <code>@Configuration</code>으로 특정 조건에 맞춰서 설정을 실행</li><li><code>sample-spring-boot-starter-request-parameter-logging-filter</code> : <code>autoconfigure</code>와 필요한 의존성을 가짐</li><li><code>sample-spring-boot-starter-web</code> : <code>starter</code>를 주입받음</li></ul><p><code>autoconfigure</code>와 <code>starter</code>를 굳이 나누지 않고,<br><code>starter</code>내에 <code>autoconfigure</code>를 정의해서 배포하는 경우도 있다.</p><h2 id="Module-Naming"><a href="#Module-Naming" class="headerlink" title="Module Naming"></a>Module Naming</h2><p><code>starter</code>를 만들 때는 설정을 담당하는 <code>autoconfigure</code>와 의존성을 담당하는 <code>starter</code> 모듈을 작성해야 한다.<br>spring reference에서는 다음과 같이 모듈들의 명명 규칙을 정의하고 있다.</p><ul><li><code>spring-boot</code>로 시작하지 않을 것</li><li><code>acme</code>에 대한 starter를 만드는 경우<ul><li><code>autoconfigure</code> : <code>acme-spring-boot-autoconfigure</code></li><li><code>starter</code> : <code>acme-spring-boot-starter</code></li></ul></li></ul><p>spring의 경우를 보면 <a href="https://github.com/spring-projects/spring-boot/tree/master/spring-boot-project/spring-boot-autoconfigure/src/main/java/org/springframework/boot/autoconfigure" target="_blank" rel="noopener">spring-boot-autoconfigure</a>에서 모든 <code>spring-boot-starter-XXX</code>의 자동 설정 사항을 들고 있다.<br>이를 기반으로 <code>spring-boot-starter-XXX</code>(예: <a href="https://github.com/spring-projects/spring-boot/blob/master/spring-boot-project/spring-boot-starters/spring-boot-starter-data-jpa/pom.xml" target="_blank" rel="noopener">spring-boot-starter-jpa</a>) 모듈에서는 의존성만 관리하고 있다.</p><p>저러한 규칙을 응용해서 <code>{project}-spring-boot-configure</code>, <code>{project}-spring-boot-starter-{module}</code>로 명명을 해도 괜찮다고 생각한다.</p><h2 id="application-property-key"><a href="#application-property-key" class="headerlink" title="application property key"></a>application property key</h2><p>reference에서는 가능한 고유한 key를 사용할 것을 권고하고 있다.<br><code>server</code>, <code>management</code>, <code>spring</code> 등, spring이 이미 정의한 property key를 사용하는 경우,<br>향후 spring의 수정 내용이 어떠한 영향을 미칠지 알 수 없기 때문이다.</p><h2 id="autoconfigure-모듈"><a href="#autoconfigure-모듈" class="headerlink" title="autoconfigure 모듈"></a>autoconfigure 모듈</h2><p><code>autoconfigure</code> 모듈은 자동 설정에 필요한 모든 요소(<code>@ConfigurationProperties</code> 등)와 <code>library</code>를 갖고 있다.<br><code>autoconfigure</code>에서 참조한 의존성에는 <code>optional</code>을 걸어두는 것이 좋다. 이 경우, <code>autoconfigure</code>를 참조하는 모듈에서 필요한 의존성이 없을 때, Spring Boot는 자동 설정을 하지 않는다.</p><h3 id="구현-1"><a href="#구현-1" class="headerlink" title="구현"></a>구현</h3><h4 id="pom-xml"><a href="#pom-xml" class="headerlink" title="pom.xml"></a>pom.xml</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.parfait.study<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sample-spring-boot-autoconfigure<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>jar<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>sample-spring-boot-autoconfigure<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.reporting.outputEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.reporting.outputEncoding</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">spring-boot.version</span>&gt;</span>2.0.0.RELEASE<span class="tag">&lt;/<span class="name">spring-boot.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-autoconfigure<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-configuration-processor<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>slf4j-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.servlet<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javax.servlet-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span> <span class="comment">&lt;!-- The parent should provide all that --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring-boot.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li><code>slf4j-api</code> : log를 사용하기 위해 의존</li><li><code>javax.servlet-api</code> : Filter를 사용하기 위해 의존</li><li><code>spring-boot-configuration-processor</code> : IDE가 <code>application.yml</code>의 내용을 가이드할 수 있도록 한다. 추후 상세 설명함.</li></ul><h4 id="application-yml"><a href="#application-yml" class="headerlink" title="application.yml"></a>application.yml</h4><p>default 설정을 정의할 수 있다.</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring.mvc.request-parameter-logging-filter:</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">level:</span> <span class="string">DEBUG</span></span><br><span class="line"><span class="attr">logging.level.com.parfait.study.autoconfigure.logging.filter.RequestParameterLoggingFilter:</span> <span class="string">$&#123;spring.mvc.request-parameter-logging-filter.level&#125;</span></span><br></pre></td></tr></table></figure><h4 id="src-main-resoucres-META-INF-additional-spring-configuration-metadata-json"><a href="#src-main-resoucres-META-INF-additional-spring-configuration-metadata-json" class="headerlink" title="src/main/resoucres/META-INF/additional-spring-configuration-metadata.json"></a>src/main/resoucres/META-INF/additional-spring-configuration-metadata.json</h4><p><code>application.yml</code>에서 설정한 key에 대한 정보를 정의할 수 있다.<br>이를 Configuration Metadata라 부르며, 이 파일을 정의한 경우 IDE에서 해당 키에 대한 가이드를 보여줄 수 있다.<br>가이드를 확인할 수 있는 화면은 추후 첨부하겠다.<br><a href="https://docs.spring.io/spring-boot/docs/current/reference/html/configuration-metadata.html" target="_blank" rel="noopener">Configuration Metadata에 대해</a></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"properties"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"name"</span>: <span class="string">"spring.mvc.request-parameter-logging-filter.enabled"</span>,</span><br><span class="line">      <span class="attr">"type"</span>: <span class="string">"org.slf4j.event.Level"</span>,</span><br><span class="line">      <span class="attr">"description"</span>: <span class="string">"true 또는 false"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"name"</span>: <span class="string">"spring.mvc.request-parameter-logging-filter.level"</span>,</span><br><span class="line">      <span class="attr">"type"</span>: <span class="string">"java.lang.String"</span>,</span><br><span class="line">      <span class="attr">"description"</span>: <span class="string">"로깅 레벨 설정"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="RequestParameterLoggingFilterProperties"><a href="#RequestParameterLoggingFilterProperties" class="headerlink" title="RequestParameterLoggingFilterProperties"></a>RequestParameterLoggingFilterProperties</h4><p><code>application.yml</code>에서 작성한 키에 대응하는 Java class를 정의할 수 있다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ConfigurationProperties</span>(prefix = <span class="string">"spring.mvc.request-parameter-logging-filter"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RequestParameterLoggingFilterProperties</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> enabled;</span><br><span class="line">    <span class="keyword">private</span> Level level;</span><br><span class="line">    <span class="comment">// getters and setters</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="RequestParameterLoggingFilter"><a href="#RequestParameterLoggingFilter" class="headerlink" title="RequestParameterLoggingFilter"></a>RequestParameterLoggingFilter</h4><p>실제 로직을 담당하는 필터를 정의한다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RequestParameterLoggingFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">        String params = request.getParameterMap()</span><br><span class="line">                            .entrySet()</span><br><span class="line">                            .stream()</span><br><span class="line">                            .map(entry -&gt; entry.getKey() + <span class="string">"="</span> + String.join(<span class="string">","</span>, entry.getValue()))</span><br><span class="line">                            .flatMap(Stream::of)</span><br><span class="line">                            .collect(Collectors.joining(<span class="string">"&amp;"</span>));</span><br><span class="line">        log(params);</span><br><span class="line">        chain.doFilter(request, response);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// private void log(String params) &#123; ... &#125;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="SampleAutoConfiguration"><a href="#SampleAutoConfiguration" class="headerlink" title="SampleAutoConfiguration"></a>SampleAutoConfiguration</h4><p>재료(<code>property</code>, <code>logic</code>)이 다 모였으니, 이를 자동 설정이 되도록 해보자.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@AutoConfigureAfter</span>(WebMvcAutoConfiguration<span class="class">.<span class="keyword">class</span>) // 1</span></span><br><span class="line"><span class="class">@<span class="title">EnableConfigurationProperties</span>(<span class="title">RequestParameterLoggingFilterProperties</span>.<span class="title">class</span>) // 2</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">SampleAutoConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RequestParameterLoggingFilterProperties requestParameterLoggingFilterProperties; </span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnProperty</span>(name = <span class="string">"spring.mvc.request-parameter-logging-filter.enabled"</span>, havingValue = <span class="string">"true"</span>) <span class="comment">// 3</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Filter <span class="title">customUriLoggingFilter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RequestParameterLoggingFilter(requestParameterLoggingFilterProperties.getLevel());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>Filter 설정(webmvc-specific)을 하는 것이기 때문에, webmvc 설정이 완료된 후에 해당 설정이 동작하게 만든다. </li><li>RequestParameterLoggingFilterProperties를 bean으로 생성해 <code>@Autowired</code> 가능하도록 만든다.</li><li><code>@ConditionalOnXXX</code>를 사용하여 <code>@Bean</code> 생성의 조건, <code>@Configuration</code> 작동의 조건을 만들 수 있다.<br><code>@Conditional(Condition condition)</code>으로 <code>Condition</code> 인터페이스를 구현하여 더욱 상세하게 조건을 지정할 수도 있다.</li></ol><h4 id="src-main-resource-META-INF-spring-factories"><a href="#src-main-resource-META-INF-spring-factories" class="headerlink" title="src/main/resource/META-INF/spring.factories"></a>src/main/resource/META-INF/spring.factories</h4><p><code>.jar</code>파일에 포함되어, 해당 boot 모듈이 설정해야 할 정보를 가지고 있다.<br><code>org.springframework.boot.autoconfigure.EnableAutoConfiguration</code> 키에 작성한 <code>@Configuration</code> class들을 콤마(<code>,</code>) 구분자로 넣어준다</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.boot.autoconfigure.EnableAutoConfiguration&#x3D;com.parfait.study.autoconfigure.SampleAutoConfiguration</span><br></pre></td></tr></table></figure><p><a href="https://github.com/spring-projects/spring-boot/blob/v2.0.0.RELEASE/spring-boot-project/spring-boot-autoconfigure/src/main/resources/META-INF/spring.factories" target="_blank" rel="noopener">spring-boot-autoconfigure에서 사용되는 spring.factories</a></p><h2 id="starter-모듈"><a href="#starter-모듈" class="headerlink" title="starter 모듈"></a>starter 모듈</h2><p>필요한 설정 정보는 <code>autoconfigure</code>에서 모두 마쳤다.<br><code>starter</code>에서는 의존성만 걸어주면 된다.<br><code>autoconfigure</code>에서 <code>optional</code>을 제거하기만 하면 된다.</p><h4 id="pom-xml-1"><a href="#pom-xml-1" class="headerlink" title="pom.xml"></a>pom.xml</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.parfait.study<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sample-spring-boot-starter-request-parameter-logging-filter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>jar<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>sample-spring-boot-starter-request-parameter-logging-filter<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.reporting.outputEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.reporting.outputEncoding</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">spring-boot.version</span>&gt;</span>2.0.0.RELEASE<span class="tag">&lt;/<span class="name">spring-boot.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.parfait.study<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sample-spring-boot-autoconfigure<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>slf4j-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.servlet<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javax.servlet-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span> <span class="comment">&lt;!-- The parent should provide all that --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring-boot.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="web-모듈"><a href="#web-모듈" class="headerlink" title="web 모듈"></a>web 모듈</h2><p>이제 설정한 <code>starter</code>를 써먹어보자.<br><code>sample-spring-boot-starter-web</code>이라는 이름이지만 그냥 웹 API Application이다.</p><h4 id="pom-xml-2"><a href="#pom-xml-2" class="headerlink" title="pom.xml"></a>pom.xml</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.parfait.study<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sample-spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>jar<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>sample-spring-boot-starter-web<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.0.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.reporting.outputEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.reporting.outputEncoding</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- starter 의존성 설정 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.parfait.study<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sample-spring-boot-starter-request-parameter-logging-filter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="UserController"><a href="#UserController" class="headerlink" title="UserController"></a>UserController</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/users"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/&#123;id&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">get</span><span class="params">(@PathVariable Long id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RestTemplate().getForObject(<span class="string">"https://jsonplaceholder.typicode.com/users/&#123;id&#125;"</span>, String<span class="class">.<span class="keyword">class</span>, <span class="title">id</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="application-yml-1"><a href="#application-yml-1" class="headerlink" title="application.yml"></a>application.yml</h4><p>드디어 보여줄 수 있게 되었다.<br><code>src/main/resoucres/META-INF/additional-spring-configuration-metadata.json</code>에서 말했던 IDE의 가이드란 이런 것이다.</p><p><img src="/images/create-spring-boot-starter/ide-guide.png" alt="ide-guide"><br><img src="/images/create-spring-boot-starter/ide-guide2.png" alt="ide-guide2"></p><p>값 타입을 해석해서 후보까지 보여주는 위엄!</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">spring.mvc.request-parameter-logging-filter.enabled=true</span></span><br><span class="line"><span class="string">spring.mvc.request-parameter-logging-filter.level=info</span></span><br></pre></td></tr></table></figure><blockquote><p><code>autoconfigure</code>에서 작성한 <code>appliaction.yml</code>값이 default이다.<br><code>autoconfigure</code>에서도 기본값을 지정하지 않고, Configuration Meta만 넘길 수도 있다.</p></blockquote><h4 id="실행-결과"><a href="#실행-결과" class="headerlink" title="실행 결과"></a>실행 결과</h4><p>이제 서버를 띄우고 API를 실행해보자.<br>사용하는 소스에서는 <code>application.yml</code> 외에는 아무런 설정을 하지 않았는데 Filter가 잘 동작하는 것을 확인할 수 있다.</p><p><strong><code>GET /users/1?name=hello</code></strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2018-03-15 21:24:20.656  INFO 16048 --- [nio-8080-exec-1] .p.s.a.l.f.RequestParameterLoggingFilter : uri : name&#x3D;hello</span><br></pre></td></tr></table></figure><h1 id="이-외에-할-수-있는-일들에-대해"><a href="#이-외에-할-수-있는-일들에-대해" class="headerlink" title="이 외에 할 수 있는 일들에 대해"></a>이 외에 할 수 있는 일들에 대해</h1><p><code>spring-boot-starter</code>는 협업에 있어서 강력한 자동 설정을 지원해 줄 수 있다는 점에서 매우 권장한다. boot를 사용하는 팀 간의 지원을 아주 간편하게 해줄 수 있다.</p><p>예를 들어, 빅데이터 분석을 위해 정보를 수집해야 하는 서비스에서는 <code>bigdata-spring-boot-starter-log</code>를 제공하여 아래와 같은 설정만으로 로그 수집 로직이 동작하게 하거나</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">bigdata.log:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">server:</span> <span class="string">http://bigdata.server.com</span></span><br><span class="line">  <span class="attr">service.name:</span> <span class="string">ABC</span> <span class="string">Portal</span></span><br></pre></td></tr></table></figure><p>혹은 회원 암호화 토큰을 cookie나 header로 받은 후,<br>회원 서버와 통신하고 그 결과를 request의 attribute에 주입해주는 경우,<br>아래와 같은 설정만으로 할 수도 있다.</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">member-server:</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">request:</span></span><br><span class="line">    <span class="attr">token:</span></span><br><span class="line">      <span class="comment"># or HEADER</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">COOKIE</span> </span><br><span class="line">      <span class="attr">name:</span> <span class="string">MEMBER_TOKEN</span></span><br><span class="line">    <span class="attr">read-timeout:</span> <span class="number">2000</span></span><br><span class="line">    <span class="attr">connect-timeout:</span> <span class="number">1000</span></span><br><span class="line">  <span class="attr">result.attribute-name:</span> <span class="string">RESOLVER_MEMBER_INFO</span></span><br></pre></td></tr></table></figure><p>필터 말고 다른 예를 들어보자.<br>spring의 <code>Cache Abstraction</code>을 이용해서 <code>@Cacheable</code>을 <a href="https://docs.oracle.com/cd/E24290_01/coh.371/e22840/nearcache.htm" target="_blank" rel="noopener">Near Cache</a>로 구성할 수도 있다.</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">chained-cache-namager:</span></span><br><span class="line">  <span class="attr">bean-name:</span> <span class="string">cacheManager</span></span><br><span class="line">  <span class="attr">local:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">EHCACHE</span></span><br><span class="line">    <span class="attr">config:</span> <span class="string">classpath:/ehcache.xml</span></span><br><span class="line">  <span class="attr">global:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">REDIS</span></span><br><span class="line">    <span class="attr">cluster.hosts:</span> </span><br><span class="line">      <span class="bullet">-</span> <span class="number">10.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:6379</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">10.0</span><span class="number">.0</span><span class="number">.2</span><span class="string">:6379</span></span><br></pre></td></tr></table></figure><h1 id="마무리"><a href="#마무리" class="headerlink" title="마무리"></a>마무리</h1><p><code>spring-boot</code>로 인해 설정이 간편화되면서, 개발자는 좀 더 핵심 logic에 신경 쓸 수 있게 되었다.<br>예전에는 상위 <code>pom.xml</code>에서 의존성 관리하랴, 개발 프로젝트에서는 일일이 설정하랴,<br>한 번 프로젝트를 생성할 때마다 다시 한 번 반복하는 일들이 많았지만,<br>이제는 정해진 규모의 팀에서 정해진 관례로 아주 간편하게 설정을 간소화할 수 있다.</p><p>협업하는 부서에서 <code>boot</code>를 쓴다면, 살며시 <code>starter</code>를 건네보자.</p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;개요&quot;&gt;&lt;a href=&quot;#개요&quot; class=&quot;headerlink&quot; title=&quot;개요&quot;&gt;&lt;/a&gt;개요&lt;/h1&gt;&lt;p&gt;&lt;code&gt;spring-boot&lt;/code&gt;에서 &lt;code&gt;starter&lt;/code&gt;란 의존성과 설정을 자동화해주는 모듈을 뜻한다.&lt;/p&gt;
&lt;p&gt;예를 들어, &lt;code&gt;spring-boot-starter-jpa&lt;/code&gt;를 의존성 추가했을 때 아래의 일을 해준다.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;spring-aop&lt;/code&gt;, &lt;code&gt;spring-jdbc&lt;/code&gt; 등의 의존성을 걸어준다.&lt;/li&gt;
&lt;li&gt;&lt;code&gt;classpath&lt;/code&gt;를 뒤져서 어떤 Database를 사용하는지 파악하고, 자동으로 entityManager를 구성해준다.&lt;/li&gt;
&lt;li&gt;해당 모듈들 설정에 필요한 properties 설정을 제공한다(&lt;code&gt;Configuration Processor&lt;/code&gt;를 사용하면 효과 UP)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;프로젝트를 진행하면서, 공통적으로 사용되는 spring 설정을 모듈로 묶어놓고 사용할 수 있다.&lt;br&gt;또한 필요한 경우, 상위 프로젝트에서 얼마든지 설정을 덮어쓸 수 있다.&lt;/p&gt;
&lt;p&gt;이번에는 직접 &lt;code&gt;spring-boot-starter&lt;/code&gt;를 작성하고 동작하는 방법을 공유해보려 한다.&lt;br&gt;&lt;code&gt;spring-boot&lt;/code&gt; 버전은 &lt;code&gt;2.0.0.RELEASE&lt;/code&gt;를 사용한다.&lt;/p&gt;
    
    </summary>
    
      <category term="spring" scheme="https://supawer0728.github.io/categories/spring/"/>
    
      <category term="practice" scheme="https://supawer0728.github.io/categories/practice/"/>
    
      <category term="practice" scheme="https://supawer0728.github.io/categories/spring/practice/"/>
    
      <category term="boot" scheme="https://supawer0728.github.io/categories/spring/boot/"/>
    
    
      <category term="spring" scheme="https://supawer0728.github.io/tags/spring/"/>
    
      <category term="spring-boot" scheme="https://supawer0728.github.io/tags/spring-boot/"/>
    
      <category term="starter" scheme="https://supawer0728.github.io/tags/starter/"/>
    
  </entry>
  
  <entry>
    <title>Spring5에서 HTTP Streaming</title>
    <link href="https://supawer0728.github.io/2018/03/15/spring-http-stereamings/"/>
    <id>https://supawer0728.github.io/2018/03/15/spring-http-stereamings/</id>
    <published>2018-03-15T06:30:19.000Z</published>
    <updated>2020-03-04T08:18:02.751Z</updated>
    
    <content type="html"><![CDATA[<h1 id="서론"><a href="#서론" class="headerlink" title="서론"></a>서론</h1><p>Spring의 Stream이라고 하면, 가장 먼저 떠오르는 것은 websocket일 것 같다.<br>websocket은 full-duplex communication(전 이중 통신)을 표방하고 있으며, 별도의 프로토콜을 공부해야하는 등, web상의 양방향 통신을 복잡하다고 느낄 수 있을 것 같다.</p><p>때문에 다음의 조건들을 충족시킬 Http Streaming 기법에 대해, <code>spring-webmvc</code>와 <code>spring-webflux</code> 별로 하나씩 공유하려한다.</p><ul><li>Spring5에서 지원</li><li>구현 난이도가 낮음</li><li>기존의 Http 통신을 기반</li></ul><a id="more"></a><h1 id="spring-webmvc-SSE"><a href="#spring-webmvc-SSE" class="headerlink" title="spring-webmvc : SSE"></a>spring-webmvc : SSE</h1><p><code>spring-webmvc</code>에서 HTTP Streaming을 하는 가장 간단한 방법은 <a href="https://www.w3.org/TR/eventsource/" target="_blank" rel="noopener">SSE(Server-Sent Event)</a>를 사용하는 것이다.(<a href="https://www.w3schools.com/html/tryit.asp?filename=tryhtml5_sse" target="_blank" rel="noopener">예제</a>)</p><h2 id="장점"><a href="#장점" class="headerlink" title="장점"></a>장점</h2><ul><li>spring에서 서버측 구현이 간편하다</li><li>표준 기술이므로 javascript에서 구현이 간편하다</li><li>Android, iOS에서도 관련 라이브러리가 있다</li><li>자동으로 재접속을 시도한다</li></ul><h2 id="단점"><a href="#단점" class="headerlink" title="단점"></a>단점</h2><ul><li>Native Javascript로는 Header를 추가하는 등의 세밀한 조정을 할 수 없다<ul><li>Polyfill로 대체 가능</li></ul></li><li>표준 기술이지만 IE(edge 포함)에서 지원하지 않는다<ul><li>Polyfill로 대체 가능</li></ul></li><li>client 측에서 연결을 끊은 경우를 감지하지 못한다</li></ul><h2 id="구현"><a href="#구현" class="headerlink" title="구현"></a>구현</h2><p><strong>spring reference에 나와있는 간단한 소스</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping</span>(path=<span class="string">"/events"</span>, produces=MediaType.TEXT_EVENT_STREAM_VALUE)</span><br><span class="line"><span class="function"><span class="keyword">public</span> SseEmitter <span class="title">handle</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    SseEmitter emitter = <span class="keyword">new</span> SseEmitter();</span><br><span class="line">    <span class="comment">// Save the emitter somewhere..</span></span><br><span class="line">    <span class="keyword">return</span> emitter;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// In some other thread</span></span><br><span class="line">emitter.send(<span class="string">"Hello once"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// and again later on</span></span><br><span class="line">emitter.send(<span class="string">"Hello again"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// and done at some point</span></span><br><span class="line">emitter.complete();</span><br></pre></td></tr></table></figure><p><code>SseEmitter</code>를 반환하고, 별도의 thread에서 <code>emmiter.send()</code>를 호출하면 된다.</p><h3 id="구현할-예제"><a href="#구현할-예제" class="headerlink" title="구현할 예제"></a>구현할 예제</h3><p><code>GET /users</code>로 요청시, 1초 간격으로<br><code>https://jsonplaceholder.typicode.com/users/{id}</code>의 1,2,3을 차례로 호출해서 응답</p><h3 id="의존성"><a href="#의존성" class="headerlink" title="의존성"></a>의존성</h3><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">dependencies</span> &#123;</span><br><span class="line">    <span class="keyword">compile</span>(<span class="string">'org.springframework.boot:spring-boot-starter-web'</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Controller"><a href="#Controller" class="headerlink" title="Controller"></a>Controller</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/users"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserEmitService service;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(produces = MediaType.TEXT_EVENT_STREAM_VALUE)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResponseBodyEmitter <span class="title">users</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        SseEmitter emitter = <span class="keyword">new</span> SseEmitter();</span><br><span class="line">        service.add(emitter);</span><br><span class="line">        <span class="keyword">return</span> emitter;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserEmitService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> REPEAT = <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;ResponseBodyEmitter, AtomicInteger&gt; emitterCountMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(ResponseBodyEmitter emitter)</span> </span>&#123;</span><br><span class="line">        emitterCountMap.put(emitter, <span class="keyword">new</span> AtomicInteger(<span class="number">0</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Scheduled</span>(fixedRate = <span class="number">1000L</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">emit</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        List&lt;ResponseBodyEmitter&gt; toBeRemoved = <span class="keyword">new</span> ArrayList&lt;&gt;(emitterCountMap.size());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;ResponseBodyEmitter, AtomicInteger&gt; entry : emitterCountMap.entrySet()) &#123;</span><br><span class="line"></span><br><span class="line">            Integer count = entry.getValue().incrementAndGet();</span><br><span class="line">            User user = <span class="keyword">new</span> RestTemplate().getForObject(<span class="string">"https://jsonplaceholder.typicode.com/users/&#123;id&#125;"</span>, User<span class="class">.<span class="keyword">class</span>, <span class="title">count</span>)</span>;</span><br><span class="line"></span><br><span class="line">            ResponseBodyEmitter emitter = entry.getKey();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                emitter.send(user);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                log.error(e.getMessage(), e);</span><br><span class="line">                toBeRemoved.add(emitter);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (count &gt;= REPEAT) &#123;</span><br><span class="line">                toBeRemoved.add(emitter);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (ResponseBodyEmitter emitter : toBeRemoved) &#123;</span><br><span class="line">            emitterCountMap.remove(emitter);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="실행-결과"><a href="#실행-결과" class="headerlink" title="실행 결과"></a>실행 결과</h3><p>브라우저에서 <code>GET /users</code>를 호출 해보면, 아래 결과가 한 줄마다 1초 간격으로 표시된다.<br><code>data</code>라고 하는 key에 json value가 붙어있는 형태다.</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">data:&#123;"id":1,"name":"Leanne Graham","email":"Sincere@april.biz","phone":"1-770-736-8031 x56442","website":"hildegard.org"&#125;</span><br><span class="line"></span><br><span class="line">data:&#123;"id":2,"name":"Ervin Howell","email":"Shanna@melissa.tv","phone":"010-692-6593 x09125","website":"anastasia.net"&#125;</span><br><span class="line"></span><br><span class="line">data:&#123;"id":3,"name":"Clementine Bauch","email":"Nathan@yesenia.net","phone":"1-463-123-4447","website":"ramiro.info"&#125;</span><br></pre></td></tr></table></figure><h2 id="동작-방식"><a href="#동작-방식" class="headerlink" title="동작 방식"></a>동작 방식</h2><p>Spring에서 지원하는 Async 응답 방식인 <code>DeferredResult</code>, <code>Callable</code>과 같다</p><p><strong>Spring Async 응답 방식 개요</strong></p><ul><li>반환형이 Async 응답을 필요로하는 경우, Spring MVC는 <code>request.startAsync()</code>를 호출하여 <code>AsyncContext</code>를 획득하여 저장해둔다.<ul><li><code>AsyncContext</code>는 비동기 처리를 제어할 수 있도록 해준다.</li><li>ex) Sevrlet container thread에서 요청 처리를 재개시키며, 기존의 <code>forward</code>와 같은 동작을 하는 <code>dispatch</code> 메서드를 제공한다.</li><li>이로 인해 응답을 별도의 thread에서 비동기로 처리할 수 있다.</li></ul></li><li>요청 thread를 종료시키되, response는 열어둔다</li><li>다른 thread에서 <code>AsyncContext</code>를 사용해서 response를 완성시킨다.<ul><li>Spring MVC는 Servlet container로 다시 요청을 보내고(dispatch), client로 응답한다.</li></ul></li></ul><h2 id="주의-사항"><a href="#주의-사항" class="headerlink" title="주의 사항"></a>주의 사항</h2><p>boot를 사용하는 경우, <code>spring.mvc.async.request-timeout: 1000</code>로 timeout 설정을 할 수 있다.<br><code>new SseEmitter(int timeout)</code>으로 개별로 사용할 수 있으며, 우선 설정된다.</p><h1 id="spring-webflux-Flux-lt-T-gt"><a href="#spring-webflux-Flux-lt-T-gt" class="headerlink" title="spring-webflux : Flux&lt;T&gt;"></a>spring-webflux : <code>Flux&lt;T&gt;</code></h1><p><code>reactor</code>에서 <code>Flux&lt;T&gt;</code>는 <code>T</code>의 stream을 의미한다.<br><code>Controller</code>에서 <code>Flux&lt;T&gt;</code>를 반환하는 경우, <code>application/stream+json</code>으로 객체를 json 형식으로 받을 수 있다.</p><blockquote><p><code>Flux&lt;ServerSentEvent&gt;</code> 방식으로 SSE를 사용할 수도 있다.</p></blockquote><h2 id="장점-1"><a href="#장점-1" class="headerlink" title="장점"></a>장점</h2><ul><li>reactive의 장점을 살릴 수 있다.</li><li>reactor를 알고 있으면 구현하기 쉽다.</li></ul><h2 id="단점-1"><a href="#단점-1" class="headerlink" title="단점"></a>단점</h2><ul><li>client 측에서 지원해주는 라이브러리는 적은 듯하다.</li></ul><h2 id="구현-예제"><a href="#구현-예제" class="headerlink" title="구현 예제"></a>구현 예제</h2><p>요구 사항은 위 예제와 동일하다.<br>1초마다 User를 불러온다.</p><h3 id="의존성-1"><a href="#의존성-1" class="headerlink" title="의존성"></a>의존성</h3><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">dependencies</span> &#123;</span><br><span class="line">    <span class="keyword">compile</span>(<span class="string">'org.springframework.boot:spring-boot-starter-webflux'</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Controller-1"><a href="#Controller-1" class="headerlink" title="Controller"></a>Controller</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/users"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserClient userClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UserController</span><span class="params">(@NonNull UserClient userClient)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.userClient = userClient;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1초마다 User 발생</span></span><br><span class="line">    <span class="meta">@GetMapping</span>(produces = <span class="string">"application/stream+json"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Flux&lt;User&gt; <span class="title">users</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Flux.interval(Duration.ofSeconds(<span class="number">1L</span>))</span><br><span class="line">                   .take(<span class="number">3</span>)</span><br><span class="line">                   .flatMap(number -&gt; userClient.get(number + <span class="number">1L</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="UserClient"><a href="#UserClient" class="headerlink" title="UserClient"></a>UserClient</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserClient</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Flux&lt;User&gt; <span class="title">get</span><span class="params">(<span class="keyword">long</span> id)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> WebClient.create(<span class="string">"https://jsonplaceholder.typicode.com"</span>)</span><br><span class="line">                        .get()</span><br><span class="line">                        .uri(<span class="string">"/users/&#123;id&#125;"</span>, id)</span><br><span class="line">                        .retrieve()</span><br><span class="line">                        .bodyToFlux(User<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="실행-결과-1"><a href="#실행-결과-1" class="headerlink" title="실행 결과"></a>실행 결과</h3><p>브라우저에서 실행해보면 1초마다 한 줄씩 표시된다.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;id&quot;:1,&quot;name&quot;:&quot;Leanne Graham&quot;,&quot;email&quot;:&quot;Sincere@april.biz&quot;,&quot;phone&quot;:&quot;1-770-736-8031 x56442&quot;,&quot;website&quot;:&quot;hildegard.org&quot;&#125;</span><br><span class="line">&#123;&quot;id&quot;:2,&quot;name&quot;:&quot;Ervin Howell&quot;,&quot;email&quot;:&quot;Shanna@melissa.tv&quot;,&quot;phone&quot;:&quot;010-692-6593 x09125&quot;,&quot;website&quot;:&quot;anastasia.net&quot;&#125;</span><br><span class="line">&#123;&quot;id&quot;:3,&quot;name&quot;:&quot;Clementine Bauch&quot;,&quot;email&quot;:&quot;Nathan@yesenia.net&quot;,&quot;phone&quot;:&quot;1-463-123-4447&quot;,&quot;website&quot;:&quot;ramiro.info&quot;&#125;</span><br></pre></td></tr></table></figure><h1 id="마무리"><a href="#마무리" class="headerlink" title="마무리"></a>마무리</h1><p>Spring5에서 지원해주는 Http Streaming에 대해서 <code>webmvc</code>, <code>webflux</code> 라이브러리 별로 하나씩 알아보았다.</p><p>아무래도 <code>websocket</code>과 비교를 할 수 밖에 없는데,</p><p><code>websocket</code>과 비교했을 때의 장점은 <code>구현하기 쉽다</code>는 것이다.<br>이것도 좀 애매한데 <code>구현하기 쉽다</code>는 상대적인 것이어서 이미 <code>websocket</code>을 경험해본 사람들은,<br>오히려 더 많은 기능을 지원해주는 <code>websocket</code>을 선호할 것 같다.<br><code>websocket</code>의 경우에는 <code>Sse</code>보다 오히려 client에서 많은 지원을 해주며(<code>SockJs</code> 등), reference도 다양하다.<br><code>Flux&lt;T&gt;</code>는 spring5로 넘어오면서 <code>websocket</code>에서도 반환할 수 있다.</p><p>다른 장점은 전통적인 Http 방식이므로 infra를 건들 일이 없다는 것이다.<br><code>websocket</code>은 몇몇 구식 load balancer나 proxy에서는 지원을 하지 않거나, 미미한 경우가 있다.</p><p>어떠한 서비스를 구현해야 하느냐에 따라서 다르겠지만, 대부분의 경우에는 <code>websocket</code>을 상위호환으로 볼 수 있을 것 같다.</p><p>소스코드 : <a href="https://github.com/supawer0728/simple-streaming" target="_blank" rel="noopener">https://github.com/supawer0728/simple-streaming</a></p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;서론&quot;&gt;&lt;a href=&quot;#서론&quot; class=&quot;headerlink&quot; title=&quot;서론&quot;&gt;&lt;/a&gt;서론&lt;/h1&gt;&lt;p&gt;Spring의 Stream이라고 하면, 가장 먼저 떠오르는 것은 websocket일 것 같다.&lt;br&gt;websocket은 full-duplex communication(전 이중 통신)을 표방하고 있으며, 별도의 프로토콜을 공부해야하는 등, web상의 양방향 통신을 복잡하다고 느낄 수 있을 것 같다.&lt;/p&gt;
&lt;p&gt;때문에 다음의 조건들을 충족시킬 Http Streaming 기법에 대해, &lt;code&gt;spring-webmvc&lt;/code&gt;와 &lt;code&gt;spring-webflux&lt;/code&gt; 별로 하나씩 공유하려한다.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Spring5에서 지원&lt;/li&gt;
&lt;li&gt;구현 난이도가 낮음&lt;/li&gt;
&lt;li&gt;기존의 Http 통신을 기반&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
      <category term="spring" scheme="https://supawer0728.github.io/categories/spring/"/>
    
      <category term="practice" scheme="https://supawer0728.github.io/categories/practice/"/>
    
      <category term="practice" scheme="https://supawer0728.github.io/categories/spring/practice/"/>
    
    
      <category term="spring" scheme="https://supawer0728.github.io/tags/spring/"/>
    
      <category term="streaming" scheme="https://supawer0728.github.io/tags/streaming/"/>
    
  </entry>
  
  <entry>
    <title>가끔 복기할 만한 TCP Socket Programming 기초</title>
    <link href="https://supawer0728.github.io/2018/03/15/Java-Server-Socket-Programming-Base/"/>
    <id>https://supawer0728.github.io/2018/03/15/Java-Server-Socket-Programming-Base/</id>
    <published>2018-03-15T01:51:24.000Z</published>
    <updated>2020-03-04T08:18:02.740Z</updated>
    
    <content type="html"><![CDATA[<h1 id="서론"><a href="#서론" class="headerlink" title="서론"></a>서론</h1><p>Spring에서 지원하는 Streaming이나, WebSocket에 관련해서 공부하다가, 기본 지식을 다시 복습해야할 필요성을 느꼈다.<br>대학 강의 내용을 토대로 가끔씩 다시 떠올릴만한 내용들을 정리해두고자 한다.</p><h1 id="Socket"><a href="#Socket" class="headerlink" title="Socket"></a>Socket</h1><p>Kernel 상에서 File Descriptor로 취급된다.<br>Local과 Remote의 Ip Address, Port 정보를 가지고 있다.<br>Data를 이 Socket을 대상으로 Read, Write한다.</p><a id="more"></a><h1 id="Linux-Socket-Programming"><a href="#Linux-Socket-Programming" class="headerlink" title="Linux Socket Programming"></a>Linux Socket Programming</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> server_socket;</span><br><span class="line">  <span class="keyword">int</span> client_socket;</span><br><span class="line">  <span class="keyword">int</span> port = <span class="number">8080</span>;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">server_address</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">client_address</span>;</span></span><br><span class="line">  <span class="keyword">int</span> client_address_len = <span class="keyword">sizeof</span>(client_address);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">char</span>[] greeting = <span class="string">"Hello World!"</span>;</span><br><span class="line">  </span><br><span class="line">  server_socket = socket(PF_INET, SOCK_STREAM, <span class="number">0</span>); <span class="comment">// 1</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">memset</span>(&amp;server_address, <span class="number">0</span>, <span class="keyword">sizeof</span>(server_address))</span><br><span class="line">  serv_addr.sin_family = AF_INET;</span><br><span class="line">  serv_addr.sin_addr.s_addr = htonl(INADDR_ANY);</span><br><span class="line">  serv_addr.sin_port = htons(<span class="number">5000</span>); </span><br><span class="line">  </span><br><span class="line">  bind(server_socket, (struct sockaddr*) &amp;server_address, <span class="keyword">sizeof</span>(server_address)); <span class="comment">// 2</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">listen</span>(server_socket, <span class="number">1</span>); <span class="comment">// 3</span></span><br><span class="line">  </span><br><span class="line">  client_socket = accept(server_socket, (struct sockaddr*)&amp;client_address, (<span class="keyword">socklen_t</span>*) &amp;client_address_len); <span class="comment">// 4</span></span><br><span class="line">  </span><br><span class="line">  <span class="built_in">write</span>(client_socket, greeting, <span class="keyword">sizeof</span>(greeting)); <span class="comment">// 5</span></span><br><span class="line">  <span class="built_in">close</span>(client_socket);</span><br><span class="line">  <span class="built_in">close</span>(server_socket);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Java는 위 작업들을 <code>new ServerSocket()</code>만으로도 자동으로 해주기 때문에.<br>Server가 Socket 통신할 때, 저수준에서 어떠한 작업들을 하는지 파악하기 위해 C로 작성해보았다.</p><ol><li>socket(file descriptor)를 생성한다<ul><li>프로토콜 체계, TCP인지, UDP인지 결정한다</li></ul></li><li>socket에 address 정보를 바인딩한다</li><li>해당 socket이 요청을 받을 수 있도록한다</li><li>server socket으로 연결(connection) 요청이 들어오면, accept()는 client의 socket을 반환한다. 연결이 있을 때까지 blocking된다</li><li>client socket에 메시지를 쓴다</li></ol><h2 id="좀-더-살펴보기"><a href="#좀-더-살펴보기" class="headerlink" title="좀 더 살펴보기"></a>좀 더 살펴보기</h2><h3 id="listen-int-socket-int-backlog"><a href="#listen-int-socket-int-backlog" class="headerlink" title="listen(int socket, int backlog)"></a>listen(int socket, int backlog)</h3><p><code>socket</code>에 connection queue를 붙이고 connection 대기 상태로 바꾼다.<br><code>backlog</code>는 queue의 크기를 나타낸다</p><h3 id="client-socket-accept-server-socket-…"><a href="#client-socket-accept-server-socket-…" class="headerlink" title="client_socket = accept(server_socket, …)"></a>client_socket = accept(server_socket, …)</h3><p>connection queue의 요청으로 connection을 맺은 후 새로운 socket을 생성해서 반환한다.<br><code>server_socket</code>은 계속해서 connection 요청을 처리해야하기 때문에, connection 요청이 처리된 경우에는 새로운 socket을 생성하게 된다.<br>새로 생성된 socket으로 client와 통신할 수 있다.</p><h1 id="Socket-Stream"><a href="#Socket-Stream" class="headerlink" title="Socket Stream"></a>Socket Stream</h1><p>socket을 생성하고 connection이 수립되면, 해당 소켓으로 읽기와 쓰기가 가능하다.<br>읽기와 쓰기는 각각의 Stream 개념으로 유지되며, 버퍼를 가진다.<br><code>write()</code>를 호출하면 입력 버퍼로 데이터가 쌓이며, 원격에서 <code>read()</code>를 호출하면 데이터를 읽을 수 있다.</p><p>오해하기 쉬운 것은 데이터를 보내는 시점이다.<br><code>write()</code>를 호출한다고 전송을 하는 것이 아니며, <code>read()</code>를 호출한다고 원격의 버퍼를 읽어오는 것이 아니다.</p><p><code>write()</code>를 호출하면 socket의 쓰기 버퍼에 정보가 쌓인 상태로 있고, 원격에서 읽기 버퍼에 데이터를 쌓을 수 있는 상황인지 파악 후 통신을 시작한다.<br><a href="http://www.omnisecu.com/tcpip/tcp-sliding-window.php" target="_blank" rel="noopener">TCP Sliding Window</a>가 이를 가능하게 해준다.</p><p>특정 socket에 read stream만 닫는다거나, write stream만 닫는 등의 방법으로 다양한 동작 방식으로 socket programming을 할 수 있다.(read thread와 write thread의 분할 등)</p><h1 id="Hand-Shake-Send-Receive-Close"><a href="#Hand-Shake-Send-Receive-Close" class="headerlink" title="Hand Shake, Send/Receive, Close"></a>Hand Shake, Send/Receive, Close</h1><h2 id="Hand-Shake-3-Way-HandShaking"><a href="#Hand-Shake-3-Way-HandShaking" class="headerlink" title="Hand Shake : 3-Way HandShaking"></a>Hand Shake : 3-Way HandShaking</h2><p>TCP socket connection을 맺기 위한 일련의 과정이다.</p><ol><li>client : 들려?</li><li>server : 어, 들려!</li><li>client : Ok, 알았어!</li></ol><img  src=http://www.plantuml.com/plantuml/svg/Syx9JCqhKT2rKmXEBIfBBLAmKeWEZlIBLGXs3RHIC3Gmq55mTFQsKj3bWie3LJf3z41KQWEbeQgDuAeD3GovdB6OZ50BL05LQsHW2000><p><strong>SEQ, ACK의 의미</strong></p><p>각자 자기 입장에서</p><ul><li>SEQ : N까지 보냈다</li><li>ACK : XX부터 보내면 된다(자신이 받은 SEQ + 1)</li></ul><h2 id="Send-Receive"><a href="#Send-Receive" class="headerlink" title="Send/Receive"></a>Send/Receive</h2><p>HandShake가 완료된 이후,<br>client에서 300byte를 세 번 전송하는 다이어그램.</p><img  src=http://www.plantuml.com/plantuml/svg/2qujAaijKj2rKt3EoKpDAr5Gi588TWsqKZ0oCD1HC3Gmq4sgB4bLu8BA0jK5GtHOAJWwUrif61iOSWMZcm4r0YY7C0Ad2IO6HbosjWebcRcf-QKb2iKbYKKb2hQs25CZq8m5Qa0o5abhQbuAYaQy-d0vnzJ06000><p>SEQ, ACK를 주고 받으면서 송수신한다.<br>timeout 내에 ACK가 오지 않으면 재전송한다.</p><h2 id="Close-4-Way-Handshaking"><a href="#Close-4-Way-Handshaking" class="headerlink" title="Close : 4-Way Handshaking"></a>Close : 4-Way Handshaking</h2><ol><li>client : 이제 우리 그만 만나…</li><li>server : 그래, 맘 정리할 시간을 줘</li><li>server : 정리다했어, 그동안 미안했어</li><li>client : 그래 안녕</li></ol><img  src=http://www.plantuml.com/plantuml/svg/Syx9JCqhKT2rKmXEBIfBBLAmKeXsy_IBLGXs3RHIC3GmCD1HS7JsjbBGvShBBqbLo4bDAx42YIYycR7czTIULpjxtYnlK01gYGztz0o9D-I2cWCqqHbYDj14e7geYKO84u666o8R2ZG3Xw5646L5cUaPK7MlDszvtRG7eTJPnp_O5QmOg_q87m7jDyIm7semXgzy78D3ue6YNCvOGWdX9qE4cK3ZZH1-0YfxCtVFcmLJttJFURMXHI74qnVYo9YyLzjtABoTtG9nk0i0><h3 id="우아한-종료란"><a href="#우아한-종료란" class="headerlink" title="우아한 종료란?"></a>우아한 종료란?</h3><p>TCP가 비정상적으로 종료될 가능성이 몇가지 있다.</p><h4 id="case-1-개발자-실수-close-호출"><a href="#case-1-개발자-실수-close-호출" class="headerlink" title="case 1: 개발자 실수(close 호출)"></a>case 1: 개발자 실수(close 호출)</h4><p>socket을 통해서 read, write stream이 생성된다.<br><code>close(socket)</code>을 호출하면, 모든 stream을 닫아서 읽기가 불가능해진다.<br>즉, 한 쪽에서 <code>close(socket)</code>을 호출하면 아래와 같은 상황이 된다.</p><p>여기서 client란 먼저 FIN을 요청한 쪽으로 정의하겠다.</p><img  src=http://www.plantuml.com/plantuml/svg/ixLLICx9JCqhUJDzmfkMEK1EVd6gHd5-SdPgYQR2snaxtcoRes1ho-KCLgIWQwSGd5fKbbgaOAKGxURf5wiGx1fefM1eO62We-3ex6sbeCi5LG1K2jK4L0gKWYerGYW5wZB4gXfXC52r8R9gMrk5Lnic0972wpLRthJrlEcU2tGT0000><h5 id="Half-Close"><a href="#Half-Close" class="headerlink" title="Half-Close"></a>Half-Close</h5><p>이러한 경우는 client에서 write stream만 먼저 종료시키는 Half-close 개념을 사용해서 해결할 수 있다.<br>write stream이 종료되어도 <code>close()</code>가 호출될 때, server로 ACK가 전송된다.</p><h4 id="case-2-Client가-FIN을-보낸-후-Server로부터-ACK없이-FIN을-받는-경우"><a href="#case-2-Client가-FIN을-보낸-후-Server로부터-ACK없이-FIN을-받는-경우" class="headerlink" title="case 2: Client가 FIN을 보낸 후, Server로부터 ACK없이 FIN을 받는 경우"></a>case 2: Client가 FIN을 보낸 후, Server로부터 ACK없이 FIN을 받는 경우</h4><ul><li>가능성 1 : Server측 ACK가 네트워크상 유실됨</li><li>가능성 2 : Network Congestion 등의 문제로 FIN이 ACK보다 먼저 도착</li></ul><p><strong>도식으로 나타내면 다음과 같다</strong></p><img  src=http://www.plantuml.com/plantuml/svg/Syx9JCqhKT2rKmXEBIfBBLAmKeXsy_IBLGXs3RHIC3GmCD1HS7JsjbBGvO8gqBMBK726w0Ag1Sf1rHeXr0Ar6IAK8wb6c0nKROYisXcBEn1c6o9K0pKQSUNbbwGgvAIcWGnzCtVFcmLJttJFURMXHI74qzSrFjpHCoGcxzNs7GflPxSeEFlu1xkw0000><h5 id="TIME-WAIT"><a href="#TIME-WAIT" class="headerlink" title="TIME_WAIT"></a>TIME_WAIT</h5><p>4-Way Handshake로 종료하도록 TCP는 정의되어 있다.<br><code>FIN_WAIT_1</code> 상태에서 FIN을 먼저 받을 경우, 패킷 흐름의 무결성을 지키기 위해 <code>TIME_WAIT</code>동안 패킷를 기다린다.<br>패킷이 도착하거나, <code>TIME_WAIT</code> 시간이 경과하면 <code>CLOSED</code>로 바뀐다.<br><code>TIME_WAIT</code>는 먼저 <code>FIN</code>을 호출한 쪽에서 생겨야한다!!!</p><p><strong>TCP State Diagram</strong></p><p><img src="https://upload.wikimedia.org/wikipedia/en/5/57/Tcp_state_diagram.png" alt="Tcp state Diagram"></p><p><strong>Sokcet Reuse</strong></p><p>기본적으로 <code>SO_RESUSEADDR</code>은 <code>false</code>로 설정되어 있으며,<br><code>true</code>로 설정하면 <code>TIME_WAIT</code> 상태의 포트를 사용할 수 있게 된다.</p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;서론&quot;&gt;&lt;a href=&quot;#서론&quot; class=&quot;headerlink&quot; title=&quot;서론&quot;&gt;&lt;/a&gt;서론&lt;/h1&gt;&lt;p&gt;Spring에서 지원하는 Streaming이나, WebSocket에 관련해서 공부하다가, 기본 지식을 다시 복습해야할 필요성을 느꼈다.&lt;br&gt;대학 강의 내용을 토대로 가끔씩 다시 떠올릴만한 내용들을 정리해두고자 한다.&lt;/p&gt;
&lt;h1 id=&quot;Socket&quot;&gt;&lt;a href=&quot;#Socket&quot; class=&quot;headerlink&quot; title=&quot;Socket&quot;&gt;&lt;/a&gt;Socket&lt;/h1&gt;&lt;p&gt;Kernel 상에서 File Descriptor로 취급된다.&lt;br&gt;Local과 Remote의 Ip Address, Port 정보를 가지고 있다.&lt;br&gt;Data를 이 Socket을 대상으로 Read, Write한다.&lt;/p&gt;
    
    </summary>
    
      <category term="etc." scheme="https://supawer0728.github.io/categories/etc/"/>
    
    
      <category term="java" scheme="https://supawer0728.github.io/tags/java/"/>
    
      <category term="socket" scheme="https://supawer0728.github.io/tags/socket/"/>
    
  </entry>
  
  <entry>
    <title>Mustache 공유</title>
    <link href="https://supawer0728.github.io/2018/03/14/Mustache/"/>
    <id>https://supawer0728.github.io/2018/03/14/Mustache/</id>
    <published>2018-03-14T02:49:21.000Z</published>
    <updated>2020-03-04T08:18:02.740Z</updated>
    
    <content type="html"><![CDATA[<h1 id="서론"><a href="#서론" class="headerlink" title="서론"></a>서론</h1><p>Java 서버를 개발하면서 View Template Engine에 대해서 매번 고민하게 된다.</p><p>spring boot를 써보면,</p><ul><li><a href="https://docs.spring.io/spring-boot/docs/2.0.0.RELEASE/reference/htmlsingle/#boot-features-spring-mvc-template-engines" target="_blank" rel="noopener">더 이상 JSP를 쓰지 말아야 할 것처럼 말한다</a><ul><li>boot에서 jsp를 쓸 경우 war로 만들어야 하며, WAS에 따라서 지원하지 않을 수 있다 - Tomcat만 고집한다면야…</li></ul></li><li>Velocity는 boot에서 지원하지 않는다<ul><li>너무 오랫동안 업데이트가 없다면서 뺐는데, 2017-08-06에 Velocity Engine 2.0이 나왔다</li></ul></li><li>Thymeleaf3는 여전히 느린 모양이다.</li><li>Freemarker가 그나마 가장 무난하다.</li></ul><p>위와 같이 알고 있던 중에 최신 spring 문서를 뒤져보다가, <code>script views</code>라는 게 있다는 걸 알게 되었다.<br>Handlebars, Mustache, React, Kotlin Script templating 등등의 많은 라이브러리가 있었는데, 그중에서 Mustache를 살펴보려 한다.</p><a id="more"></a><h1 id="Mustache"><a href="#Mustache" class="headerlink" title="Mustache"></a>Mustache</h1><p>Mustache는 Simple하다.<br>얼마나 Simple하냐면, 설명도 <code>Logic-less templates.</code>가 끝이다.<br>별다른 로직이 존재하지 않아서 배우는 것도 간단하다.<br><code>spring-boot</code>에서 <code>starter</code>를 지원하기 때문에 설정도 간단하게 할 수 있다.</p><p>하지만 가장 중요한 것은 <code>Logic-less</code>라는 점이다.<br>MVC 패턴으로 개발을 하다 보면, view에 로직을 구현하려는 경우를 종종 보게 된다.<br>web view를 작성하다 보면 필연적으로 JavaScript를 사용하게 되고,<br>client에서 필요한 로직을 JavaScript로 구현하게 된다.<br>개인적으로 client의 역할과 view의 역할은 분리해야 한다고 생각하며,<br>view에 로직이 구현되어 있는 경우, OOP의 5원칙 중에 SRP를 어겼다고 생각한다.</p><p>때문에 Mustache의 <code>Logic-less</code>라고 하는 점은 매우 끌리는 장점 중 하나이다.</p><h1 id="Mustache-배워보기"><a href="#Mustache-배워보기" class="headerlink" title="Mustache 배워보기"></a>Mustache 배워보기</h1><p>기본적으로 Mustache의 <a href="https://mustache.github.io/mustache.5.html" target="_blank" rel="noopener">Manual</a>을 따르며 하나씩 spring-boot와 연계해보겠다.</p><h2 id="프로젝트-의존성-설정"><a href="#프로젝트-의존성-설정" class="headerlink" title="프로젝트 의존성 설정"></a>프로젝트 의존성 설정</h2><p>spring-boot 버전 : 2.0.0.RELEASE</p><p>간편하게 만들기 : <a href="https://start.spring.io/" target="_blank" rel="noopener">https://start.spring.io/</a></p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">dependencies</span> &#123;</span><br><span class="line"><span class="keyword">compile</span>(<span class="string">'org.springframework.boot:spring-boot-starter-mustache'</span>)</span><br><span class="line"><span class="keyword">compile</span>(<span class="string">'org.springframework.boot:spring-boot-starter-webflux'</span>)</span><br><span class="line"><span class="keyword">runtime</span>(<span class="string">'org.springframework.boot:spring-boot-devtools'</span>)</span><br><span class="line">compileOnly(<span class="string">'org.projectlombok:lombok'</span>)</span><br><span class="line">testCompile(<span class="string">'org.springframework.boot:spring-boot-starter-test'</span>)</span><br><span class="line">testCompile(<span class="string">'io.projectreactor:reactor-test'</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="application-yml"><a href="#application-yml" class="headerlink" title="application.yml"></a>application.yml</h2><p>기본설정은 <code>spring.mustache.suffix=.mustache</code>다.<br>이를 <code>.html</code>로 바꿨다. (취향)</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring.mustache.suffix:</span> <span class="string">.html</span></span><br></pre></td></tr></table></figure><h2 id="model"><a href="#model" class="headerlink" title="model"></a>model</h2><p><a href="https://jsonplaceholder.typicode.com/users" target="_blank" rel="noopener">Online Fake Rest Api</a>를 사용했다</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> User EMPTY = <span class="keyword">new</span> User();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> String email;</span><br><span class="line">    <span class="keyword">private</span> String phone;</span><br><span class="line">    <span class="keyword">private</span> String website;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="controller"><a href="#controller" class="headerlink" title="controller"></a>controller</h2><table><thead><tr><th>API</th><th>URI</th><th>viewName</th></tr></thead><tbody><tr><td>목록</td><td><code>/users</code></td><td><code>/users/list</code></td></tr><tr><td>상세</td><td><code>/users/{id}</code></td><td><code>/users/detail</code></td></tr></tbody></table><p><code>spring.mustache.prefix=classpath:/templates/</code>가 기본설정이다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/users"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ParameterizedTypeReference&lt;List&lt;User&gt;&gt; postsListType = <span class="keyword">new</span> ParameterizedTypeReference&lt;List&lt;User&gt;&gt;() &#123;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getList</span><span class="params">(Model model)</span> </span>&#123;</span><br><span class="line">        Mono&lt;List&lt;User&gt;&gt; posts = WebClient.create(<span class="string">"https://jsonplaceholder.typicode.com"</span>)</span><br><span class="line">                                          .get()</span><br><span class="line">                                          .uri(<span class="string">"/users"</span>)</span><br><span class="line">                                          .retrieve()</span><br><span class="line">                                          .bodyToMono(postsListType)</span><br><span class="line">                                          .onErrorReturn(Collections.emptyList());</span><br><span class="line"></span><br><span class="line">        model.addAttribute(<span class="string">"user"</span>, posts);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"/users/list"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/&#123;id&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getUser</span><span class="params">(@PathVariable Long id, Model model)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        Mono&lt;User&gt; post = WebClient.create(<span class="string">"https://jsonplaceholder.typicode.com"</span>)</span><br><span class="line">                                   .get()</span><br><span class="line">                                   .uri(<span class="string">"/users/&#123;id&#125;"</span>, id)</span><br><span class="line">                                   .retrieve()</span><br><span class="line">                                   .bodyToMono(User<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">                                   .<span class="title">onErrorReturn</span>(<span class="title">User</span>.<span class="title">EMPTY</span>)</span>;</span><br><span class="line"></span><br><span class="line">        model.addAttribute(<span class="string">"user"</span>, post);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"/users/detail"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="view"><a href="#view" class="headerlink" title="view"></a>view</h2><p><code>src/main/resources/templates/users/detail.html</code></p><p>User 객체의 속성을 보여준다</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"container"</span>&gt;</span></span><br><span class="line">    &#123;&#123;#user&#125;&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span></span><br><span class="line">        id : &#123;&#123;id&#125;&#125;<span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line">        name : &#123;&#123;name&#125;&#125;<span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line">        phone : &#123;&#123;phone&#125;&#125;<span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line">        website : &#123;&#123;website&#125;&#125;<span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    &#123;&#123;/user&#125;&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="변수"><a href="#변수" class="headerlink" title="변수"></a>변수</h3><p>콧수염 두 개(<code>{{id}}</code>)로 표현한다</p><h4 id="HTML-Escape"><a href="#HTML-Escape" class="headerlink" title="HTML Escape"></a>HTML Escape</h4><p>콧수염 안의 문자열은 기본으로 HTML Escape가 적용된다</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">model.addAttribute(<span class="string">"company"</span>, <span class="string">"&lt;b&gt;GitHub&lt;/b&gt;"</span>)</span><br></pre></td></tr></table></figure><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- &#123;&#123;company&#125;&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- &lt;b&gt;GitHub&lt;&#x2F;b&amp;gt</span><br></pre></td></tr></table></figure><p>unescape를 하기 위해서는</p><ul><li>괄호를 3번 중첩 시키거나 : <code>{{{ compnay }}}</code></li><li><code>&amp;</code>를 사용한다 : <code>{{& company }}</code></li></ul><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- &#123;&#123;&#123;company&#125;&#125;&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- &lt;b&gt;GitHub&lt;&#x2F;b&gt;</span><br></pre></td></tr></table></figure><h3 id="섹션"><a href="#섹션" class="headerlink" title="섹션"></a>섹션</h3><p>섹션은 콧수염과 샵으로 표현한다(<code>{{ #post }}</code>)</p><p>섹션에 들어가는 key 타입에 따라서 표현이 달라진다</p><h4 id="False-Empty-List"><a href="#False-Empty-List" class="headerlink" title="False, Empty List"></a>False, Empty List</h4><p>key의 값이 false이거나 empty list인 경우, 해당 섹션은 표시되지 않는다</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Shown.</span><br><span class="line">&#123;&#123;#post&#125;&#125;</span><br><span class="line">Never shown!</span><br><span class="line">&#123;&#123;/person&#125;&#125;</span><br></pre></td></tr></table></figure><h4 id="Non-Empty-Lists"><a href="#Non-Empty-Lists" class="headerlink" title="Non-Empty Lists"></a>Non-Empty Lists</h4><p>key가 비어있지 않은 list인 경우 섹션 내의 내용의 반복한다</p><h5 id="GET-users-요청"><a href="#GET-users-요청" class="headerlink" title="GET /users 요청"></a><code>GET /users</code> 요청</h5><p><strong>list.html</strong></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"container"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">table</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span>id<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span>name<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span>phone<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span>website<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">        &#123;&#123;#user&#125;&#125;</span><br><span class="line">        <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span>&#123;&#123;id&#125;&#125;<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span>&#123;&#123;name&#125;&#125;<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span>&#123;&#123;phone&#125;&#125;<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span>&#123;&#123;website&#125;&#125;<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">        &#123;&#123;/user&#125;&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><p><strong>결과</strong></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"container"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">table</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">td</span>&gt;</span>id<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">td</span>&gt;</span>name<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">td</span>&gt;</span>phone<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">td</span>&gt;</span>website<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">td</span>&gt;</span>1<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">td</span>&gt;</span>Leanne Graham<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">td</span>&gt;</span>1-770-736-8031 x56442<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">td</span>&gt;</span>hildegard.org<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">td</span>&gt;</span>2<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">td</span>&gt;</span>Ervin Howell<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">td</span>&gt;</span>010-692-6593 x09125<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">td</span>&gt;</span>anastasia.net<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- ... --&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="Lambda"><a href="#Lambda" class="headerlink" title="Lambda"></a>Lambda</h4><p>lambda식을 실행할 수 있다</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;#user&#125;&#125;</span><br><span class="line">  &#123;&#123;#doubled&#125;&#125;</span><br><span class="line">    &#123;&#123;name&#125;&#125;</span><br><span class="line">  &#123;&#123;/doubled&#125;&#125;</span><br><span class="line">&#123;&#123;/user&#125;&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ControllerAdvice</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LayoutAdvice</span> </span>&#123;</span><br><span class="line">    <span class="meta">@ModelAttribute</span>(<span class="string">"doubled"</span>)</span><br><span class="line">    <span class="keyword">public</span> Mustache.<span class="function">Lambda <span class="title">doubled</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (frag, out) -&gt; &#123;</span><br><span class="line">            String bodyString = frag.execute();</span><br><span class="line">            out.append(bodyString)</span><br><span class="line">               .append(bodyString);</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>결과</strong></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 이름이 Leanne Graham인 경우 --&gt;</span></span><br><span class="line">Leanne GrahamLeanne Graham</span><br></pre></td></tr></table></figure><p>lambda식은 아래 interface를 구현해서 만들 수 있다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Lambda</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">execute</span> <span class="params">(Template.Fragment frag, Writer out)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><code>frag.execute()</code> : 내부의 표현식을 실행한 후 String으로 반환한다.</li><li><code>frag.context()</code> : 상위 오브젝트(여기서는 User)를 가져온다.</li><li><code>frag.context(int n)</code> : n번째 상위 오브젝트를 가져온다.</li></ul><blockquote><p>이러한 기능을 제공하나, 행여나 view에서 serivce logic을 작성하지는 말자.</p></blockquote><h4 id="False값이-아닌-경우"><a href="#False값이-아닌-경우" class="headerlink" title="False값이 아닌 경우"></a>False값이 아닌 경우</h4><p>list도 아니고, false도 아니라면 이를 block을 가진 context(즉 object)로 간주한다</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">model.addAttribute(<span class="string">"user"</span>, <span class="keyword">new</span> User(<span class="string">"abc"</span>));</span><br></pre></td></tr></table></figure><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;#user&#125;&#125;</span><br><span class="line">  Hello, &#123;&#123;name&#125;&#125;!</span><br><span class="line">&#123;&#123;/user&#125;&#125;</span><br></pre></td></tr></table></figure><p><strong>결과</strong></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Hello, abc!</span><br></pre></td></tr></table></figure><h4 id="Inverted-Section"><a href="#Inverted-Section" class="headerlink" title="Inverted Section"></a>Inverted Section</h4><p>섹션에 논리 부정 연산자(<code>!</code>)가 붙은 격이다</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">model.addAttribute(<span class="string">"users"</span>, Collections.emptyList());</span><br></pre></td></tr></table></figure><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;#users&#125;&#125;</span><br><span class="line">  &#123;&#123;name&#125;&#125;</span><br><span class="line">&#123;&#123;/users&#125;&#125;</span><br><span class="line">&#123;&#123;^users&#125;&#125;</span><br><span class="line">  No users...</span><br><span class="line">&#123;&#123;/users&#125;</span><br></pre></td></tr></table></figure><p><strong>결과</strong></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">No users...</span><br></pre></td></tr></table></figure><h4 id="주석"><a href="#주석" class="headerlink" title="주석"></a>주석</h4><p><code>{{! ignore me }}</code></p><h4 id="Partials"><a href="#Partials" class="headerlink" title="Partials"></a>Partials</h4><p><code>{{>users/list-item}}</code>과 같이, 외부 문서를 불러올 수 있다.</p><p><code>GET /users</code></p><p><strong>src/main/resources/templates/users/list.html</strong></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"container"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">table</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span>id<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span>name<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span>phone<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span>website<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span>doubled name<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">        &#123;&#123;#user&#125;&#125;</span><br><span class="line">        &#123;&#123;&gt;users/list-item&#125;&#125;</span><br><span class="line">        &#123;&#123;/user&#125;&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><p><strong>src/main/resources/templates/users/list-item.html</strong></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">td</span>&gt;</span>&#123;&#123;id&#125;&#125;<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">td</span>&gt;</span>&#123;&#123;name&#125;&#125;<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">td</span>&gt;</span>&#123;&#123;phone&#125;&#125;<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">td</span>&gt;</span>&#123;&#123;website&#125;&#125;<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">td</span>&gt;</span>&#123;&#123;#doubled&#125;&#125;&#123;&#123;name&#125;&#125;&#123;&#123;/doubled&#125;&#125;<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="Delimter"><a href="#Delimter" class="headerlink" title="Delimter"></a>Delimter</h4><p>콧수염(<code>{{ }}</code>) 을 다른 기호로 바꿀 때 사용한다</p><p><strong>콧수염을 <code>&lt;% %&gt;</code>로</strong></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; name &#125;&#125;</span><br><span class="line">&#123;&#123;=<span class="tag">&lt;<span class="name">%</span> %&gt;</span>=&#125;&#125; <span class="comment">&lt;!-- 변환 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">%</span> <span class="attr">name</span> %&gt;</span></span><br></pre></td></tr></table></figure><h2 id="Spring-Boot-Property"><a href="#Spring-Boot-Property" class="headerlink" title="Spring Boot Property"></a>Spring Boot Property</h2><p>기본으로 설정되어 있는 Property와 기본값은 다음과 같다</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"># HttpServletRequest의 attribute를 Controller에서 생성한 동일한 이름의 model attribute로 덮어 쓸 수 있는지 여부</span><br><span class="line">spring.mustache.allow-request-override&#x3D;false </span><br><span class="line"></span><br><span class="line"># HttpSession의 attribute를 Controller에서 생성한 동일한 이름의 model attribute로 덮어 쓸 수 있는지 여부</span><br><span class="line">spring.mustache.allow-session-override&#x3D;false </span><br><span class="line"></span><br><span class="line">spring.mustache.cache&#x3D;false </span><br><span class="line">spring.mustache.charset&#x3D;UTF-8</span><br><span class="line">spring.mustache.check-template-location&#x3D;true</span><br><span class="line">spring.mustache.content-type&#x3D;text&#x2F;html</span><br><span class="line">spring.mustache.enabled&#x3D;true</span><br><span class="line"></span><br><span class="line"># 모든 request attribute를 template에 병합하기 전 포함시켜야하는 지 여부</span><br><span class="line">spring.mustache.expose-request-attributes&#x3D;false</span><br><span class="line"># 모든 session attribute를 template에 병합하기 전 포함시켜야하는 지 여부</span><br><span class="line">spring.mustache.expose-session-attributes&#x3D;false</span><br><span class="line"># RequestContext를 노출할지 여부(&quot;springMacroRequsetContext&quot;라는 이름의 spring macro library에 의해 설정됨)</span><br><span class="line"># &lt;link rel&#x3D;&quot;stylesheet&quot; href&#x3D;&quot;&#123;&#123;springMacroRequestContext.request.contextPath&#125;&#125;&#x2F;assets&#x2F;app.css&quot;&gt;</span><br><span class="line">spring.mustache.expose-spring-macro-helpers&#x3D;true</span><br><span class="line"></span><br><span class="line">spring.mustache.prefix&#x3D;classpath:&#x2F;templates&#x2F; </span><br><span class="line"># 전체 view에서 사용할 RequestContext의 이름(키)</span><br><span class="line">spring.mustache.request-context-attribute&#x3D;</span><br><span class="line"># viewname의 접미사</span><br><span class="line">spring.mustache.suffix&#x3D;.mustache</span><br><span class="line"># 처리할 view name의 white list</span><br><span class="line">spring.mustache.view-names&#x3D;</span><br></pre></td></tr></table></figure><h1 id="마무리"><a href="#마무리" class="headerlink" title="마무리"></a>마무리</h1><p>script 기반의 view template engine인 mustache에 대해서 알아보았다.</p><p>여타 다른 엔진에 비해서 제공하는 기능은 훨씬 적다.<br>하지만 간단하고 배우기 쉬우며, spring boot와 통합도 제공한다.</p><p><a href="https://github.com/jreijn/spring-comparing-template-engines" target="_blank" rel="noopener">2015년 기준</a>으로 Freemarker나 Velocity에 견줄 수 있을 정도의 속도가 나왔다고 한다.<br>물론 이런 종류의 테스트는 최적화를 위해서는 더 다양한 케이스를 테스트해 봐야겠지만, 생각보다 훨씬 빠르다는 것에 다시 놀랐다.</p><p>logic-less의 view를 구현하고, client의 logic을 node나 전담 front-server에서 구현할 수 있다면, 꽤 괜찮은 솔루션이라 생각된다.</p><p>소스 코드 : <a href="https://github.com/supawer0728/simple-mustache" target="_blank" rel="noopener">https://github.com/supawer0728/simple-mustache</a></p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;서론&quot;&gt;&lt;a href=&quot;#서론&quot; class=&quot;headerlink&quot; title=&quot;서론&quot;&gt;&lt;/a&gt;서론&lt;/h1&gt;&lt;p&gt;Java 서버를 개발하면서 View Template Engine에 대해서 매번 고민하게 된다.&lt;/p&gt;
&lt;p&gt;spring boot를 써보면,&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://docs.spring.io/spring-boot/docs/2.0.0.RELEASE/reference/htmlsingle/#boot-features-spring-mvc-template-engines&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;더 이상 JSP를 쓰지 말아야 할 것처럼 말한다&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;boot에서 jsp를 쓸 경우 war로 만들어야 하며, WAS에 따라서 지원하지 않을 수 있다 - Tomcat만 고집한다면야…&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Velocity는 boot에서 지원하지 않는다&lt;ul&gt;
&lt;li&gt;너무 오랫동안 업데이트가 없다면서 뺐는데, 2017-08-06에 Velocity Engine 2.0이 나왔다&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Thymeleaf3는 여전히 느린 모양이다.&lt;/li&gt;
&lt;li&gt;Freemarker가 그나마 가장 무난하다.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;위와 같이 알고 있던 중에 최신 spring 문서를 뒤져보다가, &lt;code&gt;script views&lt;/code&gt;라는 게 있다는 걸 알게 되었다.&lt;br&gt;Handlebars, Mustache, React, Kotlin Script templating 등등의 많은 라이브러리가 있었는데, 그중에서 Mustache를 살펴보려 한다.&lt;/p&gt;
    
    </summary>
    
    
      <category term="view template engine" scheme="https://supawer0728.github.io/tags/view-template-engine/"/>
    
      <category term="view" scheme="https://supawer0728.github.io/tags/view/"/>
    
  </entry>
  
  <entry>
    <title>Spring에서 요청에 따른 부가 응답 추가하기(3) - webflux 적용</title>
    <link href="https://supawer0728.github.io/2018/03/11/Spring-request-model3/"/>
    <id>https://supawer0728.github.io/2018/03/11/Spring-request-model3/</id>
    <published>2018-03-11T10:45:34.000Z</published>
    <updated>2020-03-04T08:18:02.746Z</updated>
    
    <content type="html"><![CDATA[<h1 id="서론"><a href="#서론" class="headerlink" title="서론"></a>서론</h1><p>앞서 개발한 소스는 <code>spring-webmvc</code>로 작성했었다. 이번에는 Reactive Programming을 본격적으로 사용하며, non-blocking 동작을 지원하는 <code>spring-webflux</code>를 사용해서 이전까지의 소스를 포팅해보려고 한다.</p><a id="more"></a><h1 id="spring-webflux"><a href="#spring-webflux" class="headerlink" title="spring-webflux"></a>spring-webflux</h1><table><thead><tr><th><img src="https://docs.spring.io/spring/docs/5.0.0.BUILD-SNAPSHOT/spring-framework-reference/html/images/webflux-overview.png" alt="image1"></th></tr></thead><tbody><tr><td><em>출처 : <a href="https://docs.spring.io/spring/docs/5.0.0.BUILD-SNAPSHOT/spring-framework-reference/html/images/webflux-overview.png" target="_blank" rel="noopener">https://docs.spring.io/spring/docs/5.0.0.BUILD-SNAPSHOT/spring-framework-reference/html/images/webflux-overview.png</a></em></td></tr></tbody></table><p><code>spring-webflux</code>를 두가지 개발 모델을 지원한다. 하나는 기존의 <code>spring-webmvc</code>에서 사용했던 것과 마찬가지로 <code>@Controller</code> 등의 어노테이션을 이용한 개발 모델이다. 또 하나는 Java8의 함수형 람다 방식으로 rounter와 handler를 사용하는 하는 방식이다. 새로운 모듈인 <code>spring-webflux</code>을 사용하는 만큼 기존의 방식보다는 <code>Functional Endpoints</code> 기반으로 작성을 해보려고 한다.</p><p><code>spring-webflux</code>에 대해서 간단히 알아보자.</p><p>왜 spring에서는 이 모듈을 만들었을까? Spring Reference의 <a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/web-reactive.html#webflux-new-framework" target="_blank" rel="noopener">Motivation</a>챕터를 읽어보자</p><blockquote><p>그 이유 중 하나는 더 적은 하드웨어 자원으로 스케일링하고, 더 적은 thread로 동시성을 처리할 수 있는 non-blocking web stack이 필요했기 때문이다. Servlet 3.1은 non-blocking I/O에 대한 API를 제공했다. 하지만 non-blocking API를 사용하므로써, Filter, Servlet 등의 동기화나 getParameter, getPart 등의 blocking을 API을 사용하지 못하게 되었다. 이는 곧 non-blocking이 기반이 되는 새로운 공통 API가 필요한 이유가 되었다.</p><p>또 다른 이유로 함수형 프로그래밍을 들 수 있다. 마치 Java5에서 애노테이션이 등장해서 많은 기회를 창출했던 것처럼 - 예컨대 REST controller나, unit test를 애노테이션을 선언해서 쓸 수 있게 된 것처럼 Java8에서 추가된 람다표현식은 Java에 함수형 API를 사용할 수 있는 기회를 가져왔다. 비동기 로직을 선언적으로 구성할 수 있도록 해주는 continuation style API(<code>CompletableFuture, ReactiveX</code>)와 non-blocking application을 사용함에 있어서 요긴하게 쓸 수 있다. 프로그래밍 모델의 관점에서 Java8은 Spring Webflux로 하여금 기존과 같은 <code>@Controller</code> 애노테이션을 통한 컨트롤러 등록과 함수형 웹 엔드포인트를 동시에 제공할 수 있게끔 해주었다.</p><p><strong>Spring Reference</strong> - <a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/web-reactive.html#webflux-new-framework" target="_blank" rel="noopener">Web Reactive 1.1.1. Motivation</a></p></blockquote><p>위 글에서 <code>spring-webflux</code> 모듈이 나온 이유를 정리하자면 다음과 같다.</p><ul><li>non-blocking I/O를 지원하는 공통 API가 필요하기 때문</li><li>함수형 프로그래밍 스타일로 소스에서 reactive programming의 pipeline을 선언적으로 작성할 수 있게 됨</li></ul><p>Spring5부터 <code>spring-webflux</code> 모듈이 나와서, 앞으로는 Web Application을 개발할 때 기존의 <code>spring-webmvc</code>와 어느 것을 사용해야할 지 고민하게 될 것 같다. 이에 대해서 Spring Reference에서 이야기하는 내용을 잠깐 살펴보자.</p><blockquote><p>여러분이 사용하는 Spring MVC 어플리케이션이 잘 동작한다면 굳이 바꿀 필요가 없다. 명령형 프로그래밍은 코드를 작성, 이해, 디버깅하는 데에 있어서 가장 쉬운 방법이다. 대부분의 라이브러리는 명령형이며, 그 중에서 우리가 필요한 것을 고르면 된다.</p><p>framework를 고를 기준 중 하나는, 의존성을 확인하는 것이다. 만약 blocking 방식의 persistence API(JPA, JDBC)나 network API를 사용한다면 <code>spring-mvc</code>가 적합한 선택이 될 것이다. <code>Reactor</code>나 <code>RxJava</code>를 사용해서 분리된 thread에서 blocking api를 호출할 수는 있겠으나, non-blocking web stack을 최대한으로 활용하기는 어렵다.</p><p>Spring MVC application에 원격 서비스를 호출하는 일이 있다면, Reactive WebClient를 사용해볼 것을 권장한다. Spring MVC 컨트롤러 메서드에서 reative 타입(Reactor, RxJava, etc.)를 직접 반환할 수 있다. 호출 당 지연이 길수록, 호출 간 상호 의존이 클수록, 더 큰 이득을 볼 수 있다.</p><p>팀의 규모가 클 경우, non-blocking, 함수형, 선언적 프로그래밍의 학습 곡선이 가파르다는 것을 염두에 두어야 한다. 현실적으로 Reactive WebClient를 적용해보는 것부터 시작하는 것을 권장한다. 그 후에 작은 프로젝트에 적용해보고, 이점을 확인해 나가기 바란다. </p><p>어떠한 이점이 있는지 찾을 수 없을 때에는, non-blocking I/O가 어떻게 동작하며, 어떠한 효과를 볼 수 있는지 배우길 바란다.</p><p><strong>Spring Reference</strong> - <a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/web-reactive.html#webflux-framework-choice" target="_blank" rel="noopener">Web Reactive 1.1.5. Applicability</a></p></blockquote><h1 id="기본-api-작성"><a href="#기본-api-작성" class="headerlink" title="기본 api 작성"></a>기본 api 작성</h1><h2 id="의존성"><a href="#의존성" class="headerlink" title="의존성"></a>의존성</h2><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">dependencies</span> &#123;</span><br><span class="line">  <span class="keyword">compile</span>(<span class="string">'org.springframework.boot:spring-boot-starter-webflux'</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="BoardHandler-작성"><a href="#BoardHandler-작성" class="headerlink" title="BoardHandler 작성"></a>BoardHandler 작성</h2><p><code>spring-mvc</code>의 Controller와 대응되는 Handler를 작성해보자</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BoardHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> BoardRepository boardRepository;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> BoardDtoConverter boardDtoConverter;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BoardHandler</span><span class="params">(@NonNull BoardRepository boardRepository,</span></span></span><br><span class="line"><span class="function"><span class="params">                        @NonNull BoardDtoConverter boardDtoConverter)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.boardRepository = boardRepository;</span><br><span class="line">        <span class="keyword">this</span>.boardDtoConverter = boardDtoConverter;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;ServerResponse&gt; <span class="title">getBoard</span><span class="params">(ServerRequest request)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> boardId = Long.valueOf(request.pathVariable(<span class="string">"id"</span>));</span><br><span class="line">        Mono&lt;ServerResponse&gt; notFound = ServerResponse.notFound().build();</span><br><span class="line">        Mono&lt;Board&gt; boardMono = boardRepository.findOne(boardId);</span><br><span class="line">        Mono&lt;BoardDto&gt; boardDtoMono = boardMono.map(boardDtoConverter::convert);</span><br><span class="line">        <span class="keyword">return</span> boardDtoMono.flatMap(boardDto -&gt; ServerResponse.ok()</span><br><span class="line">                                                             .contentType(MediaType.APPLICATION_JSON)</span><br><span class="line">                                                             .body(fromObject(boardDto))</span><br><span class="line">                                                             .switchIfEmpty(notFound));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="BoardRepository"><a href="#BoardRepository" class="headerlink" title="BoardRepository"></a>BoardRepository</h2><p>JPA, JDBC의 API는 blocking으로 동작한다. 우선은 임시로 아래와 같이 repository를 작성했다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BoardRepository</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> generatedId = <span class="number">0L</span>;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;Long, Board&gt; boardMap = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveAll</span><span class="params">(List&lt;Board&gt; boards)</span> </span>&#123;</span><br><span class="line">        boards.forEach(board -&gt; &#123;</span><br><span class="line">            board.setId(++generatedId);</span><br><span class="line">            boardMap.put(board.getId(), board);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;Board&gt; <span class="title">findOne</span><span class="params">(Long id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Mono.just(boardMap.get(id));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="WebConfig"><a href="#WebConfig" class="headerlink" title="WebConfig"></a>WebConfig</h2><p>요청을 handler로 routing해주는 routerFunction을 등록한다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableWebFlux</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebConfig</span> <span class="keyword">extends</span> <span class="title">DelegatingWebFluxConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> BoardHandler boardHandler;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RouterFunction&lt;?&gt; boardRouter() &#123;</span><br><span class="line">        <span class="keyword">return</span> route(GET(<span class="string">"/boards/&#123;id&#125;"</span>).and(accept(APPLICATION_JSON)), boardHandler::getBoard);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="Interceptor-AOP"><a href="#Interceptor-AOP" class="headerlink" title="Interceptor, AOP"></a>Interceptor, AOP</h1><p>기존에는 Interceptor에서 request의 <code>attachment</code>를 해석하고, AOP에서 응답에 추가를 해줬었는데 지금은 그럴 수가 없다.</p><p><strong>Interceptor</strong></p><ul><li><code>spring-webflux</code>에는 <code>HandlerInterceptor</code>가 없다</li><li><code>RouterFunction</code>에 <code>HandlerFilterFunction</code>을 붙여서 처리하자</li></ul><p><strong>AOP</strong></p><p>Handler에서는 <code>Mono&lt;ServerResponse&gt;</code>를 반환하고 있다. 문제는 이 <code>ServerResponse</code>라는 객체 내부의 body를 바꿀 수가 없다. 때문에 Handler 내에서 <code>boardDto</code>에 모델을 추가하든지, 아니면 <code>BoardService</code>와 같이 Service 계층의 클래스를 두고 거기에 AOP를 걸든지 해야할 것 같다.</p><p>우선 부가 정보 추가를 Handler 내부에서 처리해보자. 핵심 로직은 추후에 따로 옮겨도 될 것이다.</p><h1 id="AttachmentHandlerFilter"><a href="#AttachmentHandlerFilter" class="headerlink" title="AttachmentHandlerFilter"></a>AttachmentHandlerFilter</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AttachmentHandlerFilter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TARGET_ATTRIBUTE_NAME = <span class="string">"attachment"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TARGET_QUERY_PARAM_NAME = <span class="string">"attachment"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TARGET_DELIMITER = <span class="string">","</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> HandlerFilterFunction&lt;ServerResponse, ServerResponse&gt; <span class="title">filter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (request, next) -&gt; &#123;</span><br><span class="line">            Set&lt;AttachmentType&gt; attachmentTypes = resolveAttachmentType(request);</span><br><span class="line">            request.attributes().put(TARGET_ATTRIBUTE_NAME, <span class="keyword">new</span> AttachmentTypeHolder(attachmentTypes));</span><br><span class="line">            <span class="keyword">return</span> next.handle(request);</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Set&lt;AttachmentType&gt; <span class="title">resolveAttachmentType</span><span class="params">(ServerRequest request)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> request.queryParam(TARGET_QUERY_PARAM_NAME)</span><br><span class="line">                      .map(attachments -&gt; Stream.of(attachments.split(TARGET_DELIMITER))</span><br><span class="line">                                                .map(AttachmentType::fromCaseIgnoredName)</span><br><span class="line">                                                .filter(Objects::nonNull)</span><br><span class="line">                                                .collect(Collectors.toSet()))</span><br><span class="line">                      .orElse(Collections.emptySet());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>처음에는 <code>AttachmentHandlerFilter</code>가 <code>HandlerFilterFunction</code>을 구현하도록 했었으나, 형안전성을 잡는게 어려워 Closure처럼 반환하도록 하였다. 해당 필터를 거쳐 request에 <code>AttachmentTypeHolder</code>가 존재하도록 attribute를 추가했다.</p><h1 id="HandlerFilterFunction-등록"><a href="#HandlerFilterFunction-등록" class="headerlink" title="HandlerFilterFunction 등록"></a>HandlerFilterFunction 등록</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> RouterFunction&lt;?&gt; boardRouter() &#123;</span><br><span class="line">    <span class="keyword">return</span> route(GET(<span class="string">"/boards/&#123;id&#125;"</span>).and(accept(APPLICATION_JSON)), boardHandler::getBoard).filter(attachmentFilter.filter());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="BoardHandler-수정"><a href="#BoardHandler-수정" class="headerlink" title="BoardHandler 수정"></a>BoardHandler 수정</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BoardHandler</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> BoardRepository boardRepository;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> BoardDtoConverter boardDtoConverter;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AttachExecutor attachExecutor;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Mono&lt;ServerResponse&gt; notFound = ServerResponse.notFound().build();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BoardHandler</span><span class="params">(@NonNull BoardRepository boardRepository,</span></span></span><br><span class="line"><span class="function"><span class="params">                        @NonNull BoardDtoConverter boardDtoConverter,</span></span></span><br><span class="line"><span class="function"><span class="params">                        @NonNull AttachExecutor attachExecutor)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.boardRepository = boardRepository;</span><br><span class="line">        <span class="keyword">this</span>.boardDtoConverter = boardDtoConverter;</span><br><span class="line">        <span class="keyword">this</span>.attachExecutor = attachExecutor;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;ServerResponse&gt; <span class="title">getBoard</span><span class="params">(ServerRequest request)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> boardId = Long.valueOf(request.pathVariable(<span class="string">"id"</span>));</span><br><span class="line">        <span class="comment">// 좀더 NPE나 형안전성 관련해서 강하게 제약을 할 수 있으면 좋을텐데...</span></span><br><span class="line">        AttachmentTypeHolder typeHolder = request.attribute(TARGET_ATTRIBUTE_NAME)</span><br><span class="line">                                                 .map(AttachmentTypeHolder.class::cast)</span><br><span class="line">                                                 .orElseGet(() -&gt; <span class="keyword">new</span> AttachmentTypeHolder(Collections.emptySet()));</span><br><span class="line">        Mono&lt;Attachable&gt; attachableMono =</span><br><span class="line">                boardRepository.findOne(boardId)</span><br><span class="line">                               .map(boardDtoConverter::convert)</span><br><span class="line">                               .flatMap(boardDto -&gt; attachExecutor.attach(boardDto, typeHolder));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> attachableMono.flatMap(boardDto -&gt; ServerResponse.ok()</span><br><span class="line">                                                                .contentType(MediaType.APPLICATION_JSON)</span><br><span class="line">                                                                .body(fromObject(boardDto))</span><br><span class="line">                                                                .switchIfEmpty(notFound));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>AttachmentTypeHolder</code>를 꺼내어서 <code>AttachExecutor</code>로 보내, 부가정보를 추가하고 <code>Mono&lt;Attachable&gt;</code>을 반환한다.<br><code>AttachExecutor</code>는 이전의 <code>AttachmentAspect</code>에서 하던 일을 수행한다.</p><h1 id="AttachService와-그-구현체들"><a href="#AttachService와-그-구현체들" class="headerlink" title="AttachService와 그 구현체들"></a>AttachService와 그 구현체들</h1><p>바뀐게 없다. 그대로 사용할 수 있다.</p><h1 id="AttachExecutor"><a href="#AttachExecutor" class="headerlink" title="AttachExecutor"></a>AttachExecutor</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AttachExecutor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;AttachmentType, List&lt;AttachService&lt;? extends Attachable&gt;&gt;&gt; typeToServiceMap;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AttachExecutor</span><span class="params">(@NonNull List&lt;AttachService&lt;? extends Attachable&gt;&gt; attachService)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.typeToServiceMap = attachService.stream()</span><br><span class="line">                                             .collect(Collectors.groupingBy(AttachService::getSupportAttachmentType, Collectors.toList()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;Attachable&gt; <span class="title">attach</span><span class="params">(Attachable attachable, AttachmentTypeHolder holder)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (holder.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span> Mono.just(attachable);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> executeAttach(attachable, holder.getTypes());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Mono&lt;Attachable&gt; <span class="title">executeAttach</span><span class="params">(Attachable attachable, Set&lt;AttachmentType&gt; types)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        List&lt;Mono&lt;AttachmentWrapperItem&gt;&gt; monoItems = createMonoList(attachable, types);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 1. block()을 호출하지 않는다</span></span><br><span class="line">        <span class="keyword">return</span> Mono.zip(monoItems, <span class="keyword">this</span>::filterItems)</span><br><span class="line">                   .map(attachable::attach)</span><br><span class="line">                   .doOnError(e -&gt; log.warn(e.getMessage(), e))</span><br><span class="line">                   .onErrorReturn(attachable);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;Mono&lt;AttachmentWrapperItem&gt;&gt; createMonoList(Attachable attachable, Set&lt;AttachmentType&gt; types) &#123;</span><br><span class="line">        <span class="keyword">return</span> types.stream()</span><br><span class="line">                    .flatMap(type -&gt; typeToServiceMap.get(type).stream())</span><br><span class="line">                    .filter(service -&gt; service.getSupportType().isAssignableFrom(attachable.getClass()))</span><br><span class="line">                    .map(service -&gt; service.getAttachment(attachable))</span><br><span class="line">                    .collect(Collectors.toList());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> List&lt;AttachmentWrapperItem&gt; <span class="title">filterItems</span><span class="params">(Object[] itemArray)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Stream.of(itemArray)</span><br><span class="line">                     .map(AttachmentWrapperItem.class::cast)</span><br><span class="line">                     .filter(item -&gt; item != AttachmentWrapperItem.ON_ERROR)</span><br><span class="line">                     .collect(Collectors.toList());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>1.</code> 주석을 단 곳의 내용이 핵심적인 차이점이다. 기존의 <code>AttachmentAspect</code>에서는 <code>block()</code>을 호출해서 <code>List&lt;AttachmentWrapperItem&gt;</code>을 <code>실행 후</code> 취합했다. 하지만 여기서는 실행의 흐름(<code>Data Flow</code>)을 pipeline으로 선언만하고 넘어간다.</p><h1 id="마무리"><a href="#마무리" class="headerlink" title="마무리"></a>마무리</h1><p>이전까지 <code>spring-webmvc</code>로 작업한 내용을 <code>spring-webflux</code>로 포팅해보았다. blocking을 non-blocking으로 바꾸었다는 것이 가장 중요하다.</p><p>앞서 설명한 바와 같이 아직까지 JDBC, JPA 등을 non-blocking으로 호출하지 못하기에 이러한 호출이 있는 Application에는 적용하지 못한다. 그 외에, api-gateway와 같은 역할을 하거나, 원격 서비스 호출이 주를 이루는 Application을 작성할 때에는 <code>spring-webflux</code>를 유용하게 시도해볼 수 있을 것 같다.</p><p>소스코드 : <a href="https://github.com/supawer0728/simple-attachment/tree/apply-webflux" target="_blank" rel="noopener">https://github.com/supawer0728/simple-attachment/tree/apply-webflux</a></p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;서론&quot;&gt;&lt;a href=&quot;#서론&quot; class=&quot;headerlink&quot; title=&quot;서론&quot;&gt;&lt;/a&gt;서론&lt;/h1&gt;&lt;p&gt;앞서 개발한 소스는 &lt;code&gt;spring-webmvc&lt;/code&gt;로 작성했었다. 이번에는 Reactive Programming을 본격적으로 사용하며, non-blocking 동작을 지원하는 &lt;code&gt;spring-webflux&lt;/code&gt;를 사용해서 이전까지의 소스를 포팅해보려고 한다.&lt;/p&gt;
    
    </summary>
    
      <category term="spring" scheme="https://supawer0728.github.io/categories/spring/"/>
    
      <category term="practice" scheme="https://supawer0728.github.io/categories/practice/"/>
    
      <category term="practice" scheme="https://supawer0728.github.io/categories/spring/practice/"/>
    
    
      <category term="spring" scheme="https://supawer0728.github.io/tags/spring/"/>
    
      <category term="webflux" scheme="https://supawer0728.github.io/tags/webflux/"/>
    
      <category term="non-blocking" scheme="https://supawer0728.github.io/tags/non-blocking/"/>
    
  </entry>
  
  <entry>
    <title>Spring Property 관리</title>
    <link href="https://supawer0728.github.io/2018/03/11/Spring-Property/"/>
    <id>https://supawer0728.github.io/2018/03/11/Spring-Property/</id>
    <published>2018-03-11T07:51:00.000Z</published>
    <updated>2020-03-04T08:18:02.745Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Spring-boot-enviroment-abstraction"><a href="#Spring-boot-enviroment-abstraction" class="headerlink" title="Spring boot enviroment abstraction"></a>Spring boot enviroment abstraction</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyBean</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;name&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>classpath 내의 application.properties(yml)을 사용하여 어플리케이션에서 사용할 프로퍼티를 정의할 수 있다.</p><a id="more"></a><h2 id="application-properties"><a href="#application-properties" class="headerlink" title="application.properties"></a>application.properties</h2><p>Srping boot enviroment abstraction은 다음 순서로 application.properties를 검색한다</p><ol><li>현재 위치에서 /config 디렉토리</li><li>현재 위치</li><li>classpath 내의 /config 패키지</li><li>classpath 내의 루트</li></ol><blockquote><p>properties 파일을 대체하여 YAML file(.yml)을 사용할 수 있다.</p></blockquote><p>application.properties라는 이름 외의 다른 이름을 사용하고자 한다면 JVM 환경을 설정하여 변경할 수 있다.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> java -jar myproject.jar --spring.config.name=myproject</span></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> java -jar myproject.jar --spring.config.location=classpath:/default.properties,classpath:/override.properties</span></span><br></pre></td></tr></table></figure><h2 id="Profile-specific-properties"><a href="#Profile-specific-properties" class="headerlink" title="Profile-specific properties"></a>Profile-specific properties</h2><p><code>application-{profile}.properties(.yml)</code>의 네이밍 컨벤션을 가진 properties 파일로 profile별로 사용할 수 있다.</p><p>복수의 profile이 적용이 된다면 last wins 전략이 사용된다.</p><p><code>spring.config.location</code>이 사용된 경우 <code>profile-specific properties</code> 전략은 무시된다.</p><h2 id="Placeholder-in-properties"><a href="#Placeholder-in-properties" class="headerlink" title="Placeholder in properties"></a>Placeholder in properties</h2><p>application.properties 내의 값은 이전의 정의된 값을 참조할 수 있다.</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">app.name</span>=<span class="string">MyApp</span></span><br><span class="line"><span class="meta">app.description</span>=<span class="string">$&#123;app.name&#125; is a Spring Boot application</span></span><br></pre></td></tr></table></figure><h1 id="properties"><a href="#properties" class="headerlink" title=".properties"></a>.properties</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># spring</span><br><span class="line">spring.server.port&#x3D;8080</span><br><span class="line">spring.server.domain&#x3D;www.example.com</span><br><span class="line"> </span><br><span class="line"># jdbc</span><br><span class="line">jdbc.url&#x3D;jdbc:mysql:&#x2F;&#x2F;0.0.0.1:3306&#x2F;example?a&#x3D;b&amp;c&#x3D;d</span><br><span class="line">jdbc.username&#x3D;root</span><br><span class="line">jdbc.password&#x3D;root</span><br><span class="line"> </span><br><span class="line"># list</span><br><span class="line">list[0]&#x3D;a</span><br><span class="line">list[1]&#x3D;b</span><br><span class="line">list[2]&#x3D;c</span><br></pre></td></tr></table></figure><h2 id="장점"><a href="#장점" class="headerlink" title="장점"></a>장점</h2><ul><li>escape문자열 필요 없다.</li><li>선언부가 필요 없다.</li><li>단순하다.</li></ul><h2 id="단점"><a href="#단점" class="headerlink" title="단점"></a>단점</h2><ul><li>가독성이 떨어질 수 있다.</li><li>키-값 1:1 매칭</li></ul><h1 id="xml"><a href="#xml" class="headerlink" title=".xml"></a>.xml</h1><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">properties</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">"http://java.sun.com/dtd/properties.dtd"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- srping --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">"spring.server.port"</span>&gt;</span>8080<span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">"spring.server.domain"</span>&gt;</span>www.example.com<span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">&lt;!-- jdbc --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">"jdbc.url"</span>&gt;</span>jdbc:mysql://0.0.0.1:3306/example?a=b<span class="symbol">&amp;amp;</span>c=d<span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">"jdbc.username"</span>&gt;</span>root<span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">"jdbc.password"</span>&gt;</span>root<span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line"> </span><br><span class="line">  <span class="comment">&lt;!-- list --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">"color"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">key</span>=<span class="string">"r"</span>&gt;</span>0<span class="tag">&lt;/<span class="name">color</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">key</span>=<span class="string">"g"</span>&gt;</span>100<span class="tag">&lt;/<span class="name">color</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">key</span>=<span class="string">"b"</span>&gt;</span>0<span class="tag">&lt;/<span class="name">color</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="장점-1"><a href="#장점-1" class="headerlink" title="장점"></a>장점</h2><ul><li>1:N 형식 매핑이 가능하다.</li></ul><h2 id="단점-1"><a href="#단점-1" class="headerlink" title="단점"></a>단점</h2><ul><li>선언부(<code>&lt;!DOCTYPE...&gt;</code>)가 존재한다.</li><li>쳐야하는 문자 수가 많다(혹은 반복되는 ctrl+c, ctrl+v, 심지어 주석 처리에도…)</li><li>가독성(escape문자)이 떨어진다.</li></ul><h1 id="yml"><a href="#yml" class="headerlink" title=".yml"></a>.yml</h1><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># spring</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">server:</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">    <span class="attr">domain:</span> <span class="string">www.example.com</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># jdbc</span></span><br><span class="line"><span class="attr">jdbc:</span></span><br><span class="line">  <span class="attr">url:</span> <span class="string">jdbc:mysql://0.0.0.1:3306/example?a=b&amp;c=d</span></span><br><span class="line">  <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">password:</span> <span class="string">root</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># list</span></span><br><span class="line"><span class="attr">list:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">apple</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">banana</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">orange</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># profiles</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">    <span class="attr">profiles:</span> <span class="string">develop</span></span><br><span class="line"><span class="attr">jdbc:</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">dev1</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">    <span class="attr">profiles:</span> <span class="string">release</span></span><br><span class="line"><span class="attr">jdbc:</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">release1</span></span><br></pre></td></tr></table></figure><h2 id="장점-2"><a href="#장점-2" class="headerlink" title="장점"></a>장점</h2><ul><li>escape 문자열 필요 없다</li><li>1:N 형식 매핑이 가능하다</li><li>선언부가 없다.</li><li>profile과 관련해서 spring의 지원을 받을 수 있다.</li></ul><h2 id="단점-2"><a href="#단점-2" class="headerlink" title="단점"></a>단점</h2><ul><li>생소함?(학습비용?)</li></ul><h2 id="참조"><a href="#참조" class="headerlink" title="참조"></a>참조</h2><p><a href="https://docs.spring.io/spring-boot/docs/current/reference/html/boot-features-external-config.html#boot-features-external-config-yaml" target="_blank" rel="noopener">https://docs.spring.io/spring-boot/docs/current/reference/html/boot-features-external-config.html#boot-features-external-config-yaml</a></p><h1 id="Spring-Profile"><a href="#Spring-Profile" class="headerlink" title="Spring Profile"></a>Spring Profile</h1><p><strong>jvm 옵션, spring boot 실행 명령에 추가</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">spring.profiles.active&#x3D;dev(local,dev,test 등)</span><br></pre></td></tr></table></figure><p><strong>xml bean 설정</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">profile</span>=<span class="string">"local"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"aesCrypto"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"privateKeyPath"</span>&gt;</span>/a/a.cert<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"publicKeyPath"</span>&gt;</span>/a/b.cert<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">profile</span>=<span class="string">"dev"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"aesCrypto"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"privateKeyPath"</span>&gt;</span>/c/c.cert<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"publicKeyPath"</span>&gt;</span>/c/d.cert<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beasn</span>&gt;</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;Spring-boot-enviroment-abstraction&quot;&gt;&lt;a href=&quot;#Spring-boot-enviroment-abstraction&quot; class=&quot;headerlink&quot; title=&quot;Spring boot enviroment abstraction&quot;&gt;&lt;/a&gt;Spring boot enviroment abstraction&lt;/h1&gt;&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;@Component&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;MyBean&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;meta&quot;&gt;@Value&lt;/span&gt;(&lt;span class=&quot;string&quot;&gt;&quot;$&amp;#123;name&amp;#125;&quot;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; String name;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;classpath 내의 application.properties(yml)을 사용하여 어플리케이션에서 사용할 프로퍼티를 정의할 수 있다.&lt;/p&gt;
    
    </summary>
    
      <category term="spring" scheme="https://supawer0728.github.io/categories/spring/"/>
    
      <category term="reference" scheme="https://supawer0728.github.io/categories/spring/reference/"/>
    
    
      <category term="spring" scheme="https://supawer0728.github.io/tags/spring/"/>
    
      <category term="reference" scheme="https://supawer0728.github.io/tags/reference/"/>
    
      <category term="spring-boot" scheme="https://supawer0728.github.io/tags/spring-boot/"/>
    
  </entry>
  
  <entry>
    <title>Spring에서 요청에 따른 부가 응답 추가하기(2) - reactor 적용</title>
    <link href="https://supawer0728.github.io/2018/03/11/Spring-request-model2/"/>
    <id>https://supawer0728.github.io/2018/03/11/Spring-request-model2/</id>
    <published>2018-03-11T05:59:03.000Z</published>
    <updated>2020-03-04T08:18:02.746Z</updated>
    
    <content type="html"><![CDATA[<h1 id="서론"><a href="#서론" class="headerlink" title="서론"></a>서론</h1><p>앞 번에 개발한 소스에는 두 가지 문제점이 있었다</p><ol><li>Network I/O를 순차 실행<ul><li>O(n) 시간이 걸림 : timeout * attachment 갯수</li><li>Async로 O(1)만에 끝내도록 튜닝 필요</li></ul></li><li>Failover<ul><li>attachment는 단순 부가 정보임에도 불구하고 attachmentService에서 exception이 발생하면, 아무 정보도 내려줄 수 없음</li><li>attach는 실패해도 Board 정보와 나머지 성공한 attachment는 보여줘야 함</li></ul></li></ol><p>이번에는 위 이슈들을 reactor를 사용해서 해결해보려 한다.</p><img  src=http://www.plantuml.com/plantuml/svg/Y_RDJyhCIOrLqDMrKuXsoayiIWbEBIfBBOhbGk4fw9OMW5J0b5iflEwP_6f70rTqU6gIWbDHVdanM1Lnfg3eWHcbysRRb3URvkYycJVnJSl6D_CceEi5wNJEpyrDpIk1YLaf91PNvYLZKncKcWnMcqA4Mj_KtAJK8ZI5EWflkfUyxLa10000><a id="more"></a><h1 id="Reactor"><a href="#Reactor" class="headerlink" title="Reactor"></a>Reactor</h1><p>우선 왜 reactor를 사용하는 가에 대해서 간략하게 정리해보자</p><ul><li>Rx(Reactive Extension)를 구현하여 쉽게 비동기 프로그래밍 가능</li><li>또 다른 Rx 구현체인 RxJava와 비교했을 때, 다음의 장점이 있음<ul><li>Spring5에 통합하기 쉬움</li><li>Java8에 대한 지원<ul><li>rxJava는 1.6버전부터 쓸 수 있으며 자체적으로 <code>Function</code>을 구현해서 사용</li><li>Reactor는 Java8부터 쓸 수 있으며 Java8 Api와 Optional 등을 지원</li></ul></li></ul></li></ul><p>여기서 Reactor API에 대한 기초적인 사항들은 다루지 않으려 한다. 참고로 reactor는 Java 버전에 영향을 받는다. 본문의 소스는 Spring 5에서 작성되었지만 Java8을 사용한다면 아래 소스를 Spring4에 적용해도 문제없이 동작해야 한다.</p><h1 id="AttachmentWrapperItem"><a href="#AttachmentWrapperItem" class="headerlink" title="AttachmentWrapperItem"></a>AttachmentWrapperItem</h1><p>본격적으로 이슈를 해결하기 전에 먼저 한가지 리팩토링을 해야한다. 이전의 내용을 잠깐 살펴보자. <code>BoardDto</code>는 아래와 같이 <code>AttachmentWrapper</code>를 가지고 있다</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@JsonInclude</span>(JsonInclude.Include.NON_NULL)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BoardDto</span> <span class="keyword">implements</span> <span class="title">Attachable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String title;</span><br><span class="line">    <span class="keyword">private</span> String content;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Setter</span>(AccessLevel.PRIVATE)</span><br><span class="line">    <span class="meta">@JsonIgnore</span></span><br><span class="line">    <span class="keyword">private</span> AttachmentWrapper attachmentWrapper = <span class="keyword">new</span> AttachmentWrapper();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>AttachmentWrapper</code>는 <code>AttachmentType</code>과 <code>Attachment</code>를 따로 받고 있다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="meta">@EqualsAndHashCode</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AttachmentWrapper</span> </span>&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">put</span><span class="params">(AttachmentType type, Attachment attachment)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>reactor를 사용하게 되면 <code>Mono&lt;T&gt;</code>, <code>Flux&lt;T&gt;</code>와 같이 Generic으로 표현할 수 있도록 <code>AttachmentType</code>과 <code>Attachment</code>를 하나로 묶는 <code>AttachmentWrapperItem</code> 클래스를 작성하고 이를 <code>AttachmentWrapper</code>에 반영해야한다.</p><p><strong>AttachmentWrapperItem</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Value</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AttachmentWrapperItem</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 예외 발생시 반환할 인스턴스</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> AttachmentWrapperItem ON_ERROR = <span class="keyword">new</span> AttachmentWrapperItem(<span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">    <span class="keyword">private</span> AttachmentType type;</span><br><span class="line">    <span class="keyword">private</span> Attachment attachment;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>AttachmentWrapper 적용</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="meta">@EqualsAndHashCode</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AttachmentWrapper</span> </span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">interface</span> <span class="title">AttachmentMap</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">boolean</span> <span class="title">isEmpty</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">        Set&lt;Map.Entry&lt;AttachmentType, Attachment&gt;&gt; entrySet();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Delegate</span>(types = AttachmentMap<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">    <span class="title">private</span> <span class="title">Map</span>&lt;<span class="title">AttachmentType</span>, <span class="title">Attachment</span>&gt; <span class="title">value</span> </span>= <span class="keyword">new</span> EnumMap&lt;&gt;(AttachmentType<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">putAll</span><span class="params">(Collection&lt;AttachmentWrapperItem&gt; items)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.value.putAll(items.stream().collect(Collectors.toMap(AttachmentWrapperItem::getType, AttachmentWrapperItem::getAttachment)));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>Attachable interface 변경</strong></p><p>기존의 두 개의 파라미터를 받던 것을 하나의 파라미터를 받도록 변경한다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 변경 전</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Attachable</span> </span>&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="function"><span class="keyword">default</span> <span class="keyword">void</span> <span class="title">attach</span><span class="params">(Map&lt;? extends AttachmentType, ? extends Attachment&gt; attachment)</span> </span>&#123;</span><br><span class="line">        getAttachmentWrapper().putAll(attachment);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 변경 후</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Attachable</span> </span>&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="function"><span class="keyword">default</span> <span class="keyword">void</span> <span class="title">attach</span><span class="params">(Collection&lt;AttachmentWrapperItem&gt; items)</span> </span>&#123;</span><br><span class="line">        getAttachmentWrapper().putAll(items);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>AttachService 변경</strong></p><p><code>getAttachment</code>의 반환값을 <code>AttachmentWrapperItem</code>으로 바꾸자.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">AttachmentWrapperItem <span class="title">getAttachment</span><span class="params">(Attachable attachable)</span></span>;</span><br></pre></td></tr></table></figure><p><strong>AttachWriterToBoardService 변경</strong></p><p><code>AttachService</code>의 변경된 로직을 반영한다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 변경 전</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Attachment <span class="title">getAttachment</span><span class="params">(Attachable attachment)</span> </span>&#123;</span><br><span class="line">    BoardDto boardDto = supportType.cast(attachment);</span><br><span class="line">    <span class="keyword">return</span> writerClient.getWriter(boardDto.getWriterId());</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 변경 후</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> AttachmentWrapperItem <span class="title">getAttachment</span><span class="params">(Attachable attachable)</span> </span>&#123;</span><br><span class="line">    BoardDto boardDto = supportType.cast(attachable);</span><br><span class="line">    Attachment attachment = writerClient.getWriter(boardDto.getWriterId());</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> AttachmentWrapperItem(supportAttachmentType, attachment);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>AttachmentAspect 변경</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 변경 전</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">executeAttach</span><span class="params">(Attachable attachable)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    Set&lt;AttachmentType&gt; types = attachmentTypeHolder.getTypes();</span><br><span class="line"></span><br><span class="line">    Map&lt;AttachmentType, Attachment&gt; attachmentMap =</span><br><span class="line">            types.stream()</span><br><span class="line">                 .flatMap(type -&gt; typeToServiceMap.get(type).stream())</span><br><span class="line">                 .filter(service -&gt; service.getSupportType().isAssignableFrom(attachable.getClass()))</span><br><span class="line">                 .collect(Collectors.toMap(AttachService::getSupportAttachmentType, service -&gt; service.getAttachment(attachable)));</span><br><span class="line"></span><br><span class="line">    attachable.attach(attachmentMap);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 변경 후</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">executeAttach</span><span class="params">(Attachable attachable)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    Set&lt;AttachmentType&gt; types = attachmentTypeHolder.getTypes();</span><br><span class="line"></span><br><span class="line">    List&lt;AttachmentWrapperItem&gt; items =</span><br><span class="line">            types.stream()</span><br><span class="line">                 .flatMap(type -&gt; typeToServiceMap.get(type).stream())</span><br><span class="line">                 .filter(service -&gt; service.getSupportType().isAssignableFrom(attachable.getClass()))</span><br><span class="line">                 .map(service -&gt; service.getAttachment(attachable))</span><br><span class="line">                 .collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">    attachable.attach(items);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="reactor로-비동기-프로그래밍-적용"><a href="#reactor로-비동기-프로그래밍-적용" class="headerlink" title="reactor로 비동기 프로그래밍 적용"></a>reactor로 비동기 프로그래밍 적용</h1><p><code>attachService.getAttachment()</code>를 호출할 때 Network I/O가 발생하고 있다.<br>문제는 이 메서드가 attachment해야할 갯수만큼 실행이 된다는 점이다.<br>이를 비동기 프로그래밍을 적용해서 해결해보자.</p><h2 id="의존성-설정"><a href="#의존성-설정" class="headerlink" title="의존성 설정"></a>의존성 설정</h2><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">compile</span>(<span class="string">'io.projectreactor:reactor-core:3.1.5.RELEASE'</span>)</span><br></pre></td></tr></table></figure><h2 id="AttachService-수정"><a href="#AttachService-수정" class="headerlink" title="AttachService 수정"></a>AttachService 수정</h2><p><code>getAttachment</code>의 반환형을 <code>Mono&lt;AttachmentWrapperInfo&gt;</code>로 수정한다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AttachService</span>&lt;<span class="title">T</span> <span class="keyword">extends</span> <span class="title">Attachable</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function">AttachmentType <span class="title">getSupportAttachmentType</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">Class&lt;T&gt; <span class="title">getSupportType</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">Mono&lt;AttachmentWrapperItem&gt; <span class="title">getAttachment</span><span class="params">(Attachable attachable)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="AttachWriterToBoardService-수정"><a href="#AttachWriterToBoardService-수정" class="headerlink" title="AttachWriterToBoardService 수정"></a>AttachWriterToBoardService 수정</h2><p>수정한 <code>AttachService</code>의 구현체인 <code>AttachWriterToBoardService</code>에 변경된 내용을 반영하자.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Mono&lt;AttachmentWrapperItem&gt; <span class="title">getAttachment</span><span class="params">(Attachable attachable)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Mono.defer(() -&gt; executeGetAttachment(attachable))</span><br><span class="line">                <span class="comment">// Network I/O를 사용하므로 elastic()으로 생성된 thread에서 실행되도록 선언</span></span><br><span class="line">               .subscribeOn(Schedulers.elastic()); </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 원래 getAttachment의 실행하던 부분을 가져옴</span></span><br><span class="line"><span class="comment">// 반환 값에 Mono.just()를 씌움</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> Mono&lt;AttachmentWrapperItem&gt; <span class="title">executeGetAttachment</span><span class="params">(Attachable attachable)</span> </span>&#123;</span><br><span class="line">    BoardDto boardDto = supportType.cast(attachable);</span><br><span class="line">    Attachment attachment = writerClient.getWriter(boardDto.getWriterId());</span><br><span class="line">    <span class="keyword">return</span> Mono.just(<span class="keyword">new</span> AttachmentWrapperItem(supportAttachmentType, attachment));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="AttachmetAspect-수정"><a href="#AttachmetAspect-수정" class="headerlink" title="AttachmetAspect 수정"></a>AttachmetAspect 수정</h2><p><code>Attachable</code>의 구현체의 타입에 맞추어 service를 실행하고<br>얻은 <code>Mono</code>의 List를 각각 비동기로 실행시키고, <code>block()</code>을 호출해 동기화합니다</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">executeAttach</span><span class="params">(Attachable attachable)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    List&lt;Mono&lt;AttachmentWrapperItem&gt;&gt; monoItems = createMonoList(attachable);</span><br><span class="line"></span><br><span class="line">    List&lt;AttachmentWrapperItem&gt; items = executeMonoAndCollectList(monoItems);</span><br><span class="line"></span><br><span class="line">    attachable.attach(items);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Attachable의 타입에 맞추어 서비스를 실행 후 List&lt;Mono&gt;를 생성함</span></span><br><span class="line"><span class="keyword">private</span> List&lt;Mono&lt;AttachmentWrapperItem&gt;&gt; createMonoList(Attachable attachable) &#123;</span><br><span class="line">    Set&lt;AttachmentType&gt; types = attachmentTypeHolder.getTypes();</span><br><span class="line">    <span class="keyword">return</span> types.stream()</span><br><span class="line">                .flatMap(type -&gt; typeToServiceMap.get(type).stream())</span><br><span class="line">                .filter(service -&gt; service.getSupportType().isAssignableFrom(attachable.getClass()))</span><br><span class="line">                .map(service -&gt; service.getAttachment(attachable))</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// List&lt;Mono&gt;를 zip()으로 각각 실행하면서 List&lt;attachmentWrapperItem&gt;으로 만들어 반환</span></span><br><span class="line"><span class="comment">// 각각의 Mono는 내부에서 elastic()에 의해 비동기로 실행되며</span></span><br><span class="line"><span class="comment">// block()을 통해 최종적으로 동기화됨</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> List&lt;AttachmentWrapperItem&gt; <span class="title">executeMonoAndCollectList</span><span class="params">(List&lt;Mono&lt;AttachmentWrapperItem&gt;&gt; monoItems)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Mono.zip(monoItems, <span class="keyword">this</span>::filterItems)</span><br><span class="line">               .block();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> List&lt;AttachmentWrapperItem&gt; <span class="title">filterItems</span><span class="params">(Object[] itemArray)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Stream.of(itemArray)</span><br><span class="line">                 .map(AttachmentWrapperItem.class::cast)</span><br><span class="line">                 .collect(Collectors.toList());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="실행"><a href="#실행" class="headerlink" title="실행"></a>실행</h2><p>이제 비동기로 돌아가는 것을 확인해볼 차례다.<br>테스트 코드를 짜서 확인하는 것이 가장 좋겠으나…<br>간편히 <code>Thread.sleep(3000)</code>을 줘서 확인해보도록 한다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 댓글 서비스에 3초 슬립</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> Mono&lt;AttachmentWrapperItem&gt; <span class="title">executeGetAttachment</span><span class="params">(Attachable attachable)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123; Thread.sleep(<span class="number">3000</span>); &#125; <span class="keyword">catch</span> (InterruptedException e) &#123; &#125;</span><br><span class="line">    BoardDto boardDto = supportType.cast(attachable);</span><br><span class="line">    Attachment attachment = <span class="keyword">new</span> SimpleAttachmentCollection&lt;&gt;(commentClient.getComments(boardDto.getId()));</span><br><span class="line">    <span class="keyword">return</span> Mono.just(<span class="keyword">new</span> AttachmentWrapperItem(supportAttachmentType, attachment));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 작성자 정보 서비스에 3초 슬립</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> Mono&lt;AttachmentWrapperItem&gt; <span class="title">executeGetAttachment</span><span class="params">(Attachable attachable)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123; Thread.sleep(<span class="number">3000</span>); &#125; <span class="keyword">catch</span> (InterruptedException e) &#123; &#125;</span><br><span class="line">    BoardDto boardDto = supportType.cast(attachable);</span><br><span class="line">    Attachment attachment = writerClient.getWriter(boardDto.getWriterId());</span><br><span class="line">    <span class="keyword">return</span> Mono.just(<span class="keyword">new</span> AttachmentWrapperItem(supportAttachmentType, attachment));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>3초 이상, 6초 이내에 요청이 오면 성공이다</p><p><img src="/images/Spring-request-model2/success.png" alt="스크린샷 2018-03-08 오후 7.42.16.png"></p><h1 id="reactor로-실패-극복"><a href="#reactor로-실패-극복" class="headerlink" title="reactor로 실패 극복"></a>reactor로 실패 극복</h1><p>reactor로 실패를 극복하는 방법은 간단하다. 오류가 발생하면 앞서 작성했던 <code>AttachmentWrapperItem.ON_ERROR</code>를 반환하도록 하면 된다. Rx는 이러한 상황을 위한 API들이 모두 정의하고 있다.</p><h2 id="AttachService에서-예외-발생시-처리"><a href="#AttachService에서-예외-발생시-처리" class="headerlink" title="AttachService에서 예외 발생시 처리"></a>AttachService에서 예외 발생시 처리</h2><p><code>AttachWriterToBoardService</code>에서 <code>Writer</code>를 가져오는 중에 Exception이 발생하면 <code>AttachmentWrapperItem.ON_ERROR</code>를 보내도록 변경한다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AttachWriterToBoardService</span> <span class="keyword">implements</span> <span class="title">AttachService</span>&lt;<span class="title">BoardDto</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> WriterClient writerClient;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Duration timeout;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AttachWriterToBoardService</span><span class="params">(@NonNull WriterClient writerClient,</span></span></span><br><span class="line"><span class="function"><span class="params">                                      @Value(<span class="string">"$&#123;attach.writer.timeoutMillis:5000&#125;"</span>)</span> <span class="keyword">long</span> timeout) </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.writerClient = writerClient;</span><br><span class="line">        <span class="keyword">this</span>.timeout = Duration.ofMillis(timeout);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;AttachmentWrapperItem&gt; <span class="title">getAttachment</span><span class="params">(Attachable attachable)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Mono.defer(() -&gt; executeGetAttachment(attachable))</span><br><span class="line">                   .subscribeOn(Schedulers.elastic())</span><br><span class="line">                   .timeout(timeout) <span class="comment">// reactor에 timeout을 줘도 되고, client에서 자체적으로 timeout을 걸 수 있으면 믿고 쓰자</span></span><br><span class="line">                   .doOnError(e -&gt; log.warn(e.getMessage(), e)) <span class="comment">// 오류가 발생하면 log를 남긴다. 대체 값을 반환하므로 warn으로 지정</span></span><br><span class="line">                   .onErrorReturn(AttachmentWrapperItem.ON_ERROR); <span class="comment">// 오류가 발생하면 ON_ERROR를 반환</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="AttachmentAspect에서-ON-ERROR를-거르도록-로직-변경"><a href="#AttachmentAspect에서-ON-ERROR를-거르도록-로직-변경" class="headerlink" title="AttachmentAspect에서 ON_ERROR를 거르도록 로직 변경"></a>AttachmentAspect에서 ON_ERROR를 거르도록 로직 변경</h2><p>앞서 <code>AttachmentAspect</code>에서 <code>List&lt;Mono&gt;</code>를 비동기로 실행시키고 결과 값들을 <code>List&lt;AttachmentWrapperItem&gt;</code>에 모아서 <code>Attachable</code>에 넣어줬다.<br>간단히 비동시 실행결과가 <code>ON_ERROR</code>인 경우를 필터링하면 성공한 결과만을 모아 <code>List&lt;AttachmentWrapperItem&gt;</code>을 만들 수 있다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AttachmentAspect</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> List&lt;AttachmentWrapperItem&gt; <span class="title">executeMonoAndCollectList</span><span class="params">(List&lt;Mono&lt;AttachmentWrapperItem&gt;&gt; monoItems)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 여기에 timeout을 주어서 모든 Mono가 실행되는 최대 시간을 지정할 수도 있다</span></span><br><span class="line">        <span class="keyword">return</span> Mono.zip(monoItems, <span class="keyword">this</span>::filterItems)</span><br><span class="line">                   .doOnError(e -&gt; log.warn(e.getMessage(), e))</span><br><span class="line">                   .onErrorReturn(Collections.emptyList()) <span class="comment">// 모든 Mono를 실행시키고 취합하는 과정에서 오류가 발생하면 emptyList()를 반환</span></span><br><span class="line">                   .block();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> List&lt;AttachmentWrapperItem&gt; <span class="title">filterItems</span><span class="params">(Object[] itemArray)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Stream.of(itemArray)</span><br><span class="line">                     .map(AttachmentWrapperItem.class::cast)</span><br><span class="line">                     .filter(item -&gt; item != AttachmentWrapperItem.ON_ERROR) <span class="comment">// 예외 발생으로 인해 실패한 요청은 걸러냄</span></span><br><span class="line">                     .collect(Collectors.toList());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="실행-1"><a href="#실행-1" class="headerlink" title="실행"></a>실행</h2><p>이전에 100번 게시판을 불러올 때, 작성자 정보를 가져오려고 하면 <code>FeignClient</code>에서 404를 던지고 아래와 같이 API 자체가 실패했었다.</p><p><code>GET /boards/100?attachment=comments,writer</code></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"timestamp"</span>: <span class="string">"2018-03-08T07:55:22.127+0000"</span>,</span><br><span class="line">  <span class="attr">"status"</span>: <span class="number">500</span>,</span><br><span class="line">  <span class="attr">"error"</span>: <span class="string">"Internal Server Error"</span>,</span><br><span class="line">  <span class="attr">"message"</span>: <span class="string">"status 404 reading WriterClient#getWriter(long); content: &#123;&#125;"</span>,</span><br><span class="line">  <span class="attr">"path"</span>: <span class="string">"/boards/100"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">feign.FeignException: status 404 reading WriterClient#getWriter(long); content: &#123;&#125;</span><br><span class="line">at feign.FeignException.errorStatus(FeignException.java:62) ~[feign-core-9.5.1.jar:na]</span><br><span class="line">        ...</span><br><span class="line">at java.lang.Thread.run(Thread.java:748) ~[na:1.8.0_152]</span><br></pre></td></tr></table></figure><p>하지만 장애 극복을 적용한 후에는 예외는 <code>warn</code>으로 로그를 남기되, 성공한 부분까지는 응답을 할 수 있게 되었다.</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &#123;</span><br><span class="line">    "id": 100,</span><br><span class="line">    "title": "title100",</span><br><span class="line">    "content": "content100",</span><br><span class="line">    "comments": [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"id"</span>: <span class="number">496</span>,</span><br><span class="line">        <span class="attr">"email"</span>: <span class="string">"Zola@lizzie.com"</span>,</span><br><span class="line">        <span class="attr">"body"</span>: <span class="string">"neque unde voluptatem iure\nodio excepturi ipsam ad id\nipsa sed expedita error quam\nvoluptatem tempora necessitatibus suscipit culpa veniam porro iste vel"</span></span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">2018-03-08 19:59:12.056  WARN 64890 --- [      elastic-5] c.p.s.s.a.s.w.AttachWriterToBoardService : status 404 reading WriterClient#getWriter(long); content:</span><br><span class="line">&#123;&#125;</span><br><span class="line"></span><br><span class="line">feign.FeignException: status 404 reading WriterClient#getWriter(long); content: &#123;&#125;</span><br><span class="line">at feign.FeignException.errorStatus(FeignException.java:62) ~[feign-core-9.5.1.jar:na]</span><br><span class="line">        ...</span><br><span class="line">at java.lang.Thread.run(Thread.java:748) ~[na:1.8.0_152]</span><br></pre></td></tr></table></figure><h1 id="마무리"><a href="#마무리" class="headerlink" title="마무리"></a>마무리</h1><p>Reactor를 사용해서 비동기 프로그래밍을 하고, 장애에 대처해 극복할 수 있게 해봤다.<br>중간에 reactor에 <code>timeout()</code>을 사용했는 데,<br>이 부분은 client를 <code>FeignClient</code>를 사용해서 <code>application.yml</code>로 빼서 따로 관리할 수 있다.<br>이전에 공유했던 <code>Hystrix</code>와도 연계해서 fallback을 구현할 수도 있어서, 강력한 장애 대응을 할 수 있다.</p><p>여전히 현재의 코드는 큰 단점이 있다.<br><code>AttachmentAspect</code>에서 reactor의 <code>block()</code>을 호출한다는 점이다.</p><p>이것이 단점인 이유는 <a href="https://projectreactor.io/learn" target="_blank" rel="noopener">reactor learn 페이지</a>에서 가져온 사진 3장으로 설명할 수 있을 것 같다.</p><table><thead><tr><th><img src="/images/Spring-request-model2/block.PNG" alt="blocking is evil"></th></tr></thead><tbody><tr><td><em>출처 : <a href="https://projectreactor.io/learn" target="_blank" rel="noopener">https://projectreactor.io/learn</a></em></td></tr></tbody></table><p>즉 Non-Blocking을 사용해서 <code>자원을 효율적으로</code> 사용하지 않았다는 것이다. 100만원짜리 서버를 써야 하던 일을, 50만원짜리 서버로 처리할 수 있다면 그렇게 해야한다. 때문에 SpringFramework 5에서는 webflux를 사용하여 netty기반(기본설정)으로 Non-Blocking + Async를 사용할 수 있도록 했다.</p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;서론&quot;&gt;&lt;a href=&quot;#서론&quot; class=&quot;headerlink&quot; title=&quot;서론&quot;&gt;&lt;/a&gt;서론&lt;/h1&gt;&lt;p&gt;앞 번에 개발한 소스에는 두 가지 문제점이 있었다&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Network I/O를 순차 실행&lt;ul&gt;
&lt;li&gt;O(n) 시간이 걸림 : timeout * attachment 갯수&lt;/li&gt;
&lt;li&gt;Async로 O(1)만에 끝내도록 튜닝 필요&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Failover&lt;ul&gt;
&lt;li&gt;attachment는 단순 부가 정보임에도 불구하고 attachmentService에서 exception이 발생하면, 아무 정보도 내려줄 수 없음&lt;/li&gt;
&lt;li&gt;attach는 실패해도 Board 정보와 나머지 성공한 attachment는 보여줘야 함&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;이번에는 위 이슈들을 reactor를 사용해서 해결해보려 한다.&lt;/p&gt;
&lt;img  src=http://www.plantuml.com/plantuml/svg/Y_RDJyhCIOrLqDMrKuXsoayiIWbEBIfBBOhbGk4fw9OMW5J0b5iflEwP_6f70rTqU6gIWbDHVdanM1Lnfg3eWHcbysRRb3URvkYycJVnJSl6D_CceEi5wNJEpyrDpIk1YLaf91PNvYLZKncKcWnMcqA4Mj_KtAJK8ZI5EWflkfUyxLa10000&gt;
    
    </summary>
    
      <category term="spring" scheme="https://supawer0728.github.io/categories/spring/"/>
    
      <category term="practice" scheme="https://supawer0728.github.io/categories/practice/"/>
    
      <category term="practice" scheme="https://supawer0728.github.io/categories/spring/practice/"/>
    
    
      <category term="spring" scheme="https://supawer0728.github.io/tags/spring/"/>
    
      <category term="reactor" scheme="https://supawer0728.github.io/tags/reactor/"/>
    
      <category term="async" scheme="https://supawer0728.github.io/tags/async/"/>
    
      <category term="fallback" scheme="https://supawer0728.github.io/tags/fallback/"/>
    
  </entry>
  
  <entry>
    <title>Spring에서 요청에 따른 부가 응답 추가하기 (1)</title>
    <link href="https://supawer0728.github.io/2018/03/11/Spring-request-model1/"/>
    <id>https://supawer0728.github.io/2018/03/11/Spring-request-model1/</id>
    <published>2018-03-10T17:48:41.000Z</published>
    <updated>2020-03-04T08:18:02.745Z</updated>
    
    <content type="html"><![CDATA[<h1 id="서론"><a href="#서론" class="headerlink" title="서론"></a>서론</h1><p>최근 들어 특정 콘텐츠에 부가 속성을 더하여 보여주는 UI가 증가하고 있다. 부가 속성의 예를 들자면 좋아요, 싫어요, 댓글, 공유 링크, 연관 게시물, 추천 게시물 등을 들 수 있다. 이러한 부가 속성들은 기획적 요구나 성능 이슈로 인하여 클라이언트마다 다른 UI를 보여줘야할 때가 있다. 웹 서버 개발자로써 자주 겪게되는 요구 사항 중 하나다. 이러한 요구 사항을 Java와 Spring Framework를 이용해서 어떻게 하면 OOP스럽게 풀어나갈 수 있을까. 당면 과제 해결과 리팩토링을 거쳐 조금씩 더 나은 애플리케이션을 만들어보고자 한다.</p><a id="more"></a><h1 id="요구-사항-정리"><a href="#요구-사항-정리" class="headerlink" title="요구 사항 정리"></a>요구 사항 정리</h1><ul><li>게시판 상세 API</li><li>Web에서는 댓글과 추천 게시글 목록을 보여줘야 함</li><li>Mobile에서는 댓글만 보여줘야 함</li></ul><p><strong>서비스 구조</strong></p><p>실제 도메인인 Board를 서비스하는 MicroService가 있고, 댓글, 회원 등의 다른 MicroService로 분리가 되어있다. BoardService는 자체로 하나의 서비스이자, 부가 속성들을 조합(API Ochestration)하는 역할을 한다.</p><img  src=http://www.plantuml.com/plantuml/svg/Y_RDJyhCIOrLqDMrKuXsoayiIWbEBIfBBOhbGk4fw9OMW5J0b5iflEwP_6f70rTqU6gIWbDHVdanM1Lnfg3eWHcbysRRb3URvkYycJVnJSl6D_CceEi5wNJEpyrDpIl1OJf8HL1gCbXD2XurlgcvIQb5K240><h1 id="해결법에-대한-생각"><a href="#해결법에-대한-생각" class="headerlink" title="해결법에 대한 생각"></a>해결법에 대한 생각</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 난 오늘만 사는 개발자(눈누난나~)</span></span><br><span class="line"><span class="keyword">if</span> (resolveDevice(request) == Device.APP) &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>if</code>가 좋은 점이 있다. 이해하기 쉽다는 점이다. 하지만 위의 예제는 OCP를 지킬 수 없다. 시간이 촉박하다면 당장에 <code>if</code>를 쓰고 싶은 마음이 들겠지만, 미래를 생각하여 접어두자.</p><h2 id="원칙"><a href="#원칙" class="headerlink" title="원칙"></a>원칙</h2><p>특정 클라이언트에서는 특정 부가 정보들이 보이게 해달라는 요구 사항들은 앞으로도 추가될 수 있다. 좋은 설계를 통해 앞으로의 대비, 로직을 추가할 때의 비용을 줄이도록 하자.</p><ul><li>가능한 OOP스럽게 : 작은 class들이 서로 협력하여 큰 문제를 해결하도록!</li><li>마치 장식(decoration)을 추가하는 것처럼 동작을 할 수 있으면 좋겠다.</li><li>client가 필요한 부가 정보를 요청하도록 구현하자.</li></ul><blockquote><p>한 번 정해진 설계를 수정할 필요 없이 확장 가능하게</p></blockquote><h2 id="예상되는-API-형식"><a href="#예상되는-API-형식" class="headerlink" title="예상되는 API 형식"></a>예상되는 API 형식</h2><ul><li>client가 필요한 부가 정보를 요청하도록 구현하자.</li></ul><p><strong>기본</strong></p><p>Board는 <code>id</code>, <code>title</code>, <code>content</code> 속성을 가지고 있다.</p><p><code>GET /boards/1</code></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"id"</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">"title"</span>: <span class="string">"title1"</span>,</span><br><span class="line">  <span class="attr">"content"</span>: <span class="string">"content1"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>댓글추가</strong></p><p>클라이언트가 댓글(<code>comments</code>)을 추가 정보로 요청할 수 있다.</p><p><code>GET /boards/1?attachment=comments</code></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"id"</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">"title"</span>: <span class="string">"title1"</span>,</span><br><span class="line">    <span class="attr">"content"</span>: <span class="string">"content1"</span>,</span><br><span class="line">    <span class="attr">"comments"</span>: [&#123;</span><br><span class="line">        <span class="attr">"id"</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">"email"</span>: <span class="string">"Eliseo@gardner.biz"</span>,</span><br><span class="line">        <span class="attr">"body"</span>: <span class="string">"laudantium enim quasi est quidem magnam voluptate ipsam eos\ntempora quo necessitatibus\ndolor quam autem quasi\nreiciendis et nam sapiente accusantium"</span></span><br><span class="line">    &#125;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>댓글과 작성자정보</strong></p><p>클라이언트가 댓글과 작성자정보(<code>writer</code>)를 추가 정보로 요청할 수 있다.</p><p><code>GET /boards/1?attachment=comments,writer</code></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"id"</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">"title"</span>: <span class="string">"title1"</span>,</span><br><span class="line">    <span class="attr">"content"</span>: <span class="string">"content1"</span>,</span><br><span class="line">    <span class="attr">"comments"</span>: [&#123;</span><br><span class="line">        <span class="attr">"id"</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">"email"</span>: <span class="string">"Eliseo@gardner.biz"</span>,</span><br><span class="line">        <span class="attr">"body"</span>: <span class="string">"laudantium enim quasi est quidem magnam voluptate ipsam eos\ntempora quo necessitatibus\ndolor quam autem quasi\nreiciendis et nam sapiente accusantium"</span></span><br><span class="line">    &#125;],</span><br><span class="line">    <span class="attr">"writer"</span>: &#123;</span><br><span class="line">        <span class="attr">"id"</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">"username"</span>: <span class="string">"Bret"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="기본-API-작성"><a href="#기본-API-작성" class="headerlink" title="기본 API 작성"></a>기본 API 작성</h1><p>천리 길도 한걸음부터다. 우선은 기본 API를 작성하자. 기본 API 작성에 관한 내용은 별다른 설명 없이 소스로 대체하고자 한다.</p><h2 id="web-모듈-생성"><a href="#web-모듈-생성" class="headerlink" title="web 모듈 생성"></a>web 모듈 생성</h2><p><strong>의존성 설정</strong></p><p>현재일(2018-03-10) 기준으로 최신 버전인 spring-boot 2.0.0.RELAESE 사용했다</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">dependencies</span> &#123;</span><br><span class="line">  <span class="keyword">compile</span>(<span class="string">'org.springframework.boot:spring-boot-starter-data-jpa'</span>)</span><br><span class="line">  <span class="keyword">compile</span>(<span class="string">'org.springframework.boot:spring-boot-starter-web'</span>)  </span><br><span class="line">  compileOnly(<span class="string">'org.projectlombok:lombok'</span>)</span><br><span class="line">  <span class="keyword">runtime</span>(<span class="string">'com.h2database:h2'</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>Entity</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span>(access = AccessLevel.PRIVATE)</span><br><span class="line"><span class="meta">@Table</span>(name = <span class="string">"board"</span>)</span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Board</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@GeneratedValue</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String title;</span><br><span class="line">    <span class="keyword">private</span> String content;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Board</span><span class="params">(@NonNull String title, @NonNull String content)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.title = title;</span><br><span class="line">        <span class="keyword">this</span>.content = content;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>Controller</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/boards"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BoardController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> BoardRepository boardRepository;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/&#123;id&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Board <span class="title">getOne</span><span class="params">(@PathVariable(<span class="string">"id"</span>)</span> Board board) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> board;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>미리 데이터 넣어두기</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleAttachmentApplication</span> <span class="keyword">implements</span> <span class="title">CommandLineRunner</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> BoardRepository boardRepository;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(SimpleAttachmentApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(String... args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        boardRepository.save(<span class="keyword">new</span> Board(<span class="string">"title1"</span>, <span class="string">"content1"</span>));</span><br><span class="line">        boardRepository.save(<span class="keyword">new</span> Board(<span class="string">"title2"</span>, <span class="string">"content2"</span>));</span><br><span class="line">        boardRepository.save(<span class="keyword">new</span> Board(<span class="string">"title3"</span>, <span class="string">"content3"</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>서버띄워 실행</strong></p><p><code>GET /borads/1</code></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"id"</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">"title"</span>: <span class="string">"title1"</span>,</span><br><span class="line">  <span class="attr">"content"</span>: <span class="string">"content1"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>소스 : <a href="https://github.com/supawer0728/simple-attachment/tree/base-api" target="_blank" rel="noopener">https://github.com/supawer0728/simple-attachment/tree/base-api</a></p><h2 id="기본-API에-attachment-구현하기"><a href="#기본-API에-attachment-구현하기" class="headerlink" title="기본 API에 attachment 구현하기"></a>기본 API에 attachment 구현하기</h2><p>attachment를 구현하기 위한 사항들을 Spring의 MVC 요청을 처리하는 흐름에 따라 정리해보았다.</p><ol><li>필요한 경우 Interceptor에서 <code>attachment</code>를 해석하고 저장한다<br> 1-1 필요한 경우가 언젠지 정의해야 함.<br> 1-2 <code>attachment</code>를 해석할 class를 정의해야 함(AttachmentType)</li><li><code>attachment</code>는 <code>Request Scope</code> bean에 담아두고, 필요할 때 꺼내 사용(AttachmentTypeHolder class 정의)</li><li>Controller에서 객체가 반환되면, 필요한 속성을 추가<br> 3-1 Controller의 로직은 변경하지 않음<br> 3-2 AOP를 통해서, <code>1-1</code>의 <code>필요한 경우</code>를 파악하여, attachment를 위한 서비스 로직을 실행<br> 3-3 <code>Board</code> 엔티티는 생성, 수정, 삭제 용도로 남겨두고, 읽기 요청에 대해서는 comments, writer 등을 추가할 수 있는 BoardDto로 변환해서 보내자.(<a href="https://martinfowler.com/bliki/CQRS.html" target="_blank" rel="noopener">CQRS 적용</a>)</li></ol><h1 id="attachment를-해석해서-저장하기"><a href="#attachment를-해석해서-저장하기" class="headerlink" title="attachment를 해석해서 저장하기"></a>attachment를 해석해서 저장하기</h1><h2 id="AttachmentType"><a href="#AttachmentType" class="headerlink" title="AttachmentType"></a>AttachmentType</h2><p>서버에서 정의한 값들만 <code>attachment</code>로 해석할 것이다. enum이 안성맞춤일 것 같다. enum으로 <code>AttachmentType</code>을 정의하자.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> AttachmentType &#123;</span><br><span class="line">    COMMENTS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="AttachmentTypeHolder"><a href="#AttachmentTypeHolder" class="headerlink" title="AttachmentTypeHolder"></a>AttachmentTypeHolder</h2><p>요청에서 해석한 <code>attachment</code>를 저장할 <code>@RequestScope</code> bean이 필요하다. <code>AttachmentTypeHolder</code>에 요청된 <code>attachment</code>의 내용을 담아둘 것이다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestScope</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AttachmentTypeHolder</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Set&lt;AttachmentType&gt; types;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Attach"><a href="#Attach" class="headerlink" title="@Attach"></a>@Attach</h2><p>어떤 경우에 attachment를 해석할 것이지를 정의해야 한다. 실행하고자 하는 Controller의 메서드에 <code>@Attach</code>가 있으면, 해석이 필요한 경우로 정의했다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target</span>(&#123;ElementType.METHOD&#125;)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Attach &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/boards"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BoardController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// `/boards/&#123;id&#125;`로 요청이 들어오면 요청에 있는 attachment를 해석하려 할 것이다.</span></span><br><span class="line">    <span class="meta">@Attach</span> </span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/&#123;id&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> BoardDto <span class="title">getOne</span><span class="params">(@PathVariable(<span class="string">"id"</span>)</span> Board board) </span>&#123; <span class="keyword">return</span> board;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="AttachInterceptor"><a href="#AttachInterceptor" class="headerlink" title="AttachInterceptor"></a>AttachInterceptor</h2><p>이제 요청에서 <code>attachment</code>를 해석해서 <code>AttachmentTypeHolder</code>에 저장하자. 편의상 성능 관련 로직은 배제했다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AttachInterceptor</span> <span class="keyword">extends</span> <span class="title">HandlerInterceptorAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TARGET_PARAMETER_NAME = <span class="string">"attachment"</span>;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AttachmentTypeHolder attachmentTypeHolder;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!(handler <span class="keyword">instanceof</span> HandlerMethod)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        HandlerMethod handlerMethod = (HandlerMethod) handler;</span><br><span class="line">        <span class="comment">// hasMethodAnnotation()의 호출 스택이 꽤 길어서, Map&lt;HandlerMethod, Boolean&gt;으로 캐싱하시면 살짝 성능이 좋아짐</span></span><br><span class="line">        <span class="keyword">if</span> (!key.hasMethodAnnotation(Attachable<span class="class">.<span class="keyword">class</span>)) </span>&#123;  </span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Set&lt;AttachmentType&gt; types = resolveAttachmentType(request);</span><br><span class="line">        attachmentTypeHolder.setTypes(types);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Set&lt;AttachmentType&gt; <span class="title">resolveAttachmentType</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">        String attachments = request.getParameter(TARGET_PARAMETER_NAME);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isBlank(attachments)) &#123;</span><br><span class="line">            <span class="keyword">return</span> Collections.emptySet();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 기본적으로 enum의 valueOf는 찾는 값이 없을 시 IllegalArgumentException을 throw</span></span><br><span class="line">        <span class="comment">// attachment 때문에 장애가 나면 넌센스, 실제로 구현할 때에는 exception을 던지지 않게 해야함</span></span><br><span class="line">        <span class="comment">// github 소스에서는 exception을 던지지 않음</span></span><br><span class="line">        <span class="keyword">return</span> Stream.of(attachments.split(<span class="string">","</span>))</span><br><span class="line">                     .map(String::toUpperCase)</span><br><span class="line">                     .map(AttachmentType::valueOf)</span><br><span class="line">                     .collect(Collectors.toSet());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Test"><a href="#Test" class="headerlink" title="Test"></a>Test</h2><p>앞서 정의한 인터셉터가 잘 동작하는 지 확인해보자.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AttachInterceptorTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@InjectMocks</span></span><br><span class="line">    <span class="keyword">private</span> AttachInterceptor attachInterceptor;</span><br><span class="line">    <span class="meta">@Spy</span></span><br><span class="line">    <span class="keyword">private</span> AttachmentTypeHolder attachmentTypeHolder;</span><br><span class="line">    <span class="meta">@Mock</span></span><br><span class="line">    <span class="keyword">private</span> HandlerMethod handlerMethod;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUp</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        MockitoAnnotations.initMocks(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">preHandle</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// given</span></span><br><span class="line">        given(handlerMethod.hasMethodAnnotation(Attachable<span class="class">.<span class="keyword">class</span>)).<span class="title">willReturn</span>(<span class="title">true</span>)</span>;</span><br><span class="line">        MockHttpServletRequest request = <span class="keyword">new</span> MockHttpServletRequest();</span><br><span class="line">        request.setParameter(AttachInterceptor.TARGET_PARAMETER_NAME, AttachmentType.COMMENTS.name().toLowerCase());</span><br><span class="line">        MockHttpServletResponse response = <span class="keyword">new</span> MockHttpServletResponse();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// when</span></span><br><span class="line">        attachInterceptor.preHandle(request, response, handlerMethod);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// then</span></span><br><span class="line">        assertThat(attachmentTypeHolder.getTypes(), hasItem(AttachmentType.COMMENTS));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>소스 : <a href="https://github.com/supawer0728/simple-attachment/tree/save-attachment-request" target="_blank" rel="noopener">https://github.com/supawer0728/simple-attachment/tree/save-attachment-request</a></p><h1 id="Controller에서-BoardDto를-반환하게-만들기"><a href="#Controller에서-BoardDto를-반환하게-만들기" class="headerlink" title="Controller에서 BoardDto를 반환하게 만들기"></a>Controller에서 BoardDto를 반환하게 만들기</h1><h2 id="BoardDto-정의"><a href="#BoardDto-정의" class="headerlink" title="BoardDto 정의"></a>BoardDto 정의</h2><p>앞에서 정의했던 <code>Board</code>는 엔티티이다. 엔티티는 생성, 수정시 사용하도록 두고, 부가 정보인 댓글, 추천정보를 담을 모델을 <code>BoardDto</code>로 정의해서 응답을 주자.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@JsonInclude</span>(JsonInclude.Include.NON_NULL)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BoardDto</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String title;</span><br><span class="line">    <span class="keyword">private</span> String content;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Setter</span>(AccessLevel.PRIVATE)</span><br><span class="line">    <span class="meta">@JsonIgnore</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;AttachmentType, Attachment&gt; attachmentMap = <span class="keyword">new</span> EnumMap&lt;&gt;(AttachmentType<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>위에서는 왜 <code>attachmentMap</code>을 썼을까? 만약 <code>attachmentMap</code>이 없었다면 아래와 같이 각각 다른 멤버로 선언이 되었을 것이고, 이는 아래와 같이 소스를 attach할 모델이 추가될 때, 소스를 <code>수정</code>하게 만드는 원인이 된다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BoardDto</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  List&lt;CommentDto&gt; comments;</span><br><span class="line">  Writer writer;</span><br><span class="line">  <span class="comment">// 추후에 추천목록이 생긴다면 List&lt;RecommendationDto&gt; recommendations;가 추가됨</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>Map</code>을 가져다 쓰는게 마음에 들지 않는다거나, 별도의 클래스를 정의해서 쓰고 싶다면, <code>AttachmentWrapper</code> 등의 클래스를 정의해서 <code>Map</code>을 래핑하고 delegate 패턴을 구현한 클래스를 사용할 수도 있다. lombok의 <code>@Delegate</code>는 이런 경우 편리하게 사용할 수 있다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AttachmentWrapper</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">interface</span> <span class="title">AttachmentMap</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">put</span><span class="params">(AttachmentType type, Attachment attachment)</span></span>;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">putAll</span><span class="params">(Map&lt;? extends AttachmentType, ? extends Attachment&gt; attachmentMap)</span></span>;</span><br><span class="line">        <span class="function"><span class="keyword">boolean</span> <span class="title">isEmpty</span><span class="params">()</span></span>;</span><br><span class="line">        Set&lt;Map.Entry&lt;AttachmentType, Attachment&gt;&gt; entrySet();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Delegate</span>(types = AttachmentMap<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">    <span class="title">private</span> <span class="title">Map</span>&lt;<span class="title">AttachmentType</span>, <span class="title">Attachment</span>&gt; <span class="title">value</span> </span>= <span class="keyword">new</span> EnumMap&lt;&gt;(AttachmentType<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>BoardDto</code>에 적용하자.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@JsonInclude</span>(JsonInclude.Include.NON_NULL)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BoardDto</span> <span class="keyword">implements</span> <span class="title">Attachable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String title;</span><br><span class="line">    <span class="keyword">private</span> String content;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Setter</span>(AccessLevel.PRIVATE)</span><br><span class="line">    <span class="meta">@JsonIgnore</span></span><br><span class="line">    <span class="keyword">private</span> AttachmentWrapper attachmentWrapper = <span class="keyword">new</span> AttachmentWrapper();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>Attcahment</strong></p><p>부가 정보 클래스를 나타내기 위한 마크 인터페이스가 있으면 좋겠다.<br><code>Attachment</code>라고 이름을 짓자.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Attachment</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure><p>부가 정보, 예를 들어 댓글 DTO를 정의한다면 다음과 같이 선언하게 된다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CommentDto</span> <span class="keyword">implements</span> <span class="title">Attachment</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String email;</span><br><span class="line">    <span class="keyword">private</span> String body;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>Attachment</code>의 내용물은 <code>Collection</code>의 자료구조가 될 수도 있다. 예를 들어, 댓글 목록을 추가할 수 있어야 한다. 그러기 위한 자료구조도 정의하자.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AttachmentCollection</span>&lt;<span class="title">T</span> <span class="keyword">extends</span> <span class="title">Attachment</span>&gt; <span class="keyword">extends</span> <span class="title">Attachment</span>, <span class="title">Collection</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@JsonUnwrapped</span></span><br><span class="line">    <span class="function">Collection&lt;T&gt; <span class="title">getValue</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Value</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleAttachmentCollection</span>&lt;<span class="title">T</span> <span class="keyword">extends</span> <span class="title">Attachment</span>&gt; <span class="keyword">implements</span> <span class="title">AttachmentCollection</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Delegate</span></span><br><span class="line">    <span class="keyword">private</span> Collection&lt;T&gt; value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Converter-정의"><a href="#Converter-정의" class="headerlink" title="Converter 정의"></a>Converter 정의</h2><p>A 오브젝트를 B 오브젝트로 변환하는 것은 여러 방법이 있다.<br>별다른 모듈에 의존하지 않고, 간단히 spring의 converter를 구현해서 정의했다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BoardDtoConverter</span> <span class="keyword">implements</span> <span class="title">Converter</span>&lt;<span class="title">Board</span>, <span class="title">BoardDto</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> BoardDto <span class="title">convert</span><span class="params">(@NonNull Board board)</span> </span>&#123;</span><br><span class="line">        BoardDto boardDto = <span class="keyword">new</span> BoardDto();</span><br><span class="line">        boardDto.setId(board.getId());</span><br><span class="line">        boardDto.setTitle(board.getTitle());</span><br><span class="line">        boardDto.setContent(board.getContent());</span><br><span class="line">        <span class="keyword">return</span> boardDto;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>Spring의 Converter를 구현한 것은 단순한 개인취향이다.<br><code>board.toDto()</code> 등의 메서드를 작성해서 변환해도 무관하나<br>Board와 BoardDto 사이에 결합도가 생기는 게 싫었다.<br>그 정도의 결합도를 용납할 수 있다면 <code>board.toDto()</code>도 좋은 선택이다.</p></blockquote><h2 id="Controller의-반환값-수정"><a href="#Controller의-반환값-수정" class="headerlink" title="Controller의 반환값 수정"></a>Controller의 반환값 수정</h2><p>앞서 정의한 Converter를 주입받아, <code>Board</code>를 <code>BoardDto</code>로 변환 후 반환한다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/boards"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BoardController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span> <span class="keyword">private</span> BoardRepository boardRepository;</span><br><span class="line">    <span class="meta">@Autowired</span> <span class="keyword">private</span> BoardDtoConverter boardDtoConverter;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Attachable</span></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/&#123;id&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> BoardDto <span class="title">getOne</span><span class="params">(@PathVariable(<span class="string">"id"</span>)</span> Board board) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> boardDtoConverter.convert(board);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="AOP로-반환된-값에-모델-추가하기"><a href="#AOP로-반환된-값에-모델-추가하기" class="headerlink" title="AOP로 반환된 값에 모델 추가하기"></a>AOP로 반환된 값에 모델 추가하기</h1><p><strong>AOP 사용 설정</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableAspectJAutoProxy</span>(proxyTargetClass = <span class="keyword">true</span>)</span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleAttachmentApplication</span> <span class="keyword">implements</span> <span class="title">CommandLineRunner</span> </span>&#123; ... &#125;</span><br></pre></td></tr></table></figure><h2 id="AOP로-Advice-작성하기"><a href="#AOP로-Advice-작성하기" class="headerlink" title="AOP로 Advice 작성하기"></a>AOP로 Advice 작성하기</h2><p><code>@Attach</code>가 있는 메서드를 pointcut으로 잡아 advice가 실행되도록 정의한다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AttachmentAspect</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span> <span class="keyword">private</span> <span class="keyword">final</span> AttachmentTypeHolder attachmentTypeHolder;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Pointcut</span>(<span class="string">"@annotation(com.parfait.study.simpleattachment.attachment.Attach)"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">pointcut</span><span class="params">()</span> </span>&#123; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AfterReturning</span>(pointcut = <span class="string">"pointcut()"</span>, returning = <span class="string">"returnValue"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">afterReturning</span><span class="params">(Object returnValue)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (attachmentTypeHolder.isEmpty() &amp;&amp; !(returnValue <span class="keyword">instanceof</span> Attachable)) &#123;</span><br><span class="line">            <span class="keyword">return</span> returnValue;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        executeAttach((Attachable) returnValue);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> returnValue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">executeAttach</span><span class="params">(Attachable attachable)</span> </span>&#123;</span><br><span class="line">      <span class="comment">// TODO : 로직 작성</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>이제 1/2는 끝났다. 사실상 핵심로직인 저 <code>TODO</code> 안의 내용만 채우면 된다.</p><h2 id="어떻게-모델을-추가할까"><a href="#어떻게-모델을-추가할까" class="headerlink" title="어떻게 모델을 추가할까?"></a>어떻게 모델을 추가할까?</h2><p>우선은 BoardDto를 먼저 손을 봐야할 것 같다.</p><p><code>BoardDto</code>에 <code>CommentDto</code>를 추가하기 위한 동작을 interface로 뽑아내자.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Attachable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function">AttachmentWrapper <span class="title">getAttachmentWrapper</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">default</span> <span class="keyword">void</span> <span class="title">attach</span><span class="params">(AttachmentType type, Attachment attachment)</span> </span>&#123;</span><br><span class="line">        getAttachmentWrapper().put(type, attachment);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">default</span> <span class="keyword">void</span> <span class="title">attach</span><span class="params">(Map&lt;? extends AttachmentType, ? extends Attachment&gt; attachment)</span> </span>&#123;</span><br><span class="line">        getAttachmentWrapper().putAll(attachment);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@JsonAnyGetter</span></span><br><span class="line">    <span class="function"><span class="keyword">default</span> Map&lt;String, Object&gt; <span class="title">getAttachment</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        AttachmentWrapper wrapper = getAttachmentWrapper();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (wrapper.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> wrapper.entrySet()</span><br><span class="line">                      .stream()</span><br><span class="line">                      .collect(Collectors.toMap(e -&gt; e.getKey().lowerCaseName(), Map.Entry::getValue));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@JsonInclude</span>(JsonInclude.Include.NON_NULL)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BoardDto</span> <span class="keyword">implements</span> <span class="title">Attachable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String title;</span><br><span class="line">    <span class="keyword">private</span> String content;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Setter</span>(AccessLevel.PRIVATE)</span><br><span class="line">    <span class="meta">@JsonIgnore</span></span><br><span class="line">    <span class="keyword">private</span> AttachmentWrapper attachmentWrapper = <span class="keyword">new</span> AttachmentWrapper();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>Attachable</code> 인터페이스에 필요한 동작들을 default로 선언했기 때문에, <code>BoardDto</code>에는 별다른 수정을 할 필요가 없다. <code>BoardDto</code>에 댓글을 추가할 때에는 <code>BoardDto.attach(AttachmentType.COMMENTS, new CommentsDto())</code>를 호출하면 된다.</p><h2 id="AttachService-정의"><a href="#AttachService-정의" class="headerlink" title="AttachService 정의"></a>AttachService 정의</h2><p>첨가 로직(attach)을 선언하고 실행할 <code>AttachmentService</code>가 있어야할 것 같다. AttachService가 가져야할 요건을 3가지로 나눌 수 있다.</p><ol><li>어떤 <code>AttachmentType</code>에 대해 동작하는가?</li><li>어떤 class에 대해 작업을 수행할 수 있는가?</li><li>attachment를 가져옴(생성)</li></ol><p>이를 interface로 뽑아내면 아래와 같이 선언할 수 있다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AttachService</span>&lt;<span class="title">T</span> <span class="keyword">extends</span> <span class="title">Attachable</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function">AttachmentType <span class="title">getSupportAttachmentType</span><span class="params">()</span></span>; <span class="comment">// 1. 어떤 AttachmentType에 대해서 동작하는가</span></span><br><span class="line"></span><br><span class="line">    <span class="function">Class&lt;T&gt; <span class="title">getSupportType</span><span class="params">()</span></span>; <span class="comment">// 2. 어떤 Attachable 클래스에 대해 동작하는가</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 형안전성을 지킬 것</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> attachment</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> ClassCastException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">Attachement <span class="title">getAttachment</span><span class="params">(Object attachment)</span></span>; <span class="comment">// 3. attachment를 가져옴</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>2번이 왜있지? 1번만 보고 댓글이 필요하면 추가하면 되는거 아냐?</code> 라고 생각할 수 있을 것 같다. 하지만 댓글은 쪽지의 댓글이 있을 수도 있고, 뉴스의 댓글이 될 수도 있고, 동영상의 댓글이 될 수도 있다. 이러한 댓글들마다 불러오는 방법이 다를 수 있다. 즉 클래스 별로 다른 방식으로 불러와야 하는 것이다. 구현체가 어떤 객체에 대해서 attach를 실행할 수 있을지 조금더 상세히 정의하기 위해 <code>Class&lt;T&gt; getSupportType()</code>를 정의했다.</p><p>아래와 같이 <code>AttachService</code>의 구현체를 정의할 수 있다.</p><p><strong>AttachCommentsToBoardService.java</strong></p><p><code>CommentClient</code>는 <a href="https://cloud.spring.io/spring-cloud-netflix/multi/multi_spring-cloud-feign.html" target="_blank" rel="noopener">FeignClient</a>를 사용했다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AttachCommentsToBoardService</span> <span class="keyword">implements</span> <span class="title">AttachService</span>&lt;<span class="title">BoardDto</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> AttachmentType supportAttachmentType = AttachmentType.COMMENTS;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Class&lt;BoardDto&gt; supportType = BoardDto<span class="class">.<span class="keyword">class</span></span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> CommentClient commentClient; <span class="comment">// feign client 사용</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AttachCommentsToBoardService</span><span class="params">(@NonNull CommentClient commentClient)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.commentClient = commentClient;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AttachmentType <span class="title">getSupportAttachmentType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> supportAttachmentType;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Class&lt;BoardDto&gt; <span class="title">getSupportType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> supportType;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Attachment <span class="title">getAttachment</span><span class="params">(Attachable attachment)</span> </span>&#123;</span><br><span class="line">        BoardDto boardDto = supportType.cast(attachment);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SimpleAttachmentCollection&lt;&gt;(commentClient.getComments(boardDto.getId()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Advice-나머지-부분-작성하기"><a href="#Advice-나머지-부분-작성하기" class="headerlink" title="Advice 나머지 부분 작성하기"></a>Advice 나머지 부분 작성하기</h2><p>앞서 작성했던 <code>AttachmentAspect</code>의 <code>//TODO</code> 부분을 채울 차례다.<br>List를 사용해서 spring에 등록된 모든 <code>AttachService</code>를 주입받아, <code>AttachmentType</code>과 <code>Attachable</code>의 타입으로 필터링해서 attach를 실행한다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AttachmentAspect</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AttachmentTypeHolder attachmentTypeHolder;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;AttachmentType, List&lt;AttachService&lt;? extends Attachable&gt;&gt;&gt; typeToServiceMap;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 생성자에서 모든 AttachService를 주입받아 지원하는 AttachmentType에 맞추어 `typeToServiceMap`에 저장</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AttachmentAspect</span><span class="params">(@NonNull AttachmentTypeHolder attachmentTypeHolder,</span></span></span><br><span class="line"><span class="function"><span class="params">                            @NonNull List&lt;AttachService&lt;? extends Attachable&gt;&gt; attachService)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.attachmentTypeHolder = attachmentTypeHolder;</span><br><span class="line">        <span class="keyword">this</span>.typeToServiceMap = attachService.stream()</span><br><span class="line">                                             .collect(Collectors.groupingBy(AttachService::getSupportAttachmentType, Collectors.toList()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Pointcut</span>(<span class="string">"@annotation(com.parfait.study.simpleattachment.attachment.Attach)"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">pointcut</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AfterReturning</span>(pointcut = <span class="string">"pointcut()"</span>, returning = <span class="string">"returnValue"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">afterReturning</span><span class="params">(Object returnValue)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (attachmentTypeHolder.isEmpty() &amp;&amp; !(returnValue <span class="keyword">instanceof</span> Attachable)) &#123;</span><br><span class="line">            <span class="keyword">return</span> returnValue;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        executeAttach((Attachable) returnValue);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> returnValue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">executeAttach</span><span class="params">(Attachable attachable)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        Set&lt;AttachmentType&gt; types = attachmentTypeHolder.getTypes();</span><br><span class="line">        Class attachableClass = attachable.getClass();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Stream API를 사용해 손쉽게 필터링을 하고 알맞은 `AttachService.attach()`를 실행</span></span><br><span class="line">        Map&lt;AttachmentType, Attachment&gt; attachmentMap =</span><br><span class="line">                types.stream()</span><br><span class="line">                     .flatMap(type -&gt; typeToServiceMap.get(type).stream())</span><br><span class="line">                     .filter(service -&gt; service.getSupportType().isAssignableFrom(attachableClass))</span><br><span class="line">                     .collect(Collectors.toMap(AttachService::getSupportAttachmentType, service -&gt; service.getAttachment(attachable)));</span><br><span class="line"></span><br><span class="line">        attachable.attach(attachmentMap);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="실행해보기"><a href="#실행해보기" class="headerlink" title="실행해보기"></a>실행해보기</h2><p><code>GET /boards/1?attachment=comments</code></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;  </span><br><span class="line">   <span class="attr">"id"</span>:<span class="number">1</span>,</span><br><span class="line">   <span class="attr">"title"</span>:<span class="string">"title1"</span>,</span><br><span class="line">   <span class="attr">"content"</span>:<span class="string">"content1"</span>,</span><br><span class="line">   <span class="attr">"comments"</span>:[  </span><br><span class="line">      &#123;  </span><br><span class="line">         <span class="attr">"id"</span>:<span class="number">1</span>,</span><br><span class="line">         <span class="attr">"email"</span>:<span class="string">"Eliseo@gardner.biz"</span>,</span><br><span class="line">         <span class="attr">"body"</span>:<span class="string">"laudantium enim quasi est quidem magnam voluptate ipsam eos\ntempora quo necessitatibus\ndolor quam autem quasi\nreiciendis et nam sapiente accusantium"</span></span><br><span class="line">      &#125;</span><br><span class="line">   ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>소스 : <a href="https://github.com/supawer0728/simple-attachment/tree/attach-writer" target="_blank" rel="noopener">https://github.com/supawer0728/simple-attachment/tree/attach-writer</a></p><h1 id="Writer를-추가해보자"><a href="#Writer를-추가해보자" class="headerlink" title="Writer를 추가해보자"></a>Writer를 추가해보자</h1><p>여태까지 장황한 소스를 작성했다. 한번 구조를 잡았으니 새로운 <code>attachment</code>를 추가하는 것은 어렵지 않다. 그러기 위해 설계를 하는 것이고, OOP를 하는 거니까.</p><h2 id="AttachmentType-수정-WRITER-추가"><a href="#AttachmentType-수정-WRITER-추가" class="headerlink" title="AttachmentType 수정(WRITER 추가)"></a>AttachmentType <code>수정</code>(WRITER 추가)</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> AttachmentType &#123;</span><br><span class="line">    COMMENTS, WRITER;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="WriterDto-추가"><a href="#WriterDto-추가" class="headerlink" title="WriterDto 추가"></a>WriterDto <code>추가</code></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WriterDto</span> <span class="keyword">implements</span> <span class="title">Attachment</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String email;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="WriterClient-추가"><a href="#WriterClient-추가" class="headerlink" title="WriterClient 추가"></a>WriterClient <code>추가</code></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient</span>(name = <span class="string">"writer-api"</span>, url = <span class="string">"https://jsonplaceholder.typicode.com"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">WriterClient</span> </span>&#123;</span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/users/&#123;id&#125;"</span>)</span><br><span class="line">    <span class="function">WriterDto <span class="title">getWriter</span><span class="params">(@PathVariable(<span class="string">"id"</span>)</span> <span class="keyword">long</span> id)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="AttachWriterToBoardService-추가"><a href="#AttachWriterToBoardService-추가" class="headerlink" title="AttachWriterToBoardService 추가"></a>AttachWriterToBoardService <code>추가</code></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AttachWriterToBoardService</span> <span class="keyword">implements</span> <span class="title">AttachService</span>&lt;<span class="title">BoardDto</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> AttachmentType supportAttachmentType = AttachmentType.WRITER;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Class&lt;BoardDto&gt; supportType = BoardDto<span class="class">.<span class="keyword">class</span></span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> WriterClient writerClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AttachWriterToBoardService</span><span class="params">(@NonNull WriterClient writerClient)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.writerClient = writerClient;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AttachmentType <span class="title">getSupportAttachmentType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> supportAttachmentType;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Class&lt;BoardDto&gt; <span class="title">getSupportType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> supportType;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Attachment <span class="title">getAttachment</span><span class="params">(Attachable attachment)</span> </span>&#123;</span><br><span class="line">        BoardDto boardDto = supportType.cast(attachment);</span><br><span class="line">        <span class="keyword">return</span> writerClient.getWriter(boardDto.getWriterId());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>기존의 소스를 수정하는 곳은 딱 한 군데다. enum에 <code>WRITER</code>를 추가했는데, 이것도 사실상 수정이 아니라 추가라고 볼 수 있지 않을까?<br>Spring이 의존성 주입은 모두 담당하기 때문에 필요한 모델을 추가로 작성할 때는 어떻게 부가 정보를 가져올지, 어떻게 모델을 정의할지만 POJO로 잘 작성하면 된다.</p><h2 id="실행"><a href="#실행" class="headerlink" title="실행"></a>실행</h2><p><code>GET /boards/1?attachment=comments,writer</code></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"id"</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">"title"</span>: <span class="string">"title1"</span>,</span><br><span class="line">  <span class="attr">"content"</span>: <span class="string">"content1"</span>,</span><br><span class="line">  <span class="attr">"comments"</span>:[</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"id"</span>: <span class="number">1</span>,</span><br><span class="line">      <span class="attr">"email"</span>: <span class="string">"Eliseo@gardner.biz"</span>,</span><br><span class="line">      <span class="attr">"body"</span>: <span class="string">"laudantium enim quasi est quidem magnam voluptate ipsam eos\ntempora quo necessitatibus\ndolor quam autem quasi\nreiciendis et nam sapiente accusantium"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"writer"</span>:&#123;</span><br><span class="line">    <span class="attr">"id"</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">"username"</span>: <span class="string">"Bret"</span>,</span><br><span class="line">    <span class="attr">"email"</span>: <span class="string">"Sincere@april.biz"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>소스 : <a href="https://github.com/supawer0728/simple-attachment/tree/attach-writer" target="_blank" rel="noopener">https://github.com/supawer0728/simple-attachment/tree/attach-writer</a></p><h1 id="마무리"><a href="#마무리" class="headerlink" title="마무리"></a>마무리</h1><p>HTTP 요청에서 client가 원하는 모델을 추가하는 로직을 구성해보았다. 다음 글에서는 여기서 성능 튜닝을 위한 몇가지 로직을 추가하려고 한다.  현재 소스에는 엄청난 단점이 적어도 두 개나 존재하는데, 바로 <code>AttachmentAspect</code>에서 외부와 통신하여 <code>Attachment</code>를 가져오는 부분이다.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;AttachmentType, Attachment&gt; attachmentMap =</span><br><span class="line">        types.stream()</span><br><span class="line">             .flatMap(type -&gt; typeToServiceMap.get(type).stream())</span><br><span class="line">             .filter(service -&gt; service.getSupportType().isAssignableFrom(attachable.getClass()))</span><br><span class="line">             .collect(Collectors.toMap(AttachService::getSupportAttachmentType, service -&gt; service.getAttachment(attachable)));</span><br></pre></td></tr></table></figure><p>이 부분이 왜 엄청난 단점인지 살펴보자.</p><ol><li>Network I/O를 순차 실행<ul><li>O(n) 시간이 걸린다 : timeout * attachment 개수</li><li>Asynch로 O(1)만에 끝내도록 튜닝 필요하다</li></ul></li><li>Failover<ul><li><code>attachment</code>는 단순 부가 정보임에도 불구하고 attachmentService에서 exception이 발생하면, 아무 정보도 내려줄 수 없음<br><code>attach</code>는 실패해도 <code>Board</code> 정보와 나머지 성공한 <code>attachment</code>는 보여줘야 한다</li></ul></li></ol><p>아래는 100번 writer가 없어서(404) 오류가 난 예제이다.</p><p><code>GET /boards/100?attachment=comments,writer</code> </p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;  </span><br><span class="line">   <span class="attr">"id"</span>:<span class="number">1</span>,</span><br><span class="line">   <span class="attr">"title"</span>:<span class="string">"title1"</span>,</span><br><span class="line">   <span class="attr">"content"</span>:<span class="string">"content1"</span>,</span><br><span class="line">   <span class="attr">"comments"</span>:[  </span><br><span class="line">      &#123;  </span><br><span class="line">         <span class="attr">"id"</span>:<span class="number">1</span>,</span><br><span class="line">         <span class="attr">"email"</span>:<span class="string">"Eliseo@gardner.biz"</span>,</span><br><span class="line">         <span class="attr">"body"</span>:<span class="string">"laudantium enim quasi est quidem magnam voluptate ipsam eos\ntempora quo necessitatibus\ndolor quam autem quasi\nreiciendis et nam sapiente accusantium"</span></span><br><span class="line">      &#125;</span><br><span class="line">   ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>부가 정보</code>인 댓글을 가져오려고 하는데 실패해서 중요한 게시글도 못 가져오면 좋은 설계라고 할 수 있을까? 다음번에는 위의 두 가지 단점을 중점으로 개선해나가려고 한다.</p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;서론&quot;&gt;&lt;a href=&quot;#서론&quot; class=&quot;headerlink&quot; title=&quot;서론&quot;&gt;&lt;/a&gt;서론&lt;/h1&gt;&lt;p&gt;최근 들어 특정 콘텐츠에 부가 속성을 더하여 보여주는 UI가 증가하고 있다. 부가 속성의 예를 들자면 좋아요, 싫어요, 댓글, 공유 링크, 연관 게시물, 추천 게시물 등을 들 수 있다. 이러한 부가 속성들은 기획적 요구나 성능 이슈로 인하여 클라이언트마다 다른 UI를 보여줘야할 때가 있다. 웹 서버 개발자로써 자주 겪게되는 요구 사항 중 하나다. 이러한 요구 사항을 Java와 Spring Framework를 이용해서 어떻게 하면 OOP스럽게 풀어나갈 수 있을까. 당면 과제 해결과 리팩토링을 거쳐 조금씩 더 나은 애플리케이션을 만들어보고자 한다.&lt;/p&gt;
    
    </summary>
    
      <category term="practice" scheme="https://supawer0728.github.io/categories/practice/"/>
    
    
      <category term="spring" scheme="https://supawer0728.github.io/tags/spring/"/>
    
      <category term="aop" scheme="https://supawer0728.github.io/tags/aop/"/>
    
      <category term="interceptor" scheme="https://supawer0728.github.io/tags/interceptor/"/>
    
  </entry>
  
  <entry>
    <title>Spring Framework 5.0.4.RELEASE Reference Web Servlet (Chapter1)</title>
    <link href="https://supawer0728.github.io/2018/03/11/Spring-Framework-5.0.4.RELEASE-Reference-Web-Servlet(Chapter1)/"/>
    <id>https://supawer0728.github.io/2018/03/11/Spring-Framework-5.0.4.RELEASE-Reference-Web-Servlet(Chapter1)/</id>
    <published>2018-03-10T17:44:10.000Z</published>
    <updated>2020-03-04T08:18:02.745Z</updated>
    
    <content type="html"><![CDATA[<h1 id="글에-앞서서"><a href="#글에-앞서서" class="headerlink" title="글에 앞서서"></a>글에 앞서서</h1><ul><li>본문은 Spring Framework Version 5의 습득을 위한 글이다.</li><li>이 글을 상업적 목적으로 쓰지 않았다<blockquote><p>Authors<br>Rod Johnson , Juergen Hoeller , Keith Donald , Colin Sampaleanu , Rob Harrop , Thomas Risberg , Alef Arendsen , Darren Davison , Dmitriy Kopylenko , Mark Pollack , Thierry Templier , Erwin Vervaet , Portia Tung , Ben Hale , Adrian Colyer , John Lewis , Costin Leau , Mark Fisher , Sam Brannen , Ramnivas Laddad , Arjen Poutsma , Chris Beams , Tareq Abedrabbo , Andy Clement , Dave Syer , Oliver Gierke , Rossen Stoyanchev , Phillip Webb , Rob Winch , Brian Clozel , Stephane Nicoll , Sebastien Deleuze</p><p>Copyright © 2004-2016</p><p>Copies of this document may be made for your own use and for distribution to others, provided that you do not charge any fee for such copies and further provided that each copy contains this Copyright Notice, whether distributed in print or electronically.</p><footer><strong>원본</strong><cite><a href="https://docs.spring.io/spring/docs/5.0.4.RELEASE/spring-framework-reference/" target="_blank" rel="noopener">docs.spring.io/spring/docs/5.0.4.RELEASE/spring-framework-reference</a></cite></footer></blockquote></li></ul><h1 id="1-Spring-Web-MVC"><a href="#1-Spring-Web-MVC" class="headerlink" title="1. Spring Web MVC"></a>1. Spring Web MVC</h1><h1 id="1-2-DispatcherServlet"><a href="#1-2-DispatcherServlet" class="headerlink" title="1.2. DispatcherServlet"></a>1.2. DispatcherServlet</h1><h2 id="1-2-DispatcherServlet-1"><a href="#1-2-DispatcherServlet-1" class="headerlink" title="1.2. DispatcherServlet"></a>1.2. DispatcherServlet</h2><p><img src="https://nesoy.github.io/assets/posts/20170217/2.PNG" alt="a"></p><a id="more"></a><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">web-app</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">listener</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">listener-class</span>&gt;</span>org.springframework.web.context.ContextLoaderListener<span class="tag">&lt;/<span class="name">listener-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">listener</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">context-param</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>contextConfigLocation<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>/WEB-INF/app-context.xml<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">context-param</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>app<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>org.springframework.web.servlet.DispatcherServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>contextConfigLocation<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">param-value</span>&gt;</span><span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">load-on-startup</span>&gt;</span>1<span class="tag">&lt;/<span class="name">load-on-startup</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>app<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/app/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://docs.spring.io/spring/docs/5.0.4.RELEASE/spring-framework-reference/images/mvc-context-hierarchy.png" alt="b"></p><p><strong>serlvet-context.xml</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">"org.example"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">cnotext:include-filter</span> <span class="attr">type</span>=<span class="string">"annotation"</span> <span class="attr">expression</span>=<span class="string">"org.springframework.stereotype.Controller"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">context:component-scan</span>&gt;</span></span><br></pre></td></tr></table></figure><p><strong>application-context.xml</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">"org.example"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">cnotext:exclude-filter</span> <span class="attr">type</span>=<span class="string">"annotation"</span> <span class="attr">expression</span>=<span class="string">"org.springframework.stereotype.Controller"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">context:component-scan</span>&gt;</span></span><br></pre></td></tr></table></figure><h1 id="1-3-Filters"><a href="#1-3-Filters" class="headerlink" title="1.3. Filters"></a>1.3. Filters</h1><h2 id="1-3-Filters-1"><a href="#1-3-Filters-1" class="headerlink" title="1.3. Filters"></a>1.3. Filters</h2><p><code>spring-web</code> 모듈은 몇가지 유용한 필터를 제공한다</p><ul><li><code>HttpPutFormContentFilter</code> : browser는 form의 요청을 <code>GET</code>, <code>POST</code>만 사용할 수 있으나, 해당 필터를 사용해서 <code>PUT</code>, <code>PATCH</code>요청도 해석할 수 있음</li><li><code>ShallowETagHeaderFilter</code> : 응답값을 버퍼링하고 ETag값을 계산</li></ul><h1 id="1-4-Annotated-Controllers"><a href="#1-4-Annotated-Controllers" class="headerlink" title="1.4. Annotated Controllers"></a>1.4. Annotated Controllers</h1><h2 id="1-4-2-RequestMapping"><a href="#1-4-2-RequestMapping" class="headerlink" title="1.4.2. RequestMapping"></a>1.4.2. RequestMapping</h2><p><strong>RequestMapping의 shortcut</strong></p><ul><li><code>@GetMapping</code></li><li><code>@PostMapping</code></li><li><code>@PutMapping</code></li><li><code>@DeleteMapping</code></li><li><code>@PatchMapping</code></li></ul><h3 id="URI-patterns"><a href="#URI-patterns" class="headerlink" title="URI patterns"></a>URI patterns</h3><p><strong>wildcards</strong></p><p><code>?</code>, <code>*</code>, <code>**</code> 등의 와일드 카드 사용 가능</p><p><strong>regx</strong></p><p><code>/spring-web-3.0.5.jar</code> 요청에 대한 매핑</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping</span>(<span class="string">"/&#123;name:[a-z-]+&#125;-&#123;version:\\d\\.\\d\\.\\d&#125;&#123;ext:\\.[a-z]+&#125;"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handle</span><span class="params">(@PathVariables String name, @PathVariable String version, @PathVariable String ext)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="1-4-2-RequestMapping-1"><a href="#1-4-2-RequestMapping-1" class="headerlink" title="1.4.2. RequestMapping"></a>1.4.2. RequestMapping</h2><h3 id="Pattern-comparison"><a href="#Pattern-comparison" class="headerlink" title="Pattern comparison"></a>Pattern comparison</h3><p>요청이 여러 URL 패턴에 매칭되었을 때, <code>AntPathMatcher.getPatternComparator(String path)</code>에 의해 더 정확한 패턴에 매칭됨</p><h3 id="Consumable-media-types"><a href="#Consumable-media-types" class="headerlink" title="Consumable media types"></a>Consumable media types</h3><p><strong>Request Header의 <code>Content-Type</code>에 매칭</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping</span>(path = <span class="string">"/pets"</span>, consumes = <span class="string">"application/json"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addPet</span><span class="params">(@RequestBody Pet pet)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Producible-media-types"><a href="#Producible-media-types" class="headerlink" title="Producible media types"></a>Producible media types</h3><p><strong>RequestHeader의 <code>Accept</code>에 매칭</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping</span>(path = <span class="string">"/pets/&#123;petId&#125;"</span>, produces = <span class="string">"application/json;charset=UTF-8"</span>)</span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Pet <span class="title">getPet</span><span class="params">(@PathVariable String petId)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Parameters-headers"><a href="#Parameters-headers" class="headerlink" title="Parameters, headers"></a>Parameters, headers</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping</span>(path = <span class="string">"/pets/&#123;petId&#125;"</span>, params = <span class="string">"myParam=myValue"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">findPet</span><span class="params">(@PathVariable String petId)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@GetMapping</span>(path = <span class="string">"/pets"</span>, headers = <span class="string">"myHeader=myValue"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">findPet</span><span class="params">(@PathVariable String petId)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="1-4-3-Handler-Methods"><a href="#1-4-3-Handler-Methods" class="headerlink" title="1.4.3. Handler Methods"></a>1.4.3. Handler Methods</h2><h3 id="Method-Arguments"><a href="#Method-Arguments" class="headerlink" title="Method Arguments"></a>Method Arguments</h3><table><thead><tr><th>Controller method arguments</th><th>Description</th></tr></thead><tbody><tr><td><code>javax.servlet.http.HttpSession</code></td><td>현재 세션 정보(Thread-safe하지 않음)</td></tr><tr><td><code>java.security.Principal</code></td><td>인증된 유저 정보</td></tr><tr><td><code>java.util.Locale</code></td><td>요청의 Locale 정보, <code>LocaleResolver</code>로 인해 계산</td></tr><tr><td>java6+: <code>java.util.TimeZone</code><br>java8+: <code>java.time.ZoneId</code></td><td><code>LocaleContextResolver</code>에 의해 계산</td></tr><tr><td><code>@PathVariable</code></td><td></td></tr><tr><td><code>@MatrixVariable</code></td><td></td></tr><tr><td><code>@RequestParam</code></td><td></td></tr><tr><td><code>@RequestHeader</code></td><td></td></tr><tr><td><code>@CookieValue</code></td><td></td></tr><tr><td><code>@RequestBody</code></td><td></td></tr><tr><td><code>HttpEntity&lt;B&gt;</code></td><td></td></tr><tr><td><code>@RequestPart</code></td><td></td></tr><tr><td><code>RedirectAttributes</code></td><td></td></tr><tr><td><code>@ModelAttribute</code></td><td></td></tr><tr><td><code>Errors</code>, <code>BindingResult</code></td><td></td></tr><tr><td><code>@RequestAttribute</code></td><td></td></tr></tbody></table><h2 id="1-4-3-Handler-Methods-1"><a href="#1-4-3-Handler-Methods-1" class="headerlink" title="1.4.3. Handler Methods"></a>1.4.3. Handler Methods</h2><h3 id="Return-Values"><a href="#Return-Values" class="headerlink" title="Return Values"></a>Return Values</h3><table><thead><tr><th>Controller method return value</th><th>Description</th></tr></thead><tbody><tr><td><code>@ResponseBody</code></td><td><code>HttpMessageConverter</code>에 의해 변환되어 응답에 쓰임</td></tr><tr><td><code>HttpEntity&lt;B&gt;</code>, <code>ResponseEntity&lt;B&gt;</code></td><td>header와 body를 가지며, body는 <code>HttpMessageConverter</code>에 의해 변환됨</td></tr><tr><td><code>HttpHeaders</code></td><td>body가 없이 header만 응답</td></tr><tr><td><code>String</code></td><td>viewName</td></tr><tr><td><code>View</code></td><td></td></tr><tr><td><code>void</code></td><td><code>ServletResponse</code>, <code>OuputStream</code>을 파라미터로 받았거나, <code>@ResponseStatus</code>가 메서드에 등록된 경우에<br>모든 처리가 완료된 것으로 간주</td></tr><tr><td><code>DeferredResult&lt;V&gt;</code></td><td>위 반환값으로 다른 스레드(any thread)에서 비동기로 반환</td></tr><tr><td><code>Callable&lt;V&gt;</code></td><td>위 반환값으로 Spring MVC가 관리하는 스레드에서 비동기로 반환</td></tr><tr><td>Reactive types<br>Reactor, RxJava, etc.</td><td></td></tr><tr><td>그 외</td><td>String의 경우 viewName으로 간주, 그 외에는 <code>@ModelAttribute</code>로 간주</td></tr></tbody></table><h2 id="1-4-3-Handler-Methods-2"><a href="#1-4-3-Handler-Methods-2" class="headerlink" title="1.4.3. Handler Methods"></a>1.4.3. Handler Methods</h2><h3 id="Jackson-JSON"><a href="#Jackson-JSON" class="headerlink" title="Jackson JSON"></a>Jackson JSON</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/user"</span>)</span><br><span class="line">    <span class="meta">@JsonView</span>(User.WithoutPasswordView<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">    <span class="title">public</span> <span class="title">User</span> <span class="title">getUser</span>() </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> User(<span class="string">"eric"</span>, <span class="string">"7!jd#h23"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">WithoutPasswordView</span> </span>&#123;&#125;;</span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">WithPasswordView</span> <span class="keyword">extends</span> <span class="title">WithoutPasswordView</span> </span>&#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">User</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">User</span><span class="params">(String username, String password)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.username = username;</span><br><span class="line">        <span class="keyword">this</span>.password = password;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@JsonView</span>(WithoutPasswordView<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">    <span class="title">public</span> <span class="title">String</span> <span class="title">getUsername</span>() </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.username;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@JsonView</span>(WithPasswordView<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">    <span class="title">public</span> <span class="title">String</span> <span class="title">getPassword</span>() </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.password;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="1-4-5-Binder-Methods"><a href="#1-4-5-Binder-Methods" class="headerlink" title="1.4.5. Binder Methods"></a>1.4.5. Binder Methods</h2><p><strong>custom editor</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FormController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@InitBinder</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initBinder</span><span class="params">(WebDataBinder binder)</span> </span>&#123;</span><br><span class="line">        SimpleDateFormat dateFormat = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd"</span>);</span><br><span class="line">        dateFormat.setLenient(<span class="keyword">false</span>);</span><br><span class="line">        binder.registerCustomEditor(Date<span class="class">.<span class="keyword">class</span>, <span class="title">new</span> <span class="title">CustomDateEditor</span>(<span class="title">dateFormat</span>, <span class="title">false</span>))</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>formatter</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FormController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@InitBinder</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initBinder</span><span class="params">(WebDataBinder binder)</span> </span>&#123;</span><br><span class="line">        binder.addCustomFormatter(<span class="keyword">new</span> DateFormatter(<span class="string">"yyyy-MM-dd"</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="1-4-6-Exception-Methods"><a href="#1-4-6-Exception-Methods" class="headerlink" title="1.4.6. Exception Methods"></a>1.4.6. Exception Methods</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExceptionHandler</span>(IOException<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">    <span class="title">public</span> <span class="title">ResponseEntity</span>&lt;<span class="title">String</span>&gt; <span class="title">handle</span>(<span class="title">IOException</span> <span class="title">ex</span>) </span>&#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><code>@ControllerAdvice</code>에서도 사용 가능</p></blockquote><h2 id="1-4-7-Controller-Advice"><a href="#1-4-7-Controller-Advice" class="headerlink" title="1.4.7. Controller Advice"></a>1.4.7. Controller Advice</h2><p><code>@ExceptionHandler</code>, <code>@InitBinder</code>, <code>@ModelAttribute</code> 등의 처리는 <code>@ControllerAdvice</code>에서 할 수 있음</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Target all Controllers annotated with @RestController</span></span><br><span class="line"><span class="meta">@ControllerAdvice</span>(annotations = RestController<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">ExampleAdvice1</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Target all Controllers within specific packages</span></span><br><span class="line"><span class="meta">@ControllerAdvice</span>(<span class="string">"org.example.controllers"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExampleAdvice2</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Target all Controllers assignable to specific classes</span></span><br><span class="line"><span class="meta">@ControllerAdvice</span>(assignableTypes = &#123;ControllerInterface<span class="class">.<span class="keyword">class</span>, <span class="title">AbstractController</span>.<span class="title">class</span>&#125;)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">ExampleAdvice3</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure><h1 id="1-5-URI-Links"><a href="#1-5-URI-Links" class="headerlink" title="1.5. URI Links"></a>1.5. URI Links</h1><h2 id="1-5-1-UriComponents"><a href="#1-5-1-UriComponents" class="headerlink" title="1.5.1. UriComponents"></a>1.5.1. UriComponents</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">String uriTemplate = <span class="string">"http://example.com/hotels/&#123;hotel&#125;"</span>;</span><br><span class="line"></span><br><span class="line">UriComponents uriComponents = UriComponentsBuilder.fromUriString(uriTemplate)  </span><br><span class="line">        .queryParam(<span class="string">"q"</span>, <span class="string">"&#123;q&#125;"</span>)  </span><br><span class="line">        .build(); </span><br><span class="line"></span><br><span class="line">URI uri = uriComponents.expand(<span class="string">"Westin"</span>, <span class="string">"123"</span>).encode().toUri();  <span class="comment">// http://example.com/hotels/Westin?q=123</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">URI uri = UriComponentsBuilder.fromUriString(uriTemplate)</span><br><span class="line">        .queryParam(<span class="string">"q"</span>, <span class="string">"&#123;q&#125;"</span>)</span><br><span class="line">        .buildAndExpand(<span class="string">"Westin"</span>, <span class="string">"123"</span>)</span><br><span class="line">        .encode()</span><br><span class="line">        .toUri();</span><br></pre></td></tr></table></figure><h1 id="1-6-Async-Requests"><a href="#1-6-Async-Requests" class="headerlink" title="1.6. Async Requests"></a>1.6. Async Requests</h1><h2 id="1-6-Async-Requests-1"><a href="#1-6-Async-Requests-1" class="headerlink" title="1.6. Async Requests"></a>1.6. Async Requests</h2><p>Spring MVC는 Servlet 3.0을 확장하여 아래와 같은 기능을 제공한다</p><ul><li>하나의 비동기 결과값을 담는 <code>DeferredResult</code>, <code>Callable</code>을 반환할 수 있음</li><li><code>SSE</code>, <code>raw data</code>를 stream할 수 있음</li><li>reactive 동작</li></ul><h2 id="1-6-1-DeferredResult"><a href="#1-6-1-DeferredResult" class="headerlink" title="1.6.1. DeferredResult"></a>1.6.1. DeferredResult</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping</span>(<span class="string">"/quotes"</span>)</span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> DeferredResult&lt;String&gt; <span class="title">quotes</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    DeferredResult&lt;String&gt; deferredResult = <span class="keyword">new</span> DeferredResult&lt;String&gt;();</span><br><span class="line">    <span class="comment">// Save the deferredResult somewhere..</span></span><br><span class="line">    <span class="keyword">return</span> deferredResult;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// From some other thread...</span></span><br><span class="line">deferredResult.setResult(data);</span><br></pre></td></tr></table></figure><blockquote><p>외부 이벤트, scheduled task 등의 다른 스레드에서 처리된 비동기 결과를 반환</p></blockquote><h2 id="1-6-2-Callable"><a href="#1-6-2-Callable" class="headerlink" title="1.6.2. Callable"></a>1.6.2. Callable</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Callable&lt;String&gt; <span class="title">processUpload</span><span class="params">(<span class="keyword">final</span> MultipartFile file)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Callable&lt;String&gt;() &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">            <span class="keyword">return</span> <span class="string">"someView"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>미리 설정해둔 <code>TaskExecutor</code>에서 반환</p></blockquote><h2 id="1-6-3-Processing"><a href="#1-6-3-Processing" class="headerlink" title="1.6.3. Processing"></a>1.6.3. Processing</h2><p><strong>비동기 처리 개요</strong></p><ul><li><code>ServletRequest</code>의 <code>startAsync()</code>를 호출하여 비동기 모드로 사용할 수 있다<br>이로 인해, Servlet과 Filter를 종료시키지만 response는 남아 따로 처리하고 완료시킬 수 있게 된다</li><li><code>request.startAsync()</code>를 호출하면 추가적인 제어를 할 수 있는 <code>AsyncContext</code>가 반환된다(<code>dispatch(String)</code>, <code>setTimeout(long)</code>)</li><li><code>ServletRequest</code>는 현재 상태(초기화, dispatch, forward) 등을 파악할 수 있는 <code>DispatcherType</code>에 대한 접근을 제공한다</li></ul><h2 id="1-6-3-Processing-1"><a href="#1-6-3-Processing-1" class="headerlink" title="1.6.3. Processing"></a>1.6.3. Processing</h2><p><strong>DefferedResult</strong></p><ul><li>Controller는 <code>DeferredResult</code>를 반환하고, 이를 in-memory queue에 저장한다</li><li>Spring MVC가 <code>request.startAsync()</code>를 호출한다</li><li>그동안 <code>DispatcherServlet</code>과 <code>Filter</code>는 요청을 처리하는 스레드를 종료시킨다. response만 남겨둔다</li><li>어느 스레드에서 <code>DeferredResult</code>에 값을 넣으면, Spring MVC는 ServletContainer에 요청을 되돌린다(dispatch)</li><li><code>DispatcherServlet</code>이 다시 실행되며, 비동기 반환 값에 대한 처리가 시작된다</li></ul><h2 id="1-6-3-Processing-2"><a href="#1-6-3-Processing-2" class="headerlink" title="1.6.3. Processing"></a>1.6.3. Processing</h2><p><strong>Callable</strong></p><ul><li>Controller가 <code>Callable</code>을 반환한다</li><li>Spring MVC는 <code>request.startAsync()</code>를 호출하고, <code>Callable</code>가 <code>TaskExecutor</code>에 의해 다른 스레드에서 실행되도록 한다</li><li>그동안 <code>DispatcherServlet</code>과 <code>Filter</code>는 요청을 처리하는 스레드를 종료시킨다. response만 남겨둔다</li><li><code>Callable</code>에 완료되어 값이 반환되면, Spring MVC는 Servlet Container에 값을 되돌린다(dispatch)</li><li><code>DispatcherServlet</code>이 다시 실행되며, 비동기 반환 값에 대한 처리가 시작된다</li></ul><h2 id="1-6-3-Processing-3"><a href="#1-6-3-Processing-3" class="headerlink" title="1.6.3. Processing"></a>1.6.3. Processing</h2><h3 id="Exception-handling"><a href="#Exception-handling" class="headerlink" title="Exception handling"></a>Exception handling</h3><p><strong>DeferredResult</strong></p><p><code>DeferredResult</code>를 사용하면 <code>setResult</code>나 <code>setErrorResult</code>를 사용한다.<br>두 경우 모두 Spring MVC에서 Servlet Container로 완료 처리를 dispatch하며, 기존의 예외 처리 방식을 따르게 된다(<code>@ExceptionHandler</code> 등)</p><p><strong>Callable</strong></p><p>대부분 비슷하다. 다만 <code>Callable</code>에는 <code>setErrorResult</code> 등의 메서드가 없으므로, 스스로 exception을 throw한다.</p><h3 id="Interception"><a href="#Interception" class="headerlink" title="Interception"></a>Interception</h3><p><code>AsyncHandlerInterceptor</code>, <code>CallableProcessingInterceptor</code>, <code>DeferredResultProcessingInterceptor</code> 등이 존재</p><h2 id="1-6-3-Processing-4"><a href="#1-6-3-Processing-4" class="headerlink" title="1.6.3. Processing"></a>1.6.3. Processing</h2><h3 id="Compare-to-WebFlux"><a href="#Compare-to-WebFlux" class="headerlink" title="Compare to WebFlux"></a>Compare to WebFlux</h3><p>Servlet 3.0에서 비동기를 하는 방법은 <code>Filter-Serlvet chain</code>은 종료시킨채, reponse만 남겨두어 다른 스레드에서 응답을 채우는 방식<br>개별 요청에 대한 응답의 쓰기 작업은 여전히 <code>blocking I/O</code>으로 이루어지며,<br>WebFlux는 이를 <code>non-blocking I/O</code>으로 처리하는 것이 큰 차이점</p><p>또 하나는, WebFlux는 Controller의 메서드에 비동기 혹은 반응형 타입을 지원함</p><h2 id="1-6-4-HTTP-Streaming"><a href="#1-6-4-HTTP-Streaming" class="headerlink" title="1.6.4. HTTP Streaming"></a>1.6.4. HTTP Streaming</h2><p><code>DeferredResult</code>나 <code>Callable</code>은 비동기 처리 후, 한 번만 반환.<br><code>Streaming</code>은 여러번 반환</p><h3 id="Objects"><a href="#Objects" class="headerlink" title="Objects"></a>Objects</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping</span>(<span class="string">"/events"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> ResponseBodyEmitter <span class="title">handle</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ResponseBodyEmitter emitter = <span class="keyword">new</span> ResponseBodyEmitter();</span><br><span class="line">    <span class="comment">// Save the emitter somewhere..</span></span><br><span class="line">    <span class="keyword">return</span> emitter;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// In some other thread</span></span><br><span class="line">emitter.send(<span class="string">"Hello once"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// and again later on</span></span><br><span class="line">emitter.send(<span class="string">"Hello again"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// and done at some point</span></span><br><span class="line">emitter.complete();</span><br></pre></td></tr></table></figure><h2 id="1-6-4-HTTP-Streaming-1"><a href="#1-6-4-HTTP-Streaming-1" class="headerlink" title="1.6.4. HTTP Streaming"></a>1.6.4. HTTP Streaming</h2><h3 id="SSE-Server-Sent-Events"><a href="#SSE-Server-Sent-Events" class="headerlink" title="SSE(Server Sent Events)"></a>SSE(Server Sent Events)</h3><p><code>SseEmitter</code>는 <code>ResponseBodyEmitter</code>의 서브 클래스로서 <code>W3C SSE</code> 스펙을 준수하여 Controller에서 Stream을 생성하도록 함<br><a href="https://www.w3schools.com/html/html5_serversentevents.asp" target="_blank" rel="noopener">https://www.w3schools.com/html/html5_serversentevents.asp</a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping</span>(path=<span class="string">"/events"</span>, produces=MediaType.TEXT_EVENT_STREAM_VALUE)</span><br><span class="line"><span class="function"><span class="keyword">public</span> SseEmitter <span class="title">handle</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    SseEmitter emitter = <span class="keyword">new</span> SseEmitter();</span><br><span class="line">    <span class="comment">// Save the emitter somewhere..</span></span><br><span class="line">    <span class="keyword">return</span> emitter;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// In some other thread</span></span><br><span class="line">emitter.send(<span class="string">"Hello once"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// and again later on</span></span><br><span class="line">emitter.send(<span class="string">"Hello again"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// and done at some point</span></span><br><span class="line">emitter.complete();</span><br></pre></td></tr></table></figure><p>하지만 SSE는 IE에서 돌아가지 않으므로(망할), WebSocket과 SockJS 등을 사용할 것을 권장</p><h2 id="1-6-4-HTTP-Streaming-2"><a href="#1-6-4-HTTP-Streaming-2" class="headerlink" title="1.6.4. HTTP Streaming"></a>1.6.4. HTTP Streaming</h2><h3 id="Raw-data"><a href="#Raw-data" class="headerlink" title="Raw data"></a>Raw data</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping</span>(<span class="string">"/download"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> StreamingResponseBody <span class="title">handle</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> StreamingResponseBody() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">writeTo</span><span class="params">(OutputStream outputStream)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">            <span class="comment">// write...</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="1-6-5-Reactive-Types"><a href="#1-6-5-Reactive-Types" class="headerlink" title="1.6.5. Reactive Types"></a>1.6.5. Reactive Types</h2><ul><li>단일 값(<code>Mono</code>, <code>Single</code>)에 대해서는 <code>DeferredResult</code>와 유사한 동작</li><li>여러 값(<code>Flux</code>, <code>Observable</code>) 등, <code>application/stream+json</code>이나 <code>text/event-stream</code> 유형의 값은 <code>ResponseBodyEmitter</code>, <code>SseEmitter</code>와 유사한 동작</li></ul><h2 id="1-6-6-Configuration"><a href="#1-6-6-Configuration" class="headerlink" title="1.6.6. Configuration"></a>1.6.6. Configuration</h2><h3 id="Servlet-Container"><a href="#Servlet-Container" class="headerlink" title="Servlet Container"></a>Servlet Container</h3><p><code>Filter</code>와 <code>ServletContainer</code>는 <code>asyncSupported</code>값이 있으며 이를 <code>true</code>로 해야한다</p><p><strong>Java</strong></p><p><code>AbstractAnnotationConfigDispatcherServletInitializer</code>로 Servlet Container를 사용한다면 자동으로 설정되어 있다</p><p><strong>web.xml</strong></p><p><code>&lt;async-supported&gt;true&lt;/async-supported&gt;</code>를 <code>DispatcherServlet</code> 설정과 <code>Filter</code> 설정에 추가한다<br><code>Filter Mapping</code>에 <code>&lt;dispatcher&gt;ASYNC&lt;/dispatcher&gt;</code>를 추가한다</p><h3 id="Spring-MVC"><a href="#Spring-MVC" class="headerlink" title="Spring MVC"></a>Spring MVC</h3><p><strong>Java</strong></p><p><code>WebMvcConfigurer</code>의 <code>configureAsyncSupport</code>를 사용</p><p><strong>xml</strong></p><p><code>&lt;mvc:annotation-driven&gt;</code> 아래에 <code>&lt;async-support&gt;</code> 선언</p><h1 id="1-7-CORS"><a href="#1-7-CORS" class="headerlink" title="1.7. CORS"></a>1.7. CORS</h1><h1 id="1-7-3-CrossOrigin"><a href="#1-7-3-CrossOrigin" class="headerlink" title="1.7.3. @CrossOrigin"></a>1.7.3. <code>@CrossOrigin</code></h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/account"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AccountController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@CrossOrigin</span></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/&#123;id&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Account <span class="title">retrieve</span><span class="params">(@PathVariable Long id)</span> </span>&#123;</span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>default</strong></p><ul><li>모든 origin 허용</li><li>모든 헤더 허용</li><li>모든 HTTP method 허용</li><li><code>maxAge</code>는 30분</li><li><code>allowedCredentials</code>는 기본적으로 비활성화됨.</li></ul><h2 id="1-7-3-CrossOrigin-1"><a href="#1-7-3-CrossOrigin-1" class="headerlink" title="1.7.3. @CrossOrigin"></a>1.7.3. <code>@CrossOrigin</code></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@CrossOrigin</span>(origins = <span class="string">"http://domain2.com"</span>, maxAge = <span class="number">3600</span>)</span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/account"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AccountController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/&#123;id&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Account <span class="title">retrieve</span><span class="params">(@PathVariable Long id)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@DeleteMapping</span>(<span class="string">"/&#123;id&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">(@PathVariable Long id)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="1-7-4-Global-Config"><a href="#1-7-4-Global-Config" class="headerlink" title="1.7.4. Global Config"></a>1.7.4. Global Config</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebMvc</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebConfig</span> <span class="keyword">implements</span> <span class="title">WebMvcConfigurer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addCorsMappings</span><span class="params">(CorsRegistry registry)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        registry.addMapping(<span class="string">"/api/**"</span>)</span><br><span class="line">            .allowedOrigins(<span class="string">"http://domain2.com"</span>)</span><br><span class="line">            .allowedMethods(<span class="string">"PUT"</span>, <span class="string">"DELETE"</span>)</span><br><span class="line">            .allowedHeaders(<span class="string">"header1"</span>, <span class="string">"header2"</span>, <span class="string">"header3"</span>)</span><br><span class="line">            .exposedHeaders(<span class="string">"header1"</span>, <span class="string">"header2"</span>)</span><br><span class="line">            .allowCredentials(<span class="keyword">true</span>).maxAge(<span class="number">3600</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="1-7-5-CORS-Filter"><a href="#1-7-5-CORS-Filter" class="headerlink" title="1.7.5. CORS Filter"></a>1.7.5. CORS Filter</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">CorsConfiguration config = <span class="keyword">new</span> CorsConfiguration();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Possibly...</span></span><br><span class="line"><span class="comment">// config.applyPermitDefaultValues()</span></span><br><span class="line"></span><br><span class="line">config.setAllowCredentials(<span class="keyword">true</span>);</span><br><span class="line">config.addAllowedOrigin(<span class="string">"http://domain1.com"</span>);</span><br><span class="line">config.addAllowedHeader(<span class="string">""</span>);</span><br><span class="line">config.addAllowedMethod(<span class="string">""</span>);</span><br><span class="line"></span><br><span class="line">UrlBasedCorsConfigurationSource source = <span class="keyword">new</span> UrlBasedCorsConfigurationSource();</span><br><span class="line">source.registerCorsConfiguration(<span class="string">"/**"</span>, config);</span><br><span class="line"></span><br><span class="line">CorsFilter filter = <span class="keyword">new</span> CorsFilter(source);</span><br></pre></td></tr></table></figure><h2 id="1-9-HTTP-Caching"><a href="#1-9-HTTP-Caching" class="headerlink" title="1.9. HTTP Caching"></a>1.9. HTTP Caching</h2><h2 id="1-9-1-Cache-Control"><a href="#1-9-1-Cache-Control" class="headerlink" title="1.9.1. Cache-Control"></a>1.9.1. Cache-Control</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Cache for an hour - "Cache-Control: max-age=3600"</span></span><br><span class="line">CacheControl ccCacheOneHour = CacheControl.maxAge(<span class="number">1</span>, TimeUnit.HOURS);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Prevent caching - "Cache-Control: no-store"</span></span><br><span class="line">CacheControl ccNoStore = CacheControl.noStore();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Cache for ten days in public and private caches,</span></span><br><span class="line"><span class="comment">// public caches should not transform the response</span></span><br><span class="line"><span class="comment">// "Cache-Control: max-age=864000, public, no-transform"</span></span><br><span class="line">CacheControl ccCustom = CacheControl.maxAge(<span class="number">10</span>, TimeUnit.DAYS)</span><br><span class="line">                                    .noTransform().cachePublic();</span><br></pre></td></tr></table></figure><h2 id="1-9-2-Static-resources"><a href="#1-9-2-Static-resources" class="headerlink" title="1.9.2. Static resources"></a>1.9.2. Static resources</h2><p><code>ResourceHttpRequestHandler</code>를 설정해서 <code>Last-Modified</code> 헤더와 <code>Cache-Control</code> 헤더를 적절히 변경할 수 있다</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebMvc</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebConfig</span> <span class="keyword">implements</span> <span class="title">WebMvcConfigurer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addResourceHandlers</span><span class="params">(ResourceHandlerRegistry registry)</span> </span>&#123;</span><br><span class="line">        registry.addResourceHandler(<span class="string">"/resources/**"</span>)</span><br><span class="line">                .addResourceLocations(<span class="string">"/public-resources/"</span>)</span><br><span class="line">                .setCacheControl(CacheControl.maxAge(<span class="number">1</span>, TimeUnit.HOURS).cachePublic());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="1-9-3-Controller-caching"><a href="#1-9-3-Controller-caching" class="headerlink" title="1.9.3. @Controller caching"></a>1.9.3. <code>@Controller caching</code></h2><p><code>Controller</code>는 <code>Cache-Control</code>, <code>ETag</code>, <code>If-Modified-Since</code> 등의 다양한 헤더를 다룰 수 있다</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping</span>(<span class="string">"/book/&#123;id&#125;"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> ResponseEntity&lt;Book&gt; <span class="title">showBook</span><span class="params">(@PathVariable Long id)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    Book book = findBook(id);</span><br><span class="line">    String version = book.getVersion();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ResponseEntity</span><br><span class="line">                .ok()</span><br><span class="line">                .cacheControl(CacheControl.maxAge(<span class="number">30</span>, TimeUnit.DAYS))</span><br><span class="line">                .eTag(version) <span class="comment">// lastModified is also available</span></span><br><span class="line">                .body(book);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>위 코드에서 응답에 <code>ETag</code> 및 <code>Cache-Control</code> 헤더가 포함되며<br>클라이언트가 보낸 조건부 헤더가 컨트롤러에서 설정한 캐시 정보와 일치하면 <code>HTTP 304 Not Modified</code> 응답의 빈 body를 내려보낸다</p><h2 id="1-9-3-Controller-caching-1"><a href="#1-9-3-Controller-caching-1" class="headerlink" title="1.9.3. @Controller caching"></a>1.9.3. <code>@Controller caching</code></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">myHandleMethod</span><span class="params">(WebRequest webRequest, Model model)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">long</span> lastModified = <span class="comment">// 1. application-specific calculation</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (request.checkNotModified(lastModified)) &#123;</span><br><span class="line">        <span class="comment">// 2. shortcut exit - no further processing necessary</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. or otherwise further request processing, actually preparing content</span></span><br><span class="line">    model.addAttribute(...);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"myViewName"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><code>request.checkNotModified(lastModified)</code> : <code>true</code>를 반환하는 경우, response status와 header를 설정</li><li><code>return null</code> : <code>request.checkNotModified()</code>와 결합하여 Spring MVC가 요청을 처리하지 않게 만듦</li></ul><h2 id="1-9-4-ETag-Filter"><a href="#1-9-4-ETag-Filter" class="headerlink" title="1.9.4. ETag Filter"></a>1.9.4. ETag Filter</h2><ul><li><code>ShallowEtagHeaderFilter</code>가 응답의 내용을 캐싱하고 ETag 헤더로 내보낼 MD5 해시를 생성</li><li>클라이언트가 동일 자원에 대한 요청을 보내면 해당 해시를 <code>If-None-Match</code> 값으로 사용</li><li>동일한 요청일 경우 필터가 304 응답</li><li>네트워크 대역 트래픽을 낮추는 효과는 있지만, CPU 사용은 낮추지 못함</li><li>앞서 설명한 <code>Controller</code> 수준의 다른 전략들은 연산을 줄일 수 있음</li></ul><h1 id="1-10-View-Technologies"><a href="#1-10-View-Technologies" class="headerlink" title="1.10. View Technologies"></a>1.10. View Technologies</h1><h1 id="1-10-View-Technologies-1"><a href="#1-10-View-Technologies-1" class="headerlink" title="1.10. View Technologies"></a>1.10. View Technologies</h1><ul><li>Thymeleaf</li><li>FreeMarker</li><li>Groovy Markup</li><li>Script Views<ul><li>Mustache</li><li>React</li><li>ext.</li></ul></li><li>JSP &amp; JSTL</li><li>Tiles</li><li>RSS, Aom</li><li>PDF, Excel</li><li>Jackson</li><li>XML</li><li>XSLT</li></ul><h1 id="1-11-MVC-Config"><a href="#1-11-MVC-Config" class="headerlink" title="1.11. MVC Config"></a>1.11. MVC Config</h1><h2 id="1-11-2-MVC-Config-API"><a href="#1-11-2-MVC-Config-API" class="headerlink" title="1.11.2. MVC Config API"></a>1.11.2. MVC Config API</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebMvc</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebConfig</span> <span class="keyword">implements</span> <span class="title">WebMvcConfigurer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Implement configuration methods...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>보통은 <code>WebMvcConfigurerAdapter</code>를 상속받아서 쓰지 않을까…</p><h2 id="1-11-3-Type-conversion"><a href="#1-11-3-Type-conversion" class="headerlink" title="1.11.3. Type conversion"></a>1.11.3. Type conversion</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebMvc</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebConfig</span> <span class="keyword">implements</span> <span class="title">WebMvcConfigurer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addFormatters</span><span class="params">(FormatterRegistry registry)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="1-11-4-Validation"><a href="#1-11-4-Validation" class="headerlink" title="1.11.4. Validation"></a>1.11.4. Validation</h2><p><strong>global validator</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebMvc</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebConfig</span> <span class="keyword">implements</span> <span class="title">WebMvcConfigurer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Validator <span class="title">getValidator</span><span class="params">()</span></span>; &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>local validator</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@InitBinder</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initBinder</span><span class="params">(WebDataBinder binder)</span> </span>&#123;</span><br><span class="line">        binder.addValidators(<span class="keyword">new</span> FooValidator());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="1-11-5-Interceptors"><a href="#1-11-5-Interceptors" class="headerlink" title="1.11.5. Interceptors"></a>1.11.5. Interceptors</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebMvc</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebConfig</span> <span class="keyword">implements</span> <span class="title">WebMvcConfigurer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> </span>&#123;</span><br><span class="line">        registry.addInterceptor(<span class="keyword">new</span> LocaleInterceptor());</span><br><span class="line">        registry.addInterceptor(<span class="keyword">new</span> ThemeInterceptor()).addPathPatterns(<span class="string">"/**"</span>).excludePathPatterns(<span class="string">"/admin/**"</span>);</span><br><span class="line">        registry.addInterceptor(<span class="keyword">new</span> SecurityInterceptor()).addPathPatterns(<span class="string">"/secure/*"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="1-11-6-Content-Types"><a href="#1-11-6-Content-Types" class="headerlink" title="1.11.6. Content Types"></a>1.11.6. Content Types</h2><p><code>ContentNegotiationConfigurer</code>를 통해 확장자로 <code>MediaType</code>을 결정할 수 있음</p><p>예) <code>/a.json</code>의 응답을 <code>application/json</code>으로 변경</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebMvc</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebConfig</span> <span class="keyword">implements</span> <span class="title">WebMvcConfigurer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configureContentNegotiation</span><span class="params">(ContentNegotiationConfigurer configurer)</span> </span>&#123;</span><br><span class="line">        configurer.mediaType(<span class="string">"json"</span>, MediaType.APPLICATION_JSON);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="1-11-7-Message-Converters"><a href="#1-11-7-Message-Converters" class="headerlink" title="1.11.7. Message Converters"></a>1.11.7. Message Converters</h2><p>아래와 같이 custom ObjectMapper를 주입할 수 있다</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebMvc</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebConfiguration</span> <span class="keyword">implements</span> <span class="title">WebMvcConfigurer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configureMessageConverters</span><span class="params">(List&lt;HttpMessageConverter&lt;?&gt;&gt; converters)</span> </span>&#123;</span><br><span class="line">        Jackson2ObjectMapperBuilder builder = <span class="keyword">new</span> Jackson2ObjectMapperBuilder()</span><br><span class="line">                .indentOutput(<span class="keyword">true</span>)</span><br><span class="line">                .dateFormat(<span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd"</span>))</span><br><span class="line">                .modulesToInstall(<span class="keyword">new</span> ParameterNamesModule());</span><br><span class="line">        converters.add(<span class="keyword">new</span> MappingJackson2HttpMessageConverter(builder.build()));</span><br><span class="line">        converters.add(<span class="keyword">new</span> MappingJackson2XmlHttpMessageConverter(builder.xml().build()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>classpath 내에 아래 모듈이 발견되면 자동으로 설정된다</p><ul><li><code>jackson-datatype-jdk7</code> : <code>java.nio.file.Path</code> 등의 Java 7에 정의된 타입</li><li><code>jackson-datatype-joda</code> : Joda-Time 타입 지원</li><li><code>jackson-datatype-jsr310</code> : Java 8에 정의된 Date, Time 타입 지원</li><li><code>jackson-datatype-jdk8</code> : <code>Optional</code>등 Java 8에 정의된 타입</li></ul><p>그 외</p><ul><li><code>jackson-datatype-money</code>: <code>javax.money</code> 타입 지원(unofficial module)</li><li><code>jackson-datatupe-hibernate</code> : <code>lazy-loading</code>등의 하이버네이트 지원</li></ul><h2 id="1-11-8-View-Controllers"><a href="#1-11-8-View-Controllers" class="headerlink" title="1.11.8. View Controllers"></a>1.11.8. View Controllers</h2><p>특정 URL을 바로 view로 매핑</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebMvc</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebConfig</span> <span class="keyword">implements</span> <span class="title">WebMvcConfigurer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addViewControllers</span><span class="params">(ViewControllerRegistry registry)</span> </span>&#123;</span><br><span class="line">        registry.addViewController(<span class="string">"/"</span>).setViewName(<span class="string">"home"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="1-11-10-Static-Resources"><a href="#1-11-10-Static-Resources" class="headerlink" title="1.11.10. Static Resources"></a>1.11.10. Static Resources</h2><p><code>/resources</code>로 들어오는 요청을 <code>/public</code>혹은 classpath 내의 <code>/static</code>에서 찾도록 설정.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebMvc</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebConfig</span> <span class="keyword">implements</span> <span class="title">WebMvcConfigurer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addResourceHandlers</span><span class="params">(ResourceHandlerRegistry registry)</span> </span>&#123;</span><br><span class="line">        registry.addResourceHandler(<span class="string">"/resources/**"</span>)</span><br><span class="line">            .addResourceLocations(<span class="string">"/public"</span>, <span class="string">"classpath:/static/"</span>)</span><br><span class="line">            .setCachePeriod(<span class="number">31556926</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;글에-앞서서&quot;&gt;&lt;a href=&quot;#글에-앞서서&quot; class=&quot;headerlink&quot; title=&quot;글에 앞서서&quot;&gt;&lt;/a&gt;글에 앞서서&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;본문은 Spring Framework Version 5의 습득을 위한 글이다.&lt;/li&gt;
&lt;li&gt;이 글을 상업적 목적으로 쓰지 않았다&lt;blockquote&gt;&lt;p&gt;Authors&lt;br&gt;Rod Johnson , Juergen Hoeller , Keith Donald , Colin Sampaleanu , Rob Harrop , Thomas Risberg , Alef Arendsen , Darren Davison , Dmitriy Kopylenko , Mark Pollack , Thierry Templier , Erwin Vervaet , Portia Tung , Ben Hale , Adrian Colyer , John Lewis , Costin Leau , Mark Fisher , Sam Brannen , Ramnivas Laddad , Arjen Poutsma , Chris Beams , Tareq Abedrabbo , Andy Clement , Dave Syer , Oliver Gierke , Rossen Stoyanchev , Phillip Webb , Rob Winch , Brian Clozel , Stephane Nicoll , Sebastien Deleuze&lt;/p&gt;
&lt;p&gt;Copyright © 2004-2016&lt;/p&gt;
&lt;p&gt;Copies of this document may be made for your own use and for distribution to others, provided that you do not charge any fee for such copies and further provided that each copy contains this Copyright Notice, whether distributed in print or electronically.&lt;/p&gt;
&lt;footer&gt;&lt;strong&gt;원본&lt;/strong&gt;&lt;cite&gt;&lt;a href=&quot;https://docs.spring.io/spring/docs/5.0.4.RELEASE/spring-framework-reference/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;docs.spring.io/spring/docs/5.0.4.RELEASE/spring-framework-reference&lt;/a&gt;&lt;/cite&gt;&lt;/footer&gt;&lt;/blockquote&gt;

&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id=&quot;1-Spring-Web-MVC&quot;&gt;&lt;a href=&quot;#1-Spring-Web-MVC&quot; class=&quot;headerlink&quot; title=&quot;1. Spring Web MVC&quot;&gt;&lt;/a&gt;1. Spring Web MVC&lt;/h1&gt;&lt;h1 id=&quot;1-2-DispatcherServlet&quot;&gt;&lt;a href=&quot;#1-2-DispatcherServlet&quot; class=&quot;headerlink&quot; title=&quot;1.2. DispatcherServlet&quot;&gt;&lt;/a&gt;1.2. DispatcherServlet&lt;/h1&gt;&lt;h2 id=&quot;1-2-DispatcherServlet-1&quot;&gt;&lt;a href=&quot;#1-2-DispatcherServlet-1&quot; class=&quot;headerlink&quot; title=&quot;1.2. DispatcherServlet&quot;&gt;&lt;/a&gt;1.2. DispatcherServlet&lt;/h2&gt;&lt;p&gt;&lt;img src=&quot;https://nesoy.github.io/assets/posts/20170217/2.PNG&quot; alt=&quot;a&quot;&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="spring" scheme="https://supawer0728.github.io/categories/spring/"/>
    
      <category term="reference" scheme="https://supawer0728.github.io/categories/spring/reference/"/>
    
    
      <category term="spring" scheme="https://supawer0728.github.io/tags/spring/"/>
    
      <category term="reference" scheme="https://supawer0728.github.io/tags/reference/"/>
    
  </entry>
  
</feed>
